# 02. Socket.io Introduction & Setup

## Introduction

**Socket.io** is a JavaScript library for real-time, bidirectional communication between web clients and servers. It builds on WebSockets and provides fallback options, making it more reliable than raw WebSockets.

---

## What is Socket.io?

### Key Features

1. **Bidirectional Communication** - Server â†” Client
2. **Event-based** - Custom event names
3. **Auto-reconnection** - Handles network issues
4. **Fallback Transport** - HTTP long-polling if WebSocket unavailable
5. **Rooms & Namespaces** - Organize connections
6. **Acknowledgments** - Callback-based responses
7. **Broadcasting** - Send to multiple clients
8. **Middleware** - Request/connection filtering

### Socket.io vs Raw WebSocket

```javascript
// Raw WebSocket (complex)
const ws = new WebSocket('ws://localhost:3000');
ws.onopen = () => ws.send(JSON.stringify({ type: 'message', data: 'Hello' }));
ws.onmessage = (e) => {
  const parsed = JSON.parse(e.data);
  if (parsed.type === 'message') console.log(parsed.data);
};

// Socket.io (simple)
const socket = io('http://localhost:3000');
socket.emit('message', 'Hello');
socket.on('message', (data) => console.log(data));
```

---

## Installation

### Server-side

```bash
npm install socket.io
```

### Client-side

**Option 1: CDN**
```html
<script src="/socket.io/socket.io.js"></script>
```

**Option 2: npm**
```bash
npm install socket.io-client
```

---

## Basic Server Setup

### Standalone Server

```javascript
// server.js
const { Server } = require('socket.io');

const io = new Server(3000, {
  cors: {
    origin: 'http://localhost:3000',
    methods: ['GET', 'POST']
  }
});

io.on('connection', (socket) => {
  console.log('A user connected:', socket.id);
  
  socket.on('disconnect', () => {
    console.log('User disconnected:', socket.id);
  });
});

console.log('Socket.io server running on port 3000');
```

### With Express

```javascript
// server.js
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');

const app = express();
const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: 'http://localhost:3000',
    methods: ['GET', 'POST']
  }
});

app.get('/', (req, res) => {
  res.send('Socket.io server is running');
});

io.on('connection', (socket) => {
  console.log('A user connected:', socket.id);
  
  socket.on('disconnect', () => {
    console.log('User disconnected:', socket.id);
  });
});

const PORT = 5000;
server.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## Basic Client Setup

### HTML + JavaScript

```html
<!DOCTYPE html>
<html>
<head>
  <title>Socket.io Client</title>
</head>
<body>
  <h1>Socket.io Test</h1>
  <div id="status">Connecting...</div>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to server
    const socket = io('http://localhost:5000');
    
    // Connection established
    socket.on('connect', () => {
      console.log('Connected to server');
      document.getElementById('status').textContent = 'Connected';
    });
    
    // Connection lost
    socket.on('disconnect', () => {
      console.log('Disconnected from server');
      document.getElementById('status').textContent = 'Disconnected';
    });
    
    // Connection error
    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      document.getElementById('status').textContent = 'Connection Error';
    });
  </script>
</body>
</html>
```

### React Client

```javascript
// App.js
import { useEffect, useState } from 'react';
import io from 'socket.io-client';

const socket = io('http://localhost:5000');

function App() {
  const [isConnected, setIsConnected] = useState(false);
  
  useEffect(() => {
    // Connection events
    socket.on('connect', () => {
      console.log('Connected:', socket.id);
      setIsConnected(true);
    });
    
    socket.on('disconnect', () => {
      console.log('Disconnected');
      setIsConnected(false);
    });
    
    // Cleanup on unmount
    return () => {
      socket.off('connect');
      socket.off('disconnect');
    };
  }, []);
  
  return (
    <div>
      <h1>Socket.io React App</h1>
      <p>Status: {isConnected ? 'Connected' : 'Disconnected'}</p>
    </div>
  );
}

export default App;
```

---

## Configuration Options

### Server Options

```javascript
const io = new Server(server, {
  // CORS configuration
  cors: {
    origin: ['http://localhost:3000', 'https://myapp.com'],
    methods: ['GET', 'POST'],
    credentials: true
  },
  
  // Connection timeout
  connectTimeout: 45000, // 45 seconds
  
  // Ping interval (heartbeat)
  pingInterval: 25000, // 25 seconds
  pingTimeout: 60000,  // 60 seconds
  
  // Max HTTP buffer size
  maxHttpBufferSize: 1e6, // 1MB
  
  // Allow upgrades
  allowUpgrades: true,
  
  // Transports
  transports: ['websocket', 'polling'],
  
  // Path
  path: '/socket.io/'
});
```

### Client Options

```javascript
const socket = io('http://localhost:5000', {
  // Auto-connect
  autoConnect: true,
  
  // Reconnection
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  
  // Timeout
  timeout: 20000,
  
  // Transports
  transports: ['websocket', 'polling'],
  
  // Upgrade
  upgrade: true,
  
  // Path
  path: '/socket.io/',
  
  // Query parameters
  query: {
    token: 'abc123'
  },
  
  // Extra headers
  extraHeaders: {
    'Authorization': 'Bearer token'
  }
});
```

---

## Connection Lifecycle

### Server-side Events

```javascript
io.on('connection', (socket) => {
  console.log('Client connected:', socket.id);
  
  // Custom events
  socket.on('message', (data) => {
    console.log('Received:', data);
  });
  
  // Disconnection
  socket.on('disconnect', (reason) => {
    console.log('Client disconnected:', reason);
    // Reasons: 'transport close', 'client namespace disconnect', etc.
  });
  
  // Error
  socket.on('error', (error) => {
    console.error('Socket error:', error);
  });
  
  // Connection error
  socket.on('connect_error', (error) => {
    console.error('Connection error:', error);
  });
});
```

### Client-side Events

```javascript
// Connection established
socket.on('connect', () => {
  console.log('Connected:', socket.id);
});

// Disconnected
socket.on('disconnect', (reason) => {
  console.log('Disconnected:', reason);
  if (reason === 'io server disconnect') {
    // Server forcefully disconnected, reconnect manually
    socket.connect();
  }
});

// Connection error
socket.on('connect_error', (error) => {
  console.error('Connection failed:', error.message);
});

// Reconnecting
socket.on('reconnect', (attemptNumber) => {
  console.log('Reconnected after', attemptNumber, 'attempts');
});

// Reconnect attempt
socket.on('reconnect_attempt', (attemptNumber) => {
  console.log('Reconnection attempt:', attemptNumber);
});

// Reconnection failed
socket.on('reconnect_failed', () => {
  console.error('Reconnection failed');
});

// Reconnection error
socket.on('reconnect_error', (error) => {
  console.error('Reconnection error:', error);
});
```

---

## Complete Example

### Server (server.js)

```javascript
const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const cors = require('cors');

const app = express();
app.use(cors());

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: 'http://localhost:3000',
    methods: ['GET', 'POST']
  }
});

app.get('/', (req, res) => {
  res.send('Socket.io server is running');
});

// Track connected clients
let connectedClients = 0;

io.on('connection', (socket) => {
  connectedClients++;
  console.log(`Client connected: ${socket.id} (Total: ${connectedClients})`);
  
  // Send welcome message
  socket.emit('welcome', {
    message: 'Welcome to Socket.io server!',
    socketId: socket.id
  });
  
  // Broadcast total clients
  io.emit('clientCount', connectedClients);
  
  // Handle custom events
  socket.on('message', (data) => {
    console.log('Message from client:', data);
    socket.emit('messageResponse', `Server received: ${data}`);
  });
  
  // Disconnection
  socket.on('disconnect', (reason) => {
    connectedClients--;
    console.log(`Client disconnected: ${socket.id} (Total: ${connectedClients})`);
    io.emit('clientCount', connectedClients);
  });
});

const PORT = 5000;
server.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

### Client (index.html)

```html
<!DOCTYPE html>
<html>
<head>
  <title>Socket.io Client</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .connected { background-color: #d4edda; color: #155724; }
    .disconnected { background-color: #f8d7da; color: #721c24; }
    #messages { border: 1px solid #ddd; padding: 10px; height: 200px; overflow-y: auto; }
    input, button { padding: 10px; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>Socket.io Client</h1>
  
  <div id="status" class="status disconnected">Disconnected</div>
  <div>Socket ID: <span id="socketId">-</span></div>
  <div>Connected Clients: <span id="clientCount">0</span></div>
  
  <h2>Messages</h2>
  <div id="messages"></div>
  
  <input type="text" id="messageInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>
  
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:5000');
    const statusDiv = document.getElementById('status');
    const socketIdSpan = document.getElementById('socketId');
    const clientCountSpan = document.getElementById('clientCount');
    const messagesDiv = document.getElementById('messages');
    
    // Connection events
    socket.on('connect', () => {
      statusDiv.textContent = 'Connected';
      statusDiv.className = 'status connected';
      socketIdSpan.textContent = socket.id;
      addMessage('Connected to server');
    });
    
    socket.on('disconnect', () => {
      statusDiv.textContent = 'Disconnected';
      statusDiv.className = 'status disconnected';
      socketIdSpan.textContent = '-';
      addMessage('Disconnected from server');
    });
    
    // Custom events
    socket.on('welcome', (data) => {
      addMessage(`Server: ${data.message}`);
    });
    
    socket.on('clientCount', (count) => {
      clientCountSpan.textContent = count;
    });
    
    socket.on('messageResponse', (data) => {
      addMessage(`Server: ${data}`);
    });
    
    // Send message
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (message) {
        socket.emit('message', message);
        addMessage(`You: ${message}`);
        input.value = '';
      }
    }
    
    // Add message to UI
    function addMessage(text) {
      const p = document.createElement('p');
      p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Send on Enter key
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
```

---

## Interview Questions

**Q1: What is Socket.io?**
- Real-time bidirectional communication library
- Built on WebSocket with fallback to HTTP long-polling
- Event-based API with rooms, namespaces, and acknowledgments

**Q2: How to create a Socket.io server?**
```javascript
const { Server } = require('socket.io');
const io = new Server(httpServer, { cors: { origin: '*' } });
io.on('connection', (socket) => { /* handle socket */ });
```

**Q3: How does Socket.io handle reconnection?**
- Automatic reconnection with exponential backoff
- Configurable attempts and delays
- Events: `reconnect`, `reconnect_attempt`, `reconnect_failed`

**Q4: What are Socket.io transports?**
- `websocket`: Full-duplex WebSocket connection
- `polling`: HTTP long-polling fallback
- Automatically upgrades from polling to WebSocket if available

**Q5: How to configure CORS in Socket.io?**
```javascript
const io = new Server(server, {
  cors: {
    origin: 'http://localhost:3000',
    methods: ['GET', 'POST'],
    credentials: true
  }
});
```

---

## Best Practices

1. **Use CORS** properly in production
2. **Set appropriate timeouts** (ping, reconnection)
3. **Limit message size** to prevent abuse
4. **Handle disconnections** gracefully
5. **Use namespaces** to separate concerns
6. **Implement authentication** for secure connections
7. **Monitor active connections** for scaling
8. **Use acknowledgments** for critical messages
9. **Clean up listeners** on component unmount (React)
10. **Test reconnection** scenarios

---

## Summary

- **Socket.io**: Real-time library with WebSocket + fallback
- **Server**: `new Server(httpServer, options)`
- **Client**: `io(url, options)`
- **Connection events**: `connect`, `disconnect`, `reconnect`
- **Auto-reconnection**: Built-in with configurable attempts
- **CORS**: Required for cross-origin connections
- **Transports**: WebSocket (preferred) and polling (fallback)
- **Event-based**: Custom events with `emit()` and `on()`
