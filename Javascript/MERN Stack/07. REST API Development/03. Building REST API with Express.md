# Building REST API with Express

## What is Express?

**Express.js** is a minimal and flexible Node.js web application framework.

**Key Features:**
- Fast and lightweight
- Robust routing
- Middleware support
- Template engines
- HTTP utility methods

> **Express is the most popular Node.js framework.**

---

## Initial Setup

### 1. Initialize Project

```bash
mkdir my-api
cd my-api
npm init -y
```

### 2. Install Dependencies

```bash
npm install express
npm install --save-dev nodemon
```

### 3. Basic Server

```js
// server.js
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.use(express.json()); // Parse JSON bodies

app.get('/', (req, res) => {
  res.json({ message: 'Welcome to my API' });
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

### 4. Add Scripts to package.json

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  }
}
```

### 5. Run Server

```bash
npm run dev
```

---

## Middleware

**Middleware** are functions that have access to `req`, `res`, and `next`.

### Built-in Middleware

```js
// Parse JSON bodies
app.use(express.json());

// Parse URL-encoded bodies
app.use(express.urlencoded({ extended: true }));

// Serve static files
app.use(express.static('public'));
```

### Custom Middleware

```js
// Logger middleware
const logger = (req, res, next) => {
  console.log(`${req.method} ${req.url}`);
  next(); // Pass to next middleware
};

app.use(logger);
```

### Third-Party Middleware

```bash
npm install cors morgan helmet
```

```js
const cors = require('cors');
const morgan = require('morgan');
const helmet = require('helmet');

app.use(cors());           // Enable CORS
app.use(morgan('dev'));    // HTTP request logger
app.use(helmet());         // Security headers
```

### Middleware Order Matters

```js
// ✅ Correct order
app.use(express.json());   // Parse body first
app.use(logger);           // Then log
app.use('/api', routes);   // Then routes
app.use(errorHandler);     // Error handler last
```

---

## Routing

### Basic Routes

```js
// GET request
app.get('/api/users', (req, res) => {
  res.json({ users: [] });
});

// POST request
app.post('/api/users', (req, res) => {
  const user = req.body;
  res.status(201).json({ user });
});

// PUT request
app.put('/api/users/:id', (req, res) => {
  const { id } = req.params;
  const updates = req.body;
  res.json({ id, updates });
});

// DELETE request
app.delete('/api/users/:id', (req, res) => {
  const { id } = req.params;
  res.status(204).send();
});
```

### Route Parameters

```js
// Single parameter
app.get('/users/:id', (req, res) => {
  const userId = req.params.id;
  res.json({ userId });
});

// Multiple parameters
app.get('/users/:userId/posts/:postId', (req, res) => {
  const { userId, postId } = req.params;
  res.json({ userId, postId });
});

// Optional parameters
app.get('/users/:id?', (req, res) => {
  // id is optional
});
```

### Query Parameters

```js
app.get('/api/products', (req, res) => {
  const { category, minPrice, maxPrice } = req.query;
  // /api/products?category=electronics&minPrice=100&maxPrice=500
  res.json({ category, minPrice, maxPrice });
});
```

---

## Express Router

Organize routes into separate files.

### routes/users.js

```js
const express = require('express');
const router = express.Router();

// GET /api/users
router.get('/', (req, res) => {
  res.json({ users: [] });
});

// GET /api/users/:id
router.get('/:id', (req, res) => {
  res.json({ id: req.params.id });
});

// POST /api/users
router.post('/', (req, res) => {
  res.status(201).json({ user: req.body });
});

// PUT /api/users/:id
router.put('/:id', (req, res) => {
  res.json({ id: req.params.id, updates: req.body });
});

// DELETE /api/users/:id
router.delete('/:id', (req, res) => {
  res.status(204).send();
});

module.exports = router;
```

### server.js

```js
const express = require('express');
const usersRouter = require('./routes/users');
const productsRouter = require('./routes/products');

const app = express();

app.use(express.json());

// Mount routers
app.use('/api/users', usersRouter);
app.use('/api/products', productsRouter);

app.listen(3000);
```

---

## MVC Architecture

### Folder Structure

```
my-api/
├── controllers/
│   └── userController.js
├── models/
│   └── User.js
├── routes/
│   └── users.js
├── middlewares/
│   └── auth.js
├── utils/
│   └── validation.js
├── config/
│   └── database.js
└── server.js
```

### Model (models/User.js)

```js
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  role: {
    type: String,
    enum: ['user', 'admin'],
    default: 'user'
  }
}, {
  timestamps: true
});

module.exports = mongoose.model('User', userSchema);
```

### Controller (controllers/userController.js)

```js
const User = require('../models/User');

// Get all users
exports.getUsers = async (req, res) => {
  try {
    const users = await User.find().select('-password');
    res.json({
      success: true,
      data: users
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};

// Get single user
exports.getUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id).select('-password');
    
    if (!user) {
      return res.status(404).json({
        success: false,
        error: 'User not found'
      });
    }
    
    res.json({
      success: true,
      data: user
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};

// Create user
exports.createUser = async (req, res) => {
  try {
    const user = await User.create(req.body);
    
    res.status(201).json({
      success: true,
      data: user
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      error: error.message
    });
  }
};

// Update user
exports.updateUser = async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    ).select('-password');
    
    if (!user) {
      return res.status(404).json({
        success: false,
        error: 'User not found'
      });
    }
    
    res.json({
      success: true,
      data: user
    });
  } catch (error) {
    res.status(400).json({
      success: false,
      error: error.message
    });
  }
};

// Delete user
exports.deleteUser = async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    
    if (!user) {
      return res.status(404).json({
        success: false,
        error: 'User not found'
      });
    }
    
    res.status(204).send();
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
};
```

### Routes (routes/users.js)

```js
const express = require('express');
const router = express.Router();
const {
  getUsers,
  getUser,
  createUser,
  updateUser,
  deleteUser
} = require('../controllers/userController');

router.route('/')
  .get(getUsers)
  .post(createUser);

router.route('/:id')
  .get(getUser)
  .put(updateUser)
  .delete(deleteUser);

module.exports = router;
```

---

## Database Connection

### config/database.js

```js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGO_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    console.log('MongoDB connected');
  } catch (error) {
    console.error('MongoDB connection error:', error);
    process.exit(1);
  }
};

module.exports = connectDB;
```

### server.js

```js
require('dotenv').config();
const express = require('express');
const connectDB = require('./config/database');
const usersRouter = require('./routes/users');

const app = express();

// Connect to database
connectDB();

// Middleware
app.use(express.json());

// Routes
app.use('/api/users', usersRouter);

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## Environment Variables

### .env

```
PORT=3000
MONGO_URI=mongodb://localhost:27017/mydb
JWT_SECRET=your_secret_key
```

### Install dotenv

```bash
npm install dotenv
```

### Usage

```js
require('dotenv').config();

const PORT = process.env.PORT;
const MONGO_URI = process.env.MONGO_URI;
```

---

## Error Handling

### Global Error Handler

```js
// middlewares/errorHandler.js
module.exports = (err, req, res, next) => {
  console.error(err.stack);
  
  res.status(err.statusCode || 500).json({
    success: false,
    error: err.message || 'Internal Server Error'
  });
};
```

### Using in server.js

```js
const errorHandler = require('./middlewares/errorHandler');

// Routes
app.use('/api/users', usersRouter);

// Error handler (must be last)
app.use(errorHandler);
```

### Custom Error Class

```js
// utils/AppError.js
class AppError extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
    this.isOperational = true;
    
    Error.captureStackTrace(this, this.constructor);
  }
}

module.exports = AppError;
```

### Usage

```js
const AppError = require('../utils/AppError');

exports.getUser = async (req, res, next) => {
  try {
    const user = await User.findById(req.params.id);
    
    if (!user) {
      return next(new AppError('User not found', 404));
    }
    
    res.json({ success: true, data: user });
  } catch (error) {
    next(error);
  }
};
```

---

## Async Error Handling

### Wrapper Function

```js
// utils/asyncHandler.js
module.exports = (fn) => (req, res, next) => {
  Promise.resolve(fn(req, res, next)).catch(next);
};
```

### Usage

```js
const asyncHandler = require('../utils/asyncHandler');

exports.getUsers = asyncHandler(async (req, res) => {
  const users = await User.find();
  res.json({ success: true, data: users });
});
```

---

## Complete CRUD Example

### Product Model

```js
const mongoose = require('mongoose');

const productSchema = new mongoose.Schema({
  name: { type: String, required: true },
  price: { type: Number, required: true },
  description: String,
  category: String,
  inStock: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('Product', productSchema);
```

### Product Controller

```js
const Product = require('../models/Product');

// @desc    Get all products
// @route   GET /api/products
// @access  Public
exports.getProducts = async (req, res) => {
  const { category, minPrice, maxPrice, page = 1, limit = 10 } = req.query;
  
  // Build query
  const query = {};
  if (category) query.category = category;
  if (minPrice || maxPrice) {
    query.price = {};
    if (minPrice) query.price.$gte = minPrice;
    if (maxPrice) query.price.$lte = maxPrice;
  }
  
  // Pagination
  const skip = (page - 1) * limit;
  
  const products = await Product.find(query)
    .skip(skip)
    .limit(parseInt(limit));
  
  const total = await Product.countDocuments(query);
  
  res.json({
    success: true,
    data: products,
    pagination: {
      page: parseInt(page),
      limit: parseInt(limit),
      total,
      pages: Math.ceil(total / limit)
    }
  });
};

// @desc    Get single product
// @route   GET /api/products/:id
// @access  Public
exports.getProduct = async (req, res) => {
  const product = await Product.findById(req.params.id);
  
  if (!product) {
    return res.status(404).json({
      success: false,
      error: 'Product not found'
    });
  }
  
  res.json({ success: true, data: product });
};

// @desc    Create product
// @route   POST /api/products
// @access  Private
exports.createProduct = async (req, res) => {
  const product = await Product.create(req.body);
  res.status(201).json({ success: true, data: product });
};

// @desc    Update product
// @route   PUT /api/products/:id
// @access  Private
exports.updateProduct = async (req, res) => {
  const product = await Product.findByIdAndUpdate(
    req.params.id,
    req.body,
    { new: true, runValidators: true }
  );
  
  if (!product) {
    return res.status(404).json({
      success: false,
      error: 'Product not found'
    });
  }
  
  res.json({ success: true, data: product });
};

// @desc    Delete product
// @route   DELETE /api/products/:id
// @access  Private
exports.deleteProduct = async (req, res) => {
  const product = await Product.findByIdAndDelete(req.params.id);
  
  if (!product) {
    return res.status(404).json({
      success: false,
      error: 'Product not found'
    });
  }
  
  res.status(204).send();
};
```

---

## Interview Questions

### Q1: What is Express middleware?
**Answer**: Functions that have access to `req`, `res`, and `next`. They execute in sequence and can modify request/response or end the request-response cycle.

### Q2: What's the difference between app.use() and app.get()?
**Answer**: 
- `app.use()`: Middleware for all HTTP methods
- `app.get()`: Route handler for GET requests only

### Q3: How do you handle errors in Express?
**Answer**: Use error-handling middleware with 4 parameters: `(err, req, res, next)`. It must be defined last.

### Q4: What is Express Router?
**Answer**: A way to organize routes into separate modules. Creates modular, mountable route handlers.

### Q5: How do you access route parameters?
**Answer**: Use `req.params` for path parameters, `req.query` for query parameters, `req.body` for request body.

---

## Summary

- **Express** is a minimal Node.js web framework
- **Middleware** are functions with access to req, res, next
- **Routing** uses HTTP methods + URL patterns
- **Express Router** organizes routes into modules
- **MVC Architecture**: Models, Controllers, Routes
- **Error Handling**: Use error middleware (4 params)
- **Environment Variables**: Use dotenv for configuration
- **Async Handlers**: Wrap async functions to catch errors
- **CRUD Operations**: Create, Read, Update, Delete
