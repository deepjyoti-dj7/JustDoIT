# Validation & Response Formatting

## Why Validation?

**Input validation** is critical for:
- Security (prevent SQL injection, XSS)
- Data integrity
- Better error messages
- Preventing crashes

> **Never trust user input!**

---

## Validation Libraries

### 1. express-validator (Most Popular)
### 2. Joi
### 3. Yup
### 4. Class-validator

---

## express-validator

### Installation

```bash
npm install express-validator
```

### Basic Usage

```js
const { body, validationResult } = require('express-validator');

app.post('/users',
  // Validation rules
  [
    body('email').isEmail().withMessage('Invalid email'),
    body('password').isLength({ min: 6 }).withMessage('Password must be at least 6 characters'),
    body('name').trim().notEmpty().withMessage('Name is required')
  ],
  // Handler
  (req, res) => {
    const errors = validationResult(req);
    
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        errors: errors.array()
      });
    }
    
    // Validation passed
    res.json({ success: true });
  }
);
```

### Validation Middleware

```js
// middlewares/validate.js
const { validationResult } = require('express-validator');

const validate = (req, res, next) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      errors: errors.array().map(err => ({
        field: err.param,
        message: err.msg
      }))
    });
  }
  
  next();
};

module.exports = validate;
```

### Usage with Middleware

```js
const { body } = require('express-validator');
const validate = require('../middlewares/validate');

router.post('/users',
  [
    body('email').isEmail(),
    body('password').isLength({ min: 6 }),
    body('name').trim().notEmpty()
  ],
  validate,  // Validation middleware
  createUser // Controller
);
```

### Common Validators

```js
const { body, param, query } = require('express-validator');

// Email
body('email').isEmail()

// String length
body('password').isLength({ min: 6, max: 20 })

// Not empty
body('name').notEmpty()

// Alphanumeric
body('username').isAlphanumeric()

// Numeric
body('age').isInt({ min: 0, max: 120 })

// Date
body('birthdate').isISO8601()

// URL
body('website').isURL()

// Custom validator
body('password').custom((value, { req }) => {
  if (value !== req.body.confirmPassword) {
    throw new Error('Passwords do not match');
  }
  return true;
})

// Conditional validation
body('shippingAddress')
  .if(body('needsShipping').equals('true'))
  .notEmpty()

// Array validation
body('tags').isArray({ min: 1, max: 5 })
body('tags.*').isString()
```

### Sanitization

```js
// Trim whitespace
body('name').trim()

// Lowercase
body('email').normalizeEmail()

// Escape HTML
body('comment').escape()

// Convert to boolean
query('active').toBoolean()

// Convert to int
query('page').toInt()

// Remove fields
body('password').trim().escape().customSanitizer(value => {
  return value.replace(/[^a-zA-Z0-9]/g, '');
})
```

### Complete Example

```js
const { body, param } = require('express-validator');
const validate = require('../middlewares/validate');

// Create user validation
const createUserValidation = [
  body('name')
    .trim()
    .notEmpty().withMessage('Name is required')
    .isLength({ min: 2, max: 50 }).withMessage('Name must be 2-50 characters'),
  
  body('email')
    .trim()
    .normalizeEmail()
    .isEmail().withMessage('Invalid email format'),
  
  body('password')
    .isLength({ min: 8 }).withMessage('Password must be at least 8 characters')
    .matches(/[a-z]/).withMessage('Password must contain lowercase letter')
    .matches(/[A-Z]/).withMessage('Password must contain uppercase letter')
    .matches(/[0-9]/).withMessage('Password must contain number'),
  
  body('age')
    .optional()
    .isInt({ min: 18, max: 100 }).withMessage('Age must be 18-100'),
  
  body('role')
    .optional()
    .isIn(['user', 'admin']).withMessage('Invalid role')
];

// Update user validation
const updateUserValidation = [
  param('id').isMongoId().withMessage('Invalid user ID'),
  
  body('name')
    .optional()
    .trim()
    .isLength({ min: 2, max: 50 }),
  
  body('email')
    .optional()
    .trim()
    .normalizeEmail()
    .isEmail()
];

router.post('/users', createUserValidation, validate, createUser);
router.put('/users/:id', updateUserValidation, validate, updateUser);
```

---

## Joi Validation

### Installation

```bash
npm install joi
```

### Basic Usage

```js
const Joi = require('joi');

const userSchema = Joi.object({
  name: Joi.string().min(2).max(50).required(),
  email: Joi.string().email().required(),
  password: Joi.string().min(8).required(),
  age: Joi.number().integer().min(18).max(100).optional(),
  role: Joi.string().valid('user', 'admin').default('user')
});

// Validate
const { error, value } = userSchema.validate(req.body);

if (error) {
  return res.status(400).json({
    success: false,
    error: error.details[0].message
  });
}
```

### Joi Middleware

```js
// middlewares/validateJoi.js
const validateJoi = (schema) => {
  return (req, res, next) => {
    const { error, value } = schema.validate(req.body, {
      abortEarly: false, // Return all errors
      stripUnknown: true // Remove unknown fields
    });
    
    if (error) {
      return res.status(400).json({
        success: false,
        errors: error.details.map(err => ({
          field: err.path[0],
          message: err.message
        }))
      });
    }
    
    req.body = value; // Use validated/sanitized value
    next();
  };
};

module.exports = validateJoi;
```

### Usage

```js
const Joi = require('joi');
const validateJoi = require('../middlewares/validateJoi');

const createUserSchema = Joi.object({
  name: Joi.string().min(2).max(50).required(),
  email: Joi.string().email().required(),
  password: Joi.string().min(8).required()
});

router.post('/users', validateJoi(createUserSchema), createUser);
```

---

## Response Formatting

### Standard Response Structure

```js
// Success Response
{
  "success": true,
  "data": { ... },
  "message": "Optional message"
}

// Error Response
{
  "success": false,
  "error": {
    "message": "Error message",
    "code": "ERROR_CODE",
    "details": [ ... ]
  }
}
```

### Response Helper

```js
// utils/response.js
class Response {
  static success(res, data, message = '', statusCode = 200) {
    return res.status(statusCode).json({
      success: true,
      data,
      message
    });
  }
  
  static error(res, message, statusCode = 500, code = null, details = null) {
    const response = {
      success: false,
      error: {
        message
      }
    };
    
    if (code) response.error.code = code;
    if (details) response.error.details = details;
    
    return res.status(statusCode).json(response);
  }
  
  static created(res, data, message = 'Created successfully') {
    return this.success(res, data, message, 201);
  }
  
  static noContent(res) {
    return res.status(204).send();
  }
  
  static badRequest(res, message, details = null) {
    return this.error(res, message, 400, 'BAD_REQUEST', details);
  }
  
  static unauthorized(res, message = 'Unauthorized') {
    return this.error(res, message, 401, 'UNAUTHORIZED');
  }
  
  static forbidden(res, message = 'Forbidden') {
    return this.error(res, message, 403, 'FORBIDDEN');
  }
  
  static notFound(res, message = 'Resource not found') {
    return this.error(res, message, 404, 'NOT_FOUND');
  }
}

module.exports = Response;
```

### Usage

```js
const Response = require('../utils/response');
const User = require('../models/User');

exports.getUsers = async (req, res) => {
  try {
    const users = await User.find();
    return Response.success(res, users, 'Users retrieved successfully');
  } catch (error) {
    return Response.error(res, error.message);
  }
};

exports.getUser = async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    
    if (!user) {
      return Response.notFound(res, 'User not found');
    }
    
    return Response.success(res, user);
  } catch (error) {
    return Response.error(res, error.message);
  }
};

exports.createUser = async (req, res) => {
  try {
    const user = await User.create(req.body);
    return Response.created(res, user, 'User created successfully');
  } catch (error) {
    return Response.badRequest(res, error.message);
  }
};

exports.deleteUser = async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    
    if (!user) {
      return Response.notFound(res, 'User not found');
    }
    
    return Response.noContent(res);
  } catch (error) {
    return Response.error(res, error.message);
  }
};
```

---

## Pagination Response

```js
class Response {
  static paginated(res, data, pagination, message = '') {
    return res.status(200).json({
      success: true,
      data,
      pagination: {
        page: pagination.page,
        limit: pagination.limit,
        total: pagination.total,
        pages: Math.ceil(pagination.total / pagination.limit)
      },
      message
    });
  }
}

// Usage
exports.getUsers = async (req, res) => {
  const page = parseInt(req.query.page) || 1;
  const limit = parseInt(req.query.limit) || 10;
  const skip = (page - 1) * limit;
  
  const users = await User.find().skip(skip).limit(limit);
  const total = await User.countDocuments();
  
  return Response.paginated(res, users, { page, limit, total });
};
```

---

## Custom Validators

### Unique Email Validator

```js
const User = require('../models/User');

const isUniqueEmail = async (email, userId = null) => {
  const query = { email };
  if (userId) query._id = { $ne: userId };
  
  const user = await User.findOne(query);
  return !user;
};

// With express-validator
body('email')
  .isEmail()
  .custom(async (email) => {
    const unique = await isUniqueEmail(email);
    if (!unique) {
      throw new Error('Email already exists');
    }
    return true;
  })

// With Joi
const schema = Joi.object({
  email: Joi.string().email().required().external(async (value) => {
    const unique = await isUniqueEmail(value);
    if (!unique) {
      throw new Error('Email already exists');
    }
  })
});
```

---

## File Upload Validation

```js
const multer = require('multer');

// Configure multer
const upload = multer({
  limits: {
    fileSize: 5 * 1024 * 1024 // 5MB
  },
  fileFilter: (req, file, cb) => {
    // Allow only images
    if (!file.mimetype.startsWith('image/')) {
      return cb(new Error('Only images are allowed'), false);
    }
    cb(null, true);
  }
});

router.post('/upload',
  upload.single('image'),
  (req, res) => {
    if (!req.file) {
      return Response.badRequest(res, 'No file uploaded');
    }
    
    Response.success(res, {
      filename: req.file.filename,
      path: req.file.path
    });
  }
);
```

---

## Interview Questions

### Q1: Why is input validation important?
**Answer**: Prevents security vulnerabilities (SQL injection, XSS), ensures data integrity, provides better error messages, and prevents application crashes.

### Q2: What's the difference between validation and sanitization?
**Answer**:
- **Validation**: Checks if input meets criteria
- **Sanitization**: Cleans/transforms input (trim, escape, etc.)

### Q3: Should validation happen on frontend or backend?
**Answer**: **Both**. Frontend for UX, backend for security (never trust client-side validation).

### Q4: What is express-validator?
**Answer**: A middleware for Express that validates and sanitizes request data using validator.js.

### Q5: How do you handle validation errors?
**Answer**: Return 400 Bad Request with structured error response containing field-specific messages.

---

## Summary

- **Validation** ensures input meets requirements
- **Sanitization** cleans/transforms input
- **express-validator**: Most popular for Express
- **Joi**: Schema-based validation
- **Response Formatting**: Consistent structure (success, data, error)
- **Helper Classes**: Simplify response handling
- **Custom Validators**: For complex rules (unique email, etc.)
- **Always validate on backend** - never trust client
- **Return meaningful errors** with field-specific messages
