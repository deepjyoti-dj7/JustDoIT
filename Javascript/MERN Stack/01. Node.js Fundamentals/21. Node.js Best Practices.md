# 21. Node.js Best Practices

## Project Structure

### Organize by Features

```
src/
├── users/
│   ├── user.controller.js
│   ├── user.service.js
│   ├── user.model.js
│   └── user.routes.js
├── posts/
│   ├── post.controller.js
│   ├── post.service.js
│   ├── post.model.js
│   └── post.routes.js
├── config/
│   └── index.js
├── middleware/
│   ├── auth.js
│   └── errorHandler.js
└── app.js
```

---

## Separate Business Logic

```javascript
// ❌ Bad - Logic in routes
app.post('/users', async (req, res) => {
  const user = await User.create(req.body);
  const hashedPassword = await bcrypt.hash(user.password, 10);
  user.password = hashedPassword;
  await user.save();
  res.json(user);
});

// ✅ Good - Use service layer
// routes/user.routes.js
router.post('/users', userController.create);

// controllers/user.controller.js
async function create(req, res, next) {
  try {
    const user = await userService.createUser(req.body);
    res.status(201).json(user);
  } catch (err) {
    next(err);
  }
}

// services/user.service.js
async function createUser(userData) {
  const hashedPassword = await bcrypt.hash(userData.password, 10);
  return User.create({ ...userData, password: hashedPassword });
}
```

---

## Error Handling

### Centralized Error Handler

```javascript
// middleware/errorHandler.js
function errorHandler(err, req, res, next) {
  console.error(err.stack);
  
  const statusCode = err.statusCode || 500;
  const message = err.message || 'Internal Server Error';
  
  res.status(statusCode).json({
    success: false,
    error: message
  });
}

module.exports = errorHandler;

// app.js
app.use(errorHandler);
```

### Custom Errors

```javascript
class AppError extends Error {
  constructor(message, statusCode) {
    super(message);
    this.statusCode = statusCode;
  }
}

class NotFoundError extends AppError {
  constructor(message = 'Resource not found') {
    super(message, 404);
  }
}

class BadRequestError extends AppError {
  constructor(message = 'Bad request') {
    super(message, 400);
  }
}

// Usage
if (!user) {
  throw new NotFoundError('User not found');
}
```

### Async Error Wrapper

```javascript
function asyncHandler(fn) {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
}

// Usage
app.get('/users/:id', asyncHandler(async (req, res) => {
  const user = await User.findById(req.params.id);
  res.json(user);
}));
```

---

## Environment Variables

```javascript
// config/index.js
require('dotenv').config();

const config = {
  port: process.env.PORT || 3000,
  env: process.env.NODE_ENV || 'development',
  db: {
    uri: process.env.MONGO_URI
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: '7d'
  }
};

// Validate required vars
const required = ['MONGO_URI', 'JWT_SECRET'];
const missing = required.filter(key => !process.env[key]);

if (missing.length > 0) {
  throw new Error(`Missing env vars: ${missing.join(', ')}`);
}

module.exports = config;
```

---

## Security

### Use Helmet

```javascript
const helmet = require('helmet');
app.use(helmet());
```

### Rate Limiting

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 minutes
  max: 100  // Max 100 requests per IP
});

app.use('/api/', limiter);
```

### Input Validation

```javascript
const Joi = require('joi');

const userSchema = Joi.object({
  email: Joi.string().email().required(),
  password: Joi.string().min(8).required()
});

function validateUser(req, res, next) {
  const { error } = userSchema.validate(req.body);
  if (error) {
    return res.status(400).json({ error: error.details[0].message });
  }
  next();
}

app.post('/users', validateUser, createUser);
```

### Prevent SQL Injection

```javascript
// ❌ Vulnerable
db.query(`SELECT * FROM users WHERE id = ${userId}`);

// ✅ Safe - Use parameterized queries
db.query('SELECT * FROM users WHERE id = ?', [userId]);

// ✅ Use ORM
User.findById(userId);
```

---

## Logging

```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// Console in development
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

// Usage
logger.info('User created', { userId: user.id });
logger.error('Error occurred', { error: err.message });
```

---

## Database Best Practices

### Use Indexes

```javascript
const userSchema = new Schema({
  email: { type: String, unique: true, index: true },
  createdAt: { type: Date, index: true }
});
```

### Lean Queries

```javascript
// ❌ Returns full Mongoose document
const users = await User.find();

// ✅ Returns plain object (faster)
const users = await User.find().lean();
```

### Select Specific Fields

```javascript
// ❌ Get all fields
const users = await User.find();

// ✅ Get only needed fields
const users = await User.find().select('name email');
```

### Pagination

```javascript
async function getUsers(req, res) {
  const page = parseInt(req.query.page) || 1;
  const limit = 20;
  const skip = (page - 1) * limit;
  
  const users = await User.find()
    .limit(limit)
    .skip(skip)
    .lean();
  
  res.json({ users, page });
}
```

---

## Async Best Practices

### Use async/await

```javascript
// ❌ Callbacks
getUser(id, (err, user) => {
  if (err) return handleError(err);
  getPosts(user.id, (err, posts) => {
    if (err) return handleError(err);
    res.json({ user, posts });
  });
});

// ✅ async/await
async function getUserData(id) {
  const user = await getUser(id);
  const posts = await getPosts(user.id);
  return { user, posts };
}
```

### Parallel Operations

```javascript
// ❌ Sequential
const user = await getUser(id);
const posts = await getPosts(id);
const comments = await getComments(id);

// ✅ Parallel
const [user, posts, comments] = await Promise.all([
  getUser(id),
  getPosts(id),
  getComments(id)
]);
```

---

## Performance

### Caching

```javascript
const cache = {};

app.get('/api/users/:id', async (req, res) => {
  const { id } = req.params;
  
  if (cache[id]) {
    return res.json(cache[id]);
  }
  
  const user = await User.findById(id);
  cache[id] = user;
  
  res.json(user);
});
```

### Compression

```javascript
const compression = require('compression');
app.use(compression());
```

### Use Streams

```javascript
// ❌ Load entire file
const data = await fs.readFile('large-file.txt');
res.send(data);

// ✅ Stream
const stream = fs.createReadStream('large-file.txt');
stream.pipe(res);
```

---

## Code Quality

### ESLint

```bash
npm install --save-dev eslint
npx eslint --init
```

**.eslintrc.json:**
```json
{
  "env": { "node": true, "es2021": true },
  "extends": "eslint:recommended",
  "rules": {
    "no-console": "warn",
    "semi": ["error", "always"]
  }
}
```

### Prettier

```bash
npm install --save-dev prettier
```

**.prettierrc:**
```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2
}
```

---

## Testing

```javascript
// user.test.js
const { createUser } = require('./userService');

test('creates user', async () => {
  const user = await createUser({
    email: 'test@example.com',
    password: 'password123'
  });
  
  expect(user).toHaveProperty('id');
  expect(user.email).toBe('test@example.com');
});
```

---

## Graceful Shutdown

```javascript
const server = app.listen(3000);

function shutdown() {
  console.log('Shutting down...');
  
  server.close(() => {
    mongoose.connection.close(false, () => {
      console.log('MongoDB closed');
      process.exit(0);
    });
  });
  
  setTimeout(() => {
    process.exit(1);
  }, 10000);
}

process.on('SIGTERM', shutdown);
process.on('SIGINT', shutdown);
```

---

## API Best Practices

### Versioning

```javascript
app.use('/api/v1/users', userRoutesV1);
app.use('/api/v2/users', userRoutesV2);
```

### Response Format

```javascript
// Success
res.json({
  success: true,
  data: users
});

// Error
res.status(404).json({
  success: false,
  error: 'Not found'
});
```

### HTTP Status Codes

```javascript
200  // OK
201  // Created
204  // No Content
400  // Bad Request
401  // Unauthorized
403  // Forbidden
404  // Not Found
500  // Internal Server Error
```

---

## Documentation

### JSDoc

```javascript
/**
 * Creates a new user
 * @param {Object} userData - User data
 * @param {string} userData.email - User email
 * @param {string} userData.password - User password
 * @returns {Promise<Object>} Created user
 */
async function createUser(userData) {
  // ...
}
```

---

## Dependencies

### Keep Updated

```bash
npm outdated
npm update
```

### Audit Security

```bash
npm audit
npm audit fix
```

---

## .gitignore

```
node_modules/
.env
.env.local
*.log
dist/
coverage/
```

---

## Production Checklist

Before deploying:

- [ ] Environment variables set
- [ ] Error handling implemented
- [ ] Security headers (Helmet)
- [ ] Rate limiting enabled
- [ ] Input validation
- [ ] Database indexes
- [ ] Tests passing
- [ ] Code linted
- [ ] Dependencies audited
- [ ] Graceful shutdown
- [ ] Monitoring setup

---

## Summary

**Key Principles:**
- Separate concerns (routes → controllers → services)
- Centralized error handling
- Security first (validation, rate limiting)
- Use environment variables
- Write tests
- Monitor and log
- Optimize performance

**Essential Tools:**
- **Helmet** - Security headers
- **Winston** - Logging
- **Joi** - Validation
- **ESLint** - Code quality
- **Jest** - Testing

**Remember:** Write **clean**, **secure**, and **maintainable** code!

**Next:** Learn about testing with Jest and Mocha!
