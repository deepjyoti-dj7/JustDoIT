# 05. CommonJS vs ES6 Modules

## Module Systems Comparison

| Feature | CommonJS | ES6 Modules (ESM) |
|---------|----------|-------------------|
| **Syntax** | `require()`/`module.exports` | `import`/`export` |
| **Loading** | Synchronous | Asynchronous |
| **When** | Runtime | Parse time |
| **Default** | Yes (Node.js default) | Opt-in (.mjs or package.json) |
| **Tree Shaking** | No | Yes |
| **Top-level await** | No | Yes |

---

## CommonJS (CJS)

### Export Syntax:

```javascript
// math.js

// Individual exports
exports.add = (a, b) => a + b;
exports.subtract = (a, b) => a - b;

// Or export entire object
module.exports = {
  add: (a, b) => a + b,
  subtract: (a, b) => a - b
};

// Or export single item
module.exports = class Calculator {
  add(a, b) { return a + b; }
};
```

### Import Syntax:

```javascript
// app.js

// Import entire module
const math = require('./math');

// Destructure
const { add, subtract } = require('./math');

// Import single export
const Calculator = require('./Calculator');
```

---

## ES6 Modules (ESM)

### Export Syntax:

```javascript
// math.js

// Named exports
export const add = (a, b) => a + b;
export const subtract = (a, b) => a - b;

// Or export at end
const multiply = (a, b) => a * b;
const divide = (a, b) => a / b;
export { multiply, divide };

// Default export (one per file)
export default class Calculator {
  add(a, b) { return a + b; }
}

// Or
class Calculator {
  add(a, b) { return a + b; }
}
export default Calculator;
```

### Import Syntax:

```javascript
// app.js

// Named imports
import { add, subtract } from './math.js';

// Rename imports
import { add as sum } from './math.js';

// Import all as namespace
import * as math from './math.js';

// Default import
import Calculator from './Calculator.js';

// Mix default and named
import Calculator, { add, subtract } from './math.js';
```

---

## Enabling ESM in Node.js

### Method 1: **.mjs Extension**

```javascript
// math.mjs
export const add = (a, b) => a + b;

// app.mjs
import { add } from './math.mjs';
```

### Method 2: **package.json "type": "module"**

```json
{
  "type": "module"
}
```

Now `.js` files use ES6 modules:

```javascript
// math.js
export const add = (a, b) => a + b;

// app.js
import { add } from './math.js';  // Note: .js extension required!
```

### Method 3: **Use .cjs for CommonJS when type: "module"**

```javascript
// oldModule.cjs
module.exports = { legacy: true };

// app.js (ESM)
import { createRequire } from 'module';
const require = createRequire(import.meta.url);
const oldModule = require('./oldModule.cjs');
```

---

## Key Differences

### 1. **Loading Time**

```javascript
// CommonJS - Runtime (Synchronous)
const math = require('./math');  // Loaded when executed

// ESM - Parse Time (Asynchronous)
import { add } from './math.js';  // Loaded before execution
```

### 2. **Dynamic Imports**

```javascript
// CommonJS - Easy
const modulePath = './math';
const math = require(modulePath);  // ✅ Works

// ESM - Use dynamic import
const modulePath = './math.js';
const math = await import(modulePath);  // ✅ Works
```

### 3. **Conditional Imports**

```javascript
// CommonJS - Simple
if (condition) {
  const math = require('./math');  // ✅ Works
}

// ESM - Use dynamic import
if (condition) {
  const math = await import('./math.js');  // ✅ Works
}

// Static imports can't be conditional
if (condition) {
  import { add } from './math.js';  // ❌ Error!
}
```

### 4. **this Context**

```javascript
// CommonJS
console.log(this === module.exports);  // true

// ESM
console.log(this);  // undefined
```

### 5. **__dirname and __filename**

```javascript
// CommonJS
console.log(__dirname);   // ✅ Available
console.log(__filename);  // ✅ Available

// ESM
console.log(__dirname);   // ❌ Not defined

// ESM equivalent:
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
```

---

## Interoperability

### Import CommonJS in ESM:

```javascript
// math.cjs (CommonJS)
module.exports = {
  add: (a, b) => a + b
};

// app.mjs (ESM)
import math from './math.cjs';
console.log(math.add(2, 3));  // ✅ Works

// Named imports don't work
import { add } from './math.cjs';  // ❌ Error!
```

### Import ESM in CommonJS:

```javascript
// math.mjs (ESM)
export const add = (a, b) => a + b;

// app.cjs (CommonJS)
(async () => {
  const math = await import('./math.mjs');
  console.log(math.add(2, 3));  // ✅ Works
})();
```

---

## When to Use Which?

### Use **CommonJS** when:
- ✅ Working with older Node.js projects
- ✅ Need synchronous loading
- ✅ Using libraries that don't support ESM
- ✅ Conditional requires

### Use **ES6 Modules** when:
- ✅ Starting new projects
- ✅ Want tree shaking (bundle optimization)
- ✅ Need static analysis
- ✅ Prefer modern syntax
- ✅ Using top-level await

---

## Migration Tips

### Gradual Migration:

```json
{
  "type": "module"
}
```

```javascript
// Convert CommonJS to ESM

// Before (CommonJS)
const express = require('express');
module.exports = app;

// After (ESM)
import express from 'express';
export default app;
```

### Handle __dirname:

```javascript
// Create helper file: dirname.js
import { fileURLToPath } from 'url';
import { dirname } from 'path';

export const __filename = fileURLToPath(import.meta.url);
export const __dirname = dirname(__filename);

// Use in other files
import { __dirname } from './dirname.js';
```

---

## Practical Examples

### Example 1: Named Exports (ESM)

```javascript
// utils.js
export const PI = 3.14159;
export function square(x) {
  return x * x;
}
export const greet = (name) => `Hello, ${name}!`;

// app.js
import { PI, square, greet } from './utils.js';
console.log(square(5));  // 25
```

### Example 2: Default + Named Exports (ESM)

```javascript
// math.js
export default class Calculator {
  add(a, b) { return a + b; }
}
export const VERSION = '1.0.0';

// app.js
import Calculator, { VERSION } from './math.js';
const calc = new Calculator();
console.log(calc.add(2, 3));  // 5
console.log(VERSION);          // 1.0.0
```

### Example 3: Dynamic Import (ESM)

```javascript
// app.js
async function loadMath() {
  const math = await import('./math.js');
  console.log(math.add(2, 3));
}

// Or with then()
import('./math.js')
  .then(math => console.log(math.add(2, 3)))
  .catch(err => console.error(err));
```

---

## Summary

- **CommonJS**: `require()`/`module.exports` - Node.js default, synchronous
- **ES6 Modules**: `import`/`export` - Modern standard, asynchronous
- Enable ESM: Use `.mjs` or `"type": "module"` in package.json
- ESM supports tree shaking and static analysis
- CommonJS easier for dynamic/conditional imports
- Both can interoperate with caveats
- Future is ESM, but CommonJS still widely used

**Next:** Learn about NPM and package management!
