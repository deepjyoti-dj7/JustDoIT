# 17. Environment Variables & dotenv

## What are Environment Variables?

**Environment variables** store configuration outside your code:
- API keys
- Database credentials
- Server ports
- Secret tokens

**Why?**
- Security (don't commit secrets to Git)
- Flexibility (different configs for dev/staging/prod)
- Easy to change without code changes

---

## Accessing Environment Variables

```javascript
// Access environment variables
console.log(process.env.NODE_ENV);
console.log(process.env.PORT);
console.log(process.env.DATABASE_URL);
```

---

## Setting Environment Variables

### Method 1: Command Line (Temporary)

```bash
# Linux/Mac
PORT=3000 node app.js
NODE_ENV=production node app.js

# Multiple variables
PORT=3000 NODE_ENV=production node app.js

# Windows (cmd)
set PORT=3000 && node app.js

# Windows (PowerShell)
$env:PORT=3000; node app.js
```

### Method 2: .env File (Recommended)

Create `.env` file:
```
PORT=3000
NODE_ENV=development
DB_HOST=localhost
DB_USER=admin
DB_PASSWORD=secret123
API_KEY=abc123xyz
```

---

## Using dotenv Package

### Installation

```bash
npm install dotenv
```

### Basic Usage

```javascript
// Load environment variables from .env file
require('dotenv').config();

// Now you can access them
const port = process.env.PORT || 3000;
const dbHost = process.env.DB_HOST;
const apiKey = process.env.API_KEY;

console.log('Port:', port);
console.log('DB Host:', dbHost);
```

### Load at App Start

```javascript
// app.js
require('dotenv').config();  // Load first!

const express = require('express');
const app = express();

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## .env File Examples

### Basic Configuration

```bash
# Server
PORT=3000
HOST=localhost

# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=myapp
DB_USER=admin
DB_PASSWORD=secret123

# API Keys
STRIPE_API_KEY=sk_test_abc123
SENDGRID_API_KEY=SG.xyz789

# Environment
NODE_ENV=development
```

### MongoDB Example

```bash
MONGO_URI=mongodb://localhost:27017/myapp
MONGO_URI_PROD=mongodb+srv://user:pass@cluster.mongodb.net/myapp
```

### JWT Example

```bash
JWT_SECRET=my-super-secret-key-12345
JWT_EXPIRE=7d
```

---

## Different Environments

Create separate files:
- `.env.development`
- `.env.production`
- `.env.test`

```javascript
// config.js
const env = process.env.NODE_ENV || 'development';
require('dotenv').config({ path: `.env.${env}` });

module.exports = {
  port: process.env.PORT,
  dbUrl: process.env.DB_URL,
  apiKey: process.env.API_KEY
};
```

---

## Using with Express

```javascript
require('dotenv').config();
const express = require('express');
const app = express();

// Use environment variables
const PORT = process.env.PORT || 3000;
const API_KEY = process.env.API_KEY;

app.get('/api/data', (req, res) => {
  // Check API key
  if (req.headers['x-api-key'] !== API_KEY) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  res.json({ message: 'Success' });
});

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## Database Configuration

```javascript
require('dotenv').config();
const mongoose = require('mongoose');

const dbConfig = {
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD
};

// MongoDB
mongoose.connect(process.env.MONGO_URI, {
  useNewUrlParser: true,
  useUnifiedTopology: true
});
```

---

## Validation & Defaults

```javascript
require('dotenv').config();

function getEnv(key, defaultValue) {
  const value = process.env[key];
  
  if (!value && !defaultValue) {
    throw new Error(`Missing environment variable: ${key}`);
  }
  
  return value || defaultValue;
}

// Usage
const PORT = getEnv('PORT', 3000);
const DB_URL = getEnv('DB_URL');  // Required, no default
const API_KEY = getEnv('API_KEY');  // Required
```

---

## Type Conversion

```javascript
require('dotenv').config();

// String to Number
const PORT = parseInt(process.env.PORT) || 3000;
const TIMEOUT = parseInt(process.env.TIMEOUT) || 5000;

// String to Boolean
const ENABLE_LOGGING = process.env.ENABLE_LOGGING === 'true';
const DEBUG = process.env.DEBUG === 'true';

// String to Array
const ALLOWED_ORIGINS = process.env.ALLOWED_ORIGINS?.split(',') || [];
// ALLOWED_ORIGINS=http://localhost:3000,http://example.com
```

---

## Config Module Pattern

```javascript
// config/index.js
require('dotenv').config();

module.exports = {
  app: {
    port: parseInt(process.env.PORT) || 3000,
    env: process.env.NODE_ENV || 'development',
    name: process.env.APP_NAME || 'MyApp'
  },
  db: {
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT) || 5432,
    name: process.env.DB_NAME || 'myapp',
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expire: process.env.JWT_EXPIRE || '7d'
  },
  api: {
    stripeKey: process.env.STRIPE_API_KEY,
    sendgridKey: process.env.SENDGRID_API_KEY
  }
};
```

Usage:
```javascript
const config = require('./config');

app.listen(config.app.port, () => {
  console.log(`${config.app.name} running on port ${config.app.port}`);
});
```

---

## .gitignore (Important!)

**Always** add `.env` to `.gitignore`:

```bash
# .gitignore
.env
.env.local
.env.*.local
node_modules/
```

Instead, commit `.env.example`:

```bash
# .env.example
PORT=3000
DB_HOST=localhost
DB_USER=
DB_PASSWORD=
API_KEY=
```

---

## Security Best Practices

✅ **Never commit .env**: Add to .gitignore  
✅ **Use strong secrets**: Long random strings  
✅ **Rotate keys regularly**: Change periodically  
✅ **Different keys per environment**: dev ≠ prod  
✅ **Limit access**: Only necessary team members  
❌ **Don't log secrets**: console.log(API_KEY)  
❌ **Don't hardcode**: Put in .env instead  

---

## Environment-Specific Logic

```javascript
require('dotenv').config();

const isDev = process.env.NODE_ENV === 'development';
const isProd = process.env.NODE_ENV === 'production';
const isTest = process.env.NODE_ENV === 'test';

// Conditional logging
if (isDev) {
  app.use(require('morgan')('dev'));
}

// Different databases
const dbUrl = isProd 
  ? process.env.MONGO_URI_PROD 
  : process.env.MONGO_URI_DEV;

// CORS
const allowedOrigins = isProd
  ? ['https://myapp.com']
  : ['http://localhost:3000'];
```

---

## Checking Required Variables

```javascript
// checkEnv.js
function checkRequiredEnvVars() {
  const required = [
    'PORT',
    'DB_HOST',
    'DB_PASSWORD',
    'JWT_SECRET',
    'API_KEY'
  ];
  
  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('Missing required environment variables:');
    missing.forEach(key => console.error(`  - ${key}`));
    process.exit(1);
  }
}

module.exports = checkRequiredEnvVars;
```

Usage:
```javascript
require('dotenv').config();
const checkRequiredEnvVars = require('./checkEnv');

checkRequiredEnvVars();  // Will exit if variables missing

// Continue with app...
```

---

## Using in package.json Scripts

```json
{
  "scripts": {
    "dev": "NODE_ENV=development nodemon app.js",
    "prod": "NODE_ENV=production node app.js",
    "test": "NODE_ENV=test jest"
  }
}
```

Cross-platform with `cross-env`:

```bash
npm install --save-dev cross-env
```

```json
{
  "scripts": {
    "dev": "cross-env NODE_ENV=development nodemon app.js",
    "prod": "cross-env NODE_ENV=production node app.js"
  }
}
```

---

## Common Variables

| Variable | Purpose | Example |
|----------|---------|---------|
| `PORT` | Server port | `3000` |
| `NODE_ENV` | Environment | `development`, `production` |
| `DB_HOST` | Database host | `localhost` |
| `DB_PORT` | Database port | `5432`, `27017` |
| `DB_NAME` | Database name | `myapp` |
| `DB_USER` | DB username | `admin` |
| `DB_PASSWORD` | DB password | `secret123` |
| `JWT_SECRET` | JWT signing key | `random-secret` |
| `API_KEY` | External API key | `abc123xyz` |

---

## Example: Complete Setup

**.env:**
```bash
PORT=3000
NODE_ENV=development
MONGO_URI=mongodb://localhost:27017/myapp
JWT_SECRET=my-secret-key-123
API_KEY=stripe_sk_test_abc123
```

**config/index.js:**
```javascript
require('dotenv').config();

module.exports = {
  port: parseInt(process.env.PORT) || 3000,
  env: process.env.NODE_ENV || 'development',
  mongoUri: process.env.MONGO_URI,
  jwtSecret: process.env.JWT_SECRET,
  apiKey: process.env.API_KEY
};
```

**app.js:**
```javascript
const config = require('./config');
const express = require('express');
const mongoose = require('mongoose');

const app = express();

// Connect to database
mongoose.connect(config.mongoUri);

// Routes
app.get('/', (req, res) => {
  res.json({ env: config.env });
});

// Start server
app.listen(config.port, () => {
  console.log(`Server running on port ${config.port}`);
});
```

---

## Summary

- **Environment variables** store configuration outside code
- **dotenv** loads variables from `.env` file
- Use `process.env.VARIABLE_NAME` to access
- **Always add .env to .gitignore**
- Create `.env.example` as template
- Use different `.env` files for different environments
- Validate required variables on startup
- Convert types (string → number, boolean)
- Never commit secrets to Git

**Next:** Learn about process and child processes!
