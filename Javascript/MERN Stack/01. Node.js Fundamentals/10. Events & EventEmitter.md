# 10. Events & EventEmitter

## What are Events?

**Events** are actions or occurrences that happen in your application. Node.js is built on an **event-driven architecture**.

```javascript
const EventEmitter = require('events');
```

---

## Basic Concept

```
┌─────────────┐       ┌──────────────┐       ┌─────────────┐
│   Event     │──────▶│ EventEmitter │──────▶│  Listeners  │
│  (Action)   │       │   (Emits)    │       │ (Functions) │
└─────────────┘       └──────────────┘       └─────────────┘
```

**Example:** User clicks button → Event fires → Functions respond

---

## Creating an EventEmitter

```javascript
const EventEmitter = require('events');

// Create instance
const myEmitter = new EventEmitter();
```

---

## Listening to Events

```javascript
const EventEmitter = require('events');
const emitter = new EventEmitter();

// Register listener
emitter.on('greet', () => {
  console.log('Hello!');
});

// Emit (trigger) the event
emitter.emit('greet');
// Output: Hello!
```

---

## Passing Arguments to Events

```javascript
const EventEmitter = require('events');
const emitter = new EventEmitter();

// Listener with parameters
emitter.on('greet', (name, age) => {
  console.log(`Hello ${name}, you are ${age} years old`);
});

// Emit with arguments
emitter.emit('greet', 'John', 30);
// Output: Hello John, you are 30 years old
```

---

## Multiple Listeners

```javascript
const emitter = new EventEmitter();

// First listener
emitter.on('data', () => {
  console.log('Listener 1');
});

// Second listener
emitter.on('data', () => {
  console.log('Listener 2');
});

// Third listener
emitter.on('data', () => {
  console.log('Listener 3');
});

emitter.emit('data');
// Output:
// Listener 1
// Listener 2
// Listener 3
```

---

## One-Time Listeners

```javascript
const emitter = new EventEmitter();

// Listen only once
emitter.once('login', (user) => {
  console.log(`${user} logged in`);
});

emitter.emit('login', 'John');  // John logged in
emitter.emit('login', 'Jane');  // (nothing happens)
```

---

## Removing Listeners

```javascript
const emitter = new EventEmitter();

function onData() {
  console.log('Data received');
}

// Add listener
emitter.on('data', onData);

emitter.emit('data');  // Data received

// Remove listener
emitter.removeListener('data', onData);
// or: emitter.off('data', onData);

emitter.emit('data');  // (nothing happens)

// Remove all listeners for an event
emitter.removeAllListeners('data');
```

---

## Custom EventEmitter Class

```javascript
const EventEmitter = require('events');

class MyEmitter extends EventEmitter {
  constructor() {
    super();
  }
  
  doSomething() {
    console.log('Doing something...');
    this.emit('done');
  }
}

const myEmitter = new MyEmitter();

myEmitter.on('done', () => {
  console.log('Task completed!');
});

myEmitter.doSomething();
// Output:
// Doing something...
// Task completed!
```

---

## Practical Examples

### Example 1: User Registration System

```javascript
const EventEmitter = require('events');

class UserManager extends EventEmitter {
  register(username, email) {
    console.log(`Registering user: ${username}`);
    
    // Emit event after registration
    this.emit('userRegistered', { username, email });
  }
}

const userManager = new UserManager();

// Email notification listener
userManager.on('userRegistered', (user) => {
  console.log(`Sending email to ${user.email}`);
});

// Database logging listener
userManager.on('userRegistered', (user) => {
  console.log(`Logging ${user.username} to database`);
});

// Analytics listener
userManager.on('userRegistered', (user) => {
  console.log(`Tracking signup: ${user.username}`);
});

// Register a user
userManager.register('john_doe', 'john@email.com');

// Output:
// Registering user: john_doe
// Sending email to john@email.com
// Logging john_doe to database
// Tracking signup: john_doe
```

### Example 2: File Upload Tracker

```javascript
const EventEmitter = require('events');

class FileUploader extends EventEmitter {
  upload(filename) {
    console.log(`Starting upload: ${filename}`);
    this.emit('uploadStart', filename);
    
    // Simulate upload progress
    setTimeout(() => {
      this.emit('uploadProgress', filename, 50);
    }, 1000);
    
    setTimeout(() => {
      this.emit('uploadProgress', filename, 100);
      this.emit('uploadComplete', filename);
    }, 2000);
  }
}

const uploader = new FileUploader();

uploader.on('uploadStart', (file) => {
  console.log(`Upload started: ${file}`);
});

uploader.on('uploadProgress', (file, percent) => {
  console.log(`${file}: ${percent}% complete`);
});

uploader.on('uploadComplete', (file) => {
  console.log(`Upload finished: ${file}`);
});

uploader.upload('document.pdf');

// Output:
// Starting upload: document.pdf
// Upload started: document.pdf
// document.pdf: 50% complete
// document.pdf: 100% complete
// Upload finished: document.pdf
```

### Example 3: Error Handling

```javascript
const EventEmitter = require('events');

class Database extends EventEmitter {
  connect() {
    // Simulate connection error
    const error = new Error('Connection failed');
    this.emit('error', error);
  }
}

const db = new Database();

// Listen for errors
db.on('error', (err) => {
  console.error('Database error:', err.message);
});

db.connect();
// Output: Database error: Connection failed
```

---

## Event Methods Summary

| Method | Description |
|--------|-------------|
| `on(event, listener)` | Add listener (can be called multiple times) |
| `once(event, listener)` | Add one-time listener |
| `emit(event, ...args)` | Trigger event with arguments |
| `removeListener(event, listener)` | Remove specific listener |
| `off(event, listener)` | Alias for removeListener |
| `removeAllListeners(event)` | Remove all listeners for event |
| `listenerCount(event)` | Get number of listeners |
| `listeners(event)` | Get array of listeners |

---

## Checking Listeners

```javascript
const emitter = new EventEmitter();

function listener1() {}
function listener2() {}

emitter.on('data', listener1);
emitter.on('data', listener2);

// Count listeners
console.log(emitter.listenerCount('data'));  // 2

// Get all listeners
console.log(emitter.listeners('data'));  // [listener1, listener2]

// Get all event names
console.log(emitter.eventNames());  // ['data']
```

---

## Listener Order

```javascript
const emitter = new EventEmitter();

emitter.on('event', () => console.log('Second'));

// Add listener at beginning
emitter.prependListener('event', () => console.log('First'));

emitter.emit('event');
// Output:
// First
// Second
```

---

## Error Events (Special)

```javascript
const emitter = new EventEmitter();

// If 'error' event has no listener, Node.js will crash!
emitter.emit('error', new Error('Something went wrong'));
// Uncaught Error: Something went wrong

// Always listen for errors ✅
emitter.on('error', (err) => {
  console.error('Error occurred:', err.message);
});

emitter.emit('error', new Error('Something went wrong'));
// Output: Error occurred: Something went wrong
```

---

## Real-World Use Cases

Node.js uses EventEmitter internally:

```javascript
// HTTP Server
const server = require('http').createServer();
server.on('request', (req, res) => { /* ... */ });

// File Streams
const fs = require('fs');
const stream = fs.createReadStream('file.txt');
stream.on('data', (chunk) => { /* ... */ });
stream.on('end', () => { /* ... */ });

// Process
process.on('exit', () => { /* cleanup */ });
```

---

## Max Listeners Warning

```javascript
const emitter = new EventEmitter();

// Default max is 10
for (let i = 0; i < 15; i++) {
  emitter.on('event', () => {});
}
// Warning: Possible EventEmitter memory leak detected

// Increase limit
emitter.setMaxListeners(20);

// Unlimited
emitter.setMaxListeners(0);
```

---

## Best Practices

✅ **Always handle errors**: Listen to `error` event  
✅ **Use descriptive names**: `userRegistered` not `event1`  
✅ **Clean up listeners**: Remove when no longer needed  
✅ **Use once()**: For one-time events  
✅ **Extend EventEmitter**: For custom event-based classes  
❌ **Don't ignore max listener warnings**: Might be a memory leak  

---

## Common Patterns

### Observer Pattern
```javascript
// One emitter, multiple observers
emitter.on('update', observerA);
emitter.on('update', observerB);
emitter.on('update', observerC);
```

### Pub/Sub Pattern
```javascript
// Publisher emits, subscribers listen
publisher.emit('news', article);
subscriber1.on('news', handleNews);
subscriber2.on('news', handleNews);
```

---

## Summary

- **EventEmitter** enables event-driven programming
- `on()` adds listeners, `emit()` triggers events
- `once()` for one-time listeners
- Multiple listeners can respond to same event
- Always handle `error` events to prevent crashes
- Use `extends EventEmitter` for custom classes
- Remove listeners to prevent memory leaks

**Next:** Learn about Streams and Buffers!
