# 16. Debugging Node.js Apps

## Why Debugging?

Find and fix errors in your code:
- Logical errors
- Runtime errors
- Performance issues
- Unexpected behavior

---

## console.log() (Basic)

Simplest debugging method:

```javascript
function calculateTotal(price, tax) {
  console.log('Price:', price);  // Check input
  console.log('Tax:', tax);
  
  const total = price + (price * tax);
  console.log('Total:', total);  // Check output
  
  return total;
}

calculateTotal(100, 0.15);
// Output:
// Price: 100
// Tax: 0.15
// Total: 115
```

---

## Console Methods

```javascript
// Basic log
console.log('Hello');

// Error (red in terminal)
console.error('Error occurred!');

// Warning (yellow)
console.warn('Warning: deprecated function');

// Info
console.info('Server started on port 3000');

// Table (for arrays/objects)
const users = [
  { id: 1, name: 'John' },
  { id: 2, name: 'Jane' }
];
console.table(users);

// Time measurement
console.time('operation');
// ... code to measure
console.timeEnd('operation');  // operation: 123.456ms

// Group logs
console.group('User Details');
console.log('Name: John');
console.log('Age: 30');
console.groupEnd();

// Clear console
console.clear();
```

---

## Node.js Debugger

### Using debugger Statement

```javascript
function calculateDiscount(price, discount) {
  debugger;  // Execution pauses here
  
  const total = price - (price * discount);
  return total;
}

calculateDiscount(100, 0.2);
```

Run with:
```bash
node inspect app.js
```

Commands:
- `c` - Continue
- `n` - Next line
- `s` - Step into function
- `o` - Step out
- `repl` - Inspect variables

---

## Chrome DevTools (Best)

### Method 1: --inspect Flag

```bash
node --inspect app.js
```

Then open Chrome:
```
chrome://inspect
```

Click "inspect" to open DevTools.

### Method 2: --inspect-brk (Pause at Start)

```bash
node --inspect-brk app.js
```

Pauses execution at first line.

---

## VS Code Debugging

### Simple Method (F5)

1. Open file in VS Code
2. Press **F5**
3. Select "Node.js"
4. Debugging starts!

### With Breakpoints

```javascript
function processData(data) {
  const result = data.map(item => {
    // Click left of line number to add breakpoint
    return item * 2;
  });
  return result;
}
```

1. Click left margin (red dot appears)
2. Press **F5**
3. Execution pauses at breakpoint
4. Inspect variables, step through code

### Debug Configuration (launch.json)

Create `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Program",
      "program": "${workspaceFolder}/app.js",
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

---

## Debugging Express Apps

```javascript
const express = require('express');
const app = express();

app.get('/users/:id', (req, res) => {
  debugger;  // Pause here
  
  const userId = req.params.id;
  console.log('User ID:', userId);
  
  res.json({ id: userId, name: 'John' });
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

Run with:
```bash
node --inspect app.js
```

Make request:
```bash
curl http://localhost:3000/users/1
```

---

## Debugging Async Code

```javascript
async function fetchUsers() {
  try {
    debugger;  // Pause here
    
    const response = await fetch('https://api.example.com/users');
    const users = await response.json();
    
    console.log('Users:', users);
    return users;
    
  } catch (err) {
    console.error('Error:', err);
  }
}

fetchUsers();
```

---

## Error Stack Traces

```javascript
function level3() {
  throw new Error('Something went wrong');
}

function level2() {
  level3();
}

function level1() {
  level2();
}

try {
  level1();
} catch (err) {
  console.error(err.stack);
}

// Output:
// Error: Something went wrong
//     at level3 (app.js:2:9)
//     at level2 (app.js:6:3)
//     at level1 (app.js:10:3)
```

---

## util.inspect() (Pretty Print)

```javascript
const util = require('util');

const obj = {
  name: 'John',
  age: 30,
  address: {
    city: 'New York',
    country: 'USA'
  }
};

// Default (may truncate)
console.log(obj);

// Full depth
console.log(util.inspect(obj, { depth: null, colors: true }));
```

---

## Debugging with nodemon

Auto-restart on file changes:

```bash
npm install -g nodemon

# Run with debugger
nodemon --inspect app.js

# With breakpoint at start
nodemon --inspect-brk app.js
```

---

## Common Debugging Scenarios

### 1. Variable Values

```javascript
function calculateTotal(items) {
  console.log('Items:', items);  // Check input
  
  let total = 0;
  items.forEach(item => {
    console.log('Processing:', item);  // Check each item
    total += item.price;
  });
  
  console.log('Final total:', total);  // Check output
  return total;
}
```

### 2. Function Execution

```javascript
function processOrder(order) {
  console.log('>>> processOrder called');
  console.log('Order:', order);
  
  // ... processing
  
  console.log('<<< processOrder done');
}
```

### 3. Conditional Logic

```javascript
function checkAge(age) {
  console.log('Age received:', age, typeof age);
  
  if (age >= 18) {
    console.log('Branch: Adult');
    return 'Adult';
  } else {
    console.log('Branch: Minor');
    return 'Minor';
  }
}
```

---

## Environment-Based Debugging

```javascript
// debug.js
const debug = process.env.DEBUG === 'true';

function log(...args) {
  if (debug) {
    console.log('[DEBUG]', ...args);
  }
}

// Usage
log('User logged in:', user);  // Only logs if DEBUG=true

module.exports = { log };
```

Run with:
```bash
DEBUG=true node app.js
```

---

## Using debug Package

```bash
npm install debug
```

```javascript
const debug = require('debug');

const dbDebug = debug('app:db');
const serverDebug = debug('app:server');

dbDebug('Connected to database');
serverDebug('Server started on port 3000');
```

Run with:
```bash
# Enable all debugging
DEBUG=* node app.js

# Enable specific namespace
DEBUG=app:db node app.js

# Enable multiple namespaces
DEBUG=app:db,app:server node app.js
```

---

## Memory Leaks

### Heap Snapshot

```bash
node --inspect app.js
```

In Chrome DevTools:
1. Go to "Memory" tab
2. Take heap snapshot
3. Perform actions
4. Take another snapshot
5. Compare snapshots

### Memory Usage

```javascript
function checkMemory() {
  const used = process.memoryUsage();
  console.log('Memory Usage:');
  console.log('RSS:', Math.round(used.rss / 1024 / 1024), 'MB');
  console.log('Heap Total:', Math.round(used.heapTotal / 1024 / 1024), 'MB');
  console.log('Heap Used:', Math.round(used.heapUsed / 1024 / 1024), 'MB');
}

setInterval(checkMemory, 5000);  // Check every 5 seconds
```

---

## Performance Profiling

```bash
node --prof app.js
# Generates isolate-*.log

# Process the log
node --prof-process isolate-*.log > processed.txt
```

---

## Debug Shortcuts (VS Code)

| Key | Action |
|-----|--------|
| **F5** | Start debugging |
| **F9** | Toggle breakpoint |
| **F10** | Step over |
| **F11** | Step into |
| **Shift+F11** | Step out |
| **F5** (during debug) | Continue |
| **Shift+F5** | Stop debugging |

---

## Conditional Breakpoints

In VS Code:
1. Right-click breakpoint
2. Select "Edit Breakpoint"
3. Add condition: `userId === '123'`

Pauses only when condition is true.

---

## Logpoints (VS Code)

Non-breaking logs:

1. Right-click line number
2. Select "Add Logpoint"
3. Enter: `User: {userId}`

Logs without pausing execution.

---

## Best Practices

✅ **Use descriptive logs**: Include context  
✅ **Remove console.logs**: Before production  
✅ **Use debugger in development**: Faster than logs  
✅ **Check error stacks**: Shows exact error location  
✅ **Use environment flags**: Toggle debug mode  
✅ **Profile performance**: Find bottlenecks  
❌ **Don't leave debugger statements**: In production  
❌ **Don't rely only on logs**: Use proper debugger  

---

## Quick Debug Checklist

1. ✅ Check console for errors
2. ✅ Add console.log() to trace execution
3. ✅ Use debugger statement
4. ✅ Check variable values
5. ✅ Verify function arguments
6. ✅ Test edge cases
7. ✅ Check async/await errors
8. ✅ Review error stack trace

---

## Summary

- **console.log()** - Quick and simple debugging
- **debugger** statement - Pauses execution
- **--inspect** flag - Chrome DevTools debugging
- **VS Code** - Best debugging experience (F5, breakpoints)
- **console methods** - table, time, group, error
- **Stack traces** - Show error location
- **debug package** - Conditional logging
- Use **breakpoints** instead of excessive logs

**Next:** Learn about environment variables!
