# 13. Frontend Auth (Context & Private Routes)

## Introduction

Frontend authentication involves managing user state, protecting routes, and handling authentication flows in React applications. This guide covers implementing robust authentication using Context API and React Router.

---

## Auth Context Setup

### Create Auth Context

```javascript
// context/AuthContext.js
import { createContext, useState, useEffect, useContext } from 'react';
import axios from 'axios';

const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // Check if user is logged in on mount
  useEffect(() => {
    const checkAuth = async () => {
      const token = localStorage.getItem('token');
      
      if (!token) {
        setLoading(false);
        return;
      }
      
      try {
        const { data } = await axios.get('/api/auth/me', {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        setUser(data.user);
      } catch (err) {
        localStorage.removeItem('token');
      } finally {
        setLoading(false);
      }
    };
    
    checkAuth();
  }, []);
  
  // Login function
  const login = async (email, password) => {
    try {
      setError(null);
      const { data } = await axios.post('/api/auth/login', { email, password });
      
      localStorage.setItem('token', data.token);
      setUser(data.user);
      
      return { success: true };
    } catch (err) {
      const message = err.response?.data?.message || 'Login failed';
      setError(message);
      return { success: false, error: message };
    }
  };
  
  // Register function
  const register = async (name, email, password) => {
    try {
      setError(null);
      const { data } = await axios.post('/api/auth/register', { name, email, password });
      
      localStorage.setItem('token', data.token);
      setUser(data.user);
      
      return { success: true };
    } catch (err) {
      const message = err.response?.data?.message || 'Registration failed';
      setError(message);
      return { success: false, error: message };
    }
  };
  
  // Logout function
  const logout = () => {
    localStorage.removeItem('token');
    setUser(null);
  };
  
  // Update user
  const updateUser = (updatedUser) => {
    setUser(updatedUser);
  };
  
  const value = {
    user,
    loading,
    error,
    login,
    register,
    logout,
    updateUser,
    isAuthenticated: !!user
  };
  
  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};

// Custom hook to use auth context
export const useAuth = () => {
  const context = useContext(AuthContext);
  
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  
  return context;
};
```

### Wrap App with Provider

```javascript
// App.js or index.js
import { AuthProvider } from './context/AuthContext';
import { BrowserRouter } from 'react-router-dom';
import Routes from './Routes';

function App() {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Routes />
      </BrowserRouter>
    </AuthProvider>
  );
}

export default App;
```

---

## Using Auth Context

### Login Component

```javascript
// pages/Login.jsx
import { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const Login = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  
  const { login } = useAuth();
  const navigate = useNavigate();
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    const result = await login(email, password);
    
    if (result.success) {
      navigate('/dashboard');
    } else {
      setError(result.error);
    }
    
    setLoading(false);
  };
  
  return (
    <div className="login-container">
      <h2>Login</h2>
      
      {error && <div className="error-message">{error}</div>}
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label>Email</label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
        </div>
        
        <div className="form-group">
          <label>Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
        </div>
        
        <button type="submit" disabled={loading}>
          {loading ? 'Logging in...' : 'Login'}
        </button>
      </form>
      
      <p>
        Don't have an account? <Link to="/register">Register</Link>
      </p>
    </div>
  );
};

export default Login;
```

### Dashboard Component

```javascript
// pages/Dashboard.jsx
import { useAuth } from '../context/AuthContext';

const Dashboard = () => {
  const { user, logout } = useAuth();
  
  return (
    <div className="dashboard">
      <h1>Welcome, {user?.name}!</h1>
      <p>Email: {user?.email}</p>
      <p>Role: {user?.role}</p>
      
      <button onClick={logout}>Logout</button>
    </div>
  );
};

export default Dashboard;
```

---

## Private Routes

### PrivateRoute Component

```javascript
// components/PrivateRoute.jsx
import { Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const PrivateRoute = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();
  
  if (loading) {
    return <div>Loading...</div>;
  }
  
  return isAuthenticated ? children : <Navigate to="/login" />;
};

export default PrivateRoute;
```

### Role-Based Route

```javascript
// components/RoleRoute.jsx
import { Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const RoleRoute = ({ children, allowedRoles }) => {
  const { user, loading, isAuthenticated } = useAuth();
  
  if (loading) {
    return <div>Loading...</div>;
  }
  
  if (!isAuthenticated) {
    return <Navigate to="/login" />;
  }
  
  if (!allowedRoles.includes(user.role)) {
    return <Navigate to="/unauthorized" />;
  }
  
  return children;
};

export default RoleRoute;
```

### Routes Configuration

```javascript
// Routes.jsx
import { Routes, Route, Navigate } from 'react-router-dom';
import { useAuth } from './context/AuthContext';

import Login from './pages/Login';
import Register from './pages/Register';
import Dashboard from './pages/Dashboard';
import Profile from './pages/Profile';
import AdminPanel from './pages/AdminPanel';
import Unauthorized from './pages/Unauthorized';

import PrivateRoute from './components/PrivateRoute';
import RoleRoute from './components/RoleRoute';

const AppRoutes = () => {
  const { isAuthenticated } = useAuth();
  
  return (
    <Routes>
      {/* Public routes */}
      <Route 
        path="/login" 
        element={isAuthenticated ? <Navigate to="/dashboard" /> : <Login />} 
      />
      <Route 
        path="/register" 
        element={isAuthenticated ? <Navigate to="/dashboard" /> : <Register />} 
      />
      
      {/* Private routes */}
      <Route 
        path="/dashboard" 
        element={
          <PrivateRoute>
            <Dashboard />
          </PrivateRoute>
        } 
      />
      
      <Route 
        path="/profile" 
        element={
          <PrivateRoute>
            <Profile />
          </PrivateRoute>
        } 
      />
      
      {/* Admin only routes */}
      <Route 
        path="/admin" 
        element={
          <RoleRoute allowedRoles={['admin']}>
            <AdminPanel />
          </RoleRoute>
        } 
      />
      
      {/* Catch all */}
      <Route path="/unauthorized" element={<Unauthorized />} />
      <Route path="/" element={<Navigate to="/dashboard" />} />
      <Route path="*" element={<div>404 Not Found</div>} />
    </Routes>
  );
};

export default AppRoutes;
```

---

## Axios Interceptor

Automatically add token to requests and handle auth errors.

```javascript
// utils/axios.js
import axios from 'axios';

const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL || 'http://localhost:5000/api'
});

// Request interceptor: Add token to all requests
api.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('token');
    
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Response interceptor: Handle auth errors
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Token expired or invalid
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    
    return Promise.reject(error);
  }
);

export default api;
```

### Usage

```javascript
// Use this api instance instead of axios
import api from '../utils/axios';

// No need to manually add Authorization header
const { data } = await api.get('/auth/me');
const { data } = await api.put('/users/profile', { name: 'New Name' });
```

---

## Persistent Authentication

### Auto-Refresh Token

```javascript
// context/AuthContext.js (enhanced)
import { createContext, useState, useEffect } from 'react';
import api from '../utils/axios';

export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // Check auth on mount and refresh
  useEffect(() => {
    const checkAuth = async () => {
      const token = localStorage.getItem('token');
      
      if (!token) {
        setLoading(false);
        return;
      }
      
      try {
        const { data } = await api.get('/auth/me');
        setUser(data.user);
      } catch (err) {
        localStorage.removeItem('token');
      } finally {
        setLoading(false);
      }
    };
    
    checkAuth();
    
    // Refresh user data every 5 minutes
    const interval = setInterval(checkAuth, 5 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, []);
  
  // Rest of the code...
};
```

---

## Loading States

### Loading Component

```javascript
// components/Loading.jsx
const Loading = () => {
  return (
    <div className="loading-container">
      <div className="spinner"></div>
      <p>Loading...</p>
    </div>
  );
};

export default Loading;
```

### Auth Loading Wrapper

```javascript
// App.js
import { useAuth } from './context/AuthContext';
import Loading from './components/Loading';
import Routes from './Routes';

function App() {
  const { loading } = useAuth();
  
  if (loading) {
    return <Loading />;
  }
  
  return <Routes />;
}

export default App;
```

---

## Conditional Rendering

### Show/Hide Based on Auth

```javascript
// components/Navbar.jsx
import { Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const Navbar = () => {
  const { isAuthenticated, user, logout } = useAuth();
  
  return (
    <nav>
      <Link to="/">Home</Link>
      
      {isAuthenticated ? (
        <>
          <Link to="/dashboard">Dashboard</Link>
          <Link to="/profile">Profile</Link>
          
          {user.role === 'admin' && (
            <Link to="/admin">Admin</Link>
          )}
          
          <button onClick={logout}>Logout</button>
          <span>Welcome, {user.name}</span>
        </>
      ) : (
        <>
          <Link to="/login">Login</Link>
          <Link to="/register">Register</Link>
        </>
      )}
    </nav>
  );
};

export default Navbar;
```

---

## Custom Hooks

### useRequireAuth Hook

```javascript
// hooks/useRequireAuth.js
import { useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

export const useRequireAuth = () => {
  const { isAuthenticated, loading } = useAuth();
  const navigate = useNavigate();
  
  useEffect(() => {
    if (!loading && !isAuthenticated) {
      navigate('/login');
    }
  }, [isAuthenticated, loading, navigate]);
  
  return { isAuthenticated, loading };
};
```

### Usage

```javascript
import { useRequireAuth } from '../hooks/useRequireAuth';

const Profile = () => {
  const { loading } = useRequireAuth();
  
  if (loading) {
    return <div>Loading...</div>;
  }
  
  return <div>Profile Page</div>;
};
```

---

## Interview Questions

**Q1: How do you implement authentication in React?**
- Use Context API to manage auth state globally
- Store JWT token in localStorage
- Create login/logout functions in AuthContext
- Protect routes with PrivateRoute component

**Q2: What's the difference between authentication and route protection?**
- **Authentication**: Verifying user identity (login/register)
- **Route Protection**: Restricting access to routes based on auth status

**Q3: Where should you store JWT tokens in React?**
- **localStorage**: Persists across sessions, accessible to JavaScript
- **sessionStorage**: Cleared when tab closes
- **Memory**: Most secure but lost on refresh
- **HttpOnly cookies**: Sent automatically, not accessible to JavaScript

**Q4: How do you protect routes in React Router v6?**
- Create PrivateRoute component
- Check authentication status
- Redirect to login if not authenticated
- Wrap protected routes with PrivateRoute

**Q5: How do you handle token expiration on frontend?**
- Axios interceptor catches 401 errors
- Clear token from storage
- Redirect to login page
- Optionally implement token refresh

**Q6: What's the purpose of axios interceptors?**
- Automatically add token to requests
- Handle auth errors globally
- Refresh tokens automatically
- Transform request/response data

---

## Best Practices

1. **Use Context API** for global auth state
2. **Protect sensitive routes** with PrivateRoute
3. **Show loading states** during auth checks
4. **Redirect after login/logout** to appropriate pages
5. **Clear tokens on logout** and 401 errors
6. **Use axios interceptors** for automatic token handling
7. **Implement role-based routes** for authorization
8. **Handle errors gracefully** with user-friendly messages
9. **Persist auth state** across page refreshes
10. **Validate tokens** on critical actions

---

## Summary

- Use **Context API** to manage authentication state
- Create **AuthProvider** with login/register/logout functions
- Implement **PrivateRoute** to protect routes
- Use **RoleRoute** for role-based access control
- **Axios interceptors** add token automatically
- Store token in **localStorage** for persistence
- Check authentication on **app mount**
- Show **loading states** during auth checks
- Redirect on **login/logout**
- Handle **401 errors** globally with interceptors
