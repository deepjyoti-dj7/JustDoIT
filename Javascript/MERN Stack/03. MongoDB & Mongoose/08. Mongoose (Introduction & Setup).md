# 08. Mongoose (Introduction & Setup)

## What is Mongoose?

Mongoose is an **ODM (Object Data Modeling)** library for MongoDB and Node.js.

**Why Mongoose?**
- ✅ Schema validation
- ✅ Type casting
- ✅ Query building
- ✅ Business logic (middleware)
- ✅ Easier than native MongoDB driver

---

## Mongoose vs MongoDB Driver

| Feature | MongoDB Driver | Mongoose |
|---------|----------------|----------|
| **Schema** | No | Yes |
| **Validation** | Manual | Built-in |
| **Type Casting** | No | Yes |
| **Middleware** | No | Yes |
| **Syntax** | Verbose | Clean |

---

## Installation

```bash
npm install mongoose
```

---

## Basic Setup

**app.js:**

```javascript
const mongoose = require('mongoose');

// Connect to MongoDB
mongoose.connect('mongodb://localhost:27017/mydb')
  .then(() => console.log('✅ Connected to MongoDB'))
  .catch(err => console.error('❌ Connection error:', err));
```

---

## Connection Options

### Local Connection

```javascript
const mongoose = require('mongoose');

mongoose.connect('mongodb://localhost:27017/mydb', {
  useNewUrlParser: true,
  useUnifiedTopology: true
});
```

### MongoDB Atlas

```javascript
const uri = 'mongodb+srv://username:password@cluster.mongodb.net/mydb?retryWrites=true&w=majority';

mongoose.connect(uri)
  .then(() => console.log('Connected to Atlas'))
  .catch(err => console.error(err));
```

### Using Environment Variables

```bash
npm install dotenv
```

**.env:**

```
MONGO_URI=mongodb://localhost:27017/mydb
```

**app.js:**

```javascript
require('dotenv').config();
const mongoose = require('mongoose');

mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log('Connected'))
  .catch(err => console.error(err));
```

---

## Connection Events

```javascript
const mongoose = require('mongoose');

mongoose.connect('mongodb://localhost:27017/mydb');

const db = mongoose.connection;

db.on('error', (err) => {
  console.error('Connection error:', err);
});

db.once('open', () => {
  console.log('✅ Connected to MongoDB');
});

db.on('disconnected', () => {
  console.log('❌ Disconnected from MongoDB');
});
```

---

## Complete Setup Example

**db.js:**

```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGO_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true
    });
    console.log('✅ MongoDB connected');
  } catch (err) {
    console.error('❌ MongoDB connection failed:', err.message);
    process.exit(1);
  }
};

module.exports = connectDB;
```

**app.js:**

```javascript
require('dotenv').config();
const express = require('express');
const connectDB = require('./db');

const app = express();

// Connect to database
connectDB();

app.use(express.json());

app.get('/', (req, res) => {
  res.send('Server running');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## Define Schema & Model

### Create User Schema

**models/User.js:**

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: true,
    unique: true
  },
  age: {
    type: Number,
    min: 0
  }
}, { timestamps: true });

module.exports = mongoose.model('User', userSchema);
```

### Use the Model

```javascript
const User = require('./models/User');

// Create user
const createUser = async () => {
  const user = new User({
    name: 'John Doe',
    email: 'john@example.com',
    age: 30
  });
  
  await user.save();
  console.log('User created:', user);
};

createUser();
```

---

## Quick Start Guide

**Step 1: Install**

```bash
npm install mongoose dotenv
```

**Step 2: Create .env**

```
MONGO_URI=mongodb://localhost:27017/mydb
```

**Step 3: Connect (db.js)**

```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  await mongoose.connect(process.env.MONGO_URI);
  console.log('Connected');
};

module.exports = connectDB;
```

**Step 4: Create Model (models/User.js)**

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: String,
  email: { type: String, unique: true },
  age: Number
});

module.exports = mongoose.model('User', userSchema);
```

**Step 5: Use in app.js**

```javascript
require('dotenv').config();
const connectDB = require('./db');
const User = require('./models/User');

connectDB();

// Create user
const newUser = new User({
  name: 'John',
  email: 'john@example.com',
  age: 30
});

newUser.save()
  .then(user => console.log('User created:', user))
  .catch(err => console.error(err));
```

---

## Mongoose Features

### 1. Schema Validation

```javascript
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Name is required'],
    minlength: 3,
    maxlength: 50
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true
  },
  age: {
    type: Number,
    min: 0,
    max: 120
  }
});
```

### 2. Default Values

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  status: {
    type: String,
    default: 'active'
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});
```

### 3. Timestamps

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  email: String
}, { timestamps: true });

// Automatically adds createdAt and updatedAt
```

---

## Connection Best Practices

✅ **Use environment variables**: Never hardcode connection strings  
✅ **Handle errors**: Use try-catch or .catch()  
✅ **Close connections**: On app shutdown  
✅ **Connection pooling**: Mongoose handles automatically  
❌ **Don't commit .env**: Add to .gitignore  

---

## Summary

**Mongoose:**
- ODM for MongoDB
- Schema validation
- Type casting
- Middleware support

**Installation:**
```bash
npm install mongoose
```

**Connection:**
```javascript
const mongoose = require('mongoose');
await mongoose.connect('mongodb://localhost:27017/mydb');
```

**Schema & Model:**
```javascript
const schema = new mongoose.Schema({ name: String });
const Model = mongoose.model('Model', schema);
```

**Next**: Learn Mongoose Schemas, Types & Models!
