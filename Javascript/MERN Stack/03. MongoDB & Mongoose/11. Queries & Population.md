# 11. Queries & Population

## Advanced Query Methods

### exists()

Check if field exists:

```javascript
// Find users with email field
const users = await User.find({ email: { $exists: true } });

// Find users without age field
const users = await User.find({ age: { $exists: false } });
```

### where()

Chain query conditions:

```javascript
const users = await User
  .where('age').gte(25).lte(65)
  .where('isActive').equals(true)
  .select('name email');
```

### or()

```javascript
const users = await User
  .find()
  .or([{ age: { $lt: 25 } }, { age: { $gt: 60 } }]);
```

### distinct()

Get unique values:

```javascript
const cities = await User.distinct('city');
console.log(cities);  // ['NYC', 'LA', 'Chicago']
```

---

## Population (References)

### What is Population?

Replacing references with actual documents (like SQL JOIN).

**Setup:**

```javascript
// Post schema with user reference
const postSchema = new mongoose.Schema({
  title: String,
  content: String,
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }
});

const Post = mongoose.model('Post', postSchema);
```

### Basic Population

```javascript
// Without populate
const post = await Post.findById(postId);
console.log(post.author);  // ObjectId('507f1f77bcf86cd799439011')

// With populate
const post = await Post.findById(postId).populate('author');
console.log(post.author);  // { _id: '...', name: 'John', email: '...' }
```

### Select Specific Fields

```javascript
const post = await Post
  .findById(postId)
  .populate('author', 'name email');  // Only name and email
```

### Multiple Populations

```javascript
const postSchema = new mongoose.Schema({
  title: String,
  author: { type: ObjectId, ref: 'User' },
  category: { type: ObjectId, ref: 'Category' },
  tags: [{ type: ObjectId, ref: 'Tag' }]
});

// Populate multiple fields
const post = await Post
  .findById(postId)
  .populate('author', 'name')
  .populate('category', 'name')
  .populate('tags', 'name');
```

### Nested Population

```javascript
const post = await Post
  .findById(postId)
  .populate({
    path: 'author',
    populate: {
      path: 'friends',
      select: 'name'
    }
  });
```

### Populate Array of References

```javascript
// User schema
const userSchema = new mongoose.Schema({
  name: String,
  friends: [{ type: ObjectId, ref: 'User' }]
});

// Populate friends
const user = await User.findById(userId).populate('friends', 'name email');
```

---

## Query Conditions with Populate

```javascript
const posts = await Post
  .find({ status: 'published' })
  .populate({
    path: 'author',
    match: { isActive: true },  // Only active authors
    select: 'name email'
  });
```

---

## Pagination with Population

```javascript
const page = 2;
const limit = 10;

const posts = await Post
  .find()
  .populate('author', 'name')
  .skip((page - 1) * limit)
  .limit(limit)
  .sort('-createdAt');
```

---

## Practical Example

**models/User.js:**

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  email: String
});

module.exports = mongoose.model('User', userSchema);
```

**models/Post.js:**

```javascript
const postSchema = new mongoose.Schema({
  title: String,
  content: String,
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  comments: [{
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
    text: String,
    createdAt: { type: Date, default: Date.now }
  }]
}, { timestamps: true });

module.exports = mongoose.model('Post', postSchema);
```

**Usage:**

```javascript
const Post = require('./models/Post');

// Get post with author and comments populated
const post = await Post
  .findById(postId)
  .populate('author', 'name email')
  .populate('comments.user', 'name');

console.log(post.author.name);  // 'John Doe'
console.log(post.comments[0].user.name);  // 'Jane Smith'
```

---

## Virtual Populate

Populate without storing references:

```javascript
// User schema
const userSchema = new mongoose.Schema({
  name: String,
  email: String
});

userSchema.virtual('posts', {
  ref: 'Post',
  localField: '_id',
  foreignField: 'author'
});

module.exports = mongoose.model('User', userSchema);
```

**Usage:**

```javascript
const user = await User
  .findById(userId)
  .populate('posts');

console.log(user.posts);  // All posts by this user
```

---

## Query Helpers

Custom query methods:

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  isActive: Boolean,
  age: Number
});

// Define query helper
userSchema.query.active = function() {
  return this.where({ isActive: true });
};

userSchema.query.byAge = function(min, max) {
  return this.where('age').gte(min).lte(max);
};

const User = mongoose.model('User', userSchema);

// Usage
const users = await User.find().active().byAge(25, 65);
```

---

## Best Practices

✅ **Select only needed fields**: Reduce data transfer  
✅ **Use indexes**: On referenced fields  
✅ **Limit populated data**: Don't populate everything  
✅ **Use lean()**: For read-only data (faster)  
❌ **Don't over-populate**: Can slow queries  
❌ **Don't populate in loops**: Use single query  

---

## Summary

**Advanced Queries:**
```javascript
await User.where('age').gte(25).lte(65);
await User.distinct('city');
```

**Population:**
```javascript
// Basic
await Post.findById(id).populate('author');

// Select fields
await Post.findById(id).populate('author', 'name email');

// Multiple
await Post
  .findById(id)
  .populate('author')
  .populate('category');

// Nested
await Post.findById(id).populate({
  path: 'author',
  populate: { path: 'friends' }
});
```

**Pattern:**
- Define ref in schema
- Use populate() to replace ObjectId with document
- Select only needed fields

**Next**: Learn Virtuals, Methods & Middleware!
