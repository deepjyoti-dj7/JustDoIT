# 07. Aggregation Framework

## What is Aggregation?

Process documents and return computed results (like SQL GROUP BY).

**Use cases:**
- Calculate totals, averages, counts
- Group data
- Filter and transform
- Data analysis

---

## Pipeline Concept

Data flows through stages:

```javascript
db.collection.aggregate([
  { stage1 },
  { stage2 },
  { stage3 }
]);
```

---

## Common Stages

### $match - Filter Documents

```javascript
db.orders.aggregate([
  { $match: { status: "completed" } }
]);

// Like: db.orders.find({ status: "completed" })
```

### $group - Group Documents

```javascript
// Count users by city
db.users.aggregate([
  {
    $group: {
      _id: "$city",
      count: { $sum: 1 }
    }
  }
]);

// Output:
// { _id: "NYC", count: 100 }
// { _id: "LA", count: 50 }
```

### $project - Select/Transform Fields

```javascript
db.users.aggregate([
  {
    $project: {
      name: 1,
      age: 1,
      _id: 0
    }
  }
]);
```

### $sort - Sort Results

```javascript
db.users.aggregate([
  { $sort: { age: -1 } }  // -1 = descending
]);
```

### $limit - Limit Results

```javascript
db.users.aggregate([
  { $limit: 5 }
]);
```

### $skip - Skip Documents

```javascript
db.users.aggregate([
  { $skip: 10 },
  { $limit: 5 }
]);
```

---

## Aggregation Operators

### Arithmetic

```javascript
db.products.aggregate([
  {
    $project: {
      name: 1,
      total: { $multiply: ["$price", "$quantity"] },
      discounted: { $subtract: ["$price", 10] }
    }
  }
]);
```

### Accumulators (in $group)

```javascript
db.orders.aggregate([
  {
    $group: {
      _id: "$customerId",
      totalAmount: { $sum: "$amount" },
      avgAmount: { $avg: "$amount" },
      maxAmount: { $max: "$amount" },
      minAmount: { $min: "$amount" },
      orderCount: { $sum: 1 }
    }
  }
]);
```

---

## Practical Examples

### Example 1: Total Sales by Product

```javascript
db.orders.aggregate([
  {
    $group: {
      _id: "$productId",
      totalSales: { $sum: "$amount" },
      orderCount: { $sum: 1 }
    }
  },
  { $sort: { totalSales: -1 } },
  { $limit: 10 }
]);
```

### Example 2: Average Age by City

```javascript
db.users.aggregate([
  {
    $group: {
      _id: "$city",
      avgAge: { $avg: "$age" },
      count: { $sum: 1 }
    }
  },
  { $sort: { avgAge: -1 } }
]);
```

### Example 3: Monthly Revenue

```javascript
db.orders.aggregate([
  {
    $match: { status: "completed" }
  },
  {
    $group: {
      _id: {
        year: { $year: "$date" },
        month: { $month: "$date" }
      },
      revenue: { $sum: "$amount" },
      orders: { $sum: 1 }
    }
  },
  { $sort: { "_id.year": -1, "_id.month": -1 } }
]);
```

### Example 4: Top 5 Customers

```javascript
db.orders.aggregate([
  {
    $group: {
      _id: "$customerId",
      totalSpent: { $sum: "$amount" },
      orderCount: { $sum: 1 }
    }
  },
  { $sort: { totalSpent: -1 } },
  { $limit: 5 }
]);
```

---

## $lookup - Join Collections

```javascript
// Orders with customer info
db.orders.aggregate([
  {
    $lookup: {
      from: "customers",
      localField: "customerId",
      foreignField: "_id",
      as: "customerInfo"
    }
  }
]);

// Output:
// {
//   _id: 1,
//   customerId: "C1",
//   amount: 100,
//   customerInfo: [{ _id: "C1", name: "John" }]
// }
```

---

## $unwind - Deconstruct Arrays

```javascript
// Document:
// { _id: 1, name: "John", hobbies: ["reading", "gaming"] }

db.users.aggregate([
  { $unwind: "$hobbies" }
]);

// Output:
// { _id: 1, name: "John", hobbies: "reading" }
// { _id: 1, name: "John", hobbies: "gaming" }
```

**Use case - Count hobbies:**

```javascript
db.users.aggregate([
  { $unwind: "$hobbies" },
  {
    $group: {
      _id: "$hobbies",
      count: { $sum: 1 }
    }
  },
  { $sort: { count: -1 } }
]);
```

---

## $addFields - Add Computed Fields

```javascript
db.products.aggregate([
  {
    $addFields: {
      total: { $multiply: ["$price", "$quantity"] },
      inStock: { $gte: ["$quantity", 1] }
    }
  }
]);
```

---

## Complex Pipeline Example

**Task:** Top 3 cities with highest average order value for completed orders

```javascript
db.orders.aggregate([
  // Stage 1: Filter completed orders
  { $match: { status: "completed" } },
  
  // Stage 2: Join with customers
  {
    $lookup: {
      from: "customers",
      localField: "customerId",
      foreignField: "_id",
      as: "customer"
    }
  },
  
  // Stage 3: Unwind customer array
  { $unwind: "$customer" },
  
  // Stage 4: Group by city
  {
    $group: {
      _id: "$customer.city",
      avgOrderValue: { $avg: "$amount" },
      totalOrders: { $sum: 1 },
      totalRevenue: { $sum: "$amount" }
    }
  },
  
  // Stage 5: Sort by average
  { $sort: { avgOrderValue: -1 } },
  
  // Stage 6: Top 3
  { $limit: 3 },
  
  // Stage 7: Format output
  {
    $project: {
      city: "$_id",
      avgOrderValue: { $round: ["$avgOrderValue", 2] },
      totalOrders: 1,
      totalRevenue: 1,
      _id: 0
    }
  }
]);
```

---

## Aggregation vs Find

| Feature | find() | aggregate() |
|---------|--------|-------------|
| **Purpose** | Retrieve docs | Transform/compute |
| **Grouping** | No | Yes |
| **Calculations** | No | Yes |
| **Joins** | No | Yes ($lookup) |
| **Performance** | Faster | Slower |

**Use find() for:** Simple queries  
**Use aggregate() for:** Data analysis, reporting

---

## Performance Tips

✅ **$match early**: Filter before grouping  
✅ **$project early**: Reduce document size  
✅ **Use indexes**: On $match fields  
✅ **Limit results**: Use $limit  
❌ **Avoid large $lookup**: Can be slow  

---

## Summary

**Aggregation:**
- Process and transform data
- Pipeline of stages
- Like SQL GROUP BY

**Common Stages:**
```javascript
$match    // Filter
$group    // Group by field
$project  // Select fields
$sort     // Sort results
$limit    // Limit results
$lookup   // Join collections
$unwind   // Deconstruct arrays
```

**Pattern:**
```javascript
db.collection.aggregate([
  { $match: { status: "active" } },
  { $group: { _id: "$field", count: { $sum: 1 } } },
  { $sort: { count: -1 } },
  { $limit: 10 }
]);
```

**Next**: Learn Mongoose!
