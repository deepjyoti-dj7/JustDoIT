# 10. CRUD with Mongoose

## Setup

**models/User.js:**

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: { type: String, required: true },
  email: { type: String, required: true, unique: true },
  age: Number,
  isActive: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('User', userSchema);
```

---

## Create (Insert)

### Method 1: new + save()

```javascript
const User = require('./models/User');

const user = new User({
  name: 'John Doe',
  email: 'john@example.com',
  age: 30
});

await user.save();
console.log('User created:', user);
```

### Method 2: create()

```javascript
const user = await User.create({
  name: 'John Doe',
  email: 'john@example.com',
  age: 30
});

console.log('User created:', user);
```

### Method 3: insertMany()

Insert multiple documents:

```javascript
const users = await User.insertMany([
  { name: 'Alice', email: 'alice@example.com', age: 25 },
  { name: 'Bob', email: 'bob@example.com', age: 35 },
  { name: 'Charlie', email: 'charlie@example.com', age: 28 }
]);

console.log(`${users.length} users created`);
```

---

## Read (Find)

### Find All

```javascript
const users = await User.find();
console.log(users);
```

### Find with Filter

```javascript
// Find active users
const activeUsers = await User.find({ isActive: true });

// Find by age
const adults = await User.find({ age: { $gte: 18 } });

// Multiple conditions
const users = await User.find({
  isActive: true,
  age: { $gte: 25 }
});
```

### Find One

```javascript
const user = await User.findOne({ email: 'john@example.com' });

if (!user) {
  console.log('User not found');
}
```

### Find by ID

```javascript
const user = await User.findById('507f1f77bcf86cd799439011');

if (!user) {
  return res.status(404).json({ error: 'User not found' });
}
```

### Select Specific Fields

```javascript
// Include only name and email
const users = await User.find().select('name email -_id');

// Exclude age field
const users = await User.find().select('-age');

// Or as second parameter
const users = await User.find({}, 'name email');
```

### Sort

```javascript
// Ascending
const users = await User.find().sort({ age: 1 });

// Descending
const users = await User.find().sort({ age: -1 });

// Multiple fields
const users = await User.find().sort({ isActive: -1, age: 1 });

// Or as string
const users = await User.find().sort('-age name');
```

### Limit & Skip

```javascript
// Limit results
const users = await User.find().limit(5);

// Skip first 10
const users = await User.find().skip(10).limit(5);

// Pagination
const page = 2;
const limit = 10;
const users = await User.find()
  .skip((page - 1) * limit)
  .limit(limit);
```

### Count Documents

```javascript
const count = await User.countDocuments();
const activeCount = await User.countDocuments({ isActive: true });
```

---

## Update

### updateOne()

Update first matching document:

```javascript
const result = await User.updateOne(
  { email: 'john@example.com' },
  { $set: { age: 31 } }
);

console.log(result);
// { acknowledged: true, modifiedCount: 1, matchedCount: 1 }
```

### updateMany()

Update all matching documents:

```javascript
const result = await User.updateMany(
  { isActive: false },
  { $set: { isActive: true } }
);

console.log(`${result.modifiedCount} users updated`);
```

### findByIdAndUpdate()

Find by ID and update (returns document):

```javascript
const user = await User.findByIdAndUpdate(
  '507f1f77bcf86cd799439011',
  { $set: { age: 31 } },
  { new: true }  // Return updated document
);

console.log('Updated user:', user);
```

**Options:**
- `new: true` - Return updated document (default: false)
- `runValidators: true` - Run schema validators

### findOneAndUpdate()

```javascript
const user = await User.findOneAndUpdate(
  { email: 'john@example.com' },
  { $set: { age: 31 } },
  { new: true, runValidators: true }
);
```

### Update Operators

```javascript
// $set - Set value
await User.updateOne({ _id: id }, { $set: { name: 'Jane' } });

// $inc - Increment
await User.updateOne({ _id: id }, { $inc: { age: 1 } });

// $push - Add to array
await User.updateOne({ _id: id }, { $push: { tags: 'developer' } });

// $pull - Remove from array
await User.updateOne({ _id: id }, { $pull: { tags: 'beginner' } });

// $unset - Remove field
await User.updateOne({ _id: id }, { $unset: { age: '' } });
```

---

## Delete

### deleteOne()

Delete first matching document:

```javascript
const result = await User.deleteOne({ email: 'john@example.com' });

console.log(result);
// { acknowledged: true, deletedCount: 1 }
```

### deleteMany()

Delete all matching documents:

```javascript
const result = await User.deleteMany({ isActive: false });

console.log(`${result.deletedCount} users deleted`);

// Delete all
const result = await User.deleteMany({});
```

### findByIdAndDelete()

Find by ID and delete (returns deleted document):

```javascript
const user = await User.findByIdAndDelete('507f1f77bcf86cd799439011');

if (user) {
  console.log('Deleted user:', user);
} else {
  console.log('User not found');
}
```

### findOneAndDelete()

```javascript
const user = await User.findOneAndDelete({ email: 'john@example.com' });
```

---

## Query Operators

### Comparison

```javascript
// Equal
User.find({ age: 30 });

// Not equal
User.find({ age: { $ne: 30 } });

// Greater than
User.find({ age: { $gt: 25 } });

// Greater than or equal
User.find({ age: { $gte: 25 } });

// Less than
User.find({ age: { $lt: 35 } });

// Less than or equal
User.find({ age: { $lte: 35 } });

// In array
User.find({ age: { $in: [25, 30, 35] } });

// Not in array
User.find({ age: { $nin: [25, 30] } });
```

### Logical

```javascript
// AND (implicit)
User.find({ age: 30, isActive: true });

// OR
User.find({
  $or: [
    { age: 30 },
    { isActive: true }
  ]
});

// AND + OR
User.find({
  isActive: true,
  $or: [
    { age: { $lt: 25 } },
    { age: { $gt: 60 } }
  ]
});
```

### String

```javascript
// Regex
User.find({ name: /john/i });  // Case-insensitive

// Starts with
User.find({ name: /^John/ });

// Ends with
User.find({ name: /Doe$/ });

// Contains
User.find({ name: /doe/i });
```

---

## Chaining Methods

```javascript
const users = await User
  .find({ isActive: true })
  .select('name email')
  .sort('-age')
  .limit(10)
  .skip(5);
```

---

## Practical Examples

### Complete CRUD API

```javascript
const express = require('express');
const User = require('./models/User');

const app = express();
app.use(express.json());

// Create
app.post('/users', async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json(user);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

// Read all
app.get('/users', async (req, res) => {
  try {
    const users = await User.find();
    res.json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Read one
app.get('/users/:id', async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Update
app.put('/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true, runValidators: true }
    );
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json(user);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

// Delete
app.delete('/users/:id', async (req, res) => {
  try {
    const user = await User.findByIdAndDelete(req.params.id);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    res.json({ message: 'User deleted', user });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.listen(3000);
```

---

## Best Practices

✅ **Use async/await**: Cleaner than callbacks  
✅ **Handle errors**: Try-catch blocks  
✅ **Validate input**: Use schema validation  
✅ **Use lean()**: For read-only queries (faster)  
✅ **Select only needed fields**: Reduce data transfer  
✅ **Use indexes**: For frequently queried fields  
❌ **Don't fetch all data**: Use pagination  
❌ **Don't ignore errors**: Always handle them  

---

## Summary

**Create:**
```javascript
await User.create({...});
await new User({...}).save();
await User.insertMany([...]);
```

**Read:**
```javascript
await User.find();
await User.findOne({ email });
await User.findById(id);
```

**Update:**
```javascript
await User.updateOne({ _id: id }, { $set: {...} });
await User.findByIdAndUpdate(id, {...}, { new: true });
```

**Delete:**
```javascript
await User.deleteOne({ _id: id });
await User.findByIdAndDelete(id);
```

**Chaining:**
```javascript
await User.find().select('name').sort('-age').limit(10);
```

**Next**: Learn Queries & Population!
