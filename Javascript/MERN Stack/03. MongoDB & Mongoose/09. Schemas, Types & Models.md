# 09. Schemas, Types & Models

## Mongoose Schema

Defines the structure of documents in a collection.

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  age: Number
});
```

---

## Schema Types

### Basic Types

```javascript
const schema = new mongoose.Schema({
  name: String,
  age: Number,
  isActive: Boolean,
  birthDate: Date,
  userId: mongoose.Schema.Types.ObjectId,
  data: Buffer,
  mixed: mongoose.Schema.Types.Mixed,
  tags: [String],  // Array of strings
  metadata: Map
});
```

### String

```javascript
const schema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    minlength: 3,
    maxlength: 50,
    lowercase: true,     // Convert to lowercase
    uppercase: false,
    trim: true,          // Remove whitespace
    match: /^[a-zA-Z]+$/ // Regex validation
  }
});
```

### Number

```javascript
const schema = new mongoose.Schema({
  age: {
    type: Number,
    required: true,
    min: 0,
    max: 120,
    default: 18
  },
  price: {
    type: Number,
    get: v => (v / 100).toFixed(2),  // Getter
    set: v => v * 100                 // Setter
  }
});
```

### Boolean

```javascript
const schema = new mongoose.Schema({
  isActive: {
    type: Boolean,
    default: true
  },
  isVerified: Boolean
});
```

### Date

```javascript
const schema = new mongoose.Schema({
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: Date,
  expiresAt: {
    type: Date,
    expires: 3600  // TTL: Delete after 1 hour
  }
});
```

### ObjectId (References)

```javascript
const schema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',  // Reference to User model
    required: true
  }
});
```

### Array

```javascript
const schema = new mongoose.Schema({
  tags: [String],
  scores: [Number],
  friends: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }]
});
```

### Nested Objects

```javascript
const schema = new mongoose.Schema({
  address: {
    street: String,
    city: String,
    zipCode: String
  },
  // Or as subdocument
  profile: {
    bio: String,
    avatar: String,
    social: {
      twitter: String,
      linkedin: String
    }
  }
});
```

### Mixed Type

```javascript
const schema = new mongoose.Schema({
  metadata: mongoose.Schema.Types.Mixed
});

// Can store any type
const doc = new Model({
  metadata: { key: 'value', count: 10, active: true }
});
```

---

## Schema Options

### Timestamps

```javascript
const schema = new mongoose.Schema({
  name: String
}, { timestamps: true });

// Automatically adds:
// createdAt: Date
// updatedAt: Date
```

### Custom Collection Name

```javascript
const schema = new mongoose.Schema({
  name: String
}, { collection: 'my_users' });
```

### Strict Mode

```javascript
const schema = new mongoose.Schema({
  name: String
}, { strict: true });  // Reject fields not in schema (default)
```

---

## Validation

### Required

```javascript
const schema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: [true, 'Email is required']  // Custom message
  }
});
```

### Custom Validators

```javascript
const schema = new mongoose.Schema({
  email: {
    type: String,
    validate: {
      validator: function(v) {
        return /^\S+@\S+\.\S+$/.test(v);
      },
      message: 'Invalid email format'
    }
  },
  age: {
    type: Number,
    validate: {
      validator: function(v) {
        return v >= 18;
      },
      message: 'Must be 18 or older'
    }
  }
});
```

### Enum

```javascript
const schema = new mongoose.Schema({
  role: {
    type: String,
    enum: ['user', 'admin', 'moderator'],
    default: 'user'
  },
  status: {
    type: String,
    enum: {
      values: ['active', 'inactive', 'banned'],
      message: '{VALUE} is not a valid status'
    }
  }
});
```

### Unique

```javascript
const schema = new mongoose.Schema({
  email: {
    type: String,
    unique: true,
    required: true
  },
  username: {
    type: String,
    unique: true,
    sparse: true  // Allow multiple null values
  }
});
```

---

## Default Values

```javascript
const schema = new mongoose.Schema({
  status: {
    type: String,
    default: 'active'
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  count: {
    type: Number,
    default: 0
  },
  settings: {
    type: Object,
    default: () => ({ theme: 'light' })
  }
});
```

---

## Mongoose Models

A model is a class created from a schema.

### Create Model

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  age: Number
});

// Create model
const User = mongoose.model('User', userSchema);

module.exports = User;
```

### Model Methods

```javascript
// Create document
const user = new User({ name: 'John', email: 'john@example.com' });
await user.save();

// Or
const user = await User.create({ name: 'John', email: 'john@example.com' });

// Find
const users = await User.find();
const user = await User.findById(id);
const user = await User.findOne({ email: 'john@example.com' });

// Update
await User.updateOne({ _id: id }, { name: 'Jane' });
await User.findByIdAndUpdate(id, { name: 'Jane' });

// Delete
await User.deleteOne({ _id: id });
await User.findByIdAndDelete(id);
```

---

## Complete Example

**models/User.js:**

```javascript
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  // Basic info
  name: {
    type: String,
    required: [true, 'Name is required'],
    trim: true,
    minlength: 3,
    maxlength: 50
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true,
    validate: {
      validator: function(v) {
        return /^\S+@\S+\.\S+$/.test(v);
      },
      message: 'Invalid email'
    }
  },
  
  // Optional fields
  age: {
    type: Number,
    min: 0,
    max: 120
  },
  
  // Enum
  role: {
    type: String,
    enum: ['user', 'admin', 'moderator'],
    default: 'user'
  },
  
  // Boolean
  isActive: {
    type: Boolean,
    default: true
  },
  
  // Array
  tags: [String],
  
  // Nested object
  address: {
    street: String,
    city: String,
    country: {
      type: String,
      default: 'USA'
    }
  },
  
  // Reference
  posts: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Post'
  }]
  
}, { timestamps: true });

module.exports = mongoose.model('User', userSchema);
```

**Usage:**

```javascript
const User = require('./models/User');

// Create user
const user = await User.create({
  name: 'John Doe',
  email: 'john@example.com',
  age: 30,
  role: 'user',
  tags: ['developer', 'blogger'],
  address: {
    street: '123 Main St',
    city: 'New York'
  }
});

console.log('User created:', user);
```

---

## Best Practices

✅ **Use validation**: Required, min, max, enum  
✅ **Use timestamps**: { timestamps: true }  
✅ **Trim strings**: trim: true  
✅ **Lowercase emails**: lowercase: true  
✅ **Custom error messages**: ['value', 'message']  
✅ **Use refs**: For relationships  
❌ **Don't use Mixed**: Unless necessary  
❌ **Don't skip validation**: Always validate  

---

## Summary

**Schema:**
- Defines document structure
- Validates data
- Type casting

**Common Types:**
- String, Number, Boolean, Date
- ObjectId, Array, Mixed

**Validation:**
```javascript
{
  type: String,
  required: true,
  minlength: 3,
  maxlength: 50,
  enum: ['value1', 'value2'],
  validate: { validator: fn }
}
```

**Model:**
```javascript
const schema = new mongoose.Schema({...});
const Model = mongoose.model('Model', schema);
```

**Next**: Learn CRUD with Mongoose!
