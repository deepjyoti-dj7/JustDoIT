# 12. Virtuals, Methods & Middleware

## Virtual Properties

Computed properties that are not stored in database.

### Define Virtual

```javascript
const userSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
});

// Virtual getter
userSchema.virtual('fullName').get(function() {
  return `${this.firstName} ${this.lastName}`;
});

// Virtual setter
userSchema.virtual('fullName').set(function(name) {
  const [firstName, lastName] = name.split(' ');
  this.firstName = firstName;
  this.lastName = lastName;
});

const User = mongoose.model('User', userSchema);
```

### Use Virtual

```javascript
const user = new User({ firstName: 'John', lastName: 'Doe' });

console.log(user.fullName);  // 'John Doe'

// Setter
user.fullName = 'Jane Smith';
console.log(user.firstName);  // 'Jane'
console.log(user.lastName);   // 'Smith'
```

### Include Virtuals in JSON

```javascript
const userSchema = new mongoose.Schema({
  firstName: String,
  lastName: String
}, {
  toJSON: { virtuals: true },
  toObject: { virtuals: true }
});

userSchema.virtual('fullName').get(function() {
  return `${this.firstName} ${this.lastName}`;
});
```

---

## Instance Methods

Methods available on document instances.

### Define Instance Method

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  password: String
});

// Instance method
userSchema.methods.greet = function() {
  return `Hello, my name is ${this.name}`;
};

userSchema.methods.comparePassword = function(password) {
  return this.password === password;
};

const User = mongoose.model('User', userSchema);
```

### Use Instance Method

```javascript
const user = await User.findById(userId);

console.log(user.greet());  // 'Hello, my name is John'

const isValid = user.comparePassword('mypassword');
console.log(isValid);  // true or false
```

---

## Static Methods

Methods available on Model (not instances).

### Define Static Method

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  isActive: Boolean
});

// Static method
userSchema.statics.findActive = function() {
  return this.find({ isActive: true });
};

userSchema.statics.findByEmail = function(email) {
  return this.findOne({ email });
};

const User = mongoose.model('User', userSchema);
```

### Use Static Method

```javascript
// Call on Model
const activeUsers = await User.findActive();
const user = await User.findByEmail('john@example.com');
```

---

## Middleware (Hooks)

Functions that run before/after certain operations.

### Types of Middleware

1. **Document middleware**: save, validate, remove, updateOne, deleteOne
2. **Query middleware**: find, findOne, updateMany, etc.
3. **Aggregate middleware**: aggregate
4. **Model middleware**: insertMany

---

## Pre Middleware

Runs **before** operation.

### Pre Save

```javascript
const bcrypt = require('bcrypt');

const userSchema = new mongoose.Schema({
  name: String,
  email: String,
  password: String
});

// Hash password before saving
userSchema.pre('save', async function(next) {
  // Only hash if password is modified
  if (!this.isModified('password')) return next();
  
  this.password = await bcrypt.hash(this.password, 10);
  next();
});

const User = mongoose.model('User', userSchema);
```

### Pre Remove

```javascript
const userSchema = new mongoose.Schema({
  name: String,
  email: String
});

// Delete user's posts when user is deleted
userSchema.pre('remove', async function(next) {
  await Post.deleteMany({ author: this._id });
  next();
});
```

### Pre Find

```javascript
// Auto-populate on every find
userSchema.pre('find', function() {
  this.populate('friends');
});

// Or filter deleted users
userSchema.pre(/^find/, function() {
  this.where({ isDeleted: { $ne: true } });
});
```

---

## Post Middleware

Runs **after** operation.

### Post Save

```javascript
userSchema.post('save', function(doc, next) {
  console.log(`User ${doc.name} has been saved`);
  next();
});
```

### Post Remove

```javascript
userSchema.post('remove', function(doc, next) {
  console.log(`User ${doc.name} has been deleted`);
  next();
});
```

---

## Complete Example

**models/User.js:**

```javascript
const mongoose = require('mongoose');
const bcrypt = require('bcrypt');

const userSchema = new mongoose.Schema({
  firstName: String,
  lastName: String,
  email: { type: String, unique: true },
  password: String,
  isActive: { type: Boolean, default: true }
}, {
  timestamps: true,
  toJSON: { virtuals: true }
});

// Virtual: Full name
userSchema.virtual('fullName').get(function() {
  return `${this.firstName} ${this.lastName}`;
});

// Instance method: Compare password
userSchema.methods.comparePassword = async function(password) {
  return await bcrypt.compare(password, this.password);
};

// Static method: Find active users
userSchema.statics.findActive = function() {
  return this.find({ isActive: true });
};

// Pre save: Hash password
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) return next();
  this.password = await bcrypt.hash(this.password, 10);
  next();
});

// Post save: Log
userSchema.post('save', function(doc) {
  console.log(`✅ User ${doc.fullName} saved`);
});

module.exports = mongoose.model('User', userSchema);
```

**Usage:**

```javascript
const User = require('./models/User');

// Create user (password auto-hashed)
const user = await User.create({
  firstName: 'John',
  lastName: 'Doe',
  email: 'john@example.com',
  password: 'mypassword'
});

// Virtual
console.log(user.fullName);  // 'John Doe'

// Instance method
const isValid = await user.comparePassword('mypassword');
console.log(isValid);  // true

// Static method
const activeUsers = await User.findActive();
```

---

## Middleware Error Handling

```javascript
userSchema.pre('save', function(next) {
  if (this.age < 0) {
    return next(new Error('Age cannot be negative'));
  }
  next();
});
```

---

## Query Helpers vs Static Methods

### Query Helper

```javascript
userSchema.query.active = function() {
  return this.where({ isActive: true });
};

// Usage
const users = await User.find().active();
```

### Static Method

```javascript
userSchema.statics.findActive = function() {
  return this.find({ isActive: true });
};

// Usage
const users = await User.findActive();
```

---

## Best Practices

✅ **Use virtuals**: For computed properties  
✅ **Instance methods**: For document-specific logic  
✅ **Static methods**: For Model-level operations  
✅ **Pre save**: Hash passwords, validate data  
✅ **Use `this`**: Access document in middleware  
❌ **Don't use arrow functions**: In methods/middleware  
❌ **Don't call next() twice**: In middleware  

---

## Summary

**Virtuals:**
```javascript
schema.virtual('fullName').get(function() {
  return `${this.firstName} ${this.lastName}`;
});
```

**Instance Methods:**
```javascript
schema.methods.greet = function() {
  return `Hello, ${this.name}`;
};
```

**Static Methods:**
```javascript
schema.statics.findActive = function() {
  return this.find({ isActive: true });
};
```

**Middleware:**
```javascript
// Pre
schema.pre('save', async function(next) {
  // Before save
  next();
});

// Post
schema.post('save', function(doc, next) {
  // After save
  next();
});
```

**Pattern:**
- Virtuals = computed properties
- Methods = instance logic
- Statics = Model logic
- Middleware = hooks

**Next**: Learn Plugins, Transactions & Validation!
