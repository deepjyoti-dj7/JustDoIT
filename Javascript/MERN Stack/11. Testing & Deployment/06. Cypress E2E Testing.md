# 06. Cypress E2E Testing

## Introduction

Cypress is a modern end-to-end testing framework for web applications. It runs tests in the browser, provides automatic waiting, and offers excellent debugging capabilities. This guide covers Cypress setup and best practices.

---

## Installation & Setup

### Install Cypress

```bash
npm install --save-dev cypress
```

### Open Cypress

```bash
npx cypress open
```

This creates the following structure:

```
cypress/
  e2e/
    example.cy.js
  fixtures/
    example.json
  support/
    commands.js
    e2e.js
cypress.config.js
```

### Configuration

```javascript
// cypress.config.js
const { defineConfig } = require('cypress');

module.exports = defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3000',
    viewportWidth: 1280,
    viewportHeight: 720,
    video: false,
    screenshotOnRunFailure: true,
    setupNodeEvents(on, config) {
      // implement node event listeners here
    },
  },
});
```

---

## Basic Syntax

### First Test

```javascript
// cypress/e2e/home.cy.js
describe('Home Page', () => {
  it('loads successfully', () => {
    cy.visit('/');
    cy.contains('Welcome to My App');
  });
  
  it('has correct title', () => {
    cy.visit('/');
    cy.title().should('include', 'My App');
  });
});
```

### Running Tests

```bash
# Open interactive test runner
npx cypress open

# Run all tests headlessly
npx cypress run

# Run specific test file
npx cypress run --spec "cypress/e2e/home.cy.js"

# Run in specific browser
npx cypress run --browser chrome
```

---

## Cypress Commands

### Visiting Pages

```javascript
cy.visit('/');              // Visit base URL
cy.visit('/about');         // Visit specific path
cy.visit('https://example.com');
cy.go('back');              // Browser back
cy.go('forward');           // Browser forward
cy.reload();                // Reload page
```

### Selecting Elements

```javascript
// By text content
cy.contains('Submit');
cy.contains('button', 'Submit');

// By selector
cy.get('button');
cy.get('.btn-primary');
cy.get('#submit-btn');
cy.get('[data-testid="login-btn"]');

// By attribute
cy.get('[type="email"]');
cy.get('[placeholder="Enter email"]');

// Multiple elements
cy.get('.item').should('have.length', 3);
```

### Interacting with Elements

```javascript
// Click
cy.get('button').click();
cy.contains('Submit').click();

// Type
cy.get('input[name="email"]').type('user@example.com');
cy.get('input').type('Hello{enter}'); // Press enter

// Clear input
cy.get('input').clear();

// Select dropdown
cy.get('select').select('Option 1');
cy.get('select').select('value');

// Check/Uncheck
cy.get('[type="checkbox"]').check();
cy.get('[type="checkbox"]').uncheck();
cy.get('[type="radio"]').check();
```

### Assertions

```javascript
// Existence
cy.get('.error').should('exist');
cy.get('.success').should('not.exist');

// Visibility
cy.get('.modal').should('be.visible');
cy.get('.modal').should('not.be.visible');

// Text content
cy.get('h1').should('have.text', 'Welcome');
cy.get('p').should('contain', 'Hello');

// Value
cy.get('input').should('have.value', 'test@example.com');

// Attribute
cy.get('button').should('have.attr', 'disabled');
cy.get('a').should('have.attr', 'href', '/about');

// Class
cy.get('button').should('have.class', 'active');

// Length
cy.get('.item').should('have.length', 5);

// URL
cy.url().should('include', '/dashboard');
cy.url().should('eq', 'http://localhost:3000/profile');
```

---

## Testing Forms

```javascript
// cypress/e2e/contact-form.cy.js
describe('Contact Form', () => {
  beforeEach(() => {
    cy.visit('/contact');
  });
  
  it('submits form with valid data', () => {
    cy.get('input[name="name"]').type('John Doe');
    cy.get('input[name="email"]').type('john@example.com');
    cy.get('textarea[name="message"]').type('This is a test message');
    
    cy.get('button[type="submit"]').click();
    
    cy.contains('Message sent successfully').should('be.visible');
  });
  
  it('shows validation errors', () => {
    cy.get('button[type="submit"]').click();
    
    cy.contains('Name is required').should('be.visible');
    cy.contains('Email is required').should('be.visible');
    cy.contains('Message is required').should('be.visible');
  });
  
  it('validates email format', () => {
    cy.get('input[name="email"]').type('invalid-email');
    cy.get('button[type="submit"]').click();
    
    cy.contains('Invalid email format').should('be.visible');
  });
  
  it('clears form after submission', () => {
    cy.get('input[name="name"]').type('John Doe');
    cy.get('input[name="email"]').type('john@example.com');
    cy.get('textarea[name="message"]').type('Test');
    
    cy.get('button[type="submit"]').click();
    
    // Wait for submission
    cy.contains('Message sent successfully');
    
    // Check form is cleared
    cy.get('input[name="name"]').should('have.value', '');
    cy.get('input[name="email"]').should('have.value', '');
    cy.get('textarea[name="message"]').should('have.value', '');
  });
});
```

---

## Testing Authentication

```javascript
// cypress/e2e/auth.cy.js
describe('Authentication', () => {
  describe('Login', () => {
    beforeEach(() => {
      cy.visit('/login');
    });
    
    it('logs in with valid credentials', () => {
      cy.get('input[name="email"]').type('user@example.com');
      cy.get('input[name="password"]').type('password123');
      cy.get('button[type="submit"]').click();
      
      cy.url().should('include', '/dashboard');
      cy.contains('Welcome back').should('be.visible');
    });
    
    it('shows error for invalid credentials', () => {
      cy.get('input[name="email"]').type('user@example.com');
      cy.get('input[name="password"]').type('wrongpassword');
      cy.get('button[type="submit"]').click();
      
      cy.contains('Invalid credentials').should('be.visible');
      cy.url().should('include', '/login');
    });
  });
  
  describe('Registration', () => {
    beforeEach(() => {
      cy.visit('/register');
    });
    
    it('registers new user', () => {
      cy.get('input[name="name"]').type('John Doe');
      cy.get('input[name="email"]').type(`user${Date.now()}@example.com`);
      cy.get('input[name="password"]').type('password123');
      cy.get('input[name="confirmPassword"]').type('password123');
      cy.get('button[type="submit"]').click();
      
      cy.url().should('include', '/dashboard');
    });
    
    it('validates password match', () => {
      cy.get('input[name="password"]').type('password123');
      cy.get('input[name="confirmPassword"]').type('different');
      cy.get('button[type="submit"]').click();
      
      cy.contains('Passwords do not match').should('be.visible');
    });
  });
  
  describe('Logout', () => {
    beforeEach(() => {
      // Login first
      cy.visit('/login');
      cy.get('input[name="email"]').type('user@example.com');
      cy.get('input[name="password"]').type('password123');
      cy.get('button[type="submit"]').click();
      cy.url().should('include', '/dashboard');
    });
    
    it('logs out successfully', () => {
      cy.get('[data-testid="logout-btn"]').click();
      
      cy.url().should('include', '/login');
      cy.contains('Logged out successfully').should('be.visible');
    });
  });
});
```

---

## Custom Commands

```javascript
// cypress/support/commands.js

// Login command
Cypress.Commands.add('login', (email, password) => {
  cy.visit('/login');
  cy.get('input[name="email"]').type(email);
  cy.get('input[name="password"]').type(password);
  cy.get('button[type="submit"]').click();
});

// Create user command
Cypress.Commands.add('createUser', (userData) => {
  cy.request('POST', '/api/users', userData);
});

// Set token in localStorage
Cypress.Commands.add('setAuthToken', (token) => {
  window.localStorage.setItem('authToken', token);
});

// Usage in tests
describe('Dashboard', () => {
  beforeEach(() => {
    cy.login('user@example.com', 'password123');
  });
  
  it('displays user info', () => {
    cy.contains('Welcome, User').should('be.visible');
  });
});
```

---

## Fixtures

```javascript
// cypress/fixtures/users.json
{
  "admin": {
    "email": "admin@example.com",
    "password": "admin123",
    "name": "Admin User"
  },
  "user": {
    "email": "user@example.com",
    "password": "user123",
    "name": "Regular User"
  }
}

// Usage in tests
describe('Login with Fixtures', () => {
  beforeEach(() => {
    cy.fixture('users').as('users');
    cy.visit('/login');
  });
  
  it('logs in as admin', function() {
    cy.get('input[name="email"]').type(this.users.admin.email);
    cy.get('input[name="password"]').type(this.users.admin.password);
    cy.get('button[type="submit"]').click();
    
    cy.contains(this.users.admin.name).should('be.visible');
  });
});
```

---

## Intercept API Calls

```javascript
describe('API Interception', () => {
  it('intercepts GET request', () => {
    cy.intercept('GET', '/api/users', {
      statusCode: 200,
      body: [
        { id: 1, name: 'User 1' },
        { id: 2, name: 'User 2' }
      ]
    }).as('getUsers');
    
    cy.visit('/users');
    cy.wait('@getUsers');
    
    cy.contains('User 1').should('be.visible');
    cy.contains('User 2').should('be.visible');
  });
  
  it('intercepts POST request', () => {
    cy.intercept('POST', '/api/users', {
      statusCode: 201,
      body: { id: 3, name: 'New User' }
    }).as('createUser');
    
    cy.visit('/users/new');
    cy.get('input[name="name"]').type('New User');
    cy.get('button[type="submit"]').click();
    
    cy.wait('@createUser');
    cy.contains('User created successfully').should('be.visible');
  });
  
  it('simulates API error', () => {
    cy.intercept('GET', '/api/users', {
      statusCode: 500,
      body: { error: 'Internal Server Error' }
    });
    
    cy.visit('/users');
    cy.contains('Failed to load users').should('be.visible');
  });
});
```

---

## Waiting

```javascript
// Implicit wait (automatic)
cy.get('.loading').should('not.exist');
cy.get('.content').should('be.visible');

// Explicit wait
cy.wait(1000); // Wait 1 second (avoid this)

// Wait for API call
cy.intercept('GET', '/api/data').as('getData');
cy.visit('/');
cy.wait('@getData');

// Wait for element
cy.get('.spinner', { timeout: 10000 }).should('not.exist');
```

---

## Best Practices

### 1. Use data-testid Attributes

```javascript
// Component
<button data-testid="submit-btn">Submit</button>

// Test
cy.get('[data-testid="submit-btn"]').click();
```

### 2. Avoid Hardcoded Waits

```javascript
// Bad
cy.wait(5000);

// Good
cy.get('.loading').should('not.exist');
```

### 3. Use Aliases

```javascript
cy.get('.user-list').as('userList');
cy.get('@userList').should('have.length', 5);
```

### 4. Clean State Between Tests

```javascript
beforeEach(() => {
  cy.clearLocalStorage();
  cy.clearCookies();
});
```

### 5. Group Related Tests

```javascript
describe('User Management', () => {
  describe('Create User', () => {
    // tests
  });
  
  describe('Edit User', () => {
    // tests
  });
});
```

---

## Interview Questions

**Q1: What is Cypress?**
- E2E testing framework
- Runs in browser, automatic waiting
- Better debugging than Selenium

**Q2: Cypress vs Selenium?**
- **Cypress**: Faster, automatic waits, better DX
- **Selenium**: Multi-browser, multi-language

**Q3: How to handle authentication in Cypress?**
- Create custom login command
- Use programmatic login (API call + set token)
- Bypass UI for faster tests

**Q4: What is cy.intercept()?**
- Mock/stub API calls
- Control response data
- Simulate errors

**Q5: Best practices for Cypress?**
- Use data-testid attributes
- Avoid hardcoded waits
- Clean state between tests
- Use custom commands for repeated actions

---

## Summary

- **Installation**: `npm install cypress`
- **Commands**: cy.visit, cy.get, cy.contains, cy.click, cy.type
- **Assertions**: should('be.visible'), should('have.text')
- **Custom Commands**: Reusable test logic
- **Fixtures**: Test data in JSON files
- **Intercept**: Mock API responses
- **Best Practice**: Use data-testid, avoid waits, clean state
