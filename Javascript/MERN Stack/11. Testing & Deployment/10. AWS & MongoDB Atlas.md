# 10. AWS & MongoDB Atlas

## Introduction

AWS (Amazon Web Services) provides infrastructure for scalable deployments. MongoDB Atlas offers managed MongoDB hosting. This guide covers deploying MERN applications on AWS and configuring MongoDB Atlas.

---

## MongoDB Atlas Setup

### Creating Cluster

**1. Sign Up**
- Go to mongodb.com/atlas
- Create free account
- Choose free M0 tier

**2. Create Cluster**
- Select cloud provider (AWS, GCP, Azure)
- Choose region (closest to users)
- Cluster name: e.g., "MyAppCluster"
- Click "Create Cluster"

**3. Create Database User**
- Database Access → Add New Database User
- Username: `myappuser`
- Password: Strong password or auto-generate
- Database User Privileges: Read and write to any database

**4. Network Access**
- Network Access → Add IP Address
- For development: 0.0.0.0/0 (allow all)
- For production: Specific IPs or AWS security group

**5. Get Connection String**
- Database → Connect → Connect your application
- Driver: Node.js, Version: 4.1 or later
- Copy connection string:

```
mongodb+srv://myappuser:<password>@cluster.mongodb.net/mydb?retryWrites=true&w=majority
```

### Connection in Node.js

```javascript
// config/database.js
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGO_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    
    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
};

module.exports = connectDB;

// server.js
require('dotenv').config();
const connectDB = require('./config/database');

connectDB();
```

### Atlas Best Practices

**1. Database Indexes**
- Create indexes for frequently queried fields
- Monitor performance in Atlas dashboard

**2. Backup**
- Enable automated backups (available in M2+ tiers)
- Take manual snapshots before major changes

**3. Monitoring**
- Use Atlas monitoring dashboard
- Set up alerts for high CPU/memory usage
- Track slow queries

**4. Security**
- Use strong passwords
- Limit IP addresses in production
- Enable encryption at rest (M10+ tiers)
- Use VPC peering for AWS (M10+ tiers)

---

## AWS EC2 Deployment

### Launch EC2 Instance

**1. Sign in to AWS Console**
- Go to console.aws.amazon.com
- Navigate to EC2 dashboard

**2. Launch Instance**
- Click "Launch Instance"
- Choose AMI: Ubuntu Server 22.04 LTS
- Instance type: t2.micro (free tier)
- Configure Security Group:
  - SSH (22): Your IP
  - HTTP (80): 0.0.0.0/0
  - HTTPS (443): 0.0.0.0/0
  - Custom TCP (5000): 0.0.0.0/0 (for Node.js)
- Create or select key pair (download .pem file)
- Launch instance

**3. Connect to Instance**

```bash
# Set key permissions
chmod 400 my-key.pem

# SSH into instance
ssh -i my-key.pem ubuntu@ec2-xx-xxx-xxx-xx.compute.amazonaws.com
```

### Server Setup

**1. Update System**

```bash
sudo apt update
sudo apt upgrade -y
```

**2. Install Node.js**

```bash
# Using NodeSource repository
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# Verify installation
node --version
npm --version
```

**3. Install Git**

```bash
sudo apt install git -y
git --version
```

**4. Install PM2** (Process Manager)

```bash
sudo npm install -g pm2
```

**5. Clone Repository**

```bash
cd /home/ubuntu
git clone https://github.com/yourusername/your-repo.git
cd your-repo
```

**6. Install Dependencies**

```bash
npm install
```

**7. Configure Environment**

```bash
# Create .env file
nano .env

# Add variables:
NODE_ENV=production
PORT=5000
MONGO_URI=mongodb+srv://user:pass@cluster.mongodb.net/db
JWT_SECRET=your_strong_secret
CLIENT_URL=http://your-domain.com

# Save: Ctrl+O, Exit: Ctrl+X
```

**8. Start Application with PM2**

```bash
# Start app
pm2 start server.js --name "my-app"

# View status
pm2 status

# View logs
pm2 logs

# Restart app
pm2 restart my-app

# Stop app
pm2 stop my-app

# Auto-restart on reboot
pm2 startup
pm2 save
```

### Nginx Setup (Reverse Proxy)

**1. Install Nginx**

```bash
sudo apt install nginx -y
```

**2. Configure Nginx**

```bash
sudo nano /etc/nginx/sites-available/myapp
```

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**3. Enable Configuration**

```bash
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### SSL with Let's Encrypt

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Obtain certificate
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# Auto-renewal (cron job already added)
sudo certbot renew --dry-run
```

---

## AWS S3 for Static Hosting

### React App on S3

**1. Create S3 Bucket**
- Go to S3 console
- Create bucket
- Bucket name: `myapp-frontend`
- Region: Same as your users
- Uncheck "Block all public access"
- Create bucket

**2. Enable Static Website Hosting**
- Bucket → Properties → Static website hosting
- Enable
- Index document: `index.html`
- Error document: `index.html` (for React Router)

**3. Bucket Policy**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::myapp-frontend/*"
    }
  ]
}
```

**4. Build and Upload**

```bash
# Build React app
npm run build

# Install AWS CLI
sudo apt install awscli -y

# Configure AWS CLI
aws configure
# Enter: Access Key ID, Secret Access Key, Region, Output format (json)

# Upload to S3
aws s3 sync build/ s3://myapp-frontend --delete
```

**5. Access Website**
- URL: `http://myapp-frontend.s3-website-us-east-1.amazonaws.com`

### CloudFront CDN (Optional)

**1. Create Distribution**
- CloudFront → Create Distribution
- Origin domain: Select S3 bucket
- Viewer protocol policy: Redirect HTTP to HTTPS
- Alternate domain names (CNAMEs): yourdomain.com
- SSL certificate: Request or import certificate

**2. Update DNS**
- Create CNAME record pointing to CloudFront URL

**3. Invalidate Cache**

```bash
aws cloudfront create-invalidation --distribution-id DISTRIBUTION_ID --paths "/*"
```

---

## AWS Elastic Beanstalk

### Deploy Node.js App

**1. Install EB CLI**

```bash
pip install awsebcli
eb --version
```

**2. Initialize**

```bash
eb init
# Select region
# Select application name
# Select platform: Node.js
# Set up SSH: Yes
```

**3. Create Environment**

```bash
eb create production-env
```

**4. Deploy**

```bash
eb deploy
```

**5. Set Environment Variables**

```bash
eb setenv MONGO_URI="mongodb+srv://..." JWT_SECRET="..."
```

**6. View Logs**

```bash
eb logs
```

---

## AWS Cost Optimization

### Free Tier
- EC2: 750 hours/month of t2.micro
- S3: 5GB storage, 20,000 GET requests
- RDS: 750 hours/month of db.t2.micro
- CloudFront: 50GB data transfer

### Cost Reduction Tips

1. **Use Reserved Instances** (for long-term)
2. **Stop instances** when not in use
3. **Use S3 lifecycle policies** to archive old data
4. **Enable auto-scaling** to match demand
5. **Monitor costs** with AWS Cost Explorer

---

## Interview Questions

**Q1: What is MongoDB Atlas?**
- Managed MongoDB cloud database
- Auto-scaling, backups, monitoring
- Free M0 tier available

**Q2: How to connect to MongoDB Atlas?**
```javascript
mongoose.connect(process.env.MONGO_URI);
// URI: mongodb+srv://user:pass@cluster.mongodb.net/db
```

**Q3: AWS EC2 vs Elastic Beanstalk?**
- **EC2**: Full control, manual setup, SSH access
- **Elastic Beanstalk**: Managed platform, auto-scaling, easier

**Q4: What is PM2?**
- Node.js process manager
- Auto-restart on crash
- Load balancing, monitoring

**Q5: S3 + CloudFront benefits?**
- **S3**: Static hosting, cheap storage
- **CloudFront**: CDN, faster global delivery, HTTPS

**Q6: How to secure MongoDB Atlas?**
- Strong passwords
- IP whitelisting
- Database user permissions
- VPC peering (production)
- Encryption at rest

---

## Summary

- **MongoDB Atlas**: Managed MongoDB, free tier, connection string
- **EC2**: Ubuntu instance, install Node.js, PM2 for process management
- **Nginx**: Reverse proxy, SSL with Let's Encrypt
- **S3**: Static hosting for React, bucket policy for public access
- **CloudFront**: CDN for global delivery
- **Elastic Beanstalk**: Managed platform, easy deployment
- **Best Practice**: Use Atlas for DB, EC2/Beanstalk for backend, S3/CloudFront for frontend
