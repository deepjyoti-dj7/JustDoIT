# 13. Nginx, SSL & Monitoring

## Introduction

Production applications require reverse proxy (Nginx), HTTPS/SSL, and monitoring. This guide covers configuring Nginx, securing with SSL certificates, and implementing monitoring for MERN stack applications.

---

## Nginx Overview

### What is Nginx?

**Nginx** is a high-performance web server and reverse proxy.

**Use Cases**:
- **Reverse Proxy**: Forward requests to Node.js backend
- **Load Balancing**: Distribute traffic across servers
- **Static File Serving**: Serve React build files
- **SSL Termination**: Handle HTTPS
- **Caching**: Cache responses for performance

### Installation

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx -y

# macOS
brew install nginx

# Verify
nginx -v
sudo systemctl status nginx

# Start/Stop/Restart
sudo systemctl start nginx
sudo systemctl stop nginx
sudo systemctl restart nginx
sudo systemctl reload nginx  # Reload config without downtime
```

---

## Nginx as Reverse Proxy

### Basic Configuration

```nginx
# /etc/nginx/sites-available/myapp
server {
    listen 80;
    server_name example.com www.example.com;
    
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Enable Configuration

```bash
# Create symbolic link
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

---

## Serving React (Static Files)

### Configuration

```nginx
server {
    listen 80;
    server_name example.com;
    
    root /var/www/myapp/build;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Cache static assets
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API proxy
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## Full MERN Stack Configuration

```nginx
# /etc/nginx/sites-available/myapp
server {
    listen 80;
    server_name example.com www.example.com;
    
    # Redirect www to non-www
    if ($host = www.example.com) {
        return 301 https://example.com$request_uri;
    }
    
    # Frontend (React)
    root /var/www/myapp/frontend/build;
    index index.html;
    
    # Serve frontend
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Backend API
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # WebSocket support
    location /socket.io/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
}
```

---

## SSL/TLS with Let's Encrypt

### Install Certbot

```bash
# Ubuntu
sudo apt install certbot python3-certbot-nginx -y

# macOS
brew install certbot
```

### Obtain SSL Certificate

```bash
# Automatic configuration
sudo certbot --nginx -d example.com -d www.example.com

# Manual (if needed)
sudo certbot certonly --nginx -d example.com -d www.example.com

# Email for renewal notifications
# Agree to Terms of Service
# Choose whether to redirect HTTP to HTTPS (recommended: Yes)
```

### Auto-Renewal

```bash
# Test renewal
sudo certbot renew --dry-run

# Certbot automatically creates cron job for renewal
# Check: /etc/cron.d/certbot
# Or systemd timer: sudo systemctl status certbot.timer

# Manual renewal
sudo certbot renew
```

### Updated Nginx Configuration

```nginx
# /etc/nginx/sites-available/myapp
# HTTP - Redirect to HTTPS
server {
    listen 80;
    server_name example.com www.example.com;
    return 301 https://$host$request_uri;
}

# HTTPS
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;
    
    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
    
    # SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Rest of configuration...
    root /var/www/myapp/frontend/build;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## Load Balancing

### Multiple Backend Instances

```nginx
upstream backend {
    least_conn;  # Load balancing method
    server localhost:5000;
    server localhost:5001;
    server localhost:5002;
}

server {
    listen 80;
    server_name example.com;
    
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
```

### Load Balancing Methods

- `round_robin` (default): Distribute evenly
- `least_conn`: Send to server with fewest connections
- `ip_hash`: Same IP always to same server (session persistence)

---

## Monitoring & Logging

### 1. Application Logging (Morgan)

```javascript
// backend/server.js
const morgan = require('morgan');
const fs = require('fs');
const path = require('path');

// Create logs directory
const logDir = path.join(__dirname, 'logs');
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir);
}

// Create write stream
const accessLogStream = fs.createWriteStream(
  path.join(logDir, 'access.log'),
  { flags: 'a' }
);

// Setup morgan
app.use(morgan('combined', { stream: accessLogStream }));
```

### 2. Winston (Structured Logging)

```javascript
// logger.js
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'backend' },
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
  ],
});

// Console logging in development
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple(),
  }));
}

module.exports = logger;

// Usage
const logger = require('./logger');

logger.info('Server started', { port: 5000 });
logger.error('Database connection failed', { error: err.message });
```

### 3. PM2 Monitoring

```bash
# Install PM2
npm install -g pm2

# Start with monitoring
pm2 start server.js --name my-app

# Monitor in real-time
pm2 monit

# View logs
pm2 logs

# Metrics
pm2 status
pm2 describe my-app

# Web dashboard
pm2 web
```

### 4. Error Tracking (Sentry)

```bash
npm install @sentry/node
```

```javascript
// server.js
const Sentry = require('@sentry/node');

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// Error handler
app.use(Sentry.Handlers.errorHandler());

app.use((err, req, res, next) => {
  Sentry.captureException(err);
  res.status(500).json({ error: 'Internal server error' });
});
```

### 5. Uptime Monitoring

**Services**:
- **UptimeRobot**: Free tier, monitors every 5 minutes
- **Pingdom**: Detailed monitoring
- **StatusCake**: Free and paid plans

**Setup**:
1. Create account
2. Add monitor with your URL
3. Set alert notifications (email, SMS, Slack)

### 6. Performance Monitoring (New Relic)

```bash
npm install newrelic
```

```javascript
// newrelic.js
exports.config = {
  app_name: ['My MERN App'],
  license_key: process.env.NEW_RELIC_LICENSE_KEY,
  logging: {
    level: 'info'
  }
};

// server.js (first line)
require('newrelic');
```

### 7. Database Monitoring (MongoDB Atlas)

- Built-in monitoring dashboard
- Real-time performance metrics
- Slow query analysis
- Alerts for high CPU/memory usage

---

## Health Check Endpoint

```javascript
// server.js
app.get('/health', async (req, res) => {
  try {
    // Check database connection
    const dbStatus = mongoose.connection.readyState === 1 ? 'connected' : 'disconnected';
    
    // Check memory usage
    const memoryUsage = process.memoryUsage();
    
    res.json({
      status: 'ok',
      timestamp: new Date(),
      uptime: process.uptime(),
      database: dbStatus,
      memory: {
        rss: `${Math.round(memoryUsage.rss / 1024 / 1024)} MB`,
        heapTotal: `${Math.round(memoryUsage.heapTotal / 1024 / 1024)} MB`,
        heapUsed: `${Math.round(memoryUsage.heapUsed / 1024 / 1024)} MB`,
      }
    });
  } catch (error) {
    res.status(503).json({ status: 'error', message: error.message });
  }
});
```

---

## Nginx Best Practices

### 1. Security Headers

```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### 2. Rate Limiting

```nginx
# Define rate limit zone
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

server {
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://localhost:5000;
    }
}
```

### 3. Gzip Compression

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
```

### 4. Client Body Size

```nginx
client_max_body_size 10M;  # Max upload size
```

---

## Interview Questions

**Q1: What is Nginx?**
- Web server and reverse proxy
- Handles static files, load balancing, SSL
- High performance, low resource usage

**Q2: Why use Nginx with Node.js?**
- Serve static files efficiently
- SSL termination
- Load balancing
- Caching
- Security (rate limiting, DDoS protection)

**Q3: How to get free SSL certificate?**
- Use Let's Encrypt
- Install Certbot: `sudo apt install certbot python3-certbot-nginx`
- Run: `sudo certbot --nginx -d example.com`
- Auto-renews every 90 days

**Q4: What is reverse proxy?**
- Nginx receives client requests
- Forwards to backend (Node.js)
- Returns backend response to client
- Hides backend details from client

**Q5: Monitoring tools for Node.js?**
- **PM2**: Process management, monitoring
- **Sentry**: Error tracking
- **New Relic**: Performance monitoring
- **Winston**: Logging
- **UptimeRobot**: Uptime monitoring

---

## Summary

- **Nginx**: Reverse proxy, static file serving, SSL, load balancing
- **SSL**: Let's Encrypt with Certbot, auto-renewal
- **Configuration**: `/etc/nginx/sites-available/`, test with `nginx -t`
- **Monitoring**: PM2, Sentry, Winston, UptimeRobot, New Relic
- **Logging**: Morgan (HTTP logs), Winston (structured logs)
- **Health Check**: `/health` endpoint for monitoring
- **Best Practice**: HTTPS, security headers, rate limiting, gzip compression
