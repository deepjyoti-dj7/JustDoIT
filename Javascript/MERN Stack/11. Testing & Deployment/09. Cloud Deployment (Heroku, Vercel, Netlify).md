# 09. Cloud Deployment (Heroku, Vercel, Netlify)

## Introduction

Cloud platforms simplify deployment with git-based workflows and automatic scaling. This guide covers deploying MERN applications to popular PaaS providers: Heroku (full-stack), Vercel (frontend), and Netlify (frontend).

---

## Heroku Deployment

### Overview

**Heroku** is a cloud PaaS supporting full-stack applications.

**Best for**:
- Full MERN stack (Node.js + React)
- Rapid prototyping
- Small to medium applications

**Pricing**: Free tier available (sleeps after 30min inactivity)

### Prerequisites

```bash
# Install Heroku CLI
# macOS
brew tap heroku/brew && brew install heroku

# Ubuntu
sudo snap install --classic heroku

# Windows: Download from heroku.com

# Login
heroku login
```

### Backend Deployment

**1. Prepare Application**

```json
// package.json
{
  "name": "mern-backend",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "engines": {
    "node": "18.x",
    "npm": "9.x"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mongoose": "^7.0.0",
    "dotenv": "^16.0.3",
    "cors": "^2.8.5"
  }
}
```

**2. Create Procfile**

```bash
# Procfile (no extension)
web: node server.js
```

**3. Server Configuration**

```javascript
// server.js
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
require('dotenv').config();

const app = express();

app.use(cors());
app.use(express.json());

// MongoDB connection
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log('MongoDB connected'))
  .catch(err => console.error('DB error:', err));

// Routes
app.use('/api/users', require('./routes/users'));

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

**4. Deploy**

```bash
# Initialize git (if not already)
git init
git add .
git commit -m "Initial commit"

# Create Heroku app
heroku create my-app-backend

# Set environment variables
heroku config:set MONGO_URI="mongodb+srv://user:pass@cluster.mongodb.net/db"
heroku config:set JWT_SECRET="your_secret_key"

# Deploy
git push heroku main

# View logs
heroku logs --tail

# Open app
heroku open
```

### Full-Stack Deployment (Unified)

**Project Structure**:
```
project/
  client/          # React app
    package.json
    public/
    src/
  server.js        # Express app
  package.json     # Root package.json
  Procfile
```

**Root package.json**:
```json
{
  "scripts": {
    "start": "node server.js",
    "heroku-postbuild": "cd client && npm install && npm run build"
  },
  "engines": {
    "node": "18.x"
  }
}
```

**Server Configuration**:
```javascript
const express = require('express');
const path = require('path');

const app = express();

app.use(express.json());

// API routes
app.use('/api/users', require('./routes/users'));

// Serve static files in production
if (process.env.NODE_ENV === 'production') {
  app.use(express.static(path.join(__dirname, 'client/build')));
  
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'client/build/index.html'));
  });
}

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server on port ${PORT}`));
```

**Deploy**:
```bash
heroku create my-fullstack-app
heroku config:set NODE_ENV=production
heroku config:set MONGO_URI="..."
git push heroku main
```

### Heroku CLI Commands

```bash
# Create app
heroku create app-name

# View apps
heroku apps

# Set env variables
heroku config:set KEY=VALUE
heroku config:set KEY1=VALUE1 KEY2=VALUE2

# View env variables
heroku config
heroku config:get KEY

# View logs
heroku logs --tail
heroku logs --num 200

# Run commands
heroku run node --version
heroku run bash

# Restart app
heroku restart

# Scale dynos
heroku ps:scale web=1

# Open app
heroku open

# Delete app
heroku apps:destroy app-name
```

---

## Vercel Deployment

### Overview

**Vercel** specializes in frontend deployment with serverless functions.

**Best for**:
- React/Next.js applications
- Static sites
- JAMstack architecture

**Pricing**: Free tier with generous limits

### Prerequisites

```bash
# Install Vercel CLI
npm install -g vercel

# Login
vercel login
```

### React App Deployment

**1. Build Configuration**

```json
// package.json
{
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build"
  }
}
```

**2. Create vercel.json**

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "build",
  "devCommand": "npm start",
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/api"
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

**3. Environment Variables**

```bash
# .env.production
REACT_APP_API_URL=https://api.myapp.com/api
```

**4. Deploy**

```bash
# Deploy to preview
vercel

# Deploy to production
vercel --prod

# Set environment variables
vercel env add REACT_APP_API_URL

# View deployments
vercel ls

# View logs
vercel logs
```

### Vercel with GitHub

**1. Connect Repository**
- Go to vercel.com
- Import Git repository
- Select framework (Create React App, Vite, Next.js)
- Configure build settings
- Add environment variables
- Deploy

**2. Auto Deployment**
- Push to `main` → Production deployment
- Push to other branches → Preview deployment
- Pull requests get unique preview URLs

**3. Custom Domain**
```bash
# Add custom domain
vercel domains add myapp.com

# Set up DNS records (provided by Vercel)
# A record: 76.76.21.21
# CNAME: cname.vercel-dns.com
```

---

## Netlify Deployment

### Overview

**Netlify** offers continuous deployment for static sites.

**Best for**:
- Static React applications
- JAMstack sites
- Frontend-only apps

**Pricing**: Free tier available

### Prerequisites

```bash
# Install Netlify CLI
npm install -g netlify-cli

# Login
netlify login
```

### Manual Deployment

**1. Build Application**

```bash
npm run build
```

**2. Deploy**

```bash
# Deploy to draft URL
netlify deploy

# Select build folder: build/

# Deploy to production
netlify deploy --prod
```

### Git-based Deployment

**1. Connect Repository**
- Go to app.netlify.com
- New site from Git
- Connect GitHub/GitLab/Bitbucket
- Configure build settings:
  - Build command: `npm run build`
  - Publish directory: `build/`
  - Environment variables (if any)

**2. netlify.toml Configuration**

```toml
[build]
  command = "npm run build"
  publish = "build"

[build.environment]
  NODE_VERSION = "18"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
```

**3. Environment Variables**

```bash
# Via CLI
netlify env:set REACT_APP_API_URL "https://api.myapp.com"

# Via web interface
# Site settings → Environment variables
```

### Netlify Functions (Serverless)

**Create function**:

```javascript
// netlify/functions/hello.js
exports.handler = async (event, context) => {
  return {
    statusCode: 200,
    body: JSON.stringify({ message: 'Hello from Netlify!' })
  };
};
```

**Access**: `https://yoursite.netlify.app/.netlify/functions/hello`

### Netlify CLI Commands

```bash
# Initialize
netlify init

# Deploy
netlify deploy
netlify deploy --prod

# View site
netlify open

# View logs
netlify logs

# Link to existing site
netlify link

# Env variables
netlify env:list
netlify env:set KEY VALUE
```

---

## Comparison

| Feature | Heroku | Vercel | Netlify |
|---------|--------|--------|----------|
| **Best For** | Full-stack | Frontend/Next.js | Static sites |
| **Backend Support** | ✅ Full | Serverless only | Serverless only |
| **Database** | Add-ons | External | External |
| **Free Tier** | Yes (sleeps) | Yes (generous) | Yes |
| **Auto Deploy** | Git push | GitHub integration | Git integration |
| **Custom Domain** | ✅ | ✅ | ✅ |
| **SSL** | Auto | Auto | Auto |
| **Build Time** | Slower | Fast | Fast |
| **Scaling** | Manual/Auto | Auto | Auto |

---

## Best Practices

### 1. Environment Variables
- Never commit secrets
- Use platform-specific env var management
- Different values for staging/production

### 2. Branch Strategy
- `main` → Production
- `develop` → Staging
- Feature branches → Preview deployments

### 3. Build Optimization
- Minimize bundle size
- Use production builds
- Enable caching

### 4. Monitoring
- Set up error tracking (Sentry)
- Monitor performance
- Configure alerts

---

## Interview Questions

**Q1: Heroku vs Vercel vs Netlify?**
- **Heroku**: Full-stack, backend support
- **Vercel**: Frontend-focused, serverless functions
- **Netlify**: Static sites, JAMstack

**Q2: How to deploy MERN to Heroku?**
1. Create Procfile
2. Set environment variables
3. Configure MongoDB (Atlas)
4. `git push heroku main`

**Q3: Auto-deployment with Vercel?**
- Connect GitHub repository
- Push to main → production
- Push to branch → preview URL

**Q4: How to handle environment variables?**
- Heroku: `heroku config:set`
- Vercel: `vercel env add` or web UI
- Netlify: `netlify env:set` or web UI

**Q5: Custom domain setup?**
1. Add domain in platform settings
2. Update DNS records (A, CNAME)
3. SSL auto-provisioned (Let's Encrypt)

---

## Summary

- **Heroku**: Full-stack, backend support, Procfile, `git push heroku main`
- **Vercel**: Frontend/Next.js, GitHub integration, serverless functions
- **Netlify**: Static sites, netlify.toml, redirects, serverless functions
- **All Three**: Auto-deployment, custom domains, free SSL
- **Best Practice**: Use environment variables, monitor deployments, optimize builds
