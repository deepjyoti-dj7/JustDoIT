# 02. Single & Multiple File Upload

## Introduction

Multer provides different methods for handling single files, multiple files from the same field, or multiple files from different fields.

---

## Single File Upload

### Backend Setup

```javascript
// config/multer.js
const multer = require('multer');
const path = require('path');
const fs = require('fs');

// Create uploads directory if it doesn't exist
const uploadDir = 'uploads/avatars';
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, uploadDir);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ storage });

module.exports = upload;
```

### Single File Route

```javascript
// routes/upload.js
const express = require('express');
const upload = require('../config/multer');
const File = require('../models/File');

const router = express.Router();

// upload.single('fieldname') - 'avatar' is the field name
router.post('/avatar', upload.single('avatar'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: 'No file uploaded' });
    }
    
    // Save file metadata to database
    const fileData = await File.create({
      filename: req.file.filename,
      originalName: req.file.originalname,
      mimetype: req.file.mimetype,
      size: req.file.size,
      path: req.file.path,
      uploadedBy: req.user.id // Assuming authenticated user
    });
    
    res.status(201).json({
      message: 'File uploaded successfully',
      file: {
        id: fileData._id,
        filename: fileData.filename,
        url: `/uploads/avatars/${fileData.filename}`,
        size: fileData.size
      }
    });
  } catch (error) {
    // Clean up file if database save fails
    if (req.file) {
      fs.unlinkSync(req.file.path);
    }
    res.status(500).json({ message: error.message });
  }
});

module.exports = router;
```

### Frontend (React)

```javascript
// components/AvatarUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const AvatarUpload = () => {
  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState(null);
  const [uploading, setUploading] = useState(false);
  const [uploadedUrl, setUploadedUrl] = useState(null);
  
  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    
    if (selectedFile) {
      setFile(selectedFile);
      
      // Create preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setPreview(reader.result);
      };
      reader.readAsDataURL(selectedFile);
    }
  };
  
  const handleUpload = async () => {
    if (!file) {
      alert('Please select a file');
      return;
    }
    
    setUploading(true);
    
    const formData = new FormData();
    formData.append('avatar', file); // 'avatar' matches field name
    
    try {
      const { data } = await axios.post('/api/upload/avatar', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      });
      
      setUploadedUrl(data.file.url);
      alert('File uploaded successfully!');
    } catch (error) {
      alert(error.response?.data?.message || 'Upload failed');
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <div>
      <h2>Upload Avatar</h2>
      
      <input 
        type="file" 
        onChange={handleFileChange}
        accept="image/*"
      />
      
      {preview && (
        <div>
          <h3>Preview:</h3>
          <img src={preview} alt="Preview" width="200" />
        </div>
      )}
      
      <button onClick={handleUpload} disabled={!file || uploading}>
        {uploading ? 'Uploading...' : 'Upload'}
      </button>
      
      {uploadedUrl && (
        <div>
          <h3>Uploaded Image:</h3>
          <img src={uploadedUrl} alt="Uploaded" width="200" />
        </div>
      )}
    </div>
  );
};

export default AvatarUpload;
```

---

## Multiple Files (Same Field)

### Backend Setup

```javascript
// routes/upload.js
// upload.array('fieldname', maxCount)
router.post('/gallery', upload.array('photos', 10), async (req, res) => {
  try {
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ message: 'No files uploaded' });
    }
    
    // Save all files to database
    const filesData = await Promise.all(
      req.files.map(file => 
        File.create({
          filename: file.filename,
          originalName: file.originalname,
          mimetype: file.mimetype,
          size: file.size,
          path: file.path,
          uploadedBy: req.user.id
        })
      )
    );
    
    res.status(201).json({
      message: `${req.files.length} files uploaded successfully`,
      files: filesData.map(file => ({
        id: file._id,
        filename: file.filename,
        url: `/uploads/avatars/${file.filename}`,
        size: file.size
      }))
    });
  } catch (error) {
    // Clean up all uploaded files on error
    if (req.files) {
      req.files.forEach(file => {
        fs.unlinkSync(file.path);
      });
    }
    res.status(500).json({ message: error.message });
  }
});
```

### Frontend (React)

```javascript
// components/GalleryUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const GalleryUpload = () => {
  const [files, setFiles] = useState([]);
  const [previews, setPreviews] = useState([]);
  const [uploading, setUploading] = useState(false);
  
  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    setFiles(selectedFiles);
    
    // Create previews for all files
    const previewPromises = selectedFiles.map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    });
    
    Promise.all(previewPromises).then(setPreviews);
  };
  
  const handleUpload = async () => {
    if (files.length === 0) {
      alert('Please select files');
      return;
    }
    
    setUploading(true);
    
    const formData = new FormData();
    files.forEach(file => {
      formData.append('photos', file); // 'photos' is the field name
    });
    
    try {
      const { data } = await axios.post('/api/upload/gallery', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      });
      
      alert(`${data.files.length} files uploaded successfully!`);
    } catch (error) {
      alert(error.response?.data?.message || 'Upload failed');
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <div>
      <h2>Upload Gallery</h2>
      
      <input 
        type="file" 
        onChange={handleFileChange}
        accept="image/*"
        multiple // Enable multiple file selection
      />
      
      <p>Selected: {files.length} file(s)</p>
      
      {previews.length > 0 && (
        <div>
          <h3>Previews:</h3>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
            {previews.map((preview, index) => (
              <img 
                key={index} 
                src={preview} 
                alt={`Preview ${index}`} 
                width="150" 
              />
            ))}
          </div>
        </div>
      )}
      
      <button onClick={handleUpload} disabled={files.length === 0 || uploading}>
        {uploading ? 'Uploading...' : `Upload ${files.length} file(s)`}
      </button>
    </div>
  );
};

export default GalleryUpload;
```

---

## Multiple Files (Different Fields)

### Backend Setup

```javascript
// routes/upload.js
router.post('/profile', upload.fields([
  { name: 'avatar', maxCount: 1 },
  { name: 'coverPhoto', maxCount: 1 },
  { name: 'gallery', maxCount: 5 }
]), async (req, res) => {
  try {
    // req.files is an object
    // { avatar: [file], coverPhoto: [file], gallery: [file, file, ...] }
    
    const uploadedFiles = {};
    
    if (req.files.avatar) {
      const avatar = req.files.avatar[0];
      uploadedFiles.avatar = {
        filename: avatar.filename,
        url: `/uploads/avatars/${avatar.filename}`
      };
    }
    
    if (req.files.coverPhoto) {
      const cover = req.files.coverPhoto[0];
      uploadedFiles.coverPhoto = {
        filename: cover.filename,
        url: `/uploads/avatars/${cover.filename}`
      };
    }
    
    if (req.files.gallery) {
      uploadedFiles.gallery = req.files.gallery.map(file => ({
        filename: file.filename,
        url: `/uploads/avatars/${file.filename}`
      }));
    }
    
    res.status(201).json({
      message: 'Files uploaded successfully',
      files: uploadedFiles
    });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});
```

### Frontend (React)

```javascript
// components/ProfileUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const ProfileUpload = () => {
  const [avatar, setAvatar] = useState(null);
  const [coverPhoto, setCoverPhoto] = useState(null);
  const [gallery, setGallery] = useState([]);
  const [uploading, setUploading] = useState(false);
  
  const handleUpload = async () => {
    setUploading(true);
    
    const formData = new FormData();
    
    if (avatar) formData.append('avatar', avatar);
    if (coverPhoto) formData.append('coverPhoto', coverPhoto);
    gallery.forEach(file => formData.append('gallery', file));
    
    try {
      const { data } = await axios.post('/api/upload/profile', formData);
      alert('Files uploaded successfully!');
      console.log(data.files);
    } catch (error) {
      alert('Upload failed');
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <div>
      <h2>Profile Upload</h2>
      
      <div>
        <label>Avatar:</label>
        <input 
          type="file" 
          onChange={(e) => setAvatar(e.target.files[0])}
          accept="image/*"
        />
      </div>
      
      <div>
        <label>Cover Photo:</label>
        <input 
          type="file" 
          onChange={(e) => setCoverPhoto(e.target.files[0])}
          accept="image/*"
        />
      </div>
      
      <div>
        <label>Gallery (max 5):</label>
        <input 
          type="file" 
          onChange={(e) => setGallery(Array.from(e.target.files))}
          accept="image/*"
          multiple
        />
      </div>
      
      <button onClick={handleUpload} disabled={uploading}>
        {uploading ? 'Uploading...' : 'Upload All'}
      </button>
    </div>
  );
};

export default ProfileUpload;
```

---

## File Model (Mongoose)

```javascript
// models/File.js
const mongoose = require('mongoose');

const fileSchema = new mongoose.Schema({
  filename: {
    type: String,
    required: true
  },
  originalName: {
    type: String,
    required: true
  },
  mimetype: {
    type: String,
    required: true
  },
  size: {
    type: Number,
    required: true
  },
  path: {
    type: String,
    required: true
  },
  uploadedBy: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User',
    required: true
  },
  uploadedAt: {
    type: Date,
    default: Date.now
  }
});

module.exports = mongoose.model('File', fileSchema);
```

---

## Serving Static Files

```javascript
// server.js
const express = require('express');
const path = require('path');

const app = express();

// Serve uploaded files
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// Now files are accessible at:
// http://localhost:5000/uploads/avatars/avatar-1234567890.jpg
```

---

## Interview Questions

**Q1: How do you upload a single file with Multer?**
```javascript
app.post('/upload', upload.single('avatar'), (req, res) => {
  console.log(req.file); // Single file
});
```

**Q2: How do you upload multiple files from the same input?**
```javascript
app.post('/upload', upload.array('photos', 10), (req, res) => {
  console.log(req.files); // Array of files
});
```

**Q3: What's the difference between req.file and req.files?**
- `req.file`: Single file (with `upload.single()`)
- `req.files`: Multiple files (with `upload.array()` or `upload.fields()`)

**Q4: How do you handle different file fields?**
```javascript
upload.fields([
  { name: 'avatar', maxCount: 1 },
  { name: 'photos', maxCount: 5 }
])
// Access: req.files.avatar, req.files.photos
```

**Q5: How do you clean up files if database save fails?**
```javascript
try {
  await File.create(data);
} catch (error) {
  fs.unlinkSync(req.file.path); // Delete uploaded file
  throw error;
}
```

---

## Best Practices

1. **Check if files exist** before processing
2. **Save metadata to database** for tracking
3. **Clean up files** on error
4. **Set max file count** to prevent abuse
5. **Use FormData** on frontend for file uploads
6. **Show previews** before uploading
7. **Create upload directory** if it doesn't exist
8. **Use unique filenames** to avoid conflicts
9. **Validate file types** on both frontend and backend
10. **Serve static files** properly with Express

---

## Summary

- **Single file**: `upload.single('fieldname')` → `req.file`
- **Multiple files (same field)**: `upload.array('fieldname', max)` → `req.files`
- **Multiple fields**: `upload.fields([{name, maxCount}])` → `req.files.fieldname`
- **Frontend**: Use `FormData` with `multipart/form-data`
- **Add `multiple` attribute** to input for multiple files
- **Save metadata** to database for tracking
- **Clean up files** if processing fails
- **Serve static files** with `express.static()`
