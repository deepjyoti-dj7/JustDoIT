# 01. File Upload Overview & Multer

## Introduction

File upload is a common feature in web applications. In Node.js/Express, handling multipart/form-data (file uploads) requires special middleware like **Multer**.

---

## Why File Upload?

### Common Use Cases

1. **Profile Pictures** - User avatars
2. **Document Upload** - PDFs, Word documents
3. **Media Content** - Images, videos, audio
4. **CSV Import** - Bulk data upload
5. **Attachments** - Email attachments, chat files

---

## File Upload Flow

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ Client  │─────▶│ Multer  │─────▶│ Server  │─────▶│ Storage │
│ Browser │      │Middleware│      │ Handler │      │Local/Cloud│
└─────────┘      └─────────┘      └─────────┘      └─────────┘
    │                 │                 │                │
    │ Send File       │ Parse File      │ Process File   │ Save File
    │                 │ Validate        │ Save Metadata  │
    │                 │ Save to Disk    │ Return URL     │
```

---

## What is Multer?

**Multer** is a Node.js middleware for handling `multipart/form-data`, primarily used for uploading files.

### Key Features

- Parse multipart/form-data
- Handle single/multiple file uploads
- File filtering (type, size)
- Custom storage engines
- Memory and disk storage

---

## Installation

```bash
npm install multer
```

---

## Basic Setup

### 1. **Import and Configure**

```javascript
// server.js
const express = require('express');
const multer = require('multer');

const app = express();

// Basic configuration (stores in memory)
const upload = multer({ dest: 'uploads/' });

app.post('/upload', upload.single('file'), (req, res) => {
  console.log(req.file); // File information
  console.log(req.body); // Other form fields
  
  res.json({
    message: 'File uploaded successfully',
    file: req.file
  });
});

app.listen(5000, () => console.log('Server running on port 5000'));
```

### 2. **File Object Structure**

```javascript
{
  fieldname: 'file',              // Field name from form
  originalname: 'image.jpg',      // Original file name
  encoding: '7bit',               // Encoding type
  mimetype: 'image/jpeg',         // MIME type
  destination: 'uploads/',        // Destination folder
  filename: '1a2b3c4d5e',        // Generated filename
  path: 'uploads/1a2b3c4d5e',    // Full path
  size: 245632                    // Size in bytes
}
```

---

## Storage Options

### 1. **Disk Storage**

Stores files on the server's disk.

```javascript
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/'); // Folder to store files
  },
  filename: (req, file, cb) => {
    // Generate unique filename
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ storage });
```

### 2. **Memory Storage**

Stores files in memory as `Buffer` objects (temporary).

```javascript
const storage = multer.memoryStorage();
const upload = multer({ storage });

app.post('/upload', upload.single('file'), (req, res) => {
  console.log(req.file.buffer); // File data as Buffer
  
  // Use case: Upload to cloud storage without saving locally
  // cloudinary.uploader.upload_stream(req.file.buffer);
});
```

---

## File Upload Methods

### 1. **Single File Upload**

```javascript
// upload.single('fieldname')
app.post('/upload/single', upload.single('avatar'), (req, res) => {
  res.json({ file: req.file });
});
```

### 2. **Multiple Files (Same Field)**

```javascript
// upload.array('fieldname', maxCount)
app.post('/upload/multiple', upload.array('photos', 5), (req, res) => {
  res.json({ files: req.files }); // Array of files
});
```

### 3. **Multiple Files (Different Fields)**

```javascript
// upload.fields([{ name, maxCount }])
app.post('/upload/fields', upload.fields([
  { name: 'avatar', maxCount: 1 },
  { name: 'gallery', maxCount: 5 }
]), (req, res) => {
  console.log(req.files.avatar);  // [file]
  console.log(req.files.gallery); // [file, file, ...]
  
  res.json({ files: req.files });
});
```

### 4. **No Files (Text Only)**

```javascript
// upload.none() - No files expected
app.post('/upload/text', upload.none(), (req, res) => {
  console.log(req.body); // Only text fields
  res.json({ data: req.body });
});
```

### 5. **Any Files**

```javascript
// upload.any() - Accept all files
app.post('/upload/any', upload.any(), (req, res) => {
  console.log(req.files); // Array of all files
  res.json({ files: req.files });
});
```

---

## Complete Example

```javascript
// config/multer.js
const multer = require('multer');
const path = require('path');

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ 
  storage,
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|gif/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);
    
    if (extname && mimetype) {
      cb(null, true);
    } else {
      cb(new Error('Only images are allowed'));
    }
  }
});

module.exports = upload;
```

```javascript
// routes/upload.js
const express = require('express');
const upload = require('../config/multer');

const router = express.Router();

router.post('/single', upload.single('avatar'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: 'No file uploaded' });
    }
    
    res.json({
      message: 'File uploaded successfully',
      file: {
        filename: req.file.filename,
        path: req.file.path,
        size: req.file.size
      }
    });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

module.exports = router;
```

```javascript
// server.js
const express = require('express');
const uploadRoutes = require('./routes/upload');

const app = express();

app.use('/api/upload', uploadRoutes);

app.listen(5000, () => console.log('Server running on port 5000'));
```

---

## Error Handling

```javascript
app.post('/upload', upload.single('file'), (req, res) => {
  // Handle upload
});

// Error handling middleware
app.use((err, req, res, next) => {
  if (err instanceof multer.MulterError) {
    // Multer-specific errors
    if (err.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({ message: 'File too large' });
    }
    if (err.code === 'LIMIT_FILE_COUNT') {
      return res.status(400).json({ message: 'Too many files' });
    }
    if (err.code === 'LIMIT_UNEXPECTED_FILE') {
      return res.status(400).json({ message: 'Unexpected field name' });
    }
  } else if (err) {
    // Other errors (from fileFilter)
    return res.status(400).json({ message: err.message });
  }
  
  next();
});
```

---

## Interview Questions

**Q1: What is Multer and why do we need it?**
- Multer is middleware for handling `multipart/form-data` (file uploads)
- Express doesn't parse multipart data by default
- Multer provides file parsing, validation, and storage

**Q2: What's the difference between diskStorage and memoryStorage?**
- **diskStorage**: Saves files to disk, persists across requests
- **memoryStorage**: Stores in memory as Buffer, temporary (good for cloud uploads)

**Q3: How do you handle file size limits?**
```javascript
const upload = multer({ 
  limits: { 
    fileSize: 5 * 1024 * 1024, // 5MB
    files: 10                   // Max 10 files
  } 
});
```

**Q4: How do you validate file types?**
Use `fileFilter` callback:
```javascript
fileFilter: (req, file, cb) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(new Error('Only images allowed'), false);
  }
}
```

**Q5: What fields are available in req.file?**
- `fieldname`, `originalname`, `encoding`, `mimetype`
- `destination`, `filename`, `path`, `size`
- `buffer` (if using memoryStorage)

---

## Best Practices

1. **Set file size limits** to prevent abuse
2. **Validate file types** using mimetype and extension
3. **Generate unique filenames** to avoid conflicts
4. **Use memory storage** for cloud uploads
5. **Handle errors properly** with error middleware
6. **Create uploads directory** before starting server
7. **Use path.join()** for cross-platform compatibility
8. **Clean up failed uploads** using error handlers
9. **Store file metadata** in database
10. **Use environment variables** for upload paths

---

## Summary

- **Multer** is middleware for handling file uploads in Express
- Supports **single**, **multiple**, and **field-specific** uploads
- Two storage options: **diskStorage** (persistent) and **memoryStorage** (temporary)
- Use **fileFilter** for file type validation
- Set **limits** for file size and count
- Handle **errors** with Multer-specific error middleware
- `req.file` contains single file info, `req.files` for multiple
- Always **validate** and **sanitize** uploaded files
