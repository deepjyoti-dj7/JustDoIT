# 08. Progress Tracking & Preview

## Introduction

Providing visual feedback during file uploads enhances user experience. Progress tracking shows upload status, while previews allow users to verify files before uploading.

---

## Upload Progress Tracking

### Basic Progress Bar (Axios)

```javascript
// components/ProgressUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const ProgressUpload = () => {
  const [file, setFile] = useState(null);
  const [progress, setProgress] = useState(0);
  const [uploading, setUploading] = useState(false);
  
  const handleUpload = async () => {
    if (!file) return;
    
    setUploading(true);
    setProgress(0);
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const { data } = await axios.post('/api/upload', formData, {
        headers: {
          'Content-Type': 'multipart/form-data'
        },
        onUploadProgress: (progressEvent) => {
          const percentCompleted = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          );
          setProgress(percentCompleted);
        }
      });
      
      alert('Upload complete!');
    } catch (error) {
      alert('Upload failed');
    } finally {
      setUploading(false);
    }
  };
  
  return (
    <div>
      <input 
        type="file" 
        onChange={(e) => setFile(e.target.files[0])}
        disabled={uploading}
      />
      
      <button onClick={handleUpload} disabled={!file || uploading}>
        {uploading ? 'Uploading...' : 'Upload'}
      </button>
      
      {uploading && (
        <div>
          <div style={{
            width: '100%',
            height: '20px',
            backgroundColor: '#e0e0e0',
            borderRadius: '10px',
            marginTop: '10px',
            overflow: 'hidden'
          }}>
            <div style={{
              width: `${progress}%`,
              height: '100%',
              backgroundColor: '#4CAF50',
              transition: 'width 0.3s'
            }} />
          </div>
          <p>{progress}%</p>
        </div>
      )}
    </div>
  );
};

export default ProgressUpload;
```

### Multiple Files with Individual Progress

```javascript
// components/MultipleProgressUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const MultipleProgressUpload = () => {
  const [files, setFiles] = useState([]);
  const [fileProgress, setFileProgress] = useState({});
  
  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    setFiles(selectedFiles);
    
    // Initialize progress for each file
    const initialProgress = {};
    selectedFiles.forEach((file, index) => {
      initialProgress[index] = 0;
    });
    setFileProgress(initialProgress);
  };
  
  const uploadFile = async (file, index) => {
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      await axios.post('/api/upload', formData, {
        onUploadProgress: (progressEvent) => {
          const percentCompleted = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          );
          
          setFileProgress(prev => ({
            ...prev,
            [index]: percentCompleted
          }));
        }
      });
    } catch (error) {
      console.error(`Upload failed for ${file.name}`);
    }
  };
  
  const handleUploadAll = async () => {
    await Promise.all(
      files.map((file, index) => uploadFile(file, index))
    );
    
    alert('All files uploaded!');
  };
  
  return (
    <div>
      <input type="file" onChange={handleFileChange} multiple />
      
      <button onClick={handleUploadAll} disabled={files.length === 0}>
        Upload All
      </button>
      
      {files.length > 0 && (
        <div style={{ marginTop: '20px' }}>
          {files.map((file, index) => (
            <div key={index} style={{ marginBottom: '15px' }}>
              <p>{file.name}</p>
              <div style={{
                width: '100%',
                height: '10px',
                backgroundColor: '#e0e0e0',
                borderRadius: '5px',
                overflow: 'hidden'
              }}>
                <div style={{
                  width: `${fileProgress[index] || 0}%`,
                  height: '100%',
                  backgroundColor: fileProgress[index] === 100 ? '#4CAF50' : '#2196F3',
                  transition: 'width 0.3s'
                }} />
              </div>
              <p style={{ fontSize: '12px' }}>
                {fileProgress[index] || 0}%
                {fileProgress[index] === 100 && ' ✓'}
              </p>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default MultipleProgressUpload;
```

---

## Image Preview

### Single Image Preview

```javascript
// components/ImagePreview.jsx
import { useState } from 'react';

const ImagePreview = () => {
  const [file, setFile] = useState(null);
  const [preview, setPreview] = useState(null);
  
  const handleFileChange = (e) => {
    const selectedFile = e.target.files[0];
    
    if (selectedFile) {
      setFile(selectedFile);
      
      // Create preview using FileReader
      const reader = new FileReader();
      reader.onloadend = () => {
        setPreview(reader.result);
      };
      reader.readAsDataURL(selectedFile);
    }
  };
  
  // Alternative: Using URL.createObjectURL
  const handleFileChangeAlt = (e) => {
    const selectedFile = e.target.files[0];
    
    if (selectedFile) {
      setFile(selectedFile);
      
      // Create object URL
      const objectUrl = URL.createObjectURL(selectedFile);
      setPreview(objectUrl);
      
      // Clean up object URL when component unmounts
      return () => URL.revokeObjectURL(objectUrl);
    }
  };
  
  return (
    <div>
      <input 
        type="file" 
        onChange={handleFileChange}
        accept="image/*"
      />
      
      {preview && (
        <div style={{ marginTop: '20px' }}>
          <h3>Preview:</h3>
          <img 
            src={preview} 
            alt="Preview" 
            style={{ 
              maxWidth: '400px', 
              maxHeight: '400px',
              border: '2px solid #ddd',
              borderRadius: '8px'
            }}
          />
          <div style={{ marginTop: '10px' }}>
            <p>Filename: {file.name}</p>
            <p>Size: {(file.size / 1024).toFixed(2)} KB</p>
            <p>Type: {file.type}</p>
          </div>
        </div>
      )}
    </div>
  );
};

export default ImagePreview;
```

### Multiple Image Preview (Grid)

```javascript
// components/MultipleImagePreview.jsx
import { useState } from 'react';

const MultipleImagePreview = () => {
  const [files, setFiles] = useState([]);
  const [previews, setPreviews] = useState([]);
  
  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    setFiles(selectedFiles);
    
    // Create previews for all files
    const previewPromises = selectedFiles.map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          resolve({
            name: file.name,
            size: file.size,
            preview: reader.result
          });
        };
        reader.readAsDataURL(file);
      });
    });
    
    Promise.all(previewPromises).then(setPreviews);
  };
  
  const removePreview = (index) => {
    setFiles(files.filter((_, i) => i !== index));
    setPreviews(previews.filter((_, i) => i !== index));
  };
  
  return (
    <div>
      <input 
        type="file" 
        onChange={handleFileChange}
        accept="image/*"
        multiple
      />
      
      {previews.length > 0 && (
        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
          gap: '15px',
          marginTop: '20px'
        }}>
          {previews.map((item, index) => (
            <div 
              key={index}
              style={{
                position: 'relative',
                border: '2px solid #ddd',
                borderRadius: '8px',
                overflow: 'hidden'
              }}
            >
              <img 
                src={item.preview} 
                alt={item.name}
                style={{
                  width: '100%',
                  height: '200px',
                  objectFit: 'cover'
                }}
              />
              
              <button
                onClick={() => removePreview(index)}
                style={{
                  position: 'absolute',
                  top: '5px',
                  right: '5px',
                  backgroundColor: 'rgba(255, 0, 0, 0.7)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '50%',
                  width: '30px',
                  height: '30px',
                  cursor: 'pointer'
                }}
              >
                X
              </button>
              
              <div style={{ padding: '10px', backgroundColor: '#f5f5f5' }}>
                <p style={{ margin: '0', fontSize: '12px', fontWeight: 'bold' }}>
                  {item.name}
                </p>
                <p style={{ margin: '0', fontSize: '11px', color: '#666' }}>
                  {(item.size / 1024).toFixed(2)} KB
                </p>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

export default MultipleImagePreview;
```

---

## Complete Upload Component with Progress and Preview

```javascript
// components/CompleteUpload.jsx
import { useState } from 'react';
import axios from 'axios';

const CompleteUpload = () => {
  const [files, setFiles] = useState([]);
  const [previews, setPreviews] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState({});
  const [uploadedFiles, setUploadedFiles] = useState([]);
  
  const handleFileChange = (e) => {
    const selectedFiles = Array.from(e.target.files);
    
    // Validate files
    const validFiles = selectedFiles.filter(file => {
      if (file.size > 5 * 1024 * 1024) {
        alert(`${file.name} is too large (max 5MB)`);
        return false;
      }
      if (!file.type.startsWith('image/')) {
        alert(`${file.name} is not an image`);
        return false;
      }
      return true;
    });
    
    if (validFiles.length === 0) return;
    
    setFiles(validFiles);
    
    // Create previews
    const previewPromises = validFiles.map((file, index) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          resolve({
            index,
            name: file.name,
            size: file.size,
            preview: reader.result
          });
        };
        reader.readAsDataURL(file);
      });
    });
    
    Promise.all(previewPromises).then(setPreviews);
    
    // Initialize progress
    const initialProgress = {};
    validFiles.forEach((_, index) => {
      initialProgress[index] = 0;
    });
    setUploadProgress(initialProgress);
  };
  
  const uploadFile = async (file, index) => {
    const formData = new FormData();
    formData.append('image', file);
    
    try {
      const { data } = await axios.post('/api/upload/image', formData, {
        onUploadProgress: (progressEvent) => {
          const percentCompleted = Math.round(
            (progressEvent.loaded * 100) / progressEvent.total
          );
          
          setUploadProgress(prev => ({
            ...prev,
            [index]: percentCompleted
          }));
        }
      });
      
      return data;
    } catch (error) {
      console.error(`Upload failed for ${file.name}`);
      throw error;
    }
  };
  
  const handleUpload = async () => {
    setUploading(true);
    
    try {
      const results = await Promise.all(
        files.map((file, index) => uploadFile(file, index))
      );
      
      setUploadedFiles(results);
      alert('All files uploaded successfully!');
      
      // Reset
      setFiles([]);
      setPreviews([]);
      setUploadProgress({});
    } catch (error) {
      alert('Some uploads failed');
    } finally {
      setUploading(false);
    }
  };
  
  const removeFile = (index) => {
    setFiles(files.filter((_, i) => i !== index));
    setPreviews(previews.filter(p => p.index !== index));
  };
  
  return (
    <div style={{ maxWidth: '800px', margin: '0 auto', padding: '20px' }}>
      <h2>Upload Images with Progress & Preview</h2>
      
      <div style={{
        border: '2px dashed #ccc',
        borderRadius: '8px',
        padding: '40px',
        textAlign: 'center',
        marginBottom: '20px'
      }}>
        <input 
          type="file" 
          onChange={handleFileChange}
          accept="image/*"
          multiple
          style={{ display: 'none' }}
          id="file-input"
          disabled={uploading}
        />
        <label htmlFor="file-input" style={{ cursor: 'pointer' }}>
          <p style={{ fontSize: '18px', margin: '10px 0' }}>Choose Images</p>
          <p style={{ color: '#888', fontSize: '14px' }}>
            Max 5MB per file • JPEG, PNG, GIF, WebP
          </p>
        </label>
      </div>
      
      {previews.length > 0 && (
        <div>
          <h3>Selected Images ({files.length})</h3>
          
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
            gap: '20px',
            marginBottom: '20px'
          }}>
            {previews.map((item) => (
              <div 
                key={item.index}
                style={{
                  border: '1px solid #ddd',
                  borderRadius: '8px',
                  overflow: 'hidden',
                  position: 'relative'
                }}
              >
                <img 
                  src={item.preview} 
                  alt={item.name}
                  style={{
                    width: '100%',
                    height: '200px',
                    objectFit: 'cover'
                  }}
                />
                
                {!uploading && (
                  <button
                    onClick={() => removeFile(item.index)}
                    style={{
                      position: 'absolute',
                      top: '10px',
                      right: '10px',
                      backgroundColor: 'rgba(255, 0, 0, 0.8)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      padding: '5px 10px',
                      cursor: 'pointer'
                    }}
                  >
                    Remove
                  </button>
                )}
                
                <div style={{ padding: '10px' }}>
                  <p style={{ margin: '0 0 5px 0', fontSize: '14px', fontWeight: 'bold' }}>
                    {item.name}
                  </p>
                  <p style={{ margin: '0', fontSize: '12px', color: '#666' }}>
                    {(item.size / 1024).toFixed(2)} KB
                  </p>
                  
                  {uploading && (
                    <div style={{ marginTop: '10px' }}>
                      <div style={{
                        width: '100%',
                        height: '8px',
                        backgroundColor: '#e0e0e0',
                        borderRadius: '4px',
                        overflow: 'hidden'
                      }}>
                        <div style={{
                          width: `${uploadProgress[item.index] || 0}%`,
                          height: '100%',
                          backgroundColor: uploadProgress[item.index] === 100 ? '#4CAF50' : '#2196F3',
                          transition: 'width 0.3s'
                        }} />
                      </div>
                      <p style={{ margin: '5px 0 0 0', fontSize: '12px', textAlign: 'center' }}>
                        {uploadProgress[item.index] || 0}%
                      </p>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
          
          <button 
            onClick={handleUpload}
            disabled={uploading}
            style={{
              width: '100%',
              padding: '15px',
              fontSize: '16px',
              backgroundColor: uploading ? '#ccc' : '#4CAF50',
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              cursor: uploading ? 'not-allowed' : 'pointer'
            }}
          >
            {uploading ? 'Uploading...' : `Upload ${files.length} file(s)`}
          </button>
        </div>
      )}
      
      {uploadedFiles.length > 0 && (
        <div style={{ marginTop: '30px' }}>
          <h3>Uploaded Files</h3>
          <ul>
            {uploadedFiles.map((file, index) => (
              <li key={index}>
                <a href={file.url} target="_blank" rel="noopener noreferrer">
                  {file.filename}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

export default CompleteUpload;
```

---

## Interview Questions

**Q1: How do you track upload progress in axios?**
```javascript
axios.post(url, formData, {
  onUploadProgress: (progressEvent) => {
    const percent = Math.round(
      (progressEvent.loaded * 100) / progressEvent.total
    );
    setProgress(percent);
  }
});
```

**Q2: How do you create image previews?**
**Method 1** - FileReader:
```javascript
const reader = new FileReader();
reader.onloadend = () => setPreview(reader.result);
reader.readAsDataURL(file);
```

**Method 2** - Object URL:
```javascript
const url = URL.createObjectURL(file);
setPreview(url);
// Don't forget: URL.revokeObjectURL(url);
```

**Q3: What's the difference between FileReader and URL.createObjectURL?**
- **FileReader**: Reads file content into base64 string, slower
- **createObjectURL**: Creates temporary URL, faster, must be revoked

**Q4: How do you track progress for multiple files?**
Use an object to store progress for each file by index:
```javascript
const [fileProgress, setFileProgress] = useState({});
setFileProgress(prev => ({ ...prev, [index]: percent }));
```

**Q5: How do you clean up object URLs?**
```javascript
URL.revokeObjectURL(objectUrl);
// Or in useEffect:
useEffect(() => {
  return () => URL.revokeObjectURL(objectUrl);
}, [objectUrl]);
```

---

## Best Practices

1. **Show progress** for files larger than 1MB
2. **Use FileReader** for small files, **createObjectURL** for large
3. **Revoke object URLs** to prevent memory leaks
4. **Display file info** (name, size, type) in preview
5. **Allow removing** files before upload
6. **Show individual progress** for multiple files
7. **Validate files** before creating previews
8. **Use grid layout** for multiple image previews
9. **Disable inputs** while uploading
10. **Provide visual feedback** (colors, animations)

---

## Summary

- **Progress tracking**: Use axios `onUploadProgress` callback
- **Progress percentage**: `(loaded / total) * 100`
- **Image preview**: `FileReader.readAsDataURL()` or `URL.createObjectURL()`
- **Multiple previews**: Use `Promise.all()` with FileReader
- **Individual progress**: Store progress object with file index as key
- **Clean up**: Revoke object URLs with `URL.revokeObjectURL()`
- **Visual feedback**: Progress bar, percentage, thumbnails
- **UX**: Disable inputs while uploading, allow file removal
