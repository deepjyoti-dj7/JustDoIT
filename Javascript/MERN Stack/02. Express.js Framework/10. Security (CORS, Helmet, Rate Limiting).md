# 10. Security (CORS, Helmet, Rate Limiting)

## CORS (Cross-Origin Resource Sharing)

### What is CORS?

Allows controlled access from different origins (domains).

**Same Origin:**
```
http://example.com:3000/api  ✅
http://example.com:3000/data ✅
```

**Cross Origin:**
```
http://example.com:3000      → http://api.example.com     ❌
http://example.com           → https://example.com        ❌
http://example.com:3000      → http://example.com:4000    ❌
```

---

### CORS Setup

```bash
npm install cors
```

**Allow all origins:**

```javascript
const express = require('express');
const cors = require('cors');

const app = express();

app.use(cors());  // ⚠️ Not recommended for production

app.get('/api/data', (req, res) => {
  res.json({ message: 'CORS enabled' });
});
```

---

### CORS Options

**Allow specific origin:**

```javascript
app.use(cors({
  origin: 'http://localhost:3000'
}));
```

**Allow multiple origins:**

```javascript
const allowedOrigins = [
  'http://localhost:3000',
  'https://example.com',
  'https://app.example.com'
];

app.use(cors({
  origin: (origin, callback) => {
    if (!origin || allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  }
}));
```

**Full options:**

```javascript
app.use(cors({
  origin: 'http://localhost:3000',
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,  // Allow cookies
  maxAge: 86400       // Cache preflight for 24 hours
}));
```

---

### CORS for Specific Routes

```javascript
// Only for this route
app.get('/api/public', cors(), (req, res) => {
  res.json({ message: 'Public data' });
});

// Protected route (no CORS)
app.get('/api/private', (req, res) => {
  res.json({ message: 'Private data' });
});
```

---

### CORS with Credentials

```javascript
// Server
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));

// Client (fetch)
fetch('http://localhost:4000/api/data', {
  credentials: 'include'
});
```

---

## Helmet (Security Headers)

### What is Helmet?

Sets secure HTTP headers to protect against common vulnerabilities.

---

### Helmet Setup

```bash
npm install helmet
```

```javascript
const express = require('express');
const helmet = require('helmet');

const app = express();

app.use(helmet());  // Enable all default protections
```

---

### What Helmet Does

| Header | Protection |
|--------|------------|
| `X-DNS-Prefetch-Control` | DNS prefetch control |
| `X-Frame-Options` | Clickjacking |
| `X-Content-Type-Options` | MIME sniffing |
| `Strict-Transport-Security` | HTTPS enforcement |
| `X-Download-Options` | Download options |
| `X-Permitted-Cross-Domain-Policies` | Cross-domain policies |

---

### Custom Helmet Configuration

```javascript
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'", "https://cdn.example.com"]
    }
  },
  hsts: {
    maxAge: 31536000,  // 1 year
    includeSubDomains: true,
    preload: true
  }
}));
```

---

### Individual Helmet Middlewares

```javascript
// Use specific protections
app.use(helmet.noSniff());              // X-Content-Type-Options
app.use(helmet.frameguard());           // X-Frame-Options
app.use(helmet.xssFilter());            // X-XSS-Protection
app.use(helmet.hidePoweredBy());        // Remove X-Powered-By
app.use(helmet.hsts({                   // HSTS
  maxAge: 31536000
}));
```

---

### Content Security Policy (CSP)

```javascript
app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],
    scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net"],
    styleSrc: ["'self'", "'unsafe-inline'"],
    imgSrc: ["'self'", "data:", "https:"],
    connectSrc: ["'self'", "https://api.example.com"],
    fontSrc: ["'self'", "https://fonts.gstatic.com"],
    objectSrc: ["'none'"],
    upgradeInsecureRequests: []
  }
}));
```

---

## Rate Limiting

### What is Rate Limiting?

Limits number of requests from same IP to prevent abuse.

---

### express-rate-limit Setup

```bash
npm install express-rate-limit
```

```javascript
const express = require('express');
const rateLimit = require('express-rate-limit');

const app = express();

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 minutes
  max: 100,                   // Max 100 requests per window
  message: 'Too many requests, please try again later'
});

app.use(limiter);  // Apply to all routes
```

---

### Rate Limit Options

```javascript
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,     // Time window
  max: 100,                      // Max requests
  message: 'Too many requests',  // Error message
  statusCode: 429,               // HTTP status
  standardHeaders: true,         // Return rate limit info
  legacyHeaders: false,          // Disable X-RateLimit-* headers
  skip: (req) => {               // Skip certain requests
    return req.ip === '127.0.0.1';
  },
  keyGenerator: (req) => {       // Custom key (default: IP)
    return req.headers['x-api-key'] || req.ip;
  }
});
```

---

### Route-Specific Rate Limiting

```javascript
// General limiter
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});

// Strict limiter for login
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'Too many login attempts'
});

app.use('/api', generalLimiter);
app.post('/login', loginLimiter, (req, res) => {
  res.send('Login');
});
```

---

### Advanced Rate Limiting

**IP + User combination:**

```javascript
const limiter = rateLimit({
  windowMs: 60 * 1000,
  max: 10,
  keyGenerator: (req) => {
    return req.user ? `${req.ip}-${req.user.id}` : req.ip;
  }
});
```

**Custom response:**

```javascript
const limiter = rateLimit({
  windowMs: 60 * 1000,
  max: 5,
  handler: (req, res) => {
    res.status(429).json({
      error: 'Rate limit exceeded',
      retryAfter: req.rateLimit.resetTime
    });
  }
});
```

**Store in Redis:**

```bash
npm install rate-limit-redis
```

```javascript
const RedisStore = require('rate-limit-redis');
const redis = require('redis');

const client = redis.createClient();

const limiter = rateLimit({
  store: new RedisStore({
    client: client
  }),
  windowMs: 15 * 60 * 1000,
  max: 100
});
```

---

## Complete Security Setup

```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');

const app = express();

// 1. CORS
app.use(cors({
  origin: ['http://localhost:3000', 'https://example.com'],
  credentials: true
}));

// 2. Helmet (Security headers)
app.use(helmet());

// 3. Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: 'Too many requests'
});
app.use('/api', limiter);

// 4. Strict limiter for auth
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'Too many login attempts'
});

app.use(express.json());

// Routes
app.post('/login', authLimiter, (req, res) => {
  res.json({ message: 'Login successful' });
});

app.get('/api/data', (req, res) => {
  res.json({ data: 'Protected data' });
});

app.listen(3000, () => {
  console.log('Secure server running on port 3000');
});
```

---

## Additional Security Practices

### 1. Validate Input

```javascript
const { body, validationResult } = require('express-validator');

app.post('/user',
  body('email').isEmail(),
  body('password').isLength({ min: 6 }),
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    res.send('Valid input');
  }
);
```

### 2. Sanitize Input

```javascript
const validator = require('validator');

app.post('/comment', (req, res) => {
  const clean = validator.escape(req.body.comment);
  res.json({ comment: clean });
});
```

### 3. Environment Variables

```javascript
require('dotenv').config();

const SECRET = process.env.SECRET_KEY;
const PORT = process.env.PORT || 3000;
```

### 4. HTTPS Only

```javascript
app.use((req, res, next) => {
  if (!req.secure && process.env.NODE_ENV === 'production') {
    return res.redirect('https://' + req.headers.host + req.url);
  }
  next();
});
```

### 5. Hide Sensitive Info

```javascript
// Remove X-Powered-By header
app.disable('x-powered-by');

// Or use helmet
app.use(helmet.hidePoweredBy());
```

---

## Security Checklist

✅ **CORS**: Restrict origins  
✅ **Helmet**: Enable security headers  
✅ **Rate Limiting**: Prevent brute force  
✅ **Input Validation**: Validate all inputs  
✅ **HTTPS**: Use SSL certificates  
✅ **Environment Variables**: Hide secrets  
✅ **Authentication**: Use JWT or sessions  
✅ **Password Hashing**: Use bcrypt  
✅ **SQL Injection**: Use parameterized queries  
✅ **XSS Protection**: Sanitize inputs  
❌ **Don't trust client**: Validate server-side  
❌ **Don't expose errors**: In production  
❌ **Don't hardcode secrets**: Use .env  

---

## Summary

**CORS:**
- Control cross-origin access
- `cors()` - Allow all (dev)
- `cors({ origin })` - Restrict (prod)

**Helmet:**
- Security headers
- `helmet()` - Enable all
- Protects against XSS, clickjacking, MIME sniffing

**Rate Limiting:**
- Prevent abuse
- `rateLimit({ windowMs, max })`
- Use different limits for auth routes

**Common Pattern:**
```javascript
app.use(cors({ origin: 'http://localhost:3000' }));
app.use(helmet());
app.use(rateLimit({ windowMs: 15*60*1000, max: 100 }));
```

**Next:** Learn about Template Engines!
