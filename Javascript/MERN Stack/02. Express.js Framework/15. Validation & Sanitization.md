# 15. Validation & Sanitization

## Why Validate?

✅ Prevent invalid data  
✅ Security (SQL injection, XSS)  
✅ Data integrity  
✅ Better user experience  

---

## express-validator

### Installation

```bash
npm install express-validator
```

---

## Basic Validation

```javascript
const { body, validationResult } = require('express-validator');

app.post('/register',
  // Validation rules
  body('email').isEmail(),
  body('password').isLength({ min: 6 }),
  
  // Handle request
  (req, res) => {
    const errors = validationResult(req);
    
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    
    res.json({ message: 'User registered' });
  }
);
```

---

## Validation Rules

### Email

```javascript
body('email')
  .isEmail()
  .withMessage('Invalid email')
  .normalizeEmail();
```

### Password

```javascript
body('password')
  .isLength({ min: 6 })
  .withMessage('Password must be at least 6 characters')
  .matches(/\d/)
  .withMessage('Password must contain a number');
```

### String Length

```javascript
body('username')
  .isLength({ min: 3, max: 20 })
  .withMessage('Username must be 3-20 characters');
```

### Required Field

```javascript
body('name')
  .notEmpty()
  .withMessage('Name is required')
  .trim();
```

### Number

```javascript
body('age')
  .isInt({ min: 18, max: 100 })
  .withMessage('Age must be between 18 and 100');
```

### URL

```javascript
body('website')
  .isURL()
  .withMessage('Invalid URL');
```

---

## Sanitization

```javascript
body('email')
  .isEmail()
  .normalizeEmail();  // Convert to lowercase, remove dots

body('name')
  .trim()             // Remove whitespace
  .escape();          // Escape HTML characters

body('bio')
  .trim()
  .stripLow();        // Remove control characters
```

---

## Complete Example

```javascript
const express = require('express');
const { body, validationResult } = require('express-validator');

const app = express();
app.use(express.json());

// Registration endpoint
app.post('/register',
  // Validation middleware
  [
    body('username')
      .trim()
      .isLength({ min: 3, max: 20 })
      .withMessage('Username must be 3-20 characters')
      .isAlphanumeric()
      .withMessage('Username must be alphanumeric'),
    
    body('email')
      .isEmail()
      .withMessage('Invalid email')
      .normalizeEmail(),
    
    body('password')
      .isLength({ min: 8 })
      .withMessage('Password must be at least 8 characters')
      .matches(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])/)
      .withMessage('Password must contain uppercase, lowercase, and number'),
    
    body('age')
      .optional()
      .isInt({ min: 18, max: 120 })
      .withMessage('Age must be between 18 and 120')
  ],
  
  // Request handler
  (req, res) => {
    const errors = validationResult(req);
    
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        errors: errors.array()
      });
    }
    
    // Process registration
    res.json({
      success: true,
      message: 'User registered successfully'
    });
  }
);

app.listen(3000);
```

---

## Custom Validators

```javascript
body('email')
  .isEmail()
  .custom(async (email) => {
    const user = await User.findOne({ email });
    if (user) {
      throw new Error('Email already exists');
    }
    return true;
  });

body('confirmPassword')
  .custom((value, { req }) => {
    if (value !== req.body.password) {
      throw new Error('Passwords do not match');
    }
    return true;
  });
```

---

## Validation Middleware

```javascript
const validate = (req, res, next) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.status(400).json({
      errors: errors.array().map(err => ({
        field: err.param,
        message: err.msg
      }))
    });
  }
  
  next();
};

// Usage
app.post('/register',
  [
    body('email').isEmail(),
    body('password').isLength({ min: 6 })
  ],
  validate,
  (req, res) => {
    res.json({ message: 'Valid!' });
  }
);
```

---

## Common Validators

| Validator | Description |
|-----------|-------------|
| `isEmail()` | Valid email |
| `isURL()` | Valid URL |
| `isInt()` | Integer |
| `isLength()` | String length |
| `isAlphanumeric()` | Letters & numbers |
| `matches()` | Regex pattern |
| `notEmpty()` | Not empty |
| `optional()` | Optional field |

---

## Sanitizers

| Sanitizer | Description |
|-----------|-------------|
| `trim()` | Remove whitespace |
| `escape()` | Escape HTML |
| `normalizeEmail()` | Normalize email |
| `toInt()` | Convert to integer |
| `toBoolean()` | Convert to boolean |
| `toLowerCase()` | Convert to lowercase |

---

## Best Practices

✅ **Validate on server**: Never trust client  
✅ **Sanitize inputs**: Remove harmful characters  
✅ **Use whitelist**: Only allow valid characters  
✅ **Clear error messages**: Help users fix issues  
✅ **Validate types**: Check data types  
❌ **Don't expose details**: In production errors  

---

## Summary

**Validation:**
- Check if data is correct format
- Use `express-validator`
- Validate email, password, strings, numbers

**Sanitization:**
- Clean and normalize data
- Remove harmful characters
- Prevent XSS attacks

**Pattern:**
```javascript
app.post('/route',
  [
    body('email').isEmail().normalizeEmail(),
    body('password').isLength({ min: 6 })
  ],
  (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // Process valid data
  }
);
```

**Next**: Learn Express Best Practices!
