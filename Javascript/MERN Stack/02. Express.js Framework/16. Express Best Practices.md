# 16. Express Best Practices

## Project Structure

**Recommended:**

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ users.js
â”‚   â”‚   â””â”€â”€ posts.js
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ userController.js
â”‚   â”‚   â””â”€â”€ postController.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ User.js
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â””â”€â”€ errorHandler.js
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ helpers.js
â”‚   â””â”€â”€ app.js
â”œâ”€â”€ public/
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â””â”€â”€ package.json
```

---

## 1. Environment Variables

**Use `.env` file:**

```bash
npm install dotenv
```

**.env:**

```
PORT=3000
DB_URL=mongodb://localhost:27017/mydb
JWT_SECRET=your-secret-key
NODE_ENV=development
```

**Usage:**

```javascript
require('dotenv').config();

const PORT = process.env.PORT || 3000;
const DB_URL = process.env.DB_URL;
```

**âŒ Don't commit `.env`** - Add to `.gitignore`

---

## 2. Error Handling

**Centralized error handler:**

```javascript
// middleware/errorHandler.js
const errorHandler = (err, req, res, next) => {
  const statusCode = err.statusCode || 500;
  
  res.status(statusCode).json({
    success: false,
    error: err.message,
    stack: process.env.NODE_ENV === 'development' ? err.stack : undefined
  });
};

module.exports = errorHandler;
```

**Use in app:**

```javascript
const errorHandler = require('./middleware/errorHandler');

// Routes here...

// Error handler (last)
app.use(errorHandler);
```

---

## 3. Async Error Handling

```javascript
const asyncHandler = (fn) => (req, res, next) => {
  Promise.resolve(fn(req, res, next)).catch(next);
};

// Usage
app.get('/users', asyncHandler(async (req, res) => {
  const users = await User.find();
  res.json(users);
}));
```

---

## 4. Security

```bash
npm install helmet cors express-rate-limit
```

```javascript
const helmet = require('helmet');
const cors = require('cors');
const rateLimit = require('express-rate-limit');

app.use(helmet());  // Security headers
app.use(cors({ origin: 'https://yoursite.com' }));

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});
app.use('/api', limiter);
```

---

## 5. Logging

```bash
npm install morgan
```

```javascript
const morgan = require('morgan');

if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'));
} else {
  app.use(morgan('combined'));
}
```

---

## 6. Validation

```javascript
const { body, validationResult } = require('express-validator');

const validate = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }
  next();
};

app.post('/users',
  [
    body('email').isEmail(),
    body('password').isLength({ min: 6 })
  ],
  validate,
  createUser
);
```

---

## 7. Separate Routes & Controllers

**routes/users.js:**

```javascript
const express = require('express');
const { getUsers, createUser } = require('../controllers/userController');

const router = express.Router();

router.get('/', getUsers);
router.post('/', createUser);

module.exports = router;
```

**controllers/userController.js:**

```javascript
exports.getUsers = async (req, res) => {
  const users = await User.find();
  res.json(users);
};

exports.createUser = async (req, res) => {
  const user = await User.create(req.body);
  res.status(201).json(user);
};
```

---

## 8. Compression

```bash
npm install compression
```

```javascript
const compression = require('compression');
app.use(compression());
```

---

## 9. CORS Configuration

```javascript
const corsOptions = {
  origin: [
    'http://localhost:3000',
    'https://yoursite.com'
  ],
  credentials: true,
  optionsSuccessStatus: 200
};

app.use(cors(corsOptions));
```

---

## 10. Database Connection

```javascript
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.DB_URL);
    console.log('MongoDB connected');
  } catch (err) {
    console.error('DB connection failed:', err.message);
    process.exit(1);
  }
};

connectDB();
```

---

## 11. Graceful Shutdown

```javascript
const server = app.listen(PORT);

process.on('SIGTERM', () => {
  console.log('SIGTERM received');
  server.close(() => {
    console.log('Server closed');
    process.exit(0);
  });
});
```

---

## 12. API Versioning

```javascript
const v1Routes = require('./routes/v1');
const v2Routes = require('./routes/v2');

app.use('/api/v1', v1Routes);
app.use('/api/v2', v2Routes);
```

---

## Complete Setup Example

```javascript
require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const morgan = require('morgan');
const compression = require('compression');
const rateLimit = require('express-rate-limit');

const app = express();

// Security
app.use(helmet());
app.use(cors({ origin: process.env.CLIENT_URL }));

// Logging
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'));
}

// Body parsing
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Compression
app.use(compression());

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100
});
app.use('/api', limiter);

// Routes
app.use('/api/v1/users', require('./routes/users'));
app.use('/api/v1/posts', require('./routes/posts'));

// 404
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found' });
});

// Error handler
app.use(require('./middleware/errorHandler'));

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

---

## Best Practices Checklist

âœ… **Use environment variables** (.env)  
âœ… **Proper error handling** (centralized)  
âœ… **Security headers** (helmet)  
âœ… **Rate limiting** (prevent abuse)  
âœ… **CORS** (restrict origins)  
âœ… **Input validation** (express-validator)  
âœ… **Logging** (morgan)  
âœ… **Compression** (gzip)  
âœ… **Async error handling** (asyncHandler)  
âœ… **Separate concerns** (MVC pattern)  
âœ… **Use HTTPS** (production)  
âœ… **Keep dependencies updated**  
âŒ **Don't commit secrets** (.env to .gitignore)  
âŒ **Don't trust user input** (validate)  
âŒ **Don't use console.log** (use logger)  

---

## Summary

**Key Practices:**
- Use `.env` for configuration
- Implement centralized error handling
- Add security middleware (helmet, cors, rate-limit)
- Separate routes, controllers, models
- Validate all inputs
- Use async error handlers
- Enable compression
- Log requests (morgan)

**Production Ready:**
```javascript
app.use(helmet());
app.use(cors());
app.use(compression());
app.use(express.json());
app.use(rateLimit());
app.use(errorHandler);
```

ğŸ‰ **You've completed Express.js Framework!**
