# 09. Body Parsing, Cookies & Sessions

## Body Parsing

### express.json()

Parses **JSON** request bodies:

```javascript
const express = require('express');
const app = express();

// Enable JSON parsing
app.use(express.json());

app.post('/api/users', (req, res) => {
  console.log(req.body);
  res.json(req.body);
});

// POST /api/users
// Body: { "name": "John", "email": "john@example.com" }
// req.body = { name: 'John', email: 'john@example.com' }
```

### express.urlencoded()

Parses **URL-encoded** form data:

```javascript
app.use(express.urlencoded({ extended: true }));

app.post('/form', (req, res) => {
  console.log(req.body);
  res.send('Form received');
});

// POST /form
// Body: name=John&email=john@example.com
// req.body = { name: 'John', email: 'john@example.com' }
```

**extended: true vs false:**

```javascript
// extended: true - Parse complex objects
app.use(express.urlencoded({ extended: true }));
// user[name]=John → { user: { name: 'John' } }

// extended: false - Parse simple strings
app.use(express.urlencoded({ extended: false }));
// user[name]=John → { 'user[name]': 'John' }
```

### Limit Body Size

```javascript
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ limit: '10mb', extended: true }));
```

### Complete Setup

```javascript
const express = require('express');
const app = express();

// Parse JSON
app.use(express.json());

// Parse form data
app.use(express.urlencoded({ extended: true }));

// POST endpoint
app.post('/data', (req, res) => {
  console.log(req.body);
  res.json({
    message: 'Data received',
    data: req.body
  });
});

app.listen(3000);
```

---

## Cookies

### cookie-parser Setup

```bash
npm install cookie-parser
```

```javascript
const express = require('express');
const cookieParser = require('cookie-parser');

const app = express();

app.use(cookieParser());
```

### Setting Cookies

**res.cookie(name, value, options):**

```javascript
app.get('/set-cookie', (req, res) => {
  res.cookie('username', 'John');
  res.send('Cookie set');
});

// With options
app.get('/login', (req, res) => {
  res.cookie('token', 'abc123', {
    maxAge: 900000,      // 15 minutes (in ms)
    httpOnly: true,      // Not accessible via JavaScript
    secure: true,        // Only HTTPS
    sameSite: 'strict',  // CSRF protection
    signed: false        // Not signed
  });
  
  res.send('Logged in');
});
```

### Reading Cookies

**req.cookies:**

```javascript
app.get('/profile', (req, res) => {
  const username = req.cookies.username;
  const token = req.cookies.token;
  
  console.log(req.cookies);
  // { username: 'John', token: 'abc123' }
  
  res.send(`Welcome ${username}`);
});
```

### Clearing Cookies

**res.clearCookie(name):**

```javascript
app.get('/logout', (req, res) => {
  res.clearCookie('token');
  res.clearCookie('username');
  res.send('Logged out');
});
```

### Signed Cookies

More secure with secret:

```javascript
app.use(cookieParser('my-secret-key'));

// Set signed cookie
app.get('/set', (req, res) => {
  res.cookie('user', 'John', { signed: true });
  res.send('Signed cookie set');
});

// Read signed cookie
app.get('/get', (req, res) => {
  console.log(req.signedCookies.user);  // 'John'
  res.send('Cookie: ' + req.signedCookies.user);
});
```

### Cookie Options

| Option | Type | Description |
|--------|------|-------------|
| `maxAge` | Number | Expiry time (ms) |
| `expires` | Date | Expiry date |
| `httpOnly` | Boolean | JS can't access |
| `secure` | Boolean | HTTPS only |
| `sameSite` | String | 'strict', 'lax', 'none' |
| `signed` | Boolean | Use signature |
| `path` | String | Cookie path |
| `domain` | String | Cookie domain |

---

## Sessions

### express-session Setup

```bash
npm install express-session
```

```javascript
const express = require('express');
const session = require('express-session');

const app = express();

app.use(session({
  secret: 'my-secret-key',
  resave: false,
  saveUninitialized: false,
  cookie: {
    maxAge: 60000,  // 1 minute
    httpOnly: true,
    secure: false   // true for HTTPS
  }
}));
```

### Session Options

| Option | Description |
|--------|-------------|
| `secret` | Used to sign session ID cookie |
| `resave` | Force save even if not modified |
| `saveUninitialized` | Save new uninitialized sessions |
| `cookie` | Cookie settings |
| `store` | Session store (default: memory) |

### Setting Session Data

```javascript
app.get('/login', (req, res) => {
  req.session.userId = 123;
  req.session.username = 'John';
  req.session.isAdmin = true;
  
  res.send('Logged in');
});
```

### Reading Session Data

```javascript
app.get('/profile', (req, res) => {
  if (req.session.userId) {
    res.json({
      userId: req.session.userId,
      username: req.session.username,
      isAdmin: req.session.isAdmin
    });
  } else {
    res.status(401).send('Not logged in');
  }
});
```

### Destroying Sessions

```javascript
app.get('/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).send('Error logging out');
    }
    res.send('Logged out');
  });
});
```

### Session Authentication Example

```javascript
const express = require('express');
const session = require('express-session');

const app = express();

app.use(express.json());
app.use(session({
  secret: 'my-secret',
  resave: false,
  saveUninitialized: false,
  cookie: { maxAge: 3600000 }  // 1 hour
}));

// Login
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  
  // Verify credentials (simplified)
  if (username === 'john' && password === 'pass123') {
    req.session.userId = 1;
    req.session.username = username;
    res.json({ message: 'Login successful' });
  } else {
    res.status(401).json({ error: 'Invalid credentials' });
  }
});

// Protected route
app.get('/dashboard', (req, res) => {
  if (req.session.userId) {
    res.json({
      message: `Welcome ${req.session.username}`,
      userId: req.session.userId
    });
  } else {
    res.status(401).json({ error: 'Please login' });
  }
});

// Logout
app.get('/logout', (req, res) => {
  req.session.destroy((err) => {
    if (err) {
      return res.status(500).json({ error: 'Logout failed' });
    }
    res.json({ message: 'Logged out' });
  });
});

app.listen(3000);
```

---

## Session Middleware

### Authentication Middleware

```javascript
const requireAuth = (req, res, next) => {
  if (req.session && req.session.userId) {
    next();
  } else {
    res.status(401).json({ error: 'Authentication required' });
  }
};

app.get('/protected', requireAuth, (req, res) => {
  res.send('Protected content');
});
```

### Admin Middleware

```javascript
const requireAdmin = (req, res, next) => {
  if (req.session.isAdmin) {
    next();
  } else {
    res.status(403).json({ error: 'Admin access required' });
  }
};

app.delete('/users/:id', requireAuth, requireAdmin, (req, res) => {
  res.send('User deleted');
});
```

---

## Session Stores

### Memory Store (Default)

**❌ Not for production:**

```javascript
app.use(session({
  secret: 'secret',
  resave: false,
  saveUninitialized: false
  // Uses memory by default
}));
```

### Redis Store (Recommended)

```bash
npm install connect-redis redis
```

```javascript
const session = require('express-session');
const RedisStore = require('connect-redis').default;
const { createClient } = require('redis');

const redisClient = createClient();
redisClient.connect();

app.use(session({
  store: new RedisStore({ client: redisClient }),
  secret: 'secret',
  resave: false,
  saveUninitialized: false
}));
```

### MongoDB Store

```bash
npm install connect-mongo
```

```javascript
const MongoStore = require('connect-mongo');

app.use(session({
  store: MongoStore.create({
    mongoUrl: 'mongodb://localhost:27017/sessions'
  }),
  secret: 'secret',
  resave: false,
  saveUninitialized: false
}));
```

---

## Cookies vs Sessions

| Feature | Cookies | Sessions |
|---------|---------|----------|
| **Storage** | Client-side | Server-side |
| **Size Limit** | ~4KB | No limit |
| **Security** | Less secure | More secure |
| **Performance** | Faster | Slower |
| **Data Type** | String | Any type |
| **Expiry** | Can persist | Server-dependent |

**When to use:**
- **Cookies**: User preferences, tracking, small data
- **Sessions**: Authentication, cart, sensitive data

---

## Practical Examples

### Shopping Cart

```javascript
app.post('/cart/add', (req, res) => {
  const { productId, quantity } = req.body;
  
  if (!req.session.cart) {
    req.session.cart = [];
  }
  
  req.session.cart.push({ productId, quantity });
  res.json({ message: 'Added to cart', cart: req.session.cart });
});

app.get('/cart', (req, res) => {
  res.json(req.session.cart || []);
});
```

### Remember Me Cookie

```javascript
app.post('/login', (req, res) => {
  const { username, password, rememberMe } = req.body;
  
  // Verify credentials
  if (isValid(username, password)) {
    req.session.userId = getUserId(username);
    
    if (rememberMe) {
      res.cookie('rememberMe', username, {
        maxAge: 30 * 24 * 60 * 60 * 1000,  // 30 days
        httpOnly: true
      });
    }
    
    res.json({ message: 'Logged in' });
  }
});
```

### Flash Messages

```javascript
app.use((req, res, next) => {
  res.locals.flash = req.session.flash || {};
  req.session.flash = {};
  next();
});

app.post('/submit', (req, res) => {
  req.session.flash = { success: 'Form submitted!' };
  res.redirect('/form');
});

app.get('/form', (req, res) => {
  res.json({ message: res.locals.flash.success });
});
```

---

## Best Practices

✅ **Use HTTPS**: Set `secure: true` in production  
✅ **Set httpOnly**: Prevent XSS attacks  
✅ **Use session store**: Redis/MongoDB for production  
✅ **Set expiry**: Use maxAge for cookies/sessions  
✅ **Validate session**: Always check if session exists  
✅ **Use signed cookies**: For sensitive data  
❌ **Don't store sensitive data**: In cookies  
❌ **Don't use memory store**: In production  

---

## Summary

**Body Parsing:**
- `express.json()` - Parse JSON
- `express.urlencoded()` - Parse forms
- Required for accessing `req.body`

**Cookies:**
- Client-side storage
- Use `cookie-parser` middleware
- Set: `res.cookie()`, Read: `req.cookies`, Clear: `res.clearCookie()`

**Sessions:**
- Server-side storage
- Use `express-session` middleware
- Store: Memory (dev), Redis/MongoDB (prod)
- Set: `req.session.key = value`, Destroy: `req.session.destroy()`

**Common Pattern:**
```javascript
app.use(express.json());
app.use(cookieParser());
app.use(session({ secret: 'secret', ... }));

app.post('/login', (req, res) => {
  req.session.userId = req.body.id;
  res.cookie('token', 'abc123');
});
```

**Next:** Learn about Security!
