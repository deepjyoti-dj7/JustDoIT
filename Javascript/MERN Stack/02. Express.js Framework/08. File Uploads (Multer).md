# 08. File Uploads (Multer)

## What is Multer?

Middleware for handling `multipart/form-data` (file uploads).

---

## Installation

```bash
npm install multer
```

---

## Basic Setup

```javascript
const express = require('express');
const multer = require('multer');

const app = express();

// Configure upload
const upload = multer({ dest: 'uploads/' });

// Single file upload
app.post('/upload', upload.single('file'), (req, res) => {
  console.log(req.file);
  res.json({
    message: 'File uploaded',
    file: req.file
  });
});

app.listen(3000);
```

**HTML Form:**

```html
<form action="/upload" method="POST" enctype="multipart/form-data">
  <input type="file" name="file" />
  <button type="submit">Upload</button>
</form>
```

---

## Storage Configuration

### Disk Storage

```javascript
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');  // Save to uploads folder
  },
  filename: (req, file, cb) => {
    const uniqueName = Date.now() + '-' + file.originalname;
    cb(null, uniqueName);
  }
});

const upload = multer({ storage: storage });
```

### Memory Storage

Stores in memory as Buffer:

```javascript
const storage = multer.memoryStorage();
const upload = multer({ storage: storage });

app.post('/upload', upload.single('file'), (req, res) => {
  console.log(req.file.buffer);  // File as Buffer
  res.send('File uploaded to memory');
});
```

---

## Upload Types

### Single File

```javascript
app.post('/upload', upload.single('profilePic'), (req, res) => {
  console.log(req.file);
  res.json({ file: req.file });
});
```

### Multiple Files (Same Field)

```javascript
app.post('/upload', upload.array('photos', 5), (req, res) => {
  console.log(req.files);  // Array of files (max 5)
  res.json({ files: req.files });
});
```

### Multiple Files (Different Fields)

```javascript
app.post('/upload', upload.fields([
  { name: 'avatar', maxCount: 1 },
  { name: 'gallery', maxCount: 5 }
]), (req, res) => {
  console.log(req.files.avatar);   // [file]
  console.log(req.files.gallery);  // [file1, file2, ...]
  res.json({ files: req.files });
});
```

### Any Files

```javascript
app.post('/upload', upload.any(), (req, res) => {
  console.log(req.files);  // All files
  res.json({ files: req.files });
});
```

---

## File Object

**req.file** contains:

```javascript
{
  fieldname: 'file',
  originalname: 'photo.jpg',
  encoding: '7bit',
  mimetype: 'image/jpeg',
  destination: 'uploads/',
  filename: '1234567890-photo.jpg',
  path: 'uploads/1234567890-photo.jpg',
  size: 123456  // bytes
}
```

---

## File Filtering

### Accept Only Images

```javascript
const fileFilter = (req, file, cb) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);  // Accept
  } else {
    cb(new Error('Only images allowed'), false);  // Reject
  }
};

const upload = multer({
  storage: storage,
  fileFilter: fileFilter
});
```

### Accept Specific Types

```javascript
const fileFilter = (req, file, cb) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
  
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Invalid file type'), false);
  }
};
```

---

## File Size Limit

```javascript
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 5 * 1024 * 1024  // 5 MB
  }
});
```

---

## Complete Example

```javascript
const express = require('express');
const multer = require('multer');
const path = require('path');

const app = express();

// Storage configuration
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

// File filter
const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|gif/;
  const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
  const mimetype = allowedTypes.test(file.mimetype);
  
  if (extname && mimetype) {
    cb(null, true);
  } else {
    cb(new Error('Only images allowed (jpeg, jpg, png, gif)'));
  }
};

// Multer config
const upload = multer({
  storage: storage,
  limits: { fileSize: 5 * 1024 * 1024 },  // 5 MB
  fileFilter: fileFilter
});

// Single upload
app.post('/upload/single', upload.single('image'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No file uploaded' });
  }
  
  res.json({
    message: 'File uploaded',
    file: {
      filename: req.file.filename,
      size: req.file.size,
      path: req.file.path
    }
  });
});

// Multiple upload
app.post('/upload/multiple', upload.array('images', 5), (req, res) => {
  if (!req.files || req.files.length === 0) {
    return res.status(400).json({ error: 'No files uploaded' });
  }
  
  res.json({
    message: 'Files uploaded',
    count: req.files.length,
    files: req.files.map(f => ({
      filename: f.filename,
      size: f.size
    }))
  });
});

// Error handling
app.use((err, req, res, next) => {
  if (err instanceof multer.MulterError) {
    if (err.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({ error: 'File too large (max 5MB)' });
    }
    return res.status(400).json({ error: err.message });
  }
  res.status(500).json({ error: err.message });
});

app.listen(3000);
```

---

## Error Handling

### Multer Errors

```javascript
app.use((err, req, res, next) => {
  if (err instanceof multer.MulterError) {
    if (err.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({ error: 'File too large' });
    }
    if (err.code === 'LIMIT_FILE_COUNT') {
      return res.status(400).json({ error: 'Too many files' });
    }
    if (err.code === 'LIMIT_UNEXPECTED_FILE') {
      return res.status(400).json({ error: 'Unexpected field' });
    }
  }
  
  res.status(500).json({ error: err.message });
});
```

---

## Advanced Usage

### Custom File Path

```javascript
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const userFolder = `uploads/${req.user.id}`;
    cb(null, userFolder);
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + '-' + file.originalname);
  }
});
```

### Image Processing (Sharp)

```bash
npm install sharp
```

```javascript
const sharp = require('sharp');

app.post('/upload', upload.single('image'), async (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No file' });
  }
  
  const outputPath = `uploads/resized-${req.file.filename}`;
  
  await sharp(req.file.path)
    .resize(800, 600)
    .jpeg({ quality: 80 })
    .toFile(outputPath);
  
  res.json({ message: 'Image uploaded and resized' });
});
```

### Cloud Upload (Cloudinary)

```bash
npm install cloudinary
```

```javascript
const cloudinary = require('cloudinary').v2;

cloudinary.config({
  cloud_name: process.env.CLOUD_NAME,
  api_key: process.env.API_KEY,
  api_secret: process.env.API_SECRET
});

const storage = multer.memoryStorage();
const upload = multer({ storage });

app.post('/upload', upload.single('image'), async (req, res) => {
  const result = await cloudinary.uploader.upload_stream(
    { folder: 'uploads' },
    (error, result) => {
      if (error) return res.status(500).json({ error });
      res.json({ url: result.secure_url });
    }
  ).end(req.file.buffer);
});
```

---

## Practical Examples

### Profile Picture Upload

```javascript
app.post('/profile/upload', authenticate, upload.single('avatar'), async (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'No file uploaded' });
  }
  
  const user = await User.findById(req.user.id);
  user.avatar = req.file.filename;
  await user.save();
  
  res.json({
    message: 'Profile picture updated',
    avatar: req.file.filename
  });
});
```

### Document Upload

```javascript
const docFilter = (req, file, cb) => {
  const allowedTypes = ['application/pdf', 'application/msword'];
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Only PDF and DOC allowed'));
  }
};

const uploadDoc = multer({
  storage: storage,
  fileFilter: docFilter,
  limits: { fileSize: 10 * 1024 * 1024 }  // 10 MB
});

app.post('/documents', uploadDoc.single('document'), (req, res) => {
  res.json({
    message: 'Document uploaded',
    file: req.file.filename
  });
});
```

---

## Best Practices

✅ **Validate file type**: Use fileFilter  
✅ **Set size limit**: Prevent large uploads  
✅ **Use unique filenames**: Avoid conflicts  
✅ **Store outside public folder**: For security  
✅ **Validate on server**: Don't trust client  
✅ **Use cloud storage**: For production (AWS S3, Cloudinary)  
✅ **Delete old files**: Clean up unused files  
❌ **Don't trust file extensions**: Check mimetype  
❌ **Don't store in database**: Store path only  

---

## Summary

**Multer:**
- Handles file uploads
- Supports single/multiple files
- Disk or memory storage

**Setup:**
```javascript
const upload = multer({ dest: 'uploads/' });
app.post('/upload', upload.single('file'), (req, res) => {
  res.json({ file: req.file });
});
```

**Storage:**
```javascript
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, 'uploads/'),
  filename: (req, file, cb) => cb(null, Date.now() + '-' + file.originalname)
});
```

**File Filter:**
```javascript
fileFilter: (req, file, cb) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(new Error('Images only'));
  }
}
```

**Next:** Learn about Body Parsing, Cookies & Sessions!
