# 06. Middleware (Complete Guide)

## What is Middleware?

Middleware functions have access to:
- **Request object** (req)
- **Response object** (res)
- **Next middleware function** (next)

They can:
✅ Execute code  
✅ Modify req/res objects  
✅ End request-response cycle  
✅ Call next middleware  

---

## Basic Middleware Structure

```javascript
const middleware = (req, res, next) => {
  // Do something
  console.log('Middleware executed');
  
  // Pass control to next middleware
  next();
};

app.use(middleware);
```

**❌ Without next():**
```javascript
app.use((req, res, next) => {
  console.log('Request stopped here');
  // No next() → request hangs
});
```

**✅ With next():**
```javascript
app.use((req, res, next) => {
  console.log('Request continues');
  next();  // Passes to next middleware
});
```

---

## Middleware Types

### 1. Application-Level Middleware

Bound to `app` object:

```javascript
const express = require('express');
const app = express();

// Runs for ALL routes
app.use((req, res, next) => {
  console.log(`${req.method} ${req.url}`);
  next();
});

// Runs for specific path
app.use('/admin', (req, res, next) => {
  console.log('Admin section');
  next();
});

app.get('/', (req, res) => {
  res.send('Home');
});
```

### 2. Router-Level Middleware

Bound to `express.Router()`:

```javascript
const router = express.Router();

// Router middleware
router.use((req, res, next) => {
  console.log('Router middleware');
  next();
});

router.get('/users', (req, res) => {
  res.send('Users list');
});

app.use('/api', router);
```

### 3. Built-in Middleware

**express.json()** - Parse JSON bodies:

```javascript
app.use(express.json());

app.post('/data', (req, res) => {
  console.log(req.body);  // { name: "John" }
  res.json(req.body);
});
```

**express.urlencoded()** - Parse URL-encoded data:

```javascript
app.use(express.urlencoded({ extended: true }));

app.post('/form', (req, res) => {
  console.log(req.body);
  res.send('Form submitted');
});
```

**express.static()** - Serve static files:

```javascript
app.use(express.static('public'));

// Now accessible:
// http://localhost:3000/style.css
// http://localhost:3000/script.js
```

### 4. Third-Party Middleware

**morgan** - HTTP request logger:

```javascript
const morgan = require('morgan');

app.use(morgan('dev'));
// Output: GET /users 200 12.345 ms - 1234
```

**cors** - Enable CORS:

```javascript
const cors = require('cors');

app.use(cors());
```

**helmet** - Security headers:

```javascript
const helmet = require('helmet');

app.use(helmet());
```

**cookie-parser** - Parse cookies:

```javascript
const cookieParser = require('cookie-parser');

app.use(cookieParser());

app.get('/test', (req, res) => {
  console.log(req.cookies);
  res.send('Cookies parsed');
});
```

### 5. Error-Handling Middleware

Has **4 parameters** (err, req, res, next):

```javascript
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    error: 'Something went wrong!',
    message: err.message
  });
});
```

**Must be defined LAST** (after all routes):

```javascript
app.get('/error', (req, res) => {
  throw new Error('Oops!');
});

// Error handler (defined last)
app.use((err, req, res, next) => {
  res.status(500).send('Error occurred');
});
```

---

## Middleware Execution Order

```javascript
// 1. First middleware
app.use((req, res, next) => {
  console.log('1st');
  next();
});

// 2. Second middleware
app.use((req, res, next) => {
  console.log('2nd');
  next();
});

// 3. Route handler
app.get('/', (req, res) => {
  console.log('3rd - Route');
  res.send('Done');
});

// Output: 1st → 2nd → 3rd - Route
```

---

## Custom Middleware Examples

### Logging Middleware

```javascript
const logger = (req, res, next) => {
  const timestamp = new Date().toISOString();
  console.log(`[${timestamp}] ${req.method} ${req.url}`);
  next();
};

app.use(logger);
```

### Authentication Middleware

```javascript
const authenticate = (req, res, next) => {
  const token = req.headers.authorization;
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }
  
  // Verify token
  if (token === 'valid-token') {
    next();  // Allow access
  } else {
    res.status(403).json({ error: 'Invalid token' });
  }
};

// Protected route
app.get('/protected', authenticate, (req, res) => {
  res.send('Access granted');
});
```

### Request Timing Middleware

```javascript
const requestTime = (req, res, next) => {
  req.requestTime = Date.now();
  next();
};

app.use(requestTime);

app.get('/', (req, res) => {
  const time = Date.now() - req.requestTime;
  res.send(`Request took ${time}ms`);
});
```

### Validation Middleware

```javascript
const validateUser = (req, res, next) => {
  const { name, email } = req.body;
  
  if (!name || !email) {
    return res.status(400).json({
      error: 'Name and email required'
    });
  }
  
  if (!email.includes('@')) {
    return res.status(400).json({
      error: 'Invalid email'
    });
  }
  
  next();
};

app.post('/users', validateUser, (req, res) => {
  res.json({ message: 'User created' });
});
```

### Admin Authorization

```javascript
const isAdmin = (req, res, next) => {
  if (req.user && req.user.role === 'admin') {
    next();
  } else {
    res.status(403).json({
      error: 'Admin access required'
    });
  }
};

app.delete('/users/:id', authenticate, isAdmin, (req, res) => {
  res.send('User deleted');
});
```

---

## Multiple Middleware

### Array of Middleware

```javascript
const middleware1 = (req, res, next) => {
  console.log('Middleware 1');
  next();
};

const middleware2 = (req, res, next) => {
  console.log('Middleware 2');
  next();
};

// Apply multiple
app.get('/test', [middleware1, middleware2], (req, res) => {
  res.send('Done');
});

// Or
app.get('/test2', middleware1, middleware2, (req, res) => {
  res.send('Done');
});
```

### Chained Middleware

```javascript
app.get('/secure',
  authenticate,
  authorize,
  validateInput,
  (req, res) => {
    res.send('All checks passed');
  }
);
```

---

## Conditional Middleware

```javascript
const conditionalMiddleware = (req, res, next) => {
  if (req.query.admin === 'true') {
    console.log('Admin mode');
  }
  next();
};

app.use((req, res, next) => {
  if (req.path.startsWith('/api')) {
    return conditionalMiddleware(req, res, next);
  }
  next();
});
```

---

## Error Handling with Middleware

### Async Error Handler

```javascript
const asyncHandler = (fn) => {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

app.get('/users', asyncHandler(async (req, res) => {
  const users = await User.find();
  res.json(users);
}));

// Error handler
app.use((err, req, res, next) => {
  res.status(500).json({ error: err.message });
});
```

### Custom Error Classes

```javascript
class NotFoundError extends Error {
  constructor(message) {
    super(message);
    this.statusCode = 404;
  }
}

app.get('/users/:id', (req, res, next) => {
  const user = findUser(req.params.id);
  if (!user) {
    return next(new NotFoundError('User not found'));
  }
  res.json(user);
});

// Error handler
app.use((err, req, res, next) => {
  res.status(err.statusCode || 500).json({
    error: err.message
  });
});
```

---

## Practical Example: Complete Setup

```javascript
const express = require('express');
const morgan = require('morgan');
const cors = require('cors');
const helmet = require('helmet');

const app = express();

// 1. Built-in middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static('public'));

// 2. Third-party middleware
app.use(morgan('dev'));
app.use(cors());
app.use(helmet());

// 3. Custom middleware
app.use((req, res, next) => {
  req.requestTime = new Date().toISOString();
  next();
});

// 4. Routes
app.get('/', (req, res) => {
  res.json({
    message: 'Hello World',
    time: req.requestTime
  });
});

// Protected route
const authenticate = (req, res, next) => {
  const token = req.headers.authorization;
  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
};

app.get('/protected', authenticate, (req, res) => {
  res.json({ message: 'Secret data' });
});

// 5. 404 Handler
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found' });
});

// 6. Error handler (MUST be last)
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    error: 'Internal server error',
    message: err.message
  });
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

---

## Middleware Cheat Sheet

| Type | Example | Usage |
|------|---------|-------|
| **Application** | `app.use(middleware)` | All routes |
| **Router** | `router.use(middleware)` | Router routes |
| **Built-in** | `express.json()` | Parse JSON |
| **Third-party** | `morgan('dev')` | Logging |
| **Error** | `(err, req, res, next)` | Handle errors |

---

## Best Practices

✅ **Use built-in middleware**: express.json(), express.static()  
✅ **Order matters**: Define middleware before routes  
✅ **Error handler last**: After all routes and middleware  
✅ **Call next()**: Always call next() unless ending response  
✅ **Return on errors**: Use `return res.status().json()` in middleware  
✅ **Use async handlers**: Wrap async functions to catch errors  
❌ **Don't forget next()**: Request will hang  
❌ **Don't modify req/res carelessly**: Can break other middleware  

---

## Summary

**Middleware:**
- Functions with access to req, res, next
- Execute in order they're defined
- Can modify request/response or end cycle

**Types:**
1. Application-level (app.use)
2. Router-level (router.use)
3. Built-in (express.json, express.static)
4. Third-party (morgan, cors, helmet)
5. Error-handling (4 parameters)

**Common Pattern:**
```javascript
app.use(middleware1);
app.use(middleware2);
app.get('/route', middleware3, handler);
app.use(errorHandler);  // Last
```

**Next:** Learn about Template Engines!
