# Nullish Coalescing

The nullish coalescing operator (`??`) returns the right-hand operand when the left-hand operand is `null` or `undefined`, otherwise returns the left-hand operand.

---

## The Problem It Solves

### Before Nullish Coalescing (Using OR)
```javascript
const user = {
  name: "John",
  age: 0,
  isActive: false,
  score: 0
};

// Problem with OR operator
const age = user.age || 18;           // 18 ⚠️ (0 is falsy)
const active = user.isActive || true; // true ⚠️ (false is falsy)
const score = user.score || 100;      // 100 ⚠️ (0 is falsy)
const username = user.username || "Guest";  // "Guest" ✓

// All falsy values trigger OR:
// false, 0, "", null, undefined, NaN
```

### With Nullish Coalescing
```javascript
const age = user.age ?? 18;           // 0 ✓ (only null/undefined trigger ??)
const active = user.isActive ?? true; // false ✓
const score = user.score ?? 100;      // 0 ✓
const username = user.username ?? "Guest";  // "Guest" ✓

// Only null and undefined trigger ??
```

---

## Basic Syntax

```javascript
// value ?? defaultValue
const result = value ?? "default";

// If value is null or undefined, use "default"
// Otherwise, use value (even if it's 0, false, or "")
```

---

## Nullish vs Falsy Values

### Falsy Values (OR operator)
```javascript
// These all trigger || operator:
false || "default"      // "default"
0 || "default"          // "default"
"" || "default"         // "default"
null || "default"       // "default"
undefined || "default"  // "default"
NaN || "default"        // "default"
```

### Nullish Values (?? operator)
```javascript
// Only null and undefined trigger ??:
false ?? "default"      // false ✓
0 ?? "default"          // 0 ✓
"" ?? "default"         // "" ✓
null ?? "default"       // "default" ✓
undefined ?? "default"  // "default" ✓
NaN ?? "default"        // NaN ✓
```

---

## Practical Use Cases

### 1. Configuration with Zero Values
```javascript
const config = {
  port: 0,           // Valid port (random assignment)
  retries: 0,        // Valid - don't retry
  timeout: 0,        // Valid - no timeout
  maxConnections: null  // Not set
};

// ✗ Using OR - wrong results
const port = config.port || 3000;                // 3000 ⚠️
const retries = config.retries || 3;             // 3 ⚠️
const timeout = config.timeout || 5000;          // 5000 ⚠️
const maxConn = config.maxConnections || 100;    // 100 ✓

// ✓ Using ?? - correct results
const port = config.port ?? 3000;                // 0 ✓
const retries = config.retries ?? 3;             // 0 ✓
const timeout = config.timeout ?? 5000;          // 0 ✓
const maxConn = config.maxConnections ?? 100;    // 100 ✓
```

### 2. User Preferences
```javascript
const userSettings = {
  notifications: false,  // Explicitly disabled
  volume: 0,            // Muted
  theme: null           // Not set
};

// Get settings with defaults
const notifications = userSettings.notifications ?? true;  // false ✓
const volume = userSettings.volume ?? 50;                  // 0 ✓
const theme = userSettings.theme ?? "light";               // "light" ✓
```

### 3. API Responses
```javascript
function processResponse(response) {
  // API might return 0 or false as valid values
  const count = response.count ?? -1;          // 0 is valid
  const enabled = response.enabled ?? true;    // false is valid
  const message = response.message ?? "No message";
  
  return { count, enabled, message };
}

processResponse({ count: 0, enabled: false, message: "" });
// { count: 0, enabled: false, message: "" }

processResponse({});
// { count: -1, enabled: true, message: "No message" }
```

### 4. Form Validation
```javascript
function validateForm(formData) {
  // Empty string is different from undefined
  const name = formData.name ?? null;        // "" is valid input
  const age = formData.age ?? null;          // 0 is valid age
  const agreed = formData.agreed ?? false;   // false is valid value
  
  return {
    isValid: name !== null && age !== null && agreed === true,
    data: { name, age, agreed }
  };
}

validateForm({ name: "", age: 0, agreed: false });
// { isValid: true, data: { name: "", age: 0, agreed: false } }
```

### 5. Database Queries
```javascript
function findUsers({ limit, offset, active }) {
  // 0 is a valid offset (start from beginning)
  const queryLimit = limit ?? 10;
  const queryOffset = offset ?? 0;
  const queryActive = active ?? true;
  
  return {
    limit: queryLimit,
    offset: queryOffset,
    active: queryActive
  };
}

findUsers({ limit: 5, offset: 0, active: false });
// { limit: 5, offset: 0, active: false } ✓
```

---

## Combining with Optional Chaining

Perfect combination for safe property access with defaults.

```javascript
const user = {
  profile: {
    settings: {
      theme: "dark",
      notifications: false,
      volume: 0
    }
  }
};

// Safe access with proper defaults
const theme = user?.profile?.settings?.theme ?? "light";
// "dark"

const notifications = user?.profile?.settings?.notifications ?? true;
// false ✓ (not true, because false is not nullish)

const volume = user?.profile?.settings?.volume ?? 50;
// 0 ✓ (not 50, because 0 is not nullish)

const language = user?.profile?.settings?.language ?? "en";
// "en" ✓ (undefined triggers ??)

// With missing nested objects
const noUser = null;
const userTheme = noUser?.profile?.settings?.theme ?? "light";
// "light"
```

---

## Chaining Nullish Coalescing

```javascript
// Check multiple values, use first non-nullish
const value = option1 ?? option2 ?? option3 ?? "default";

// Example: Priority configuration sources
const config = {
  getPort() {
    return (
      process.env.PORT ??
      this.userConfig?.port ??
      this.defaultConfig.port ??
      3000
    );
  }
};

// Example: Fallback values
function getUserName(user) {
  return (
    user?.displayName ??
    user?.username ??
    user?.email?.split('@')[0] ??
    "Anonymous"
  );
}
```

---

## Cannot Mix with AND/OR (Without Parentheses)

```javascript
// ✗ SyntaxError - must use parentheses
const result = value ?? defaultValue || otherDefault;
const result = value && check ?? defaultValue;

// ✓ Use parentheses to clarify precedence
const result = (value ?? defaultValue) || otherDefault;
const result = value && (check ?? defaultValue);
const result = (value && check) ?? defaultValue;
```

---

## Common Patterns

### 1. Function Parameters with Defaults
```javascript
function createUser(data) {
  return {
    name: data?.name ?? "Anonymous",
    age: data?.age ?? 0,
    active: data?.active ?? true,
    score: data?.score ?? 0
  };
}

createUser({ name: "", age: 0, active: false, score: 0 });
// Preserves all values including 0, false, ""
```

### 2. Environment Variables
```javascript
const config = {
  port: process.env.PORT ?? 3000,
  host: process.env.HOST ?? "localhost",
  debug: process.env.DEBUG ?? false,
  maxRetries: process.env.MAX_RETRIES ?? 3
};
```

### 3. Local Storage with Defaults
```javascript
function getStoredValue(key, defaultValue) {
  const stored = localStorage.getItem(key);
  
  // localStorage returns null if key doesn't exist
  return stored ?? defaultValue;
}

const theme = getStoredValue("theme", "light");
const volume = getStoredValue("volume", 50);
```

### 4. Reducer Pattern
```javascript
function reducer(state, action) {
  return {
    ...state,
    count: action.count ?? state.count,
    name: action.name ?? state.name,
    active: action.active ?? state.active
  };
}

// Only updates provided values
reducer({ count: 0, name: "Test", active: false }, { count: 5 });
// { count: 5, name: "Test", active: false }
```

---

## Common Pitfalls

### 1. Not Understanding the Difference
```javascript
const value = 0;

const resultOr = value || 10;   // 10 (0 is falsy)
const resultNullish = value ?? 10;  // 0 (0 is not nullish)

// Know when to use each!
```

### 2. Checking for Empty Strings
```javascript
const input = "";

// If empty string should trigger default, use ||
const text1 = input || "default";  // "default"

// If empty string is valid, use ??
const text2 = input ?? "default";  // ""

// Explicitly check for empty string
const text3 = (input === "") ? "default" : input;
```

### 3. NaN is Not Nullish
```javascript
const result = parseInt("abc");  // NaN

const value1 = result || 0;   // 0 (NaN is falsy)
const value2 = result ?? 0;   // NaN (NaN is not nullish)

// Explicitly check for NaN
const value3 = Number.isNaN(result) ? 0 : result;
```

---

## Best Practices

1. **Use ?? for meaningful falsy values**
   ```javascript
   // When 0, false, "" are valid values
   const count = data.count ?? defaultCount;
   const enabled = data.enabled ?? true;
   ```

2. **Use || for truly falsy defaults**
   ```javascript
   // When you want to reject all falsy values
   const name = input.name || "Anonymous";
   ```

3. **Combine with optional chaining**
   ```javascript
   const value = obj?.deeply?.nested?.prop ?? defaultValue;
   ```

4. **Document your intention**
   ```javascript
   // 0 is a valid score, only use default for null/undefined
   const score = user.score ?? 0;
   ```

5. **Use parentheses when mixing operators**
   ```javascript
   const result = (a ?? b) || c;
   const result = a && (b ?? c);
   ```

---

## Comparison Table

| Value | `value || "default"` | `value ?? "default"` |
|-------|---------------------|---------------------|
| `null` | `"default"` | `"default"` |
| `undefined` | `"default"` | `"default"` |
| `false` | `"default"` | `false` |
| `0` | `"default"` | `0` |
| `""` | `"default"` | `""` |
| `NaN` | `"default"` | `NaN` |
| `"value"` | `"value"` | `"value"` |

---

## Key Takeaways

- `??` only checks for `null` and `undefined`, not all falsy values
- Use `??` when `0`, `false`, `""`, or `NaN` are valid values
- Use `||` when you want to reject all falsy values
- Perfect companion to optional chaining (`?.`)
- Cannot mix with `&&` or `||` without parentheses
- Solves the "zero problem" with OR operator
- More precise than `||` for default values
- Essential for working with numeric configurations and boolean flags
