# Web APIs

Browser-provided APIs that enable asynchronous operations outside the JavaScript runtime.

---

## What are Web APIs?

Web APIs are browser features that handle tasks like timers, HTTP requests, and DOM events. They run outside the JavaScript engine, allowing non-blocking operations.

```javascript
// These use Web APIs:
setTimeout(() => console.log('Timer'), 1000);  // Timer API
fetch('https://api.example.com/data');         // Fetch API
document.addEventListener('click', handler);    // DOM API
```

---

## Common Web APIs

### setTimeout / setInterval

Execute code after a delay or repeatedly.

```javascript
// setTimeout - runs once after delay
const timeoutId = setTimeout(() => {
  console.log('Executed after 2 seconds');
}, 2000);

// Clear timeout before it executes
clearTimeout(timeoutId);

// setInterval - runs repeatedly
const intervalId = setInterval(() => {
  console.log('Every second');
}, 1000);

// Clear interval
clearInterval(intervalId);
```

### Practical Examples

```javascript
// Countdown timer
function countdown(seconds) {
  let remaining = seconds;
  
  const timer = setInterval(() => {
    console.log(remaining);
    remaining--;
    
    if (remaining < 0) {
      clearInterval(timer);
      console.log('Done!');
    }
  }, 1000);
}

countdown(5);  // 5, 4, 3, 2, 1, 0, Done!

// Debounce function
function debounce(func, delay) {
  let timeoutId;
  
  return function(...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
}

const debouncedSearch = debounce((query) => {
  console.log('Searching for:', query);
}, 300);

// Throttle function
function throttle(func, limit) {
  let inThrottle;
  
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

const throttledScroll = throttle(() => {
  console.log('Scroll event');
}, 100);
```

---

## Fetch API

Modern way to make HTTP requests.

```javascript
// Basic GET request
fetch('https://api.example.com/users')
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));

// POST request
fetch('https://api.example.com/users', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    name: 'John Doe',
    email: 'john@example.com'
  })
})
  .then(response => response.json())
  .then(data => console.log('Created:', data));

// Async/await version
async function fetchUsers() {
  try {
    const response = await fetch('https://api.example.com/users');
    const users = await response.json();
    return users;
  } catch (error) {
    console.error('Failed to fetch users:', error);
  }
}
```

### Fetch Options

```javascript
const options = {
  method: 'GET',           // HTTP method
  headers: {               // Request headers
    'Authorization': 'Bearer token',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data),  // Request body (for POST/PUT)
  mode: 'cors',            // cors, no-cors, same-origin
  credentials: 'include',  // include, same-origin, omit
  cache: 'no-cache',       // default, no-cache, reload, force-cache
  redirect: 'follow',      // follow, error, manual
  signal: abortController.signal  // For cancellation
};

fetch(url, options);
```

### Abort Requests

```javascript
const controller = new AbortController();

fetch('https://api.example.com/data', {
  signal: controller.signal
})
  .then(response => response.json())
  .catch(error => {
    if (error.name === 'AbortError') {
      console.log('Fetch aborted');
    }
  });

// Cancel the request
controller.abort();
```

---

## XMLHttpRequest (Legacy)

Older way to make HTTP requests.

```javascript
const xhr = new XMLHttpRequest();

xhr.open('GET', 'https://api.example.com/users');

xhr.onload = function() {
  if (xhr.status === 200) {
    const data = JSON.parse(xhr.responseText);
    console.log(data);
  }
};

xhr.onerror = function() {
  console.error('Request failed');
};

xhr.send();
```

---

## DOM Events API

Handle user interactions and document events.

```javascript
// Click event
document.getElementById('button').addEventListener('click', (event) => {
  console.log('Button clicked', event);
});

// Keyboard event
document.addEventListener('keydown', (event) => {
  console.log('Key pressed:', event.key);
});

// Form submission
document.querySelector('form').addEventListener('submit', (event) => {
  event.preventDefault();
  console.log('Form submitted');
});

// Mouse move
document.addEventListener('mousemove', (event) => {
  console.log('Mouse at:', event.clientX, event.clientY);
});

// Scroll event
window.addEventListener('scroll', () => {
  console.log('Scrolled to:', window.scrollY);
});
```

---

## Storage APIs

### localStorage / sessionStorage

```javascript
// localStorage - persists across sessions
localStorage.setItem('username', 'John');
const username = localStorage.getItem('username');
localStorage.removeItem('username');
localStorage.clear();

// sessionStorage - cleared when tab closes
sessionStorage.setItem('tempData', 'value');
const tempData = sessionStorage.getItem('tempData');

// Store objects
const user = { name: 'John', age: 30 };
localStorage.setItem('user', JSON.stringify(user));
const storedUser = JSON.parse(localStorage.getItem('user'));
```

### IndexedDB

```javascript
// Open database
const request = indexedDB.open('MyDatabase', 1);

request.onsuccess = (event) => {
  const db = event.target.result;
  console.log('Database opened');
};

request.onerror = (event) => {
  console.error('Database error');
};

request.onupgradeneeded = (event) => {
  const db = event.target.result;
  const objectStore = db.createObjectStore('users', { keyPath: 'id' });
  objectStore.createIndex('name', 'name', { unique: false });
};
```

---

## Geolocation API

```javascript
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      console.log('Location:', latitude, longitude);
    },
    (error) => {
      console.error('Location error:', error.message);
    },
    {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    }
  );
}

// Watch position changes
const watchId = navigator.geolocation.watchPosition((position) => {
  console.log('Position changed:', position.coords);
});

// Stop watching
navigator.geolocation.clearWatch(watchId);
```

---

## Notification API

```javascript
// Request permission
Notification.requestPermission().then(permission => {
  if (permission === 'granted') {
    new Notification('Hello!', {
      body: 'This is a notification',
      icon: '/icon.png',
      tag: 'unique-tag'
    });
  }
});

// Notification with event handlers
const notification = new Notification('New Message', {
  body: 'You have a new message'
});

notification.onclick = () => {
  console.log('Notification clicked');
  window.focus();
};

notification.onclose = () => {
  console.log('Notification closed');
};
```

---

## Canvas API

```javascript
const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');

// Draw rectangle
ctx.fillStyle = 'blue';
ctx.fillRect(10, 10, 100, 100);

// Draw circle
ctx.beginPath();
ctx.arc(200, 60, 50, 0, 2 * Math.PI);
ctx.fillStyle = 'red';
ctx.fill();

// Draw text
ctx.font = '20px Arial';
ctx.fillStyle = 'black';
ctx.fillText('Hello Canvas', 10, 150);

// Draw line
ctx.beginPath();
ctx.moveTo(10, 200);
ctx.lineTo(300, 200);
ctx.strokeStyle = 'green';
ctx.lineWidth = 3;
ctx.stroke();
```

---

## File API

```javascript
// File input
document.getElementById('fileInput').addEventListener('change', (event) => {
  const file = event.target.files[0];
  
  console.log('Name:', file.name);
  console.log('Size:', file.size);
  console.log('Type:', file.type);
  
  // Read file
  const reader = new FileReader();
  
  reader.onload = (e) => {
    console.log('File content:', e.target.result);
  };
  
  reader.readAsText(file);  // or readAsDataURL, readAsArrayBuffer
});

// Drag and drop
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  console.log('Dropped files:', files);
});
```

---

## Web Workers

Run JavaScript in background threads.

```javascript
// main.js
const worker = new Worker('worker.js');

// Send message to worker
worker.postMessage({ type: 'start', data: [1, 2, 3, 4, 5] });

// Receive message from worker
worker.onmessage = (event) => {
  console.log('Worker result:', event.data);
};

worker.onerror = (error) => {
  console.error('Worker error:', error);
};

// Terminate worker
worker.terminate();
```

```javascript
// worker.js
self.onmessage = (event) => {
  const { type, data } = event.data;
  
  if (type === 'start') {
    const result = data.reduce((sum, num) => sum + num, 0);
    self.postMessage(result);
  }
};
```

---

## requestAnimationFrame

Optimal for animations (60fps).

```javascript
function animate() {
  // Update animation
  element.style.left = position + 'px';
  position += 1;
  
  // Continue animation
  if (position < 500) {
    requestAnimationFrame(animate);
  }
}

requestAnimationFrame(animate);
```

### Animation Loop

```javascript
let lastTime = 0;

function gameLoop(currentTime) {
  const deltaTime = currentTime - lastTime;
  lastTime = currentTime;
  
  // Update game state
  update(deltaTime);
  
  // Render
  render();
  
  // Continue loop
  requestAnimationFrame(gameLoop);
}

requestAnimationFrame(gameLoop);
```

---

## IntersectionObserver

Efficiently detect element visibility.

```javascript
const observer = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      console.log('Element is visible:', entry.target);
      entry.target.classList.add('visible');
    }
  });
}, {
  threshold: 0.5,  // 50% visible
  rootMargin: '0px'
});

// Observe elements
document.querySelectorAll('.lazy-load').forEach(element => {
  observer.observe(element);
});

// Stop observing
observer.unobserve(element);
observer.disconnect();
```

---

## MutationObserver

Watch for DOM changes.

```javascript
const observer = new MutationObserver((mutations) => {
  mutations.forEach(mutation => {
    console.log('DOM changed:', mutation.type);
    
    if (mutation.type === 'childList') {
      console.log('Children added/removed');
    }
    
    if (mutation.type === 'attributes') {
      console.log('Attribute changed:', mutation.attributeName);
    }
  });
});

observer.observe(document.body, {
  childList: true,     // Watch for child additions/removals
  attributes: true,    // Watch for attribute changes
  subtree: true,       // Watch descendants too
  characterData: true  // Watch for text changes
});

// Stop observing
observer.disconnect();
```

---

## Clipboard API

```javascript
// Write to clipboard
navigator.clipboard.writeText('Hello, clipboard!')
  .then(() => console.log('Copied to clipboard'))
  .catch(err => console.error('Failed to copy', err));

// Read from clipboard
navigator.clipboard.readText()
  .then(text => console.log('Clipboard content:', text))
  .catch(err => console.error('Failed to read', err));

// Copy image
const blob = await fetch('/image.png').then(r => r.blob());
await navigator.clipboard.write([
  new ClipboardItem({ 'image/png': blob })
]);
```

---

## Web APIs and Event Loop

Web APIs work with the event loop:

```javascript
console.log('1');

setTimeout(() => {
  console.log('2');  // Web API handles timing
}, 0);

console.log('3');

// Output: 1, 3, 2
// Call Stack: Execute sync code (1, 3)
// Web API: Timer runs in background
// Callback Queue: Callback added after timer
// Event Loop: Moves callback to stack when empty
```

---

## Best Practices

```javascript
// 1. Always handle errors
fetch(url)
  .then(response => response.json())
  .catch(error => console.error('Error:', error));

// 2. Clean up timers
const timer = setInterval(() => {}, 1000);
// Later...
clearInterval(timer);

// 3. Clean up event listeners
const handler = () => console.log('Click');
element.addEventListener('click', handler);
// Later...
element.removeEventListener('click', handler);

// 4. Use AbortController for cancellation
const controller = new AbortController();
fetch(url, { signal: controller.signal });
// Cancel if needed
controller.abort();

// 5. Debounce expensive operations
const debouncedFn = debounce(expensiveFn, 300);
input.addEventListener('input', debouncedFn);
```

---

## Key Takeaways

- **Web APIs**: Browser features for async operations
- **setTimeout/setInterval**: Timers for delayed/repeated execution
- **Fetch API**: Modern HTTP requests
- **DOM Events**: User interaction handling
- **Storage APIs**: localStorage, sessionStorage, IndexedDB
- **Web Workers**: Background threading
- **requestAnimationFrame**: Smooth animations
- **Observers**: IntersectionObserver, MutationObserver
- Web APIs run outside JavaScript engine
- Results go to callback/microtask queue
- Always clean up (timers, listeners, observers)
- Handle errors appropriately
- Use AbortController for cancellable operations
