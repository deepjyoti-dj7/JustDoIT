# 03. Hashes & Sorted Sets

## Redis Hashes

**Hashes** are maps of field-value pairs, similar to objects or dictionaries.

**Characteristics:**
- Key â†’ {field1: value1, field2: value2, ...}
- Efficient for storing objects
- Memory-efficient for small hashes
- All values are strings

**Use Cases:**
- User profiles
- Product details
- Session data
- Configuration settings

---

## Hash Commands - Basic Operations

### HSET - Set Field

```bash
# Set single field
HSET user:1001 name "John Doe"

# Set multiple fields
HSET user:1001 email "john@example.com" age "30" city "NYC"

# Set only if field doesn't exist
HSETNX user:1001 country "USA"
```

### HGET - Get Field

```bash
HGET user:1001 name
# "John Doe"

HGET user:1001 nonexistent
# (nil)
```

### HMGET - Get Multiple Fields

```bash
HMGET user:1001 name email age
# 1) "John Doe"
# 2) "john@example.com"
# 3) "30"
```

### HGETALL - Get All Fields

```bash
HGETALL user:1001
# 1) "name"
# 2) "John Doe"
# 3) "email"
# 4) "john@example.com"
# 5) "age"
# 6) "30"
# 7) "city"
# 8) "NYC"
```

### HKEYS / HVALS - Get Keys or Values

```bash
# Get all field names
HKEYS user:1001
# 1) "name"
# 2) "email"
# 3) "age"
# 4) "city"

# Get all values
HVALS user:1001
# 1) "John Doe"
# 2) "john@example.com"
# 3) "30"
# 4) "NYC"
```

### HEXISTS - Check Field Existence

```bash
HEXISTS user:1001 email
# (integer) 1 (exists)

HEXISTS user:1001 phone
# (integer) 0 (doesn't exist)
```

### HDEL - Delete Fields

```bash
# Delete single field
HDEL user:1001 city

# Delete multiple fields
HDEL user:1001 age country
```

### HLEN - Get Field Count

```bash
HLEN user:1001
# (integer) 3
```

---

## Hash Commands - Numeric Operations

### HINCRBY - Increment Integer Field

```bash
HSET user:1001 age 30
HINCRBY user:1001 age 1
# (integer) 31

HINCRBY user:1001 age -5
# (integer) 26
```

### HINCRBYFLOAT - Increment Float Field

```bash
HSET product:123 price 19.99
HINCRBYFLOAT product:123 price 5.00
# "24.99"

HINCRBYFLOAT product:123 price -2.50
# "22.49"
```

---

## Hash Use Cases

### 1. User Profile

```bash
# Store user profile
HSET user:1001 name "John Doe" email "john@example.com" age "30" city "NYC" role "admin"

# Get specific fields
HMGET user:1001 name email

# Update field
HSET user:1001 city "San Francisco"

# Increment age
HINCRBY user:1001 age 1
```

### 2. Product Catalog

```bash
# Store product
HSET product:123 name "Laptop" price "999.99" stock "50" category "electronics"

# Update stock
HINCRBY product:123 stock -1  # Sold one

# Update price
HINCRBYFLOAT product:123 price -50.00  # Discount
```

### 3. Session Storage

```bash
# Create session
HSET session:abc123 userId "1001" role "admin" loginTime "1735689600"
EXPIRE session:abc123 3600  # Session expires in 1 hour

# Check session
HGET session:abc123 userId
```

### 4. Configuration Settings

```bash
# App config
HSET config:app maxConnections "1000" timeout "30" debugMode "false"

# Get all settings
HGETALL config:app
```

---

## Hashes vs Strings (for objects)

### Storing User with Strings

```bash
SET user:1001:name "John"
SET user:1001:email "john@example.com"
SET user:1001:age "30"
# 3 keys, more memory
```

### Storing User with Hash

```bash
HSET user:1001 name "John" email "john@example.com" age "30"
# 1 key, less memory, more efficient
```

**Hash is better for:**
- Related fields grouped together
- Memory efficiency
- Atomic operations on single object

---

## Redis Sorted Sets (ZSets)

**Sorted Sets** are sets where each member has an associated score, sorted by score.

**Characteristics:**
- Unique members
- Each member has a score (float)
- Sorted by score (ascending)
- Fast access by rank or score range

**Use Cases:**
- Leaderboards
- Priority queues
- Time-series data
- Trending posts
- Rate limiting with timestamps

---

## Sorted Set Commands - Basic Operations

### ZADD - Add Members

```bash
# Add single member with score
ZADD leaderboard 100 "player1"

# Add multiple members
ZADD leaderboard 200 "player2" 150 "player3" 300 "player4"

# Update score if member exists
ZADD leaderboard 250 "player2"

# Add only if doesn't exist (NX)
ZADD leaderboard NX 400 "player5"

# Add only if exists (XX)
ZADD leaderboard XX 350 "player4"

# Increment score
ZADD leaderboard INCR 50 "player1"
# "150"
```

### ZRANGE - Get Members by Rank

```bash
# Get all members (ascending by score)
ZRANGE leaderboard 0 -1
# 1) "player1"
# 2) "player3"
# 3) "player2"
# 4) "player4"

# Get with scores
ZRANGE leaderboard 0 -1 WITHSCORES
# 1) "player1"
# 2) "150"
# 3) "player3"
# 4) "150"
# 5) "player2"
# 6) "250"
# 7) "player4"
# 8) "350"

# Get top 3
ZRANGE leaderboard 0 2
```

### ZREVRANGE - Get Members (Descending)

```bash
# Get all members (descending by score)
ZREVRANGE leaderboard 0 -1 WITHSCORES
# Highest score first

# Get top 3 players
ZREVRANGE leaderboard 0 2
```

### ZRANK / ZREVRANK - Get Member Rank

```bash
# Get rank (0-indexed, ascending)
ZRANK leaderboard "player2"
# (integer) 2 (3rd place from bottom)

# Get rank (descending)
ZREVRANK leaderboard "player2"
# (integer) 1 (2nd place from top)
```

### ZSCORE - Get Member Score

```bash
ZSCORE leaderboard "player2"
# "250"
```

### ZINCRBY - Increment Score

```bash
ZINCRBY leaderboard 50 "player1"
# "200"

ZINCRBY leaderboard -10 "player2"
# "240"
```

---

## Sorted Set Commands - Range Operations

### ZRANGEBYSCORE - Get Members by Score Range

```bash
# Get members with score 100-200
ZRANGEBYSCORE leaderboard 100 200

# Get with scores
ZRANGEBYSCORE leaderboard 100 200 WITHSCORES

# Exclusive range
ZRANGEBYSCORE leaderboard (100 (200  # 100 < score < 200

# Infinity
ZRANGEBYSCORE leaderboard 200 +inf  # score >= 200
ZRANGEBYSCORE leaderboard -inf 200  # score <= 200

# Limit results
ZRANGEBYSCORE leaderboard 0 1000 LIMIT 0 10  # First 10
```

### ZCOUNT - Count Members in Score Range

```bash
ZCOUNT leaderboard 100 200
# (integer) 3
```

### ZREM - Remove Members

```bash
ZREM leaderboard "player1"
# (integer) 1

# Remove multiple
ZREM leaderboard "player2" "player3"
```

### ZREMRANGEBYRANK - Remove by Rank

```bash
# Remove bottom 3
ZREMRANGEBYRANK leaderboard 0 2

# Remove all except top 10
ZREMRANGEBYRANK leaderboard 0 -11
```

### ZREMRANGEBYSCORE - Remove by Score

```bash
# Remove members with score < 100
ZREMRANGEBYSCORE leaderboard -inf 100

# Remove members with score 200-300
ZREMRANGEBYSCORE leaderboard 200 300
```

### ZCARD - Get Set Size

```bash
ZCARD leaderboard
# (integer) 4
```

---

## Sorted Set Use Cases

### 1. Leaderboard

```bash
# Add player scores
ZADD game:leaderboard 1500 "player1" 2000 "player2" 1800 "player3"

# Increment score when player wins
ZINCRBY game:leaderboard 100 "player1"

# Get top 10 players
ZREVRANGE game:leaderboard 0 9 WITHSCORES

# Get player's rank
ZREVRANK game:leaderboard "player1"
# (integer) 2 (3rd place)

# Get player's score
ZSCORE game:leaderboard "player1"
```

### 2. Priority Queue

```bash
# Add tasks with priority (lower score = higher priority)
ZADD tasks 1 "critical_bug"
ZADD tasks 5 "feature_request"
ZADD tasks 3 "documentation"

# Get highest priority task
ZRANGE tasks 0 0
# 1) "critical_bug"

# Process and remove
ZPOPMIN tasks
# 1) "critical_bug"
# 2) "1"
```

### 3. Time-Series Data (with timestamps)

```bash
# Store events with timestamp as score
ZADD events 1735689600 "user_login"
ZADD events 1735689650 "page_view"
ZADD events 1735689700 "purchase"

# Get events in time range
ZRANGEBYSCORE events 1735689600 1735689660

# Get events in last hour
ZRANGEBYSCORE events (now-3600) +inf

# Remove old events (older than 7 days)
ZREMRANGEBYSCORE events -inf (now-604800)
```

### 4. Trending Posts

```bash
# Add post with engagement score
ZADD trending:posts 100 "post:123"

# Upvote increases score
ZINCRBY trending:posts 1 "post:123"

# Get top 10 trending
ZREVRANGE trending:posts 0 9

# Decay scores (simulate time-based trending)
for post in ZRANGE trending:posts 0 -1:
    ZINCRBY trending:posts -1 post
```

### 5. Rate Limiting (Sliding Window)

```bash
# Add request with timestamp
ZADD ratelimit:user:1001 1735689600 "req1"
ZADD ratelimit:user:1001 1735689601 "req2"

# Remove requests older than 60 seconds
ZREMRANGEBYSCORE ratelimit:user:1001 -inf (now-60)

# Count requests in last 60 seconds
ZCOUNT ratelimit:user:1001 (now-60) +inf
# If > 100, rate limit exceeded
```

---

## Performance Characteristics

### Hashes

| Command | Time Complexity |
|---------|----------------|
| HSET | O(1) |
| HGET | O(1) |
| HMGET | O(N) - N fields |
| HGETALL | O(N) - N fields |
| HDEL | O(N) - N fields |
| HINCRBY | O(1) |

### Sorted Sets

| Command | Time Complexity |
|---------|----------------|
| ZADD | O(log N) |
| ZREM | O(log N) |
| ZRANGE | O(log N + M) - M elements returned |
| ZRANGEBYSCORE | O(log N + M) |
| ZRANK | O(log N) |
| ZSCORE | O(1) |
| ZINCRBY | O(log N) |

---

## Summary

**Hashes:**
- Commands: `HSET`, `HGET`, `HGETALL`, `HDEL`, `HINCRBY`
- Use cases: User profiles, product data, session storage
- Memory-efficient for objects
- Field-level operations

**Sorted Sets:**
- Commands: `ZADD`, `ZRANGE`, `ZREVRANGE`, `ZRANK`, `ZINCRBY`, `ZRANGEBYSCORE`
- Use cases: Leaderboards, priority queues, time-series, trending
- Sorted by score
- Fast range queries

---

## Interview Questions & Answers

### Q1: What's the difference between a Hash and a String for storing objects?
**A:**

**Hash (Better):**
```bash
HSET user:1001 name "John" age "30"
# 1 key, field-level access
```

**String (Less efficient):**
```bash
SET user:1001:name "John"
SET user:1001:age "30"
# 2 keys, more memory overhead
```

Hash is more memory-efficient and allows atomic field operations.

### Q2: How do you implement a leaderboard with Redis?
**A:** Use Sorted Sets with scores:
```bash
# Add players with scores
ZADD leaderboard 1500 "player1" 2000 "player2"

# Update score
ZINCRBY leaderboard 100 "player1"

# Get top 10
ZREVRANGE leaderboard 0 9 WITHSCORES

# Get player rank
ZREVRANK leaderboard "player1"
```

### Q3: What's the time complexity of HGETALL?
**A:** **O(N)** where N is the number of fields. For large hashes, avoid `HGETALL` and use `HSCAN` to iterate:
```bash
HSCAN user:1001 0 COUNT 10
```

### Q4: Can you store non-string values in a Hash?
**A:** No, all hash values are strings. For numbers, store as string and use `HINCRBY`/`HINCRBYFLOAT`:
```bash
HSET user:1001 age "30"      # Stored as string
HINCRBY user:1001 age 1      # "31"
```

### Q5: How do you get the top 3 members from a Sorted Set?
**A:** Use `ZREVRANGE` (descending order):
```bash
ZREVRANGE leaderboard 0 2 WITHSCORES
```
`ZRANGE` returns ascending order, `ZREVRANGE` returns descending.

### Q6: What's the difference between ZRANGE and ZRANGEBYSCORE?
**A:**
- **ZRANGE**: Get by rank/position (0-indexed)
- **ZRANGEBYSCORE**: Get by score range

```bash
ZRANGE leaderboard 0 9           # Top 10 by rank
ZRANGEBYSCORE leaderboard 100 200 # Score between 100-200
```

### Q7: How do you implement a priority queue with Redis?
**A:** Use Sorted Set with priority as score (lower = higher priority):
```bash
ZADD tasks 1 "critical" 5 "normal" 10 "low"

# Get highest priority
ZPOPMIN tasks  # Returns "critical"
```

### Q8: Can Sorted Set members have the same score?
**A:** Yes! Members with same score are sorted lexicographically:
```bash
ZADD myset 100 "alice" 100 "bob" 100 "charlie"
ZRANGE myset 0 -1
# 1) "alice" 2) "bob" 3) "charlie" (alphabetical)
```

### Q9: How do you increment a hash field atomically?
**A:** Use `HINCRBY` or `HINCRBYFLOAT`:
```bash
HINCRBY user:1001 loginCount 1
HINCRBYFLOAT product:123 price 5.99
```
These are atomic operations, safe for concurrent access.

### Q10: What's ZPOPMIN and ZPOPMAX?
**A:** Pop member with min/max score (Redis 5.0+):
```bash
ZPOPMIN leaderboard    # Remove & return lowest score
ZPOPMAX leaderboard    # Remove & return highest score

# Pop multiple
ZPOPMIN leaderboard 3
```

### Q11: How do you implement rate limiting with Sorted Sets?
**A:** Use timestamp as score:
```bash
# Add request with current timestamp
ZADD ratelimit:user:1001 1735689600 "req1"

# Remove old requests (older than 60 seconds)
ZREMRANGEBYSCORE ratelimit:user:1001 -inf (now-60)

# Count requests in window
ZCARD ratelimit:user:1001
# If > 100, rate limit
```

### Q12: Can you update multiple hash fields atomically?
**A:** Yes, `HSET` with multiple fields is atomic:
```bash
HSET user:1001 name "John" age "30" city "NYC"
# All fields set atomically
```

### Q13: How do you get a member's rank in a Sorted Set?
**A:** Use `ZRANK` (ascending) or `ZREVRANK` (descending):
```bash
ZRANK leaderboard "player1"      # Rank from lowest
ZREVRANK leaderboard "player1"   # Rank from highest
```

### Q14: What's the difference between ZREM and ZREMRANGEBYRANK?
**A:**
- **ZREM**: Remove specific members by name
- **ZREMRANGEBYRANK**: Remove by rank range

```bash
ZREM leaderboard "player1"       # Remove specific member
ZREMRANGEBYRANK leaderboard 0 2  # Remove bottom 3
```

### Q15: How do you store time-series data in Redis?
**A:** Use Sorted Set with timestamp as score:
```bash
ZADD events 1735689600 "event1"
ZADD events 1735689650 "event2"

# Get events in time range
ZRANGEBYSCORE events 1735689600 1735689700

# Remove old events
ZREMRANGEBYSCORE events -inf (now-86400)
```

**Next:** Bitmaps, HyperLogLog & Streams!