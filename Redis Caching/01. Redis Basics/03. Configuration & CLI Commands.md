# 03. Configuration & CLI Commands

## Redis Configuration

### Configuration File Location

**Default Locations:**
- Linux: `/etc/redis/redis.conf`
- macOS (Homebrew): `/usr/local/etc/redis.conf`
- Docker: Mount custom config

### View Current Configuration

```bash
# Get all config
redis-cli CONFIG GET *

# Get specific config
redis-cli CONFIG GET maxmemory
redis-cli CONFIG GET requirepass
```

### Set Configuration at Runtime

```bash
# Set config (doesn't persist after restart)
redis-cli CONFIG SET maxmemory 2gb
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# Save to disk (make persistent)
redis-cli CONFIG REWRITE
```

---

## Important Configuration Options

### 1. Network Configuration

```conf
# Bind to specific interfaces
bind 127.0.0.1 ::1

# Accept all connections (use with caution!)
bind 0.0.0.0

# Port
port 6379

# TCP listen backlog
tcp-backlog 511

# Close connection after client idle for N seconds
timeout 300

# TCP keepalive
tcp-keepalive 300
```

### 2. Security

```conf
# Require password for authentication
requirepass YourStrongPassword123!

# Disable specific commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_abc123"

# Protected mode (default: yes)
protected-mode yes
```

### 3. Memory Management

```conf
# Maximum memory limit
maxmemory 4gb

# Eviction policy when maxmemory reached
maxmemory-policy allkeys-lru

# Sample size for LRU/LFU algorithms
maxmemory-samples 5
```

**Eviction Policies:**

| Policy | Description |
|--------|-------------|
| `noeviction` | Return errors when memory limit reached |
| `allkeys-lru` | Evict least recently used keys |
| `volatile-lru` | Evict LRU among keys with TTL |
| `allkeys-lfu` | Evict least frequently used keys |
| `volatile-lfu` | Evict LFU among keys with TTL |
| `allkeys-random` | Evict random keys |
| `volatile-random` | Evict random keys with TTL |
| `volatile-ttl` | Evict keys with shortest TTL |

### 4. Persistence (RDB Snapshots)

```conf
# Save snapshots based on time and changes
save 900 1       # Save if 1 key changed in 900 seconds
save 300 10      # Save if 10 keys changed in 300 seconds
save 60 10000    # Save if 10000 keys changed in 60 seconds

# Disable snapshots
save ""

# RDB filename
dbfilename dump.rdb

# Directory for dump files
dir /var/lib/redis

# Compress RDB files
rdbcompression yes

# Checksum in RDB files
rdbchecksum yes

# Stop writes if save fails
stop-writes-on-bgsave-error yes
```

### 5. Persistence (AOF)

```conf
# Enable AOF
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# Fsync policy
appendfsync everysec
# Options:
#   always  - Fsync after every write (slow, safest)
#   everysec - Fsync every second (good compromise)
#   no      - Let OS decide (fastest, least safe)

# Rewrite AOF when it grows by percentage
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF on startup
aof-load-truncated yes
```

### 6. Replication

```conf
# Make this instance a replica
replicaof 192.168.1.100 6379

# Password for master
masterauth <master-password>

# Replica read-only (default: yes)
replica-read-only yes

# Replica priority for Sentinel
replica-priority 100
```

### 7. Logging

```conf
# Log levels: debug, verbose, notice, warning
loglevel notice

# Log file location
logfile /var/log/redis/redis-server.log

# Log to stdout
logfile ""

# Syslog
syslog-enabled no
```

### 8. Performance

```conf
# Max clients
maxclients 10000

# Lazy freeing (delete keys in background)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Disable Transparent Huge Pages warning
vm.overcommit_memory 1
```

---

## Essential Redis CLI Commands

### Connection Commands

```bash
# Connect to Redis
redis-cli

# Connect with password
redis-cli -a password

# Connect to remote server
redis-cli -h 192.168.1.100 -p 6379

# Authenticate after connecting
127.0.0.1:6379> AUTH password
OK

# Ping server
127.0.0.1:6379> PING
PONG

# Test connection
127.0.0.1:6379> ECHO "Hello Redis"
"Hello Redis"
```

---

### Server Commands

```bash
# Get server info
INFO
INFO server
INFO memory
INFO stats
INFO replication
INFO cpu
INFO keyspace

# Get config
CONFIG GET *
CONFIG GET maxmemory

# Set config
CONFIG SET maxmemory 2gb
CONFIG REWRITE

# Get database size
DBSIZE

# Get memory stats
MEMORY STATS
MEMORY USAGE key

# Get client list
CLIENT LIST

# Kill client
CLIENT KILL 127.0.0.1:6379

# Monitor all commands in real-time
MONITOR

# Get slow log
SLOWLOG GET 10
SLOWLOG LEN
SLOWLOG RESET

# Save database
SAVE           # Blocking
BGSAVE         # Background

# Last save time
LASTSAVE

# Shutdown server
SHUTDOWN
SHUTDOWN SAVE
```

---

### Key Commands

```bash
# List keys (avoid in production!)
KEYS *
KEYS user:*
KEYS user:??

# Scan keys (production-safe)
SCAN 0 MATCH user:* COUNT 100

# Check if key exists
EXISTS key
EXISTS key1 key2 key3

# Get key type
TYPE key

# Delete keys
DEL key
DEL key1 key2 key3

# Unlink (async delete)
UNLINK key

# Rename key
RENAME oldkey newkey
RENAMENX oldkey newkey  # Only if newkey doesn't exist

# Get random key
RANDOMKEY

# Move key to another database
MOVE key 1
```

---

### TTL (Time To Live) Commands

```bash
# Set TTL in seconds
EXPIRE key 60
EXPIREAT key 1609459200  # Unix timestamp

# Set TTL in milliseconds
PEXPIRE key 60000
PEXPIREAT key 1609459200000

# Check TTL
TTL key      # Returns remaining seconds
PTTL key     # Returns remaining milliseconds
# Returns:
#   -1 if key has no expiry
#   -2 if key doesn't exist
#   N if TTL is N seconds

# Remove TTL
PERSIST key

# Set with TTL
SETEX key 60 "value"       # String with TTL
SET key "value" EX 60      # Same as SETEX
SET key "value" PX 60000   # TTL in milliseconds
```

---

### Database Commands

```bash
# Select database (0-15 by default)
SELECT 0
SELECT 1

# Flush current database
FLUSHDB

# Flush all databases
FLUSHALL

# Get database size
DBSIZE

# Swap databases
SWAPDB 0 1
```

---

### Transaction Commands

```bash
# Start transaction
MULTI

# Execute commands
SET key1 "value1"
INCR counter
GET key1

# Execute transaction
EXEC

# Cancel transaction
DISCARD

# Watch key for changes
WATCH key
UNWATCH
```

**Example Transaction:**

```bash
127.0.0.1:6379> MULTI
OK
127.0.0.1:6379> SET user:1:name "John"
QUEUED
127.0.0.1:6379> SET user:1:age 30
QUEUED
127.0.0.1:6379> INCR user:count
QUEUED
127.0.0.1:6379> EXEC
1) OK
2) OK
3) (integer) 1
```

---

### Pub/Sub Commands

```bash
# Subscribe to channels
SUBSCRIBE channel1 channel2

# Subscribe with pattern
PSUBSCRIBE news:*

# Unsubscribe
UNSUBSCRIBE channel1
PUNSUBSCRIBE news:*

# Publish message
PUBLISH channel "Hello"

# List active channels
PUBSUB CHANNELS
PUBSUB CHANNELS news:*

# Count subscribers
PUBSUB NUMSUB channel1 channel2
```

---

### Scripting Commands

```bash
# Evaluate Lua script
EVAL "return redis.call('SET', 'key', 'value')" 0

# Load script
SCRIPT LOAD "return redis.call('GET', KEYS[1])"
# Returns: SHA1 hash

# Execute loaded script
EVALSHA sha1hash 1 mykey

# Check if script exists
SCRIPT EXISTS sha1hash

# Flush scripts
SCRIPT FLUSH

# Kill running script
SCRIPT KILL
```

---

### Benchmark Commands

```bash
# Run benchmark
redis-benchmark -h localhost -p 6379 -c 50 -n 10000

# Options:
#   -c: Number of parallel connections (default: 50)
#   -n: Total number of requests (default: 100000)
#   -d: Data size of SET/GET value in bytes (default: 3)
#   -t: Only run specific tests (e.g., get,set)

# Benchmark specific commands
redis-benchmark -t set,get -n 100000 -q

# Benchmark with pipeline
redis-benchmark -n 1000000 -t get,set -P 16 -q
```

---

## Advanced CLI Features

### 1. CLI with JSON Output

```bash
redis-cli --json GET user:1
```

### 2. Execute Commands from File

```bash
# commands.txt:
# SET key1 value1
# SET key2 value2
# GET key1

cat commands.txt | redis-cli
```

### 3. Continuous Stats

```bash
# Live stats every second
redis-cli --stat

# Custom interval (5 seconds)
redis-cli --stat -i 5
```

### 4. Latency Monitoring

```bash
# Check latency
redis-cli --latency

# Latency history
redis-cli --latency-history

# Latency doctor
redis-cli --latency-doctor
```

### 5. Memory Analysis

```bash
# Get memory report
redis-cli --memkeys

# Memory usage of specific key
redis-cli MEMORY USAGE mykey
```

### 6. RDB Analysis

```bash
# Analyze RDB file
redis-cli --rdb dump.rdb
```

---

## Useful CLI Patterns

### Delete Keys by Pattern

```bash
# Delete all keys matching pattern
redis-cli --scan --pattern 'user:*' | xargs redis-cli DEL

# Or using Lua script
redis-cli EVAL "return redis.call('del', unpack(redis.call('keys', 'user:*')))" 0
```

### Count Keys by Pattern

```bash
redis-cli --scan --pattern 'session:*' | wc -l
```

### Export/Import Data

```bash
# Export
redis-cli --rdb backup.rdb

# Import
redis-cli --pipe < backup.txt
```

---

## Summary

**Configuration:**
- File: `/etc/redis/redis.conf`
- Runtime: `CONFIG SET`, `CONFIG GET`
- Persistence: `CONFIG REWRITE`

**Key Commands:**
- `KEYS *` (dev only), `SCAN` (production)
- `EXISTS`, `TYPE`, `DEL`, `RENAME`
- `EXPIRE`, `TTL`, `PERSIST`

**Server Commands:**
- `INFO`, `CONFIG`, `DBSIZE`
- `MONITOR`, `SLOWLOG`
- `SAVE`, `BGSAVE`, `SHUTDOWN`

**Databases:**
- `SELECT`, `FLUSHDB`, `FLUSHALL`
- Default: 16 databases (0-15)

**Transactions:**
- `MULTI`, `EXEC`, `DISCARD`
- `WATCH`, `UNWATCH`

---

## Interview Questions & Answers

### Q1: How do you get all Redis configuration?
**A:**
```bash
redis-cli CONFIG GET *
```

### Q2: How do you set maxmemory at runtime?
**A:**
```bash
redis-cli CONFIG SET maxmemory 2gb
redis-cli CONFIG REWRITE  # Make it persistent
```

### Q3: What is the difference between KEYS and SCAN?
**A:**
- **KEYS**: Returns all matching keys at once (blocks server, avoid in production)
- **SCAN**: Returns keys in batches using cursor (non-blocking, production-safe)

```bash
KEYS user:*           # Blocks until done
SCAN 0 MATCH user:*   # Returns cursor + partial results
```

### Q4: What are Redis eviction policies?
**A:** When `maxmemory` is reached:
- `noeviction`: Return errors
- `allkeys-lru`: Evict least recently used
- `volatile-lru`: Evict LRU with TTL
- `allkeys-lfu`: Evict least frequently used
- `volatile-ttl`: Evict shortest TTL first

### Q5: How do you set a key with expiration?
**A:**
```bash
SET key "value" EX 60        # 60 seconds
SET key "value" PX 60000     # 60000 milliseconds
SETEX key 60 "value"         # Alternative syntax
EXPIRE key 60                # Set TTL on existing key
```

### Q6: What does TTL -1 mean?
**A:**
- **-1**: Key exists but has no expiration
- **-2**: Key doesn't exist
- **N**: Key expires in N seconds

### Q7: How do you monitor all Redis commands in real-time?
**A:**
```bash
redis-cli MONITOR
```
Shows all commands executed on the server (use cautiously in production).

### Q8: What is the difference between SAVE and BGSAVE?
**A:**
- **SAVE**: Blocks server while saving (synchronous)
- **BGSAVE**: Forks process to save in background (asynchronous, recommended)

### Q9: How do you delete multiple keys matching a pattern?
**A:**
```bash
redis-cli --scan --pattern 'session:*' | xargs redis-cli DEL
```
Don't use `KEYS *` in production as it blocks the server.

### Q10: What are Redis transactions?
**A:** Group of commands executed atomically:
```bash
MULTI
SET key1 "value1"
INCR counter
EXEC
```
All commands execute together or none execute. Not full ACID - no rollback.

### Q11: How do you check Redis slow queries?
**A:**
```bash
redis-cli SLOWLOG GET 10   # Get last 10 slow queries
redis-cli SLOWLOG LEN      # Count of slow queries
```

### Q12: How many databases does Redis have by default?
**A:** **16 databases** (0-15). Switch with:
```bash
SELECT 0
SELECT 1
```

### Q13: How do you flush all Redis data?
**A:**
```bash
FLUSHDB    # Flush current database
FLUSHALL   # Flush all databases
```
**Warning:** Irreversible operation!

### Q14: What is the purpose of WATCH command?
**A:** `WATCH` implements optimistic locking for transactions:
```bash
WATCH balance
MULTI
DECR balance
EXEC
```
If `balance` changes after `WATCH` but before `EXEC`, transaction is aborted.

### Q15: How do you benchmark Redis performance?
**A:**
```bash
redis-benchmark -c 50 -n 100000 -t get,set -q
```
- `-c`: Concurrent connections
- `-n`: Total requests
- `-t`: Commands to test
- `-q`: Quiet mode (summary only)

**ðŸŽ‰ Redis Basics Complete! All 3 files done!**