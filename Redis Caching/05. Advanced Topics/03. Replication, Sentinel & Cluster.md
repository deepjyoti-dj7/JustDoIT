# 03. Replication, Sentinel & Cluster

## Overview

- Replication: Master → replicas for read scale and failover.
- Sentinel: Monitors, auto-failover to replica.
- Cluster: Shards data across nodes (16384 hash slots) with built-in replication.

---

## Replication

### Configure
```conf
# redis.conf (replica)
replicaof 127.0.0.1 6379
masterauth <password>
```

### Notes
- Async replication; replicas may lag.
- Read from replicas to offload masters.

---

## Sentinel (High Availability)

### sentinel.conf
```conf
port 26379
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel auth-pass mymaster <password>
```

### Start
```bash
redis-sentinel sentinel.conf
```

### Clients
```javascript
// ioredis
const Redis = require('ioredis');
const r = new Redis({
  sentinels: [{host:'127.0.0.1',port:26379}],
  name: 'mymaster',
  password: process.env.REDIS_PASSWORD
});
```

---

## Cluster (Sharding)

### Hash Slots
- 16384 slots distributed across masters.
- Key slot = `CRC16(key) % 16384`.

### Setup
```bash
# 6 nodes (3 masters, 3 replicas)
redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
  127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 \
  --cluster-replicas 1
```

### Clients
```javascript
const cluster = new Redis.Cluster([
  {host:'127.0.0.1',port:7000},
  {host:'127.0.0.1',port:7001},
  {host:'127.0.0.1',port:7002}
], { scaleReads: 'slave' });
```

### Hash Tags
```bash
SET user:{1001}:name "John"
SET user:{1001}:email "john@example.com"
MGET user:{1001}:name user:{1001}:email  # same slot → allowed
```

---

## Failover & Consistency

- Sentinel: promotes replica; clients reconnect automatically.
- Cluster: replica promoted to master for a slot subset.
- Eventual consistency: reads from replicas may be stale.

---

## Resharding & Maintenance

- Add/remove nodes with `--cluster reshard`.
- Handle `MOVED/ASK` redirects; clients auto-follow.
- Monitor slot balance and replica health.

---

## Best Practices

- Use Sentinel for HA without sharding; Cluster for scale-out.
- Use hash tags for multi-key ops in Cluster.
- Separate read/write paths: reads to replicas when safe.
- Monitor failovers; set reasonable timeouts.

---

## Summary

Replication adds redundancy; Sentinel automates failover; Cluster shards data for scale while providing HA.

---

## Interview Questions & Answers

1) Q: Difference between Sentinel and Cluster?
   A: Sentinel handles HA failover for a single master-replica set; Cluster shards data across masters and includes replication.

2) Q: What are hash slots?
   A: Fixed 16384 logical partitions to distribute keys; slot = `CRC16(key) % 16384`.

3) Q: How to perform multi-key ops in Cluster?
   A: Use hash tags `{...}` to ensure keys hash to same slot.

4) Q: Can replicas serve writes?
   A: No; writes go to masters; replicas serve reads to offload.

5) Q: How does Sentinel detect failure?
   A: Based on `down-after-milliseconds` and quorum; triggers failover if master unresponsive.

6) Q: What is `MOVED` error?
   A: Indicates key is on a different slot/master; client should redirect to specified node.

7) Q: How to scale reads?
   A: Configure clients (e.g., ioredis `scaleReads:'slave'`) to use replicas for reads.

8) Q: Does Cluster guarantee strong consistency?
   A: No; replication is asynchronous; replicas may lag.

9) Q: How to handle resharding?
   A: Use cluster admin tools; clients automatically follow `MOVED/ASK` redirections.

10) Q: How to set up Sentinel quorum?
    A: `sentinel monitor mymaster host port quorum` where quorum is # of sentinels required to agree.

11) Q: Pros/cons of Cluster vs single-node with sharding at app?
    A: Cluster simplifies routing/failover; app-side sharding gives more control but adds complexity.

12) Q: Can you run Pub/Sub in Cluster?
    A: Yes, but subscribers must connect to relevant nodes; consider proxy or central channel.

13) Q: How do clients discover topology?
    A: Cluster nodes share topology; clients update on `MOVED`/`ASK` responses.

14) Q: What happens during failover?
    A: Replica promoted to master; writes continue; brief write stall possible.

15) Q: Why use hash tags?
    A: Enable multi-key operations by co-locating related keys in the same slot.
