# 06. Docker, Deployment & Best Practices

## Docker Basics

### Standalone
```bash
docker run -d --name redis \
  -p 6379:6379 \
  -v redis-data:/data \
  redis:7-alpine \
  --appendonly yes --appendfsync everysec
```

### Compose (Sentinel)
```yaml
version: '3.8'
services:
  redis-master:
    image: redis:7-alpine
    command: ["redis-server", "--requirepass", "pass"]
    ports: ["6379:6379"]
  redis-replica:
    image: redis:7-alpine
    command: ["redis-server", "--replicaof", "redis-master", "6379", "--masterauth", "pass"]
  sentinel:
    image: redis:7-alpine
    command: ["redis-sentinel", "/etc/sentinel.conf"]
    volumes:
      - ./sentinel.conf:/etc/sentinel.conf
    ports: ["26379:26379"]
```

### Compose (Cluster minimal)
```yaml
version: '3.8'
services:
  redis-7000:
    image: redis:7-alpine
    command: ["redis-server", "--port", "7000", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf"]
    ports: ["7000:7000"]
  redis-7001:
    image: redis:7-alpine
    command: ["redis-server", "--port", "7001", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf"]
    ports: ["7001:7001"]
  redis-7002:
    image: redis:7-alpine
    command: ["redis-server", "--port", "7002", "--cluster-enabled", "yes", "--cluster-config-file", "nodes.conf"]
    ports: ["7002:7002"]
```

Initialize cluster:
```bash
docker exec -it redis-7000 redis-cli --cluster create \
  127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
  --cluster-replicas 0
```

---

## Deployment Guidelines

- Use managed Redis (AWS ElastiCache, Azure Cache) for production if possible.
- Enable persistence (AOF everysec or mixed mode).
- Size instances with RAM buffer for COW.
- Use Sentinel or Cluster for HA/scale.
- Secure with ACLs and TLS; isolate network.

---

## Operations

### Backups
- Snapshot RDB regularly; store securely.
- For AOF, ensure reliable disks and monitor rewrite.

### Upgrades
- Rolling upgrades for replicas first, then master.
- In Cluster, relocate slots to minimize impact.

### Observability
- Export Prometheus metrics; create dashboards for memory, hit rate, latency, evictions.

---

## Best Practices

- Use hash tags in Cluster for multi-key ops.
- Set TTL for cached data; avoid unbounded growth.
- Use lazy free options for large deletions.
- Avoid `FLUSHALL` in production; use `UNLINK` on large key removals.
- Load test with realistic traffic patterns.

---

## Summary

Containerize Redis with sensible defaults; for production, secure, persist, monitor, and deploy with HA. Prefer managed services to reduce ops burden.

---

## Interview Questions & Answers

1) Q: Why prefer managed Redis over self-hosted?
   A: Managed services handle HA, backups, monitoring, upgrades, and patching, reducing operational risk and toil.

2) Q: How to deploy Redis with HA?
   A: Sentinel for master-replica failover; Cluster for sharding + replication; use multiple nodes across AZs.

3) Q: How to back up Redis?
   A: Periodic RDB snapshots, secure storage; for AOF, ensure reliable disks and monitor rewrite.

4) Q: What’s `UNLINK` vs `DEL`?
   A: `UNLINK` frees memory asynchronously (lazy free), reducing latency spikes for large keys.

5) Q: How to initialize a cluster in Docker?
   A: Start nodes with cluster enabled, then `redis-cli --cluster create` to assign slots.

6) Q: How to secure Redis in containers?
   A: ACLs, TLS, secrets management, network isolation (no public ports), read-only root FS where possible.

7) Q: What persistence mode for production?
   A: AOF `everysec` or mixed mode (RDB preamble + AOF tail) for balanced durability and restart time.

8) Q: How to perform rolling upgrades?
   A: Upgrade replicas first; failover; upgrade former master; in Cluster, move slots carefully.

9) Q: What metrics to alert on?
   A: Memory usage %, hit rate, evictions, command latency, replication lag, cluster state.

10) Q: Why set maxmemory?
    A: Prevents Redis from consuming all RAM; enables predictable evictions by policy.

11) Q: How to handle large key deletions?
    A: Use `UNLINK` and enable lazyfree configs to offload freeing to background threads.

12) Q: How to support multi-key ops in Cluster?
    A: Hash tags (e.g., `user:{1001}:name` and `user:{1001}:email`) to place keys in same slot.

13) Q: What’s the risk of exposing 6379 publicly?
    A: Unauthorized access and data exfiltration; always restrict network and require auth/TLS.

14) Q: How to keep images small?
    A: Use alpine images; avoid installing unnecessary packages; mount configs and volumes externally.

15) Q: How to test failover?
    A: Kill master; verify Sentinel promotes replica and clients reconnect; in Cluster, check slot masters and replica promotions.
