# 05. Performance, Security & Monitoring

## Performance Tuning

- Use pipelines for batching to reduce RTT.
- Prefer `MGET/MSET` over many single operations.
- Keep Lua scripts short; offload long work to workers.
- Tune `tcp-keepalive`, `client-output-buffer-limit` for large Pub/Sub.
- Choose right eviction policy (`allkeys-lru`, `allkeys-lfu`).

```conf
maxmemory 4gb
maxmemory-policy allkeys-lfu
maxmemory-samples 5
```

### Data Structure Choices
- Hashes for objects (reduce key overhead).
- Bitmaps for boolean arrays.
- HyperLogLog for cardinality estimation.
- Sorted sets for leaderboards and time-based scoring.

---

## Security

### ACLs
```conf
requirepass <strong-password>
user default on >password ~* +@all
user readonly on >ro-pass ~* +get +mget +exists
```

### TLS
```conf
tls-port 6380
tls-cert-file /etc/redis/redis.crt
tls-key-file /etc/redis/redis.key
tls-ca-cert-file /etc/redis/ca.crt
```

### Network Hardening
- Bind to private interfaces: `bind 10.0.0.5`.
- Disable dangerous commands for managed deployments.

```conf
disable-commands FLUSHALL FLUSHDB
```

---

## Monitoring & Observability

### Built-in Commands
- `INFO` (memory, clients, cpu, stats).
- `LATENCY LATEST` and `LATENCY DOCTOR`.
- `SLOWLOG GET` for slow commands.
- `MONITOR` (debug only!).

```bash
redis-cli INFO memory
redis-cli LATENCY LATEST
redis-cli SLOWLOG GET 10
```

### Metrics to Watch
- Hit rate (hits/misses).
- Memory usage & fragmentation ratio.
- Evictions & expired keys.
- Command latency percentiles.
- Replication lag.

### External Tools
- Prometheus exporter (e.g., `oliver006/redis_exporter`).
- Grafana dashboards.
- APM integration for app-level latency.

---

## Capacity & Resilience

- Size maxmemory based on dataset; leave RAM buffer for COW.
- Use Sentinel or Cluster for HA.
- Enable `lazyfree-lazy-eviction` for large key deletions.

```conf
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
```

---

## Summary

Tune performance with batching and right data structures; secure with ACL/TLS; monitor memory, latency, and hit rate; use HA configurations.

---

## Interview Questions & Answers

1) Q: How to improve Redis throughput?
   A: Use pipelines, batch ops (`MGET/MSET`), and reduce RTT; choose memory-efficient structures.

2) Q: What’s `maxmemory-policy allkeys-lfu`?
   A: Evicts least frequently used keys among all keys; good for skewed access patterns.

3) Q: Why use hashes over many keys?
   A: Lower per-key overhead; better memory efficiency for related fields.

4) Q: How to secure Redis in production?
   A: ACLs with strong passwords, TLS, bind to private interfaces, disable risky commands.

5) Q: What does fragmentation ratio indicate?
   A: `mem_fragmentation_ratio` shows allocator overhead; >1.5 may indicate fragmentation; <1.0 suggests swapping.

6) Q: How to find slow commands?
   A: `SLOWLOG GET` and latency commands; profile and optimize.

7) Q: What’s hit rate and why does it matter?
   A: Ratio of cache hits to total lookups; low hit rate indicates poor caching strategy or TTL settings.

8) Q: How to monitor replication health?
   A: Track replica offset and lag; alerts on stalls.

9) Q: Why enable lazyfree options?
   A: Offload deletion work to background threads to reduce latency spikes when deleting large keys.

10) Q: How to prevent data leaks?
    A: TLS, ACL-restricted users, network isolation, auditing access.

11) Q: What’s the risk of `MONITOR`?
    A: Heavy overhead, exposes sensitive data; use only for short-lived debugging.

12) Q: How to set rate limits effectively?
    A: Lua token buckets or fixed-window counters with TTL; log and alert on abuse.

13) Q: What’s a good eviction metric to track?
    A: `evicted_keys` increasing may indicate undersized memory or poor TTL policies.

14) Q: How to tune maxmemory-samples?
    A: Higher improves eviction accuracy at some CPU cost; default 5 is a good balance.

15) Q: How to plan capacity?
    A: Estimate dataset + overhead, include 2× for persistence COW, set `maxmemory`, test under load.
