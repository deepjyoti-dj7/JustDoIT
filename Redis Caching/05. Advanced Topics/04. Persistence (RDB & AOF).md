# 04. Persistence (RDB & AOF)

## Overview

Redis supports two persistence mechanisms:
- RDB (snapshots): Compact binary dumps at intervals.
- AOF (append-only file): Log of every write operation.
- Mixed mode: RDB + AOF for fast restarts + durability.

---

## RDB Snapshots

### Configure
```conf
save 900 1   # after 1 change in 900s
save 300 10  # after 10 changes in 300s
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
```

### Pros/Cons
- Pros: Smaller files, faster restarts.
- Cons: Potential data loss between snapshots.

---

## AOF (Append Only File)

### Configure
```conf
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec   # always|everysec|no
no-appendfsync-on-rewrite yes
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

### Fsync Policies
- `always`: Safest, slowest.
- `everysec`: Good compromise (at most 1s of data loss).
- `no`: Fastest, risk of loss on crash.

### Rewrite
- AOF rewrite compacts the log; runs in background to reduce size.

---

## Mixed Mode (RDB preamble + AOF tail)

- Fast restart from RDB, then apply AOF tail.
- Recommended in modern Redis with `aof-use-rdb-preamble yes`.

```conf
appendonly yes
aof-use-rdb-preamble yes
```

---

## Restore & Backup

### Backup
- Copy `dump.rdb` and/or `appendonly.aof` safely.
- Use `BGSAVE` to trigger snapshot.

### Restore
```bash
# Stop server, place files, then start
cp dump.rdb /var/lib/redis/
systemctl start redis
```

### AOF Corruption Recovery
```bash
redis-check-aof --fix appendonly.aof
```

---

## Fork & Memory Considerations

- Persistence operations fork the process.
- Copy-on-write increases memory usage during `BGSAVE`/rewrite.
- Ensure free RAM (~2× dataset worst-case) to avoid OOM.

---

## Best Practices

- Use AOF `everysec` for balanced durability.
- Combine RDB for periodic full backups.
- Store files on reliable disks (SSD) with enough IOPS.
- Monitor rewrite cycles and latency spikes.
- Test restore procedures regularly.

---

## Summary

Choose RDB for speed and simple backups; AOF for durability; mixed mode for fast restarts with low loss.

---

## Interview Questions & Answers

1) Q: Difference between RDB and AOF?
   A: RDB snapshots capture state periodically; AOF logs each write. RDB is smaller/faster start; AOF is more durable.

2) Q: What is `appendfsync everysec`?
   A: Flushes AOF to disk every second; balances performance and durability.

3) Q: Can AOF grow indefinitely?
   A: Rewrite process compacts AOF; configure `auto-aof-rewrite-*` to trigger.

4) Q: Does RDB guarantee zero data loss?
   A: No; changes since last snapshot can be lost on crash.

5) Q: What happens during `BGSAVE`?
   A: Redis forks; child writes snapshot; parent continues serving clients.

6) Q: What is mixed AOF/RDB mode?
   A: RDB preamble for fast load; AOF tail for recent writes; enables quick restarts with durability.

7) Q: How to recover from AOF corruption?
   A: Use `redis-check-aof --fix` to truncate to last valid op.

8) Q: How to trigger a manual snapshot?
   A: `BGSAVE` (async) or `SAVE` (blocking).

9) Q: Where are files stored?
   A: Typically in `dir` configured path (e.g., `/var/lib/redis`).

10) Q: Impact of persistence on latency?
    A: Fsync and background rewrite may increase latency; monitor and tune.

11) Q: How to reduce RDB size?
    A: Enable compression, remove unnecessary keys, use memory-efficient structures.

12) Q: Can you disable persistence?
    A: Yes; run pure in-memory by disabling RDB and AOF, but risk data loss.

13) Q: How to back up Cluster?
    A: Snapshot each master; ensure consistent timing or quiesce writes.

14) Q: Why `no-appendfsync-on-rewrite`?
    A: Avoid double fsync during rewrite to reduce I/O pressure.

15) Q: How much memory to reserve?
    A: Enough for fork copy-on-write; commonly 2× dataset as a safe buffer.
