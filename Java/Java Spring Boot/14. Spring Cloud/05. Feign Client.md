# üîó Feign Client - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Setup](#setup)
- [Basic Usage](#basic-usage)
- [Configuration](#configuration)
- [Error Handling](#error-handling)
- [Integration](#integration)
- [Advanced Features](#advanced-features)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**OpenFeign** is a declarative REST client that simplifies HTTP API calls using annotations, integrating seamlessly with Spring Cloud.

### Why Feign?

```
Without Feign:
‚ùå Manual RestTemplate configuration
‚ùå Boilerplate code for each endpoint
‚ùå Manual error handling
‚ùå Complex load balancing setup

With Feign:
‚úÖ Declarative interface
‚úÖ Automatic load balancing
‚úÖ Circuit breaker integration
‚úÖ Retry mechanism
‚úÖ Request/response logging
```

---

## üöÄ Setup

### Maven Dependencies

```xml
<dependencies>
    <!-- OpenFeign -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>
    
    <!-- Load Balancer -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-loadbalancer</artifactId>
    </dependency>
    
    <!-- Circuit Breaker (optional) -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
    </dependency>
</dependencies>
```

### Enable Feign

```java
package com.example.order;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableFeignClients  // Enable Feign Clients
public class OrderServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

---

## üìù Basic Usage

### Simple Feign Client

```java
package com.example.order.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

@FeignClient(name = "payment-service")
public interface PaymentClient {
    
    @GetMapping("/api/payments/{paymentId}")
    PaymentResponse getPayment(@PathVariable("paymentId") String paymentId);
    
    @PostMapping("/api/payments")
    PaymentResponse createPayment(@RequestBody PaymentRequest request);
    
    @PutMapping("/api/payments/{paymentId}")
    PaymentResponse updatePayment(
        @PathVariable("paymentId") String paymentId,
        @RequestBody PaymentRequest request
    );
    
    @DeleteMapping("/api/payments/{paymentId}")
    void deletePayment(@PathVariable("paymentId") String paymentId);
}
```

### Using the Client

```java
@Service
public class OrderService {
    
    @Autowired
    private PaymentClient paymentClient;
    
    public Order createOrder(OrderRequest request) {
        // Create payment
        PaymentRequest paymentRequest = PaymentRequest.builder()
            .orderId(UUID.randomUUID().toString())
            .amount(request.getTotal())
            .currency("USD")
            .build();
        
        PaymentResponse payment = paymentClient.createPayment(paymentRequest);
        
        // Create order
        Order order = Order.builder()
            .id(paymentRequest.getOrderId())
            .paymentId(payment.getPaymentId())
            .status(OrderStatus.CREATED)
            .build();
        
        return orderRepository.save(order);
    }
}
```

### Request Parameters

```java
@FeignClient(name = "product-service")
public interface ProductClient {
    
    // Query parameters
    @GetMapping("/api/products")
    List<Product> searchProducts(
        @RequestParam("category") String category,
        @RequestParam("minPrice") Double minPrice,
        @RequestParam("maxPrice") Double maxPrice
    );
    
    // Query map
    @GetMapping("/api/products/search")
    List<Product> searchProducts(@RequestParam Map<String, Object> params);
    
    // Header parameters
    @GetMapping("/api/products/{id}")
    Product getProduct(
        @PathVariable("id") String id,
        @RequestHeader("X-API-Key") String apiKey
    );
}
```

---

## ‚öôÔ∏è Configuration

### Application Properties

```yaml
spring:
  application:
    name: order-service

# Feign configuration
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 5000
        logger-level: full
      
      payment-service:
        connect-timeout: 3000
        read-timeout: 10000
        logger-level: basic

# Circuit breaker
feign:
  circuitbreaker:
    enabled: true

resilience4j:
  circuitbreaker:
    instances:
      payment-service:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
```

### Java Configuration

```java
@Configuration
public class FeignConfig {
    
    @Bean
    public Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }
    
    @Bean
    public RequestInterceptor requestInterceptor() {
        return template -> {
            // Add headers to all requests
            template.header("X-Request-ID", UUID.randomUUID().toString());
            template.header("X-Service-Name", "order-service");
            
            // Add authentication
            String token = SecurityContextHolder.getContext()
                .getAuthentication()
                .getCredentials()
                .toString();
            
            if (token != null) {
                template.header("Authorization", "Bearer " + token);
            }
        };
    }
    
    @Bean
    public ErrorDecoder errorDecoder() {
        return new CustomErrorDecoder();
    }
    
    @Bean
    public Retryer retryer() {
        return new Retryer.Default(100, 1000, 3);
    }
}
```

### Client-Specific Configuration

```java
@FeignClient(
    name = "payment-service",
    configuration = PaymentClientConfig.class,
    fallback = PaymentClientFallback.class
)
public interface PaymentClient {
    // Client methods
}

@Configuration
public class PaymentClientConfig {
    
    @Bean
    public Logger.Level feignLoggerLevel() {
        return Logger.Level.HEADERS;
    }
    
    @Bean
    public Contract feignContract() {
        return new SpringMvcContract();
    }
}
```

---

## üõ°Ô∏è Error Handling

### Custom Error Decoder

```java
public class CustomErrorDecoder implements ErrorDecoder {
    
    private final ErrorDecoder defaultErrorDecoder = new Default();
    
    @Override
    public Exception decode(String methodKey, Response response) {
        int status = response.status();
        
        switch (status) {
            case 400:
                return new BadRequestException("Bad request");
            
            case 401:
                return new UnauthorizedException("Unauthorized");
            
            case 404:
                return new NotFoundException("Resource not found");
            
            case 503:
                return new ServiceUnavailableException("Service unavailable");
            
            default:
                return defaultErrorDecoder.decode(methodKey, response);
        }
    }
}
```

### Fallback Implementation

```java
@Component
public class PaymentClientFallback implements PaymentClient {
    
    @Override
    public PaymentResponse getPayment(String paymentId) {
        log.error("Payment service unavailable, using fallback");
        return PaymentResponse.failed("Service unavailable");
    }
    
    @Override
    public PaymentResponse createPayment(PaymentRequest request) {
        return PaymentResponse.failed("Service unavailable");
    }
    
    @Override
    public PaymentResponse updatePayment(String paymentId, PaymentRequest request) {
        return PaymentResponse.failed("Service unavailable");
    }
    
    @Override
    public void deletePayment(String paymentId) {
        log.error("Cannot delete payment, service unavailable");
    }
}
```

### Fallback Factory

```java
@Component
public class PaymentClientFallbackFactory implements FallbackFactory<PaymentClient> {
    
    @Override
    public PaymentClient create(Throwable cause) {
        return new PaymentClient() {
            
            @Override
            public PaymentResponse getPayment(String paymentId) {
                log.error("Error calling payment service: {}", cause.getMessage());
                
                if (cause instanceof FeignException.NotFound) {
                    throw new NotFoundException("Payment not found");
                }
                
                return PaymentResponse.failed("Service error: " + cause.getMessage());
            }
            
            @Override
            public PaymentResponse createPayment(PaymentRequest request) {
                log.error("Cannot create payment: {}", cause.getMessage());
                return PaymentResponse.failed("Service unavailable");
            }
            
            // Other methods...
        };
    }
}

@FeignClient(
    name = "payment-service",
    fallbackFactory = PaymentClientFallbackFactory.class
)
public interface PaymentClient {
    // Methods...
}
```

---

## üîó Integration

### With Eureka (Service Discovery)

```yaml
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

```java
@FeignClient(name = "payment-service")  // Service name in Eureka
public interface PaymentClient {
    // Automatically discovers instances from Eureka
}
```

### With Load Balancer

```java
@FeignClient(name = "payment-service")
public interface PaymentClient {
    // Automatically load-balanced across instances
}
```

**Custom Load Balancer:**

```java
@Configuration
public class LoadBalancerConfig {
    
    @Bean
    public ServiceInstanceListSupplier discoveryClientServiceInstanceListSupplier(
            ConfigurableApplicationContext context) {
        return ServiceInstanceListSupplier.builder()
            .withDiscoveryClient()
            .withHealthChecks()
            .build(context);
    }
}
```

### With Circuit Breaker

```yaml
feign:
  circuitbreaker:
    enabled: true
```

```java
@FeignClient(
    name = "payment-service",
    fallback = PaymentClientFallback.class
)
public interface PaymentClient {
    
    @GetMapping("/api/payments/{id}")
    PaymentResponse getPayment(@PathVariable("id") String id);
}
```

### With OAuth2

```xml
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-client</artifactId>
</dependency>
```

```java
@Configuration
public class OAuth2FeignConfig {
    
    @Bean
    public RequestInterceptor oauth2FeignRequestInterceptor(
            OAuth2AuthorizedClientService clientService) {
        
        return template -> {
            Authentication authentication = SecurityContextHolder
                .getContext()
                .getAuthentication();
            
            if (authentication != null) {
                OAuth2AuthorizedClient client = clientService
                    .loadAuthorizedClient("client-id", authentication.getName());
                
                if (client != null) {
                    String accessToken = client.getAccessToken().getTokenValue();
                    template.header("Authorization", "Bearer " + accessToken);
                }
            }
        };
    }
}
```

---

## üöÄ Advanced Features

### File Upload

```java
@FeignClient(name = "file-service")
public interface FileClient {
    
    @PostMapping(value = "/api/files/upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    FileResponse uploadFile(
        @RequestPart("file") MultipartFile file,
        @RequestParam("description") String description
    );
}
```

### Custom Encoder/Decoder

```java
@Configuration
public class FeignEncoderConfig {
    
    @Bean
    public Encoder feignEncoder() {
        return new SpringFormEncoder(new SpringEncoder(feignObjectFactory()));
    }
    
    @Bean
    public Decoder feignDecoder() {
        return new ResponseEntityDecoder(new SpringDecoder(feignObjectFactory()));
    }
    
    private ObjectFactory<HttpMessageConverters> feignObjectFactory() {
        return () -> new HttpMessageConverters(new MappingJackson2HttpMessageConverter());
    }
}
```

### Retry Configuration

```java
@Configuration
public class FeignRetryConfig {
    
    @Bean
    public Retryer feignRetryer() {
        return new Retryer.Default(
            100,    // Initial interval (ms)
            1000,   // Max interval (ms)
            3       // Max attempts
        );
    }
}

// Or custom retryer
public class CustomRetryer implements Retryer {
    
    private final int maxAttempts;
    private int attempt = 1;
    
    public CustomRetryer(int maxAttempts) {
        this.maxAttempts = maxAttempts;
    }
    
    @Override
    public void continueOrPropagate(RetryableException e) {
        if (attempt++ >= maxAttempts) {
            throw e;
        }
        
        try {
            Thread.sleep(100 * attempt);  // Exponential backoff
        } catch (InterruptedException ignored) {
            Thread.currentThread().interrupt();
        }
    }
    
    @Override
    public Retryer clone() {
        return new CustomRetryer(maxAttempts);
    }
}
```

### Request/Response Compression

```yaml
feign:
  compression:
    request:
      enabled: true
      mime-types: application/json,application/xml
      min-request-size: 2048
    response:
      enabled: true
```

### Metrics and Monitoring

```xml
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-micrometer</artifactId>
</dependency>
```

```java
@Configuration
public class FeignMetricsConfig {
    
    @Bean
    public FeignClientMetrics feignClientMetrics(MeterRegistry registry) {
        return new FeignClientMetrics(registry);
    }
}
```

---

## üí° Best Practices

### 1. Use Fallbacks

```java
// ‚úÖ Good - Implement fallback
@FeignClient(name = "payment-service", fallback = PaymentFallback.class)
public interface PaymentClient { }

// ‚ùå Bad - No fallback
@FeignClient(name = "payment-service")
public interface PaymentClient { }
```

### 2. Configure Timeouts

```yaml
# ‚úÖ Good - Reasonable timeouts
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000

# ‚ùå Bad - Default (infinite)
```

### 3. Enable Logging

```yaml
# ‚úÖ Good - Enable logging
logging:
  level:
    com.example.client: DEBUG

feign:
  client:
    config:
      default:
        logger-level: full
```

### 4. Use DTOs

```java
// ‚úÖ Good - Separate DTOs
public class PaymentRequest {
    private String orderId;
    private BigDecimal amount;
}

// ‚ùå Bad - Domain objects in client
public class Payment {
    // Internal domain object
}
```

### 5. Handle Errors Properly

```java
// ‚úÖ Good - Custom error decoder
@Bean
public ErrorDecoder errorDecoder() {
    return new CustomErrorDecoder();
}

// ‚ùå Bad - Default error handling
```

---

## üé§ Interview Questions

### Q1: What is OpenFeign?
**Answer:** Declarative REST client simplifying HTTP API calls using annotated interfaces.

### Q2: How does Feign work?
**Answer:** Creates proxy implementation of interface, handles HTTP communication automatically.

### Q3: Feign vs RestTemplate?
**Answer:** Feign: Declarative, less boilerplate. RestTemplate: Imperative, more control.

### Q4: How to enable Feign?
**Answer:** Add `@EnableFeignClients` to main class, create `@FeignClient` interfaces.

### Q5: What is @FeignClient annotation?
**Answer:** Marks interface as Feign client, specifies service name or URL.

### Q6: How does Feign integrate with Eureka?
**Answer:** Uses service name from `@FeignClient`, discovers instances automatically.

### Q7: What is fallback in Feign?
**Answer:** Alternative implementation when circuit breaker opens or service fails.

### Q8: Fallback vs FallbackFactory?
**Answer:** Fallback: Simple implementation. FallbackFactory: Access to exception cause.

### Q9: How to configure timeouts?
**Answer:** Set `feign.client.config.{service}.connect-timeout` and `read-timeout`.

### Q10: What is ErrorDecoder?
**Answer:** Customizes exception handling based on HTTP status codes.

### Q11: How to add headers to requests?
**Answer:** Implement `RequestInterceptor`, add headers in `apply()` method.

### Q12: What logging levels does Feign support?
**Answer:** NONE, BASIC, HEADERS, FULL.

### Q13: How to retry failed requests?
**Answer:** Configure `Retryer` bean with retry interval and max attempts.

### Q14: Can Feign upload files?
**Answer:** Yes, use `@RequestPart` with `MultipartFile` and `MULTIPART_FORM_DATA`.

### Q15: How to enable compression?
**Answer:** Set `feign.compression.request.enabled=true` and configure MIME types.

### Q16: What is Feign contract?
**Answer:** Defines how annotations are interpreted (Spring MVC, JAX-RS, default Feign).

### Q17: How to handle authentication?
**Answer:** Use `RequestInterceptor` to add Authorization header with JWT/OAuth token.

### Q18: Feign with circuit breaker?
**Answer:** Enable `feign.circuitbreaker.enabled=true`, add fallback implementation.

### Q19: How to customize encoder/decoder?
**Answer:** Provide custom `Encoder` and `Decoder` beans in configuration.

### Q20: Feign alternatives?
**Answer:** RestTemplate, WebClient, OkHttp, Retrofit.

---

## üìö Summary

### Key Components

```
@FeignClient: Define client interface
‚îú‚îÄ name: Service name (Eureka)
‚îú‚îÄ url: Direct URL (optional)
‚îú‚îÄ configuration: Custom config
‚îú‚îÄ fallback: Fallback implementation
‚îî‚îÄ fallbackFactory: Fallback with exception

Features:
‚îú‚îÄ Automatic load balancing
‚îú‚îÄ Circuit breaker integration
‚îú‚îÄ Retry mechanism
‚îú‚îÄ Request/response logging
‚îî‚îÄ Error handling
```

### Essential Configuration

```yaml
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000
        logger-level: basic
  circuitbreaker:
    enabled: true
```

### Usage Pattern

```java
@FeignClient(name = "service", fallback = Fallback.class)
public interface Client {
    @GetMapping("/api/resource")
    Response getResource();
}
```

**Next:** Resilience4j ‚Üí

