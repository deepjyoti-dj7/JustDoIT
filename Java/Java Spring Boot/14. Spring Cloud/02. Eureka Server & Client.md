# üîç Eureka Server & Client - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Eureka Server](#eureka-server)
- [Eureka Client](#eureka-client)
- [Service Registration](#service-registration)
- [Service Discovery](#service-discovery)
- [High Availability](#high-availability)
- [Advanced Configuration](#advanced-configuration)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Netflix Eureka** is a service registry for resilient mid-tier load balancing and failover in microservices architecture.

### How Eureka Works

```
1. Service Registration
   Service A ‚Üí Registers ‚Üí Eureka Server
   Service B ‚Üí Registers ‚Üí Eureka Server
   
2. Service Discovery
   Service A ‚Üí Query ‚Üí Eureka Server ‚Üí Get Service B instances
   
3. Heartbeat
   Services send heartbeat every 30s to Eureka
   
4. Eviction
   Eureka removes instance if no heartbeat for 90s
```

---

## üñ•Ô∏è Eureka Server

### Maven Dependencies

```xml
<dependencies>
    <!-- Eureka Server -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
    
    <!-- Spring Boot Actuator (Optional) -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2023.0.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### Application Class

```java
package com.example.eureka;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer  // Enable Eureka Server
public class EurekaServerApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### Configuration (application.yml)

```yaml
server:
  port: 8761  # Default Eureka port

spring:
  application:
    name: eureka-server

eureka:
  instance:
    hostname: localhost
  
  client:
    # Don't register itself as a client
    register-with-eureka: false
    fetch-registry: false
    
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
  
  server:
    # Self-preservation mode
    enable-self-preservation: true
    
    # Eviction interval (default: 60s)
    eviction-interval-timer-in-ms: 60000
    
    # Response cache update interval (default: 30s)
    response-cache-update-interval-ms: 30000
    
    # Expected heartbeat renewal threshold
    renewal-percent-threshold: 0.85

# Actuator endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
```

### Eureka Dashboard

Access Eureka UI at: **http://localhost:8761**

```
Eureka Dashboard Shows:
- Registered instances
- Instance status (UP, DOWN, OUT_OF_SERVICE)
- Lease renewal information
- General system info
- Self-preservation mode status
```

---

## üì± Eureka Client

### Maven Dependencies

```xml
<dependencies>
    <!-- Web Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Eureka Client -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    
    <!-- Actuator for health checks -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>
```

### Application Class

```java
package com.example.order;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient  // Enable Eureka Client
public class OrderServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

### Configuration (application.yml)

```yaml
server:
  port: 8081

spring:
  application:
    name: order-service  # Service ID in Eureka

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    
    # Fetch registry from Eureka (default: true)
    fetch-registry: true
    
    # Register with Eureka (default: true)
    register-with-eureka: true
    
    # Interval to fetch registry (default: 30s)
    registry-fetch-interval-seconds: 30
    
    # Initial instance info replication time (default: 40s)
    initial-instance-info-replication-interval-seconds: 40
  
  instance:
    # Instance ID format
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}
    
    # Prefer IP address over hostname
    prefer-ip-address: true
    
    # Lease renewal interval (heartbeat) - default: 30s
    lease-renewal-interval-in-seconds: 30
    
    # Lease expiration duration - default: 90s
    lease-expiration-duration-in-seconds: 90
    
    # Health check URL path
    health-check-url-path: /actuator/health
    
    # Status page URL path
    status-page-url-path: /actuator/info
    
    # Metadata
    metadata-map:
      zone: zone1
      version: 1.0.0

# Actuator configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
```

---

## üìù Service Registration

### Automatic Registration

```java
// Simply annotate with @EnableDiscoveryClient
@SpringBootApplication
@EnableDiscoveryClient
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

// Service automatically registers on startup
```

### Programmatic Registration

```java
@Component
public class ServiceRegistrar {
    
    @Autowired
    private EurekaClient eurekaClient;
    
    @PostConstruct
    public void registerService() {
        InstanceInfo instanceInfo = InstanceInfo.Builder.newBuilder()
            .setAppName("order-service")
            .setIPAddr("192.168.1.10")
            .setPort(8081)
            .setSecurePort(8443)
            .setHealthCheckUrls("/actuator/health", null, null)
            .setHomePageUrl("/", null)
            .setStatusPageUrl("/actuator/info", null)
            .setDataCenterInfo(new MyDataCenterInfo(DataCenterInfo.Name.MyOwn))
            .build();
        
        ApplicationInfoManager.getInstance()
            .setInstanceStatus(InstanceInfo.InstanceStatus.UP);
    }
}
```

### Custom Metadata

```yaml
eureka:
  instance:
    metadata-map:
      zone: us-east-1a
      environment: production
      version: 2.0.0
      team: payments
      owner: john.doe@example.com
```

```java
@RestController
public class MetadataController {
    
    @Autowired
    private EurekaClient eurekaClient;
    
    @GetMapping("/instance-metadata")
    public Map<String, String> getMetadata() {
        InstanceInfo instance = eurekaClient.getApplicationInfoManager()
            .getInfo();
        return instance.getMetadata();
    }
}
```

---

## üîç Service Discovery

### Using DiscoveryClient

```java
@Service
public class OrderService {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    public List<String> getPaymentServiceInstances() {
        List<ServiceInstance> instances = discoveryClient
            .getInstances("payment-service");
        
        return instances.stream()
            .map(instance -> instance.getUri().toString())
            .collect(Collectors.toList());
    }
    
    public ServiceInstance chooseInstance(String serviceId) {
        List<ServiceInstance> instances = discoveryClient.getInstances(serviceId);
        
        if (instances.isEmpty()) {
            throw new ServiceUnavailableException("No instances available");
        }
        
        // Simple round-robin
        int index = ThreadLocalRandom.current().nextInt(instances.size());
        return instances.get(index);
    }
}
```

### Using EurekaClient

```java
@Service
public class PaymentDiscovery {
    
    @Autowired
    private EurekaClient eurekaClient;
    
    public InstanceInfo getPaymentServiceInstance() {
        Application application = eurekaClient
            .getApplication("payment-service");
        
        List<InstanceInfo> instances = application.getInstances();
        
        if (instances.isEmpty()) {
            throw new ServiceNotFoundException("payment-service not found");
        }
        
        return instances.get(0);
    }
    
    public List<InstanceInfo> getInstancesByZone(String serviceId, String zone) {
        Application application = eurekaClient.getApplication(serviceId);
        
        return application.getInstances().stream()
            .filter(instance -> zone.equals(
                instance.getMetadata().get("zone")
            ))
            .collect(Collectors.toList());
    }
}
```

### Using @LoadBalanced RestTemplate

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // Enable client-side load balancing
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}

@Service
public class OrderService {
    
    @Autowired
    @LoadBalanced
    private RestTemplate restTemplate;
    
    public PaymentResponse processPayment(PaymentRequest request) {
        // Use service name instead of URL
        String url = "http://payment-service/api/payments";
        
        return restTemplate.postForObject(
            url,
            request,
            PaymentResponse.class
        );
    }
}
```

### Using WebClient (Reactive)

```java
@Configuration
public class WebClientConfig {
    
    @Bean
    @LoadBalanced
    public WebClient.Builder loadBalancedWebClientBuilder() {
        return WebClient.builder();
    }
}

@Service
public class OrderService {
    
    @Autowired
    @LoadBalanced
    private WebClient.Builder webClientBuilder;
    
    public Mono<PaymentResponse> processPayment(PaymentRequest request) {
        return webClientBuilder.build()
            .post()
            .uri("http://payment-service/api/payments")
            .bodyValue(request)
            .retrieve()
            .bodyToMono(PaymentResponse.class);
    }
}
```

---

## üè¢ High Availability

### Multiple Eureka Servers

**Eureka Server 1 (application-peer1.yml):**

```yaml
server:
  port: 8761

spring:
  application:
    name: eureka-server
  profiles:
    active: peer1

eureka:
  instance:
    hostname: peer1
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://peer2:8762/eureka/,http://peer3:8763/eureka/
```

**Eureka Server 2 (application-peer2.yml):**

```yaml
server:
  port: 8762

spring:
  application:
    name: eureka-server
  profiles:
    active: peer2

eureka:
  instance:
    hostname: peer2
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://peer1:8761/eureka/,http://peer3:8763/eureka/
```

**Eureka Server 3 (application-peer3.yml):**

```yaml
server:
  port: 8763

spring:
  application:
    name: eureka-server
  profiles:
    active: peer3

eureka:
  instance:
    hostname: peer3
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://peer1:8761/eureka/,http://peer2:8762/eureka/
```

### Client Configuration for HA

```yaml
eureka:
  client:
    service-url:
      defaultZone: http://peer1:8761/eureka/,http://peer2:8762/eureka/,http://peer3:8763/eureka/
    
    # Backup registry on startup
    backup-registry-impl: com.netflix.discovery.BackupRegistry
```

---

## ‚öôÔ∏è Advanced Configuration

### Self-Preservation Mode

```yaml
eureka:
  server:
    # Enable self-preservation (default: true)
    enable-self-preservation: true
    
    # Renewal percent threshold (default: 0.85)
    renewal-percent-threshold: 0.85
    
    # Renewal threshold update interval
    renewal-threshold-update-interval-ms: 900000
```

**What is Self-Preservation?**
- Protects against network partitions
- Eureka stops evicting instances when renewal rate drops below threshold
- Prevents mass eviction during network issues

### Response Caching

```yaml
eureka:
  server:
    # Response cache update interval (default: 30s)
    response-cache-update-interval-ms: 30000
    
    # Response cache auto expiration (default: 180s)
    response-cache-auto-expiration-in-seconds: 180
    
    # Disable response cache (not recommended in production)
    use-read-only-response-cache: false
```

### Health Checks

```yaml
eureka:
  client:
    # Enable health check
    healthcheck:
      enabled: true

management:
  endpoint:
    health:
      show-details: always
  health:
    defaults:
      enabled: true
```

```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // Custom health logic
        boolean databaseUp = checkDatabase();
        boolean cacheUp = checkCache();
        
        if (databaseUp && cacheUp) {
            return Health.up()
                .withDetail("database", "UP")
                .withDetail("cache", "UP")
                .build();
        } else {
            return Health.down()
                .withDetail("database", databaseUp ? "UP" : "DOWN")
                .withDetail("cache", cacheUp ? "UP" : "DOWN")
                .build();
        }
    }
    
    private boolean checkDatabase() {
        // Database check logic
        return true;
    }
    
    private boolean checkCache() {
        // Cache check logic
        return true;
    }
}
```

### Zone Awareness

```yaml
# Client in Zone 1
eureka:
  instance:
    metadata-map:
      zone: zone1
  client:
    prefer-same-zone-eureka: true
    region: us-east
    availability-zones:
      us-east: zone1,zone2

# Client in Zone 2
eureka:
  instance:
    metadata-map:
      zone: zone2
  client:
    prefer-same-zone-eureka: true
    region: us-east
    availability-zones:
      us-east: zone2,zone1
```

### Security

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

**Eureka Server:**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .authorizeHttpRequests(auth -> auth
                .anyRequest().authenticated()
            )
            .httpBasic();
        
        return http.build();
    }
    
    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.withDefaultPasswordEncoder()
            .username("eureka")
            .password("password")
            .roles("ADMIN")
            .build();
        
        return new InMemoryUserDetailsManager(user);
    }
}
```

```yaml
spring:
  security:
    user:
      name: eureka
      password: password
```

**Eureka Client:**

```yaml
eureka:
  client:
    service-url:
      defaultZone: http://eureka:password@localhost:8761/eureka/
```

---

## üí° Best Practices

### 1. Use Instance ID

```yaml
# ‚úÖ Good - Unique instance ID
eureka:
  instance:
    instance-id: ${spring.application.name}:${spring.application.instance_id:${random.value}}

# ‚ùå Bad - Default hostname
eureka:
  instance:
    instance-id: ${spring.cloud.client.hostname}
```

### 2. Configure Timeouts Properly

```yaml
# ‚úÖ Good - Reasonable timeouts
eureka:
  instance:
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
  client:
    registry-fetch-interval-seconds: 30

# ‚ùå Bad - Too aggressive
eureka:
  instance:
    lease-renewal-interval-in-seconds: 1
    lease-expiration-duration-in-seconds: 3
```

### 3. Enable Health Checks

```yaml
# ‚úÖ Good - Health check enabled
eureka:
  client:
    healthcheck:
      enabled: true

# ‚ùå Bad - No health checks
eureka:
  client:
    healthcheck:
      enabled: false
```

### 4. Use IP Address in Containers

```yaml
# ‚úÖ Good - Use IP in Docker/Kubernetes
eureka:
  instance:
    prefer-ip-address: true

# ‚ùå Bad - Use hostname in containers
eureka:
  instance:
    prefer-ip-address: false
```

### 5. Implement Graceful Shutdown

```java
@Component
public class GracefulShutdown {
    
    @Autowired
    private EurekaClient eurekaClient;
    
    @PreDestroy
    public void onShutdown() {
        log.info("Deregistering from Eureka...");
        eurekaClient.shutdown();
    }
}
```

---

## üé§ Interview Questions

### Q1: What is Eureka?
**Answer:** Netflix service registry for service discovery and registration in microservices.

### Q2: How does Eureka work?
**Answer:** Services register with Eureka, send heartbeats, other services query Eureka to discover instances.

### Q3: What is @EnableEurekaServer?
**Answer:** Annotation to enable Eureka Server functionality in Spring Boot application.

### Q4: What is @EnableDiscoveryClient?
**Answer:** Annotation to enable service registration and discovery for Eureka clients.

### Q5: What is heartbeat interval?
**Answer:** Default 30 seconds. Services send heartbeat to Eureka to indicate they're alive.

### Q6: What is lease expiration duration?
**Answer:** Default 90 seconds. Eureka removes instance if no heartbeat received within this time.

### Q7: What is self-preservation mode?
**Answer:** Eureka stops evicting instances when renewal rate drops below threshold, protecting against network partitions.

### Q8: How to disable self-preservation?
**Answer:** Set `eureka.server.enable-self-preservation=false` (not recommended in production).

### Q9: What is service instance metadata?
**Answer:** Custom key-value pairs attached to service instances (zone, version, etc.).

### Q10: How does @LoadBalanced work?
**Answer:** Enables client-side load balancing using service name instead of URL.

### Q11: DiscoveryClient vs EurekaClient?
**Answer:** DiscoveryClient is Spring Cloud abstraction. EurekaClient is Netflix-specific with more features.

### Q12: How to achieve Eureka high availability?
**Answer:** Run multiple Eureka servers in peer-to-peer replication mode.

### Q13: What is zone awareness?
**Answer:** Preferring service instances in same availability zone to reduce latency and cost.

### Q14: How to secure Eureka?
**Answer:** Add Spring Security, use HTTP Basic authentication, or mTLS.

### Q15: What is response caching in Eureka?
**Answer:** Eureka caches registry for 30s to reduce load, clients also cache fetched registry.

### Q16: How to force immediate registry fetch?
**Answer:** Call `eurekaClient.getApplications()` or reduce `registry-fetch-interval-seconds`.

### Q17: What happens if Eureka server is down?
**Answer:** Clients use cached registry, services continue working with last known instances.

### Q18: Eureka vs Consul?
**Answer:** Eureka: AP (availability, partition tolerance). Consul: CP (consistency, partition tolerance).

### Q19: Eureka vs Kubernetes Service Discovery?
**Answer:** Eureka: Application-level. Kubernetes: Infrastructure-level DNS-based discovery.

### Q20: How to test Eureka locally?
**Answer:** Run Eureka Server, register multiple instances, check dashboard at http://localhost:8761.

---

## üìö Summary

### Key Concepts

```
Eureka Architecture:
‚îú‚îÄ Eureka Server (Registry)
‚îÇ  ‚îú‚îÄ Service instances register
‚îÇ  ‚îú‚îÄ Heartbeat monitoring
‚îÇ  ‚îú‚îÄ Instance eviction
‚îÇ  ‚îî‚îÄ Self-preservation mode
‚îÇ
‚îî‚îÄ Eureka Client
   ‚îú‚îÄ Register on startup
   ‚îú‚îÄ Send heartbeat (30s)
   ‚îú‚îÄ Fetch registry (30s)
   ‚îî‚îÄ Deregister on shutdown
```

### Essential Configuration

**Server:**
```yaml
eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
```

**Client:**
```yaml
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
```

### Common Operations

```java
// Get instances
List<ServiceInstance> instances = discoveryClient.getInstances("service-name");

// Load-balanced call
restTemplate.getForObject("http://service-name/api/endpoint", Response.class);
```

**Next:** Config Server ‚Üí

