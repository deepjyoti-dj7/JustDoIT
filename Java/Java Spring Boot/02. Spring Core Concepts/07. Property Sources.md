# ‚öôÔ∏è Property Sources in Spring

## üìã Table of Contents
- [What are Property Sources?](#what-are-property-sources)
- [Property Loading Hierarchy](#property-loading-hierarchy)
- [@Value Annotation](#value-annotation)
- [@ConfigurationProperties](#configurationproperties)
- [Property Files](#property-files)
- [Environment Abstraction](#environment-abstraction)
- [External Configuration](#external-configuration)
- [Property Placeholders](#property-placeholders)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ What are Property Sources?

### Definition
**Property Sources** are mechanisms in Spring for externalizing configuration, allowing you to work with properties from various sources like files, environment variables, command-line arguments, and more.

### Why Externalize Configuration?

```
‚úÖ Environment-specific settings
‚úÖ No code changes for config updates
‚úÖ Security (credentials outside code)
‚úÖ Easy deployment across environments
‚úÖ Runtime configuration changes
‚úÖ Cloud-native compatibility
```

### Sources of Properties

```
1. Command-line arguments
2. SPRING_APPLICATION_JSON properties
3. ServletConfig init parameters
4. ServletContext init parameters
5. JNDI attributes
6. Java System properties (System.getProperties())
7. OS environment variables
8. RandomValuePropertySource
9. Profile-specific application properties
10. Application properties (application.properties/yml)
11. @PropertySource annotations
12. Default properties
```

---

## üìä Property Loading Hierarchy

### Spring Boot Property Priority (Highest to Lowest)

```
1. Command Line Arguments
   --server.port=9000

2. SPRING_APPLICATION_JSON
   SPRING_APPLICATION_JSON='{"server.port":9000}'

3. ServletConfig/ServletContext init parameters

4. JNDI attributes
   java:comp/env

5. Java System Properties
   -Dserver.port=9000

6. OS Environment Variables
   SERVER_PORT=9000

7. RandomValuePropertySource
   ${random.value}

8. Profile-specific properties OUTSIDE jar
   application-{profile}.properties

9. Profile-specific properties INSIDE jar

10. Application properties OUTSIDE jar
    application.properties

11. Application properties INSIDE jar

12. @PropertySource on @Configuration

13. Default properties
    SpringApplication.setDefaultProperties()
```

### Example Demonstrating Precedence

```properties
# application.properties (inside jar)
server.port=8080

# application.properties (outside jar - config/)
server.port=8081

# OS environment variable
export SERVER_PORT=8082

# Command line
java -jar app.jar --server.port=8083

# Final value: 8083 (command line wins)
```

---

## üíâ @Value Annotation

### Basic Usage

```java
@Component
public class AppConfig {
    
    // Simple property injection
    @Value("${app.name}")
    private String appName;
    
    // With default value
    @Value("${app.timeout:30}")
    private int timeout;
    
    // System property
    @Value("${java.home}")
    private String javaHome;
    
    // Environment variable
    @Value("${USER}")
    private String user;
    
    @PostConstruct
    public void init() {
        System.out.println("App: " + appName);
        System.out.println("Timeout: " + timeout);
    }
}
```

### Type Conversion

```java
@Component
public class ConfigBean {
    
    // String
    @Value("${app.name}")
    private String name;
    
    // Integer
    @Value("${app.max.connections}")
    private int maxConnections;
    
    // Boolean
    @Value("${app.feature.enabled}")
    private boolean featureEnabled;
    
    // Long
    @Value("${app.max.file.size}")
    private long maxFileSize;
    
    // Double
    @Value("${app.tax.rate}")
    private double taxRate;
    
    // List
    @Value("${app.allowed.hosts}")
    private List<String> allowedHosts;
    
    // Array
    @Value("${app.admin.emails}")
    private String[] adminEmails;
    
    // Duration (Spring Boot)
    @Value("${app.session.timeout}")
    private Duration sessionTimeout;
}
```

**application.properties:**
```properties
app.name=My Application
app.max.connections=100
app.feature.enabled=true
app.max.file.size=104857600
app.tax.rate=0.18
app.allowed.hosts=localhost,example.com
app.admin.emails=admin1@example.com,admin2@example.com
app.session.timeout=30m
```

### SpEL Expressions

```java
@Component
public class AdvancedConfig {
    
    // Static method call
    @Value("#{T(java.lang.Math).random() * 100}")
    private double randomNumber;
    
    // System property
    @Value("#{systemProperties['user.name']}")
    private String userName;
    
    // Environment variable
    @Value("#{systemEnvironment['PATH']}")
    private String path;
    
    // Conditional
    @Value("#{${app.feature.enabled} ? 'Enabled' : 'Disabled'}")
    private String featureStatus;
    
    // Bean property access
    @Value("#{databaseConfig.url}")
    private String dbUrl;
    
    // Collection manipulation
    @Value("#{${app.allowed.hosts}.contains('localhost')}")
    private boolean localhostAllowed;
}
```

### Constructor and Method Injection

```java
@Component
public class ServiceConfig {
    
    private final String apiKey;
    private final int retryCount;
    
    // Constructor injection (recommended)
    public ServiceConfig(
            @Value("${api.key}") String apiKey,
            @Value("${api.retry.count:3}") int retryCount) {
        this.apiKey = apiKey;
        this.retryCount = retryCount;
    }
}

@Component
public class CacheConfig {
    
    private String cacheType;
    
    // Setter injection
    @Value("${cache.type:memory}")
    public void setCacheType(String cacheType) {
        this.cacheType = cacheType;
    }
}
```

---

## üîß @ConfigurationProperties

### Basic Usage

```java
@Component
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    
    private String name;
    private String version;
    private int maxConnections;
    private Duration timeout;
    
    // Nested properties
    private Security security = new Security();
    private Database database = new Database();
    
    // Getters and setters
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public Security getSecurity() { return security; }
    public Database getDatabase() { return database; }
    
    public static class Security {
        private boolean enabled;
        private String algorithm;
        
        // Getters and setters
        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }
        
        public String getAlgorithm() { return algorithm; }
        public void setAlgorithm(String algorithm) { this.algorithm = algorithm; }
    }
    
    public static class Database {
        private String url;
        private String username;
        private int poolSize;
        
        // Getters and setters
    }
}
```

**application.properties:**
```properties
app.name=My Application
app.version=1.0.0
app.max-connections=100
app.timeout=30s

app.security.enabled=true
app.security.algorithm=SHA-256

app.database.url=jdbc:postgresql://localhost:5432/mydb
app.database.username=admin
app.database.pool-size=10
```

### Usage in Other Beans

```java
@Service
public class UserService {
    
    private final AppProperties appProperties;
    
    public UserService(AppProperties appProperties) {
        this.appProperties = appProperties;
    }
    
    public void printConfig() {
        System.out.println("App: " + appProperties.getName());
        System.out.println("Max connections: " + appProperties.getMaxConnections());
        System.out.println("Security enabled: " + 
            appProperties.getSecurity().isEnabled());
    }
}
```

### Validation

```java
@Component
@ConfigurationProperties(prefix = "app")
@Validated
public class AppProperties {
    
    @NotEmpty
    private String name;
    
    @Min(1)
    @Max(1000)
    private int maxConnections;
    
    @Email
    private String adminEmail;
    
    @Pattern(regexp = "^(http|https)://.*")
    private String apiUrl;
    
    @Valid
    private Security security;
    
    // Getters and setters
    
    public static class Security {
        @NotEmpty
        private String algorithm;
        
        @Size(min = 16, max = 32)
        private String secretKey;
        
        // Getters and setters
    }
}
```

### Lists and Maps

```java
@Component
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    
    private List<String> allowedOrigins;
    private Map<String, String> headers;
    private List<Server> servers;
    
    // Getters and setters
    
    public static class Server {
        private String name;
        private String host;
        private int port;
        
        // Getters and setters
    }
}
```

**application.yml:**
```yaml
app:
  allowed-origins:
    - http://localhost:3000
    - https://example.com
  
  headers:
    Content-Type: application/json
    Authorization: Bearer token
  
  servers:
    - name: primary
      host: server1.example.com
      port: 8080
    - name: backup
      host: server2.example.com
      port: 8081
```

### @ConfigurationPropertiesScan

```java
@SpringBootApplication
@ConfigurationPropertiesScan("com.example.config")
public class Application {
    // Automatically scans and registers @ConfigurationProperties
}
```

---

## üìù Property Files

### application.properties

```properties
# Server configuration
server.port=8080
server.servlet.context-path=/api

# Database configuration
spring.datasource.url=jdbc:postgresql://localhost:5432/mydb
spring.datasource.username=admin
spring.datasource.password=${DB_PASSWORD}

# Logging
logging.level.root=INFO
logging.level.com.example=DEBUG
logging.file.name=logs/application.log

# Custom properties
app.name=My Application
app.version=1.0.0
app.timeout=30s
```

### application.yml

```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/mydb
    username: admin
    password: ${DB_PASSWORD}
  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

logging:
  level:
    root: INFO
    com.example: DEBUG
  file:
    name: logs/application.log

app:
  name: My Application
  version: 1.0.0
  timeout: 30s
  features:
    - caching
    - monitoring
    - swagger
```

### Custom Property Files

```java
@Configuration
@PropertySource("classpath:custom.properties")
public class CustomConfig {
}

// Multiple sources
@Configuration
@PropertySource({
    "classpath:app.properties",
    "classpath:database.properties"
})
public class AppConfig {
}

// With encoding
@Configuration
@PropertySource(
    value = "classpath:messages.properties",
    encoding = "UTF-8"
)
public class I18nConfig {
}

// Ignore if not found
@Configuration
@PropertySource(
    value = "classpath:optional.properties",
    ignoreResourceNotFound = true
)
public class OptionalConfig {
}
```

---

## üåç Environment Abstraction

### Accessing Environment

```java
@Component
public class EnvironmentBean {
    
    @Autowired
    private Environment environment;
    
    @PostConstruct
    public void init() {
        // Get property
        String appName = environment.getProperty("app.name");
        
        // Get with default value
        String timeout = environment.getProperty("app.timeout", "30s");
        
        // Get with type conversion
        Integer port = environment.getProperty("server.port", Integer.class);
        
        // Get required property (throws if missing)
        String apiKey = environment.getRequiredProperty("api.key");
        
        // Check if property exists
        boolean hasProperty = environment.containsProperty("app.name");
        
        // Get active profiles
        String[] profiles = environment.getActiveProfiles();
        
        // Check profile
        boolean isDev = environment.acceptsProfiles(Profiles.of("dev"));
    }
}
```

### Programmatic Property Access

```java
@Service
public class ConfigService {
    
    @Autowired
    private Environment env;
    
    public Map<String, String> getDatabaseConfig() {
        return Map.of(
            "url", env.getProperty("spring.datasource.url"),
            "username", env.getProperty("spring.datasource.username"),
            "driver", env.getProperty("spring.datasource.driver-class-name")
        );
    }
    
    public boolean isFeatureEnabled(String feature) {
        String property = "app.features." + feature + ".enabled";
        return env.getProperty(property, Boolean.class, false);
    }
}
```

---

## üîê External Configuration

### Loading External Files

```bash
# 1. config/ directory in working directory
./config/application.properties

# 2. Current directory
./application.properties

# 3. classpath:/config/
src/main/resources/config/application.properties

# 4. classpath root
src/main/resources/application.properties
```

### Specify Config Location

```bash
# Specific file
java -jar app.jar --spring.config.location=file:/path/to/config.properties

# Directory (scans for application.properties/yml)
java -jar app.jar --spring.config.location=file:/path/to/config/

# Multiple locations
java -jar app.jar --spring.config.location=\
  classpath:/default/,\
  file:/external/config/
```

### Additional Locations

```bash
# Keeps default locations + adds new ones
java -jar app.jar --spring.config.additional-location=\
  file:/etc/myapp/,\
  file:/opt/config/
```

### Import Configuration

```properties
# application.properties
spring.config.import=file:.env[.properties],optional:file:./secrets.properties
```

```yaml
# application.yml
spring:
  config:
    import:
      - file:.env[.properties]
      - optional:file:./secrets.properties
      - classpath:default-config.yml
```

### Environment Variables

```bash
# Relaxed binding
export SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/mydb
export SERVER_PORT=9000
export APP_MAX_CONNECTIONS=100

# In properties: spring.datasource.url, server.port, app.maxConnections
```

**Naming Conventions:**
```
spring.datasource.url ‚Üí SPRING_DATASOURCE_URL
server.port ‚Üí SERVER_PORT
app.maxConnections ‚Üí APP_MAX_CONNECTIONS or APP_MAXCONNECTIONS
```

---

## üîó Property Placeholders

### Basic Placeholders

```properties
app.name=My Application
app.version=1.0.0
app.description=${app.name} version ${app.version}
# Result: My Application version 1.0.0

# Default values
app.timeout=${app.custom.timeout:30}
# If app.custom.timeout not set, uses 30
```

### Nested Placeholders

```properties
base.url=http://api.example.com
api.endpoint=${base.url}/v1
user.endpoint=${api.endpoint}/users
# Result: http://api.example.com/v1/users
```

### System Properties

```properties
app.java.home=${java.home}
app.user.name=${user.name}
app.os.name=${os.name}
```

### Environment Variables

```properties
database.url=jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME}
database.password=${DB_PASSWORD}
```

---

## üìã @Value vs @ConfigurationProperties

### Comparison

| Feature | @Value | @ConfigurationProperties |
|---------|--------|-------------------------|
| **Use Case** | Single property | Group of properties |
| **Type Safety** | Limited | Full type safety |
| **Validation** | Manual | Built-in (@Validated) |
| **SpEL Support** | ‚úÖ Yes | ‚ùå No |
| **Relaxed Binding** | ‚ùå No | ‚úÖ Yes |
| **Meta-data Support** | ‚ùå No | ‚úÖ Yes (IDE autocomplete) |
| **Immutability** | Mutable | Can be immutable (constructor binding) |

### When to Use What

```java
// ‚úÖ Use @Value for:
// - Simple properties
// - SpEL expressions needed
// - Single values

@Component
public class SimpleConfig {
    @Value("${app.name}")
    private String name;
    
    @Value("#{T(java.lang.Math).random()}")
    private double random;
}

// ‚úÖ Use @ConfigurationProperties for:
// - Grouped properties
// - Complex structures
// - Validation needed
// - Better IDE support

@ConfigurationProperties(prefix = "app")
@Validated
public class AppConfig {
    @NotEmpty
    private String name;
    
    private Security security;
    private Database database;
    
    // Nested structures, validation, type safety
}
```

---

## ‚úÖ Best Practices

### 1. **Use ConfigurationProperties for Grouped Config**

```java
// ‚úÖ Good - type-safe, validated
@ConfigurationProperties(prefix = "app.database")
public class DatabaseProperties {
    private String url;
    private String username;
    private int poolSize;
    // Getters and setters
}

// ‚ùå Avoid - scattered @Value annotations
@Component
public class DatabaseConfig {
    @Value("${app.database.url}")
    private String url;
    
    @Value("${app.database.username}")
    private String username;
    
    @Value("${app.database.pool-size}")
    private int poolSize;
}
```

### 2. **Externalize Sensitive Data**

```properties
# ‚ùå Bad - hardcoded secrets
spring.datasource.password=mySecretPassword123

# ‚úÖ Good - environment variable
spring.datasource.password=${DB_PASSWORD}

# ‚úÖ Good - external secrets file
spring.config.import=file:./secrets.properties
```

### 3. **Provide Default Values**

```java
@Value("${app.timeout:30}")
private int timeout;

@Value("${app.feature.enabled:false}")
private boolean featureEnabled;
```

### 4. **Use Validation**

```java
@ConfigurationProperties(prefix = "app")
@Validated
public class AppProperties {
    
    @NotEmpty
    @Pattern(regexp = "^[a-zA-Z0-9-]+$")
    private String name;
    
    @Min(1)
    @Max(1000)
    private int maxConnections;
    
    @Email
    private String adminEmail;
}
```

### 5. **Document Properties**

```properties
# Application name (displayed in UI)
app.name=My Application

# Maximum number of concurrent connections (1-1000)
app.max-connections=100

# Session timeout in minutes
app.session-timeout=30m
```

### 6. **Use Constructor Binding for Immutability**

```java
@ConfigurationProperties(prefix = "app")
@ConstructorBinding
public class AppProperties {
    
    private final String name;
    private final int maxConnections;
    
    public AppProperties(String name, int maxConnections) {
        this.name = name;
        this.maxConnections = maxConnections;
    }
    
    // Only getters, no setters - immutable
}

// Enable in Spring Boot
@EnableConfigurationProperties(AppProperties.class)
```

### 7. **Use Profiles for Environment-Specific Properties**

```
application.properties           # Common properties
application-dev.properties       # Development overrides
application-prod.properties      # Production overrides
```

---

## üéì Interview Questions

### Q1: What are Property Sources in Spring?
**Answer:**
Property Sources are mechanisms to externalize configuration in Spring, allowing properties from various sources like files, environment variables, command-line arguments, etc.

Sources (in precedence order):
1. Command-line arguments
2. Java system properties
3. OS environment variables
4. Profile-specific properties
5. Application properties
6. @PropertySource annotations
7. Default properties

### Q2: What is the difference between @Value and @ConfigurationProperties?
**Answer:**
| @Value | @ConfigurationProperties |
|--------|-------------------------|
| Single property injection | Group of related properties |
| Supports SpEL | No SpEL support |
| No validation | Built-in validation support |
| Field/constructor/setter | POJO with getters/setters |
| Less type-safe | Fully type-safe |

```java
// @Value
@Value("${app.name}")
private String name;

// @ConfigurationProperties
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private String name; // Binds to app.name
}
```

### Q3: How does property precedence work in Spring Boot?
**Answer:**
Higher priority overrides lower:
1. Command-line arguments (highest)
2. SPRING_APPLICATION_JSON
3. Java system properties
4. OS environment variables
5. Profile-specific application properties
6. Application properties
7. @PropertySource
8. Default properties (lowest)

### Q4: How to inject a list using @Value?
**Answer:**
```properties
app.allowed-hosts=localhost,example.com,api.example.com
```

```java
@Value("${app.allowed-hosts}")
private List<String> allowedHosts;

// Or array
@Value("${app.allowed-hosts}")
private String[] allowedHosts;
```

### Q5: What is relaxed binding in @ConfigurationProperties?
**Answer:**
Relaxed binding allows different property formats to bind to the same field:

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private String maxConnections; // Field in camelCase
}
```

All these work:
```properties
app.maxConnections=100
app.max-connections=100
app.max_connections=100
APP_MAX_CONNECTIONS=100  # Environment variable
```

### Q6: How to load external configuration files?
**Answer:**
```bash
# Specific file
--spring.config.location=file:/path/to/config.properties

# Additional locations (keeps defaults)
--spring.config.additional-location=file:/etc/myapp/

# Import in properties
spring.config.import=file:.env[.properties]
```

### Q7: How to use default values with @Value?
**Answer:**
```java
// Syntax: ${property:defaultValue}
@Value("${app.timeout:30}")
private int timeout; // 30 if not set

@Value("${app.name:My Application}")
private String name;

@Value("${app.enabled:false}")
private boolean enabled;
```

### Q8: How to validate @ConfigurationProperties?
**Answer:**
```java
@ConfigurationProperties(prefix = "app")
@Validated
public class AppProperties {
    
    @NotEmpty
    private String name;
    
    @Min(1) @Max(1000)
    private int maxConnections;
    
    @Email
    private String adminEmail;
    
    @Valid  // Validate nested objects
    private Security security;
}
```

### Q9: How to access Environment programmatically?
**Answer:**
```java
@Autowired
private Environment environment;

String appName = environment.getProperty("app.name");
Integer port = environment.getProperty("server.port", Integer.class);
String required = environment.getRequiredProperty("api.key");
boolean hasProperty = environment.containsProperty("app.name");
String[] profiles = environment.getActiveProfiles();
```

### Q10: What is @PropertySource used for?
**Answer:**
@PropertySource loads custom property files into the Spring Environment:

```java
@Configuration
@PropertySource("classpath:custom.properties")
public class CustomConfig {
}

// Multiple files
@PropertySource({
    "classpath:app.properties",
    "classpath:database.properties"
})

// With encoding and optional
@PropertySource(
    value = "classpath:messages.properties",
    encoding = "UTF-8",
    ignoreResourceNotFound = true
)
```

---

## üìö Summary

Property Sources provide flexible configuration management in Spring:

1. **Hierarchy**: Command-line ‚Üí System properties ‚Üí Environment variables ‚Üí Property files
2. **@Value**: Simple property injection with SpEL support
3. **@ConfigurationProperties**: Type-safe, validated, grouped properties (preferred for complex config)
4. **Externalization**: Load from external files, environment variables, command-line
5. **Best Practices**: Use ConfigurationProperties for groups, externalize secrets, provide defaults, validate

Proper configuration management is crucial for cloud-native, twelve-factor applications!

---

**Next Topic:** [Spring Expression Language (SpEL) ‚Üí](./08.%20SpEL.md)
