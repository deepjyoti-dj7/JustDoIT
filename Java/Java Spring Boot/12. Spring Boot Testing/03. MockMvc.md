# üåê MockMvc - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [MockMvc Setup](#mockmvc-setup)
- [Performing Requests](#performing-requests)
- [Request Matchers](#request-matchers)
- [Response Assertions](#response-assertions)
- [JSON Testing](#json-testing)
- [File Upload Testing](#file-upload-testing)
- [Security Testing](#security-testing)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**MockMvc** is Spring's primary mechanism for testing web layer (controllers) without starting a full HTTP server. It provides a powerful API for performing requests and asserting responses.

### Why MockMvc?

```
Advantages:
‚úÖ Fast - No HTTP server needed
‚úÖ Isolated - Test only web layer
‚úÖ Comprehensive - Full Spring MVC flow
‚úÖ Easy debugging - Stack traces available
‚úÖ No network overhead

Use Cases:
‚úÖ Controller testing
‚úÖ Request mapping verification
‚úÖ Request/response validation
‚úÖ Exception handling testing
‚úÖ Filter testing
```

---

## ‚öôÔ∏è MockMvc Setup

### Standalone Setup

```java
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

class UserControllerStandaloneTest {
    
    private MockMvc mockMvc;
    private UserService userService;
    
    @BeforeEach
    void setup() {
        userService = mock(UserService.class);
        UserController userController = new UserController(userService);
        
        mockMvc = MockMvcBuilders
            .standaloneSetup(userController)
            .build();
    }
    
    @Test
    void shouldGetUser() throws Exception {
        when(userService.getUser(1L))
            .thenReturn(new User(1L, "John", "john@example.com"));
        
        mockMvc.perform(get("/api/users/1"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.name").value("John"));
    }
}
```

### WebApplicationContext Setup

```java
@WebMvcTest(UserController.class)
class UserControllerWebMvcTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    void shouldGetUser() throws Exception {
        when(userService.getUser(1L))
            .thenReturn(new User(1L, "John", "john@example.com"));
        
        mockMvc.perform(get("/api/users/1"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.name").value("John"));
    }
}
```

### Custom Configuration

```java
@WebMvcTest(UserController.class)
class CustomMockMvcTest {
    
    @Autowired
    private WebApplicationContext webApplicationContext;
    
    private MockMvc mockMvc;
    
    @BeforeEach
    void setup() {
        mockMvc = MockMvcBuilders
            .webAppContextSetup(webApplicationContext)
            .apply(springSecurity())  // Add security
            .alwaysDo(print())        // Print all requests/responses
            .build();
    }
}
```

---

## üì§ Performing Requests

### GET Requests

```java
@Test
void getRequests() throws Exception {
    // Simple GET
    mockMvc.perform(get("/api/users/1"))
        .andExpect(status().isOk());
    
    // GET with query parameters
    mockMvc.perform(get("/api/users")
            .param("page", "0")
            .param("size", "10")
            .param("sort", "name,asc"))
        .andExpect(status().isOk());
    
    // GET with path variable
    mockMvc.perform(get("/api/users/{id}", 1L))
        .andExpect(status().isOk());
    
    // GET with headers
    mockMvc.perform(get("/api/users/1")
            .header("Authorization", "Bearer token")
            .accept(MediaType.APPLICATION_JSON))
        .andExpect(status().isOk());
}
```

### POST Requests

```java
@Test
void postRequests() throws Exception {
    // POST with JSON body
    String userJson = """
        {
            "name": "John Doe",
            "email": "john@example.com",
            "age": 25
        }
        """;
    
    mockMvc.perform(post("/api/users")
            .contentType(MediaType.APPLICATION_JSON)
            .content(userJson))
        .andExpect(status().isCreated())
        .andExpect(header().exists("Location"));
    
    // POST with form data
    mockMvc.perform(post("/api/login")
            .contentType(MediaType.APPLICATION_FORM_URLENCODED)
            .param("username", "john")
            .param("password", "secret"))
        .andExpect(status().isOk());
    
    // POST with object (using Jackson)
    UserRequest request = new UserRequest("John", "john@example.com");
    
    mockMvc.perform(post("/api/users")
            .contentType(MediaType.APPLICATION_JSON)
            .content(asJsonString(request)))
        .andExpect(status().isCreated());
}

// Helper method
private String asJsonString(Object obj) throws JsonProcessingException {
    return new ObjectMapper().writeValueAsString(obj);
}
```

### PUT Requests

```java
@Test
void putRequests() throws Exception {
    String updateJson = """
        {
            "name": "John Updated",
            "email": "john.updated@example.com"
        }
        """;
    
    mockMvc.perform(put("/api/users/{id}", 1L)
            .contentType(MediaType.APPLICATION_JSON)
            .content(updateJson))
        .andExpect(status().isOk());
}
```

### PATCH Requests

```java
@Test
void patchRequests() throws Exception {
    String patchJson = """
        {
            "email": "newemail@example.com"
        }
        """;
    
    mockMvc.perform(patch("/api/users/{id}", 1L)
            .contentType(MediaType.APPLICATION_JSON)
            .content(patchJson))
        .andExpect(status().isOk());
}
```

### DELETE Requests

```java
@Test
void deleteRequests() throws Exception {
    mockMvc.perform(delete("/api/users/{id}", 1L))
        .andExpect(status().isNoContent());
    
    // Verify service method called
    verify(userService).deleteUser(1L);
}
```

---

## üéØ Request Matchers

### Content Type Matchers

```java
@Test
void contentTypeMatchers() throws Exception {
    mockMvc.perform(post("/api/users")
            .contentType(MediaType.APPLICATION_JSON)
            .content("{}"))
        .andExpect(status().isCreated())
        .andExpect(content().contentType(MediaType.APPLICATION_JSON))
        .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON));
}
```

### Header Matchers

```java
@Test
void headerMatchers() throws Exception {
    mockMvc.perform(get("/api/users/1"))
        .andExpect(header().exists("Content-Type"))
        .andExpect(header().string("Content-Type", "application/json"))
        .andExpect(header().stringValues("Cache-Control", "no-cache", "no-store"))
        .andExpect(header().longValue("Content-Length", 100));
}
```

### Cookie Matchers

```java
@Test
void cookieMatchers() throws Exception {
    mockMvc.perform(post("/api/login")
            .param("username", "john")
            .param("password", "secret"))
        .andExpect(cookie().exists("JSESSIONID"))
        .andExpect(cookie().value("rememberMe", "true"))
        .andExpect(cookie().maxAge("token", 3600))
        .andExpect(cookie().httpOnly("token", true));
}
```

---

## ‚úÖ Response Assertions

### Status Assertions

```java
@Test
void statusAssertions() throws Exception {
    // Success statuses
    mockMvc.perform(get("/api/users"))
        .andExpect(status().isOk())           // 200
        .andExpect(status().is(200));
    
    mockMvc.perform(post("/api/users").content("{}"))
        .andExpect(status().isCreated())      // 201
        .andExpect(status().is(201));
    
    mockMvc.perform(delete("/api/users/1"))
        .andExpect(status().isNoContent());   // 204
    
    // Client error statuses
    mockMvc.perform(get("/api/users/999"))
        .andExpect(status().isNotFound())     // 404
        .andExpect(status().is(404));
    
    mockMvc.perform(post("/api/users").content("invalid"))
        .andExpect(status().isBadRequest())   // 400
        .andExpect(status().is4xxClientError());
    
    mockMvc.perform(get("/api/admin"))
        .andExpect(status().isUnauthorized()) // 401
        .andExpect(status().isForbidden());   // 403
    
    // Server error statuses
    mockMvc.perform(get("/api/error"))
        .andExpect(status().isInternalServerError())  // 500
        .andExpect(status().is5xxServerError());
}
```

### Content Assertions

```java
@Test
void contentAssertions() throws Exception {
    mockMvc.perform(get("/api/users/1"))
        // Exact content
        .andExpect(content().string("{\"name\":\"John\"}"))
        
        // Contains
        .andExpect(content().string(containsString("John")))
        
        // Starts/ends with
        .andExpect(content().string(startsWith("{")))
        .andExpect(content().string(endsWith("}")));
}
```

### Model Assertions

```java
@Test
void modelAssertions() throws Exception {
    mockMvc.perform(get("/users/form"))
        .andExpect(model().attributeExists("user"))
        .andExpect(model().attribute("user", hasProperty("name", equalTo("John"))))
        .andExpect(model().size(2))
        .andExpect(model().hasNoErrors());
    
    // Form validation errors
    mockMvc.perform(post("/users")
            .param("email", "invalid"))
        .andExpect(model().hasErrors())
        .andExpect(model().errorCount(1))
        .andExpect(model().attributeHasFieldErrors("user", "email"));
}
```

### View Assertions

```java
@Test
void viewAssertions() throws Exception {
    mockMvc.perform(get("/users"))
        .andExpect(view().name("users/list"))
        .andExpect(forwardedUrl("/WEB-INF/views/users/list.jsp"));
    
    mockMvc.perform(post("/users"))
        .andExpect(redirectedUrl("/users/1"))
        .andExpect(redirectedUrlPattern("/users/*"));
}
```

---

## üîç JSON Testing

### JSONPath Assertions

```java
@Test
void jsonPathAssertions() throws Exception {
    when(userService.getUser(1L)).thenReturn(
        User.builder()
            .id(1L)
            .name("John Doe")
            .email("john@example.com")
            .age(25)
            .address(new Address("123 Main St", "New York"))
            .build()
    );
    
    mockMvc.perform(get("/api/users/1"))
        // Simple field
        .andExpect(jsonPath("$.id").value(1))
        .andExpect(jsonPath("$.name").value("John Doe"))
        .andExpect(jsonPath("$.email").value("john@example.com"))
        
        // Exists/doesn't exist
        .andExpect(jsonPath("$.age").exists())
        .andExpect(jsonPath("$.phone").doesNotExist())
        
        // Type checks
        .andExpect(jsonPath("$.id").isNumber())
        .andExpect(jsonPath("$.name").isString())
        .andExpect(jsonPath("$.active").isBoolean())
        
        // Nested objects
        .andExpect(jsonPath("$.address.street").value("123 Main St"))
        .andExpect(jsonPath("$.address.city").value("New York"));
}
```

### Array JSONPath

```java
@Test
void jsonPathArrays() throws Exception {
    List<User> users = Arrays.asList(
        new User(1L, "John", "john@example.com"),
        new User(2L, "Jane", "jane@example.com"),
        new User(3L, "Bob", "bob@example.com")
    );
    
    when(userService.getAllUsers()).thenReturn(users);
    
    mockMvc.perform(get("/api/users"))
        // Array size
        .andExpect(jsonPath("$").isArray())
        .andExpect(jsonPath("$", hasSize(3)))
        
        // First element
        .andExpect(jsonPath("$[0].id").value(1))
        .andExpect(jsonPath("$[0].name").value("John"))
        
        // Last element
        .andExpect(jsonPath("$[2].name").value("Bob"))
        
        // Contains
        .andExpect(jsonPath("$[*].name", containsInAnyOrder("John", "Jane", "Bob")))
        .andExpect(jsonPath("$[*].email", hasItem("john@example.com")));
}
```

### Complex JSON Assertions

```java
@Test
void complexJsonAssertions() throws Exception {
    mockMvc.perform(get("/api/orders/1"))
        .andExpect(jsonPath("$.orderNumber").value("ORD-001"))
        .andExpect(jsonPath("$.items", hasSize(2)))
        .andExpect(jsonPath("$.items[0].productName").value("Product 1"))
        .andExpect(jsonPath("$.items[0].quantity").value(2))
        .andExpect(jsonPath("$.items[0].price").value(10.00))
        .andExpect(jsonPath("$.total").value(35.00))
        .andExpect(jsonPath("$.customer.name").value("John Doe"))
        .andExpect(jsonPath("$.customer.email").value("john@example.com"));
}
```

### Custom JSON Matchers

```java
@Test
void customJsonMatchers() throws Exception {
    mockMvc.perform(get("/api/users/1"))
        .andExpect(jsonPath("$.email", matchesPattern("^[^@]+@[^@]+\\.[^@]+$")))
        .andExpect(jsonPath("$.age", greaterThan(18)))
        .andExpect(jsonPath("$.createdAt", notNullValue()));
}
```

---

## üìÅ File Upload Testing

### Single File Upload

```java
@Test
void shouldUploadFile() throws Exception {
    MockMultipartFile file = new MockMultipartFile(
        "file",                          // Parameter name
        "test.txt",                      // Original filename
        MediaType.TEXT_PLAIN_VALUE,      // Content type
        "Test file content".getBytes()   // Content
    );
    
    mockMvc.perform(multipart("/api/files/upload")
            .file(file))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.filename").value("test.txt"))
        .andExpect(jsonPath("$.size").value(18));
}
```

### Multiple Files Upload

```java
@Test
void shouldUploadMultipleFiles() throws Exception {
    MockMultipartFile file1 = new MockMultipartFile(
        "files", "file1.txt", MediaType.TEXT_PLAIN_VALUE, "Content 1".getBytes()
    );
    
    MockMultipartFile file2 = new MockMultipartFile(
        "files", "file2.txt", MediaType.TEXT_PLAIN_VALUE, "Content 2".getBytes()
    );
    
    mockMvc.perform(multipart("/api/files/upload/multiple")
            .file(file1)
            .file(file2))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$", hasSize(2)));
}
```

### File Upload with Additional Data

```java
@Test
void shouldUploadFileWithMetadata() throws Exception {
    MockMultipartFile file = new MockMultipartFile(
        "file", "document.pdf", MediaType.APPLICATION_PDF_VALUE, "PDF content".getBytes()
    );
    
    mockMvc.perform(multipart("/api/documents/upload")
            .file(file)
            .param("title", "Important Document")
            .param("description", "This is a test document")
            .param("category", "LEGAL"))
        .andExpect(status().isCreated())
        .andExpect(jsonPath("$.title").value("Important Document"))
        .andExpect(jsonPath("$.filename").value("document.pdf"));
}
```

---

## üîí Security Testing

### Testing with Authentication

```java
@WebMvcTest(UserController.class)
@Import(SecurityConfig.class)
class SecureControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    @WithMockUser(username = "john", roles = "USER")
    void shouldAccessWithAuthentication() throws Exception {
        mockMvc.perform(get("/api/users/me"))
            .andExpect(status().isOk());
    }
    
    @Test
    void shouldFailWithoutAuthentication() throws Exception {
        mockMvc.perform(get("/api/users/me"))
            .andExpect(status().isUnauthorized());
    }
    
    @Test
    @WithMockUser(username = "admin", roles = "ADMIN")
    void shouldAccessAdminEndpoint() throws Exception {
        mockMvc.perform(get("/api/admin/users"))
            .andExpect(status().isOk());
    }
    
    @Test
    @WithMockUser(username = "user", roles = "USER")
    void shouldDenyAccessToAdminEndpoint() throws Exception {
        mockMvc.perform(get("/api/admin/users"))
            .andExpect(status().isForbidden());
    }
}
```

### Custom Security Context

```java
@Test
void testWithCustomSecurityContext() throws Exception {
    UserDetails userDetails = User.builder()
        .username("john")
        .password("password")
        .roles("USER")
        .build();
    
    SecurityContext securityContext = SecurityContextHolder.createEmptyContext();
    securityContext.setAuthentication(
        new UsernamePasswordAuthenticationToken(
            userDetails,
            userDetails.getPassword(),
            userDetails.getAuthorities()
        )
    );
    
    mockMvc.perform(get("/api/users/me")
            .with(securityContext(securityContext)))
        .andExpect(status().isOk());
}
```

### Testing JWT Authentication

```java
@Test
void shouldAuthenticateWithJWT() throws Exception {
    String token = jwtTokenProvider.createToken("john", Arrays.asList("ROLE_USER"));
    
    mockMvc.perform(get("/api/users/me")
            .header("Authorization", "Bearer " + token))
        .andExpect(status().isOk())
        .andExpect(jsonPath("$.username").value("john"));
}

@Test
void shouldRejectInvalidJWT() throws Exception {
    mockMvc.perform(get("/api/users/me")
            .header("Authorization", "Bearer invalid-token"))
        .andExpect(status().isUnauthorized());
}
```

---

## üí° Best Practices

### 1. Use Result Actions Chaining

```java
// ‚úÖ Good - Fluent API
mockMvc.perform(get("/api/users/1"))
    .andExpect(status().isOk())
    .andExpect(content().contentType(MediaType.APPLICATION_JSON))
    .andExpect(jsonPath("$.name").value("John"))
    .andExpect(jsonPath("$.email").value("john@example.com"));

// ‚ùå Bad - Separate calls
ResultActions result = mockMvc.perform(get("/api/users/1"));
result.andExpect(status().isOk());
result.andExpect(jsonPath("$.name").value("John"));
```

### 2. Extract Common Setup

```java
// ‚úÖ Good - Reusable setup
class UserControllerTest {
    
    private static final String BASE_URL = "/api/users";
    
    @BeforeEach
    void setup() {
        when(userService.getUser(1L))
            .thenReturn(createTestUser());
    }
    
    private User createTestUser() {
        return new User(1L, "John", "john@example.com");
    }
    
    @Test
    void test1() {
        mockMvc.perform(get(BASE_URL + "/1"))
            .andExpect(status().isOk());
    }
}
```

### 3. Use andDo() for Debugging

```java
@Test
void debuggingTest() throws Exception {
    mockMvc.perform(get("/api/users/1"))
        .andDo(print())  // Prints request/response details
        .andExpect(status().isOk());
}
```

---

## üé§ Interview Questions

### Q1: What is MockMvc?
**Answer:** Spring's tool for testing web layer without starting HTTP server, simulates HTTP requests/responses.

### Q2: How to create MockMvc?
**Answer:**
```java
// Standalone
MockMvcBuilders.standaloneSetup(controller).build();

// With @WebMvcTest
@Autowired MockMvc mockMvc;
```

### Q3: How to test GET request?
**Answer:**
```java
mockMvc.perform(get("/api/users/1"))
    .andExpect(status().isOk());
```

### Q4: How to test POST with JSON?
**Answer:**
```java
mockMvc.perform(post("/api/users")
    .contentType(MediaType.APPLICATION_JSON)
    .content(json))
    .andExpect(status().isCreated());
```

### Q5: What is jsonPath()?
**Answer:** Asserts JSON response content using JSONPath expressions:
```java
.andExpect(jsonPath("$.name").value("John"))
```

### Q6: How to test file upload?
**Answer:**
```java
MockMultipartFile file = new MockMultipartFile("file", "test.txt", 
    MediaType.TEXT_PLAIN_VALUE, "content".getBytes());
mockMvc.perform(multipart("/upload").file(file))
```

### Q7: How to add headers to request?
**Answer:**
```java
mockMvc.perform(get("/api/users")
    .header("Authorization", "Bearer token"))
```

### Q8: How to test with authentication?
**Answer:**
```java
@Test
@WithMockUser(username = "john", roles = "USER")
void test() { }
```

### Q9: What is andDo(print())?
**Answer:** Prints request/response details to console for debugging.

### Q10: How to test query parameters?
**Answer:**
```java
mockMvc.perform(get("/api/users")
    .param("page", "0")
    .param("size", "10"))
```

### Q11: Difference between standalone and WebApplicationContext setup?
**Answer:**
- Standalone: Tests single controller in isolation
- WebApplicationContext: Tests with full Spring configuration

### Q12: How to test status code?
**Answer:**
```java
.andExpect(status().isOk())      // 200
.andExpect(status().isCreated()) // 201
.andExpect(status().is(404))     // Any code
```

### Q13: How to test response headers?
**Answer:**
```java
.andExpect(header().exists("Location"))
.andExpect(header().string("Content-Type", "application/json"))
```

### Q14: How to test cookies?
**Answer:**
```java
.andExpect(cookie().exists("JSESSIONID"))
.andExpect(cookie().value("token", "abc123"))
```

### Q15: What is @WebMvcTest?
**Answer:** Test slice annotation that loads only web layer components for controller testing.

### Q16: How to test JSON arrays?
**Answer:**
```java
.andExpect(jsonPath("$", hasSize(3)))
.andExpect(jsonPath("$[0].name").value("John"))
```

### Q17: How to verify service method was called?
**Answer:**
```java
verify(userService).getUser(1L);
```

### Q18: Can MockMvc test security?
**Answer:** Yes, with @WithMockUser or SecurityMockMvcConfigurers.

### Q19: How to test DELETE request?
**Answer:**
```java
mockMvc.perform(delete("/api/users/1"))
    .andExpect(status().isNoContent());
```

### Q20: What is content() matcher?
**Answer:** Asserts response body content:
```java
.andExpect(content().string("expected"))
.andExpect(content().contentType(MediaType.APPLICATION_JSON))
```

---

## üìö Summary

### MockMvc Request Pattern

```java
mockMvc.perform(
    // HTTP method + URL
    get("/api/users/1")
        .param("key", "value")
        .header("Name", "Value")
        .contentType(MediaType.APPLICATION_JSON)
        .content(json)
)
.andExpect(status().isOk())
.andExpect(jsonPath("$.name").value("John"))
.andDo(print());
```

### Common Assertions

| Assertion Type | Example |
|----------------|---------|
| Status | `.andExpect(status().isOk())` |
| JSON | `.andExpect(jsonPath("$.name").value("John"))` |
| Header | `.andExpect(header().exists("Location"))` |
| Content | `.andExpect(content().string("text"))` |
| Cookie | `.andExpect(cookie().value("token", "abc"))` |

### HTTP Methods

```java
get("/url")
post("/url").content(json)
put("/url").content(json)
patch("/url").content(json)
delete("/url")
multipart("/url").file(file)
```

**Next:** @WebMvcTest ‚Üí

