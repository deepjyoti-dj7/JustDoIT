# üõ†Ô∏è ExceptionHandler - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Exception Handler Basics](#exception-handler-basics)
- [Method-Level Exception Handling](#method-level-exception-handling)
- [Controller-Level Exception Handling](#controller-level-exception-handling)
- [Exception Hierarchy](#exception-hierarchy)
- [Multiple Exception Handlers](#multiple-exception-handlers)
- [Response Status](#response-status)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**@ExceptionHandler** is a Spring annotation for handling exceptions at the controller level, providing centralized error handling.

### Why Exception Handling?

```
Without Exception Handling:
‚ùå 500 Internal Server Error
‚ùå Stack trace exposed to client
‚ùå Inconsistent error responses
‚ùå Poor user experience

With Exception Handling:
‚úÖ Meaningful error messages
‚úÖ Consistent response format
‚úÖ Appropriate HTTP status codes
‚úÖ Security (no stack trace leakage)
‚úÖ Better debugging
```

### Exception Flow

```
Request ‚Üí Controller ‚Üí Service ‚Üí Exception
                                     ‚Üì
                          @ExceptionHandler catches
                                     ‚Üì
                          Format error response
                                     ‚Üì
                          Return to client
```

---

## üîß Exception Handler Basics

### Simple Exception Handler

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public User getUserById(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    @ExceptionHandler(UserNotFoundException.class)
    public ResponseEntity<String> handleUserNotFound(UserNotFoundException ex) {
        return ResponseEntity
            .status(HttpStatus.NOT_FOUND)
            .body(ex.getMessage());
    }
}
```

### With Error Details

```java
@ExceptionHandler(UserNotFoundException.class)
public ResponseEntity<ErrorResponse> handleUserNotFound(UserNotFoundException ex) {
    ErrorResponse error = new ErrorResponse(
        HttpStatus.NOT_FOUND.value(),
        ex.getMessage(),
        LocalDateTime.now()
    );
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
}

// Error Response DTO
@Data
@AllArgsConstructor
public class ErrorResponse {
    private int status;
    private String message;
    private LocalDateTime timestamp;
}
```

---

## üìù Method-Level Exception Handling

### Single Exception

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    @GetMapping("/{id}")
    public Product getProduct(@PathVariable Long id) {
        return productService.findById(id);
    }
    
    @ExceptionHandler(ProductNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleProductNotFound(ProductNotFoundException ex) {
        return new ErrorResponse(
            HttpStatus.NOT_FOUND.value(),
            ex.getMessage(),
            LocalDateTime.now()
        );
    }
}
```

### Multiple Exceptions

```java
@ExceptionHandler({
    ProductNotFoundException.class,
    CategoryNotFoundException.class
})
@ResponseStatus(HttpStatus.NOT_FOUND)
public ErrorResponse handleNotFound(RuntimeException ex) {
    return new ErrorResponse(
        HttpStatus.NOT_FOUND.value(),
        ex.getMessage(),
        LocalDateTime.now()
    );
}
```

### With Request Information

```java
@ExceptionHandler(InvalidRequestException.class)
public ResponseEntity<ErrorResponse> handleInvalidRequest(
        InvalidRequestException ex,
        WebRequest request) {
    
    ErrorResponse error = ErrorResponse.builder()
        .status(HttpStatus.BAD_REQUEST.value())
        .message(ex.getMessage())
        .path(request.getDescription(false))
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
}
```

---

## üéØ Controller-Level Exception Handling

### Complete Controller with Handlers

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public ResponseEntity<Order> createOrder(@Valid @RequestBody OrderRequest request) {
        Order order = orderService.createOrder(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(order);
    }
    
    @GetMapping("/{id}")
    public Order getOrder(@PathVariable Long id) {
        return orderService.findById(id);
    }
    
    @PutMapping("/{id}")
    public Order updateOrder(@PathVariable Long id, @Valid @RequestBody OrderRequest request) {
        return orderService.update(id, request);
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteOrder(@PathVariable Long id) {
        orderService.delete(id);
        return ResponseEntity.noContent().build();
    }
    
    // Exception Handlers
    
    @ExceptionHandler(OrderNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleOrderNotFound(OrderNotFoundException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.NOT_FOUND.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    @ExceptionHandler(InsufficientStockException.class)
    @ResponseStatus(HttpStatus.CONFLICT)
    public ErrorResponse handleInsufficientStock(InsufficientStockException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.CONFLICT.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ValidationErrorResponse handleValidationErrors(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        
        ex.getBindingResult().getFieldErrors().forEach(error -> 
            errors.put(error.getField(), error.getDefaultMessage())
        );
        
        return ValidationErrorResponse.builder()
            .status(HttpStatus.BAD_REQUEST.value())
            .message("Validation failed")
            .errors(errors)
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ErrorResponse handleGenericException(Exception ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
            .message("An unexpected error occurred")
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

---

## üå≤ Exception Hierarchy

### Custom Exception Base Class

```java
public abstract class BaseException extends RuntimeException {
    private final HttpStatus status;
    
    public BaseException(String message, HttpStatus status) {
        super(message);
        this.status = status;
    }
    
    public HttpStatus getStatus() {
        return status;
    }
}
```

### Domain-Specific Exceptions

```java
// Not Found Exceptions
public class ResourceNotFoundException extends BaseException {
    public ResourceNotFoundException(String resource, Long id) {
        super(String.format("%s not found with id: %d", resource, id), HttpStatus.NOT_FOUND);
    }
}

public class UserNotFoundException extends ResourceNotFoundException {
    public UserNotFoundException(Long id) {
        super("User", id);
    }
}

public class ProductNotFoundException extends ResourceNotFoundException {
    public ProductNotFoundException(Long id) {
        super("Product", id);
    }
}

// Conflict Exceptions
public class ResourceAlreadyExistsException extends BaseException {
    public ResourceAlreadyExistsException(String message) {
        super(message, HttpStatus.CONFLICT);
    }
}

public class DuplicateEmailException extends ResourceAlreadyExistsException {
    public DuplicateEmailException(String email) {
        super(String.format("Email already exists: %s", email));
    }
}

// Bad Request Exceptions
public class InvalidRequestException extends BaseException {
    public InvalidRequestException(String message) {
        super(message, HttpStatus.BAD_REQUEST);
    }
}

public class InvalidOrderStatusException extends InvalidRequestException {
    public InvalidOrderStatusException(String status) {
        super(String.format("Invalid order status: %s", status));
    }
}
```

### Generic Handler for Base Exception

```java
@ExceptionHandler(BaseException.class)
public ResponseEntity<ErrorResponse> handleBaseException(BaseException ex) {
    ErrorResponse error = ErrorResponse.builder()
        .status(ex.getStatus().value())
        .message(ex.getMessage())
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(ex.getStatus()).body(error);
}
```

---

## üî¢ Multiple Exception Handlers

### Handling Multiple Related Exceptions

```java
@RestController
@RequestMapping("/api/payments")
public class PaymentController {
    
    @Autowired
    private PaymentService paymentService;
    
    @PostMapping
    public Payment processPayment(@Valid @RequestBody PaymentRequest request) {
        return paymentService.process(request);
    }
    
    // Handle all NOT_FOUND exceptions
    @ExceptionHandler({
        PaymentNotFoundException.class,
        CardNotFoundException.class,
        MerchantNotFoundException.class
    })
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleNotFound(RuntimeException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.NOT_FOUND.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    // Handle all payment processing errors
    @ExceptionHandler({
        InsufficientFundsException.class,
        CardExpiredException.class,
        CardDeclinedException.class
    })
    @ResponseStatus(HttpStatus.PAYMENT_REQUIRED)
    public ErrorResponse handlePaymentErrors(RuntimeException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.PAYMENT_REQUIRED.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    // Handle validation errors
    @ExceptionHandler({
        InvalidCardNumberException.class,
        InvalidCvvException.class,
        InvalidAmountException.class
    })
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ErrorResponse handleValidationErrors(RuntimeException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.BAD_REQUEST.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

### Prioritizing Exception Handlers

```java
// More specific handler (executed first)
@ExceptionHandler(UserNotFoundException.class)
public ResponseEntity<ErrorResponse> handleUserNotFound(UserNotFoundException ex) {
    // Specific handling for UserNotFoundException
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(createError(ex));
}

// Less specific handler (fallback)
@ExceptionHandler(ResourceNotFoundException.class)
public ResponseEntity<ErrorResponse> handleResourceNotFound(ResourceNotFoundException ex) {
    // Generic handling for all ResourceNotFoundException
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(createError(ex));
}

// Catch-all handler (last resort)
@ExceptionHandler(Exception.class)
public ResponseEntity<ErrorResponse> handleGenericException(Exception ex) {
    // Handle all other exceptions
    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(createError(ex));
}
```

---

## üìä Response Status

### Using @ResponseStatus

```java
@ExceptionHandler(UserNotFoundException.class)
@ResponseStatus(HttpStatus.NOT_FOUND)
public ErrorResponse handleUserNotFound(UserNotFoundException ex) {
    return new ErrorResponse(
        HttpStatus.NOT_FOUND.value(),
        ex.getMessage(),
        LocalDateTime.now()
    );
}
```

### Using ResponseEntity

```java
@ExceptionHandler(UnauthorizedException.class)
public ResponseEntity<ErrorResponse> handleUnauthorized(UnauthorizedException ex) {
    ErrorResponse error = new ErrorResponse(
        HttpStatus.UNAUTHORIZED.value(),
        ex.getMessage(),
        LocalDateTime.now()
    );
    
    return ResponseEntity
        .status(HttpStatus.UNAUTHORIZED)
        .header("WWW-Authenticate", "Bearer")
        .body(error);
}
```

### Common HTTP Status Codes

```java
@ExceptionHandler(ResourceNotFoundException.class)
@ResponseStatus(HttpStatus.NOT_FOUND) // 404
public ErrorResponse handleNotFound(ResourceNotFoundException ex) {
    return createError(ex, HttpStatus.NOT_FOUND);
}

@ExceptionHandler(InvalidRequestException.class)
@ResponseStatus(HttpStatus.BAD_REQUEST) // 400
public ErrorResponse handleBadRequest(InvalidRequestException ex) {
    return createError(ex, HttpStatus.BAD_REQUEST);
}

@ExceptionHandler(UnauthorizedException.class)
@ResponseStatus(HttpStatus.UNAUTHORIZED) // 401
public ErrorResponse handleUnauthorized(UnauthorizedException ex) {
    return createError(ex, HttpStatus.UNAUTHORIZED);
}

@ExceptionHandler(ForbiddenException.class)
@ResponseStatus(HttpStatus.FORBIDDEN) // 403
public ErrorResponse handleForbidden(ForbiddenException ex) {
    return createError(ex, HttpStatus.FORBIDDEN);
}

@ExceptionHandler(ConflictException.class)
@ResponseStatus(HttpStatus.CONFLICT) // 409
public ErrorResponse handleConflict(ConflictException ex) {
    return createError(ex, HttpStatus.CONFLICT);
}

@ExceptionHandler(InternalServerException.class)
@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR) // 500
public ErrorResponse handleInternalError(InternalServerException ex) {
    return createError(ex, HttpStatus.INTERNAL_SERVER_ERROR);
}
```

---

## üìå Best Practices

### 1. Don't Expose Stack Traces

```java
// ‚ùå Bad - Exposes sensitive information
@ExceptionHandler(Exception.class)
public ErrorResponse handleException(Exception ex) {
    return new ErrorResponse(
        500,
        ex.getStackTrace().toString(), // Never do this!
        LocalDateTime.now()
    );
}

// ‚úÖ Good - Generic message to client, log details server-side
@ExceptionHandler(Exception.class)
public ErrorResponse handleException(Exception ex) {
    log.error("Unexpected error occurred", ex); // Log full details
    return new ErrorResponse(
        500,
        "An unexpected error occurred. Please try again later.",
        LocalDateTime.now()
    );
}
```

### 2. Use Specific Exceptions

```java
// ‚ùå Bad - Generic exception
if (user == null) {
    throw new RuntimeException("User not found");
}

// ‚úÖ Good - Specific exception
if (user == null) {
    throw new UserNotFoundException(userId);
}
```

### 3. Consistent Error Response Format

```java
// ‚úÖ Good - Consistent structure
@Data
@Builder
public class ErrorResponse {
    private int status;
    private String message;
    private String path;
    private LocalDateTime timestamp;
}

// All handlers return this format
@ExceptionHandler(UserNotFoundException.class)
public ResponseEntity<ErrorResponse> handleUserNotFound(
        UserNotFoundException ex,
        WebRequest request) {
    
    ErrorResponse error = ErrorResponse.builder()
        .status(HttpStatus.NOT_FOUND.value())
        .message(ex.getMessage())
        .path(request.getDescription(false))
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
}
```

### 4. Log Exceptions Appropriately

```java
@ExceptionHandler(UserNotFoundException.class)
public ResponseEntity<ErrorResponse> handleUserNotFound(UserNotFoundException ex) {
    log.warn("User not found: {}", ex.getMessage()); // WARN for expected errors
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(createError(ex));
}

@ExceptionHandler(Exception.class)
public ResponseEntity<ErrorResponse> handleGenericException(Exception ex) {
    log.error("Unexpected error occurred", ex); // ERROR for unexpected errors
    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(createError(ex));
}
```

### 5. Include Request Context

```java
@ExceptionHandler(InvalidRequestException.class)
public ResponseEntity<ErrorResponse> handleInvalidRequest(
        InvalidRequestException ex,
        HttpServletRequest request) {
    
    ErrorResponse error = ErrorResponse.builder()
        .status(HttpStatus.BAD_REQUEST.value())
        .message(ex.getMessage())
        .path(request.getRequestURI())
        .method(request.getMethod())
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
}
```

### 6. Use @ControllerAdvice for Global Handling

```java
// ‚ùå Bad - Duplicate handlers in every controller
@RestController
public class UserController {
    @ExceptionHandler(Exception.class)
    public ErrorResponse handleException(Exception ex) { }
}

@RestController
public class ProductController {
    @ExceptionHandler(Exception.class)
    public ErrorResponse handleException(Exception ex) { }
}

// ‚úÖ Good - Centralized in @ControllerAdvice
@ControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(Exception.class)
    public ErrorResponse handleException(Exception ex) { }
}
```

### 7. Handle Async Exceptions

```java
@ExceptionHandler(AsyncRequestTimeoutException.class)
@ResponseStatus(HttpStatus.SERVICE_UNAVAILABLE)
public ErrorResponse handleAsyncTimeout(AsyncRequestTimeoutException ex) {
    return ErrorResponse.builder()
        .status(HttpStatus.SERVICE_UNAVAILABLE.value())
        .message("Request timeout. Please try again.")
        .timestamp(LocalDateTime.now())
        .build();
}
```

---

## üé§ Interview Questions

### Q1: What is @ExceptionHandler?
**Answer:** Annotation for handling exceptions at controller level, providing centralized error handling.

### Q2: Where can @ExceptionHandler be used?
**Answer:** 
1. Controller class (handles exceptions for that controller)
2. @ControllerAdvice class (handles exceptions globally)

### Q3: How to handle multiple exceptions?
**Answer:**
```java
@ExceptionHandler({Exception1.class, Exception2.class})
public ResponseEntity<ErrorResponse> handle(RuntimeException ex) { }
```

### Q4: What is @ResponseStatus?
**Answer:** Annotation to specify HTTP status code for exception handler response.

### Q5: Difference between @ExceptionHandler and @ControllerAdvice?
**Answer:** 
- @ExceptionHandler: Method-level, handles exceptions
- @ControllerAdvice: Class-level, applies handlers globally

### Q6: How to access request information in handler?
**Answer:**
```java
@ExceptionHandler(Exception.class)
public ResponseEntity<?> handle(Exception ex, WebRequest request) {
    String path = request.getDescription(false);
}
```

### Q7: Can you use ResponseEntity with @ExceptionHandler?
**Answer:** Yes, for more control over response (headers, status, body).

### Q8: What happens if no handler matches?
**Answer:** Spring's default exception resolver handles it, typically returning 500.

### Q9: How to prioritize exception handlers?
**Answer:** More specific exceptions are matched first (UserNotFoundException before ResourceNotFoundException).

### Q10: Can @ExceptionHandler handle checked exceptions?
**Answer:** Yes, can handle both checked and unchecked exceptions.

### Q11: What is the order of exception handler execution?
**Answer:**
1. Most specific exception class
2. Less specific parent class
3. Generic Exception class

### Q12: How to return different status codes?
**Answer:**
```java
@ExceptionHandler(NotFoundException.class)
public ResponseEntity<?> handle(NotFoundException ex) {
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
}
```

### Q13: Can you add headers in exception response?
**Answer:**
```java
return ResponseEntity.status(401)
    .header("WWW-Authenticate", "Bearer")
    .body(error);
```

### Q14: What is WebRequest parameter?
**Answer:** Provides access to request details (path, headers, parameters).

### Q15: How to handle validation exceptions?
**Answer:**
```java
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<?> handleValidation(MethodArgumentNotValidException ex) {
    // Extract field errors
}
```

### Q16: Should you log in @ExceptionHandler?
**Answer:** Yes, log appropriate level (WARN for expected, ERROR for unexpected).

### Q17: Can you throw exceptions from @ExceptionHandler?
**Answer:** Yes, but they'll be caught by other handlers or default resolver.

### Q18: What is HttpServletRequest parameter?
**Answer:** Provides access to servlet request details (URI, method, headers).

### Q19: How to handle async exceptions?
**Answer:**
```java
@ExceptionHandler(AsyncRequestTimeoutException.class)
public ResponseEntity<?> handleAsyncTimeout(AsyncRequestTimeoutException ex) { }
```

### Q20: Best practice for exception handling?
**Answer:**
1. Use specific exceptions
2. Don't expose stack traces
3. Consistent error format
4. Log appropriately
5. Use @ControllerAdvice for global handling
6. Include request context

---

## üìö Summary

### Basic Handler

```java
@RestController
public class UserController {
    
    @ExceptionHandler(UserNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ErrorResponse handleUserNotFound(UserNotFoundException ex) {
        return ErrorResponse.builder()
            .status(HttpStatus.NOT_FOUND.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

### Error Response Structure

```java
@Data
@Builder
public class ErrorResponse {
    private int status;
    private String message;
    private String path;
    private LocalDateTime timestamp;
}
```

### Key Points

- **@ExceptionHandler:** Handle exceptions in controller
- **@ResponseStatus:** Set HTTP status code
- **ResponseEntity:** More control over response
- **Multiple Exceptions:** Use array in @ExceptionHandler
- **Request Context:** Use WebRequest or HttpServletRequest
- **Logging:** Log errors appropriately
- **Global Handling:** Use @ControllerAdvice (covered in next topic)

**Next:** ControllerAdvice ‚Üí

