# üì¶ Error Response Structure - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Basic Error Response](#basic-error-response)
- [Validation Error Response](#validation-error-response)
- [Rich Error Response](#rich-error-response)
- [API Error Standards](#api-error-standards)
- [Error Response Builder](#error-response-builder)
- [Real-World Examples](#real-world-examples)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Error Response Structure** defines a standardized format for API error responses to ensure consistency and clarity.

### Why Standardized Error Responses?

```
Inconsistent Errors:
‚ùå Different formats per endpoint
‚ùå Hard to parse on client
‚ùå Poor developer experience
‚ùå Difficult to debug

Standardized Errors:
‚úÖ Consistent format
‚úÖ Easy to parse
‚úÖ Clear error information
‚úÖ Better debugging
‚úÖ Professional API
‚úÖ Client-friendly
```

### Common Error Fields

```json
{
  "errorCode": "USER_NOT_FOUND",
  "status": 404,
  "message": "User not found with id: 123",
  "path": "/api/users/123",
  "timestamp": "2024-01-15T10:30:45"
}
```

---

## üîß Basic Error Response

### Simple Error Response

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ErrorResponse {
    private int status;
    private String message;
    private LocalDateTime timestamp;
}
```

### Usage

```java
@ExceptionHandler(UserNotFoundException.class)
@ResponseStatus(HttpStatus.NOT_FOUND)
public ErrorResponse handleUserNotFound(UserNotFoundException ex) {
    return ErrorResponse.builder()
        .status(HttpStatus.NOT_FOUND.value())
        .message(ex.getMessage())
        .timestamp(LocalDateTime.now())
        .build();
}
```

### Response Example

```json
{
  "status": 404,
  "message": "User not found with id: 123",
  "timestamp": "2024-01-15T10:30:45"
}
```

---

## üìù Enhanced Error Response

### With Error Code and Path

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private String path;
    private LocalDateTime timestamp;
}
```

### Usage

```java
@ExceptionHandler(ResourceNotFoundException.class)
public ResponseEntity<ErrorResponse> handleResourceNotFound(
        ResourceNotFoundException ex,
        HttpServletRequest request) {
    
    ErrorResponse error = ErrorResponse.builder()
        .errorCode(ex.getErrorCode())
        .status(HttpStatus.NOT_FOUND.value())
        .message(ex.getMessage())
        .path(request.getRequestURI())
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
}
```

### Response Example

```json
{
  "errorCode": "USER_NOT_FOUND",
  "status": 404,
  "message": "User not found with id: 123",
  "path": "/api/users/123",
  "timestamp": "2024-01-15T10:30:45.123"
}
```

---

## ‚úÖ Validation Error Response

### Validation Error DTO

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ValidationErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private Map<String, String> errors;
    private String path;
    private LocalDateTime timestamp;
}
```

### Usage

```java
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<ValidationErrorResponse> handleValidationErrors(
        MethodArgumentNotValidException ex,
        HttpServletRequest request) {
    
    Map<String, String> errors = new HashMap<>();
    ex.getBindingResult().getFieldErrors().forEach(error -> 
        errors.put(error.getField(), error.getDefaultMessage())
    );
    
    ValidationErrorResponse errorResponse = ValidationErrorResponse.builder()
        .errorCode("VALIDATION_ERROR")
        .status(HttpStatus.BAD_REQUEST.value())
        .message("Validation failed")
        .errors(errors)
        .path(request.getRequestURI())
        .timestamp(LocalDateTime.now())
        .build();
    
    return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(errorResponse);
}
```

### Response Example

```json
{
  "errorCode": "VALIDATION_ERROR",
  "status": 400,
  "message": "Validation failed",
  "errors": {
    "email": "Email must be valid",
    "age": "Age must be at least 18",
    "username": "Username is required"
  },
  "path": "/api/users",
  "timestamp": "2024-01-15T10:30:45.123"
}
```

---

## üéØ Rich Error Response

### Comprehensive Error Response

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class RichErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private String path;
    private String method;
    private LocalDateTime timestamp;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private Map<String, Object> metadata;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private List<String> details;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String debugMessage;
}
```

### Usage

```java
@ExceptionHandler(OrderProcessingException.class)
public ResponseEntity<RichErrorResponse> handleOrderProcessing(
        OrderProcessingException ex,
        HttpServletRequest request) {
    
    Map<String, Object> metadata = new HashMap<>();
    metadata.put("orderId", ex.getOrderId());
    metadata.put("orderStatus", ex.getOrderStatus());
    metadata.put("failureReason", ex.getFailureReason());
    
    RichErrorResponse error = RichErrorResponse.builder()
        .errorCode("ORDER_PROCESSING_FAILED")
        .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
        .message(ex.getMessage())
        .path(request.getRequestURI())
        .method(request.getMethod())
        .timestamp(LocalDateTime.now())
        .metadata(metadata)
        .build();
    
    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
}
```

### Response Example

```json
{
  "errorCode": "ORDER_PROCESSING_FAILED",
  "status": 500,
  "message": "Failed to process order 12345",
  "path": "/api/orders/12345/process",
  "method": "POST",
  "timestamp": "2024-01-15T10:30:45.123",
  "metadata": {
    "orderId": 12345,
    "orderStatus": "PENDING",
    "failureReason": "Payment gateway timeout"
  }
}
```

---

## üìê API Error Standards

### RFC 7807 - Problem Details

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ProblemDetail {
    
    private String type;        // URI reference identifying the problem type
    private String title;       // Short, human-readable summary
    private int status;         // HTTP status code
    private String detail;      // Human-readable explanation
    private String instance;    // URI reference identifying specific occurrence
    
    private Map<String, Object> extensions;
}
```

### Usage

```java
@ExceptionHandler(ResourceNotFoundException.class)
public ResponseEntity<ProblemDetail> handleResourceNotFound(
        ResourceNotFoundException ex,
        HttpServletRequest request) {
    
    ProblemDetail problem = ProblemDetail.builder()
        .type("https://api.example.com/errors/not-found")
        .title("Resource Not Found")
        .status(HttpStatus.NOT_FOUND.value())
        .detail(ex.getMessage())
        .instance(request.getRequestURI())
        .build();
    
    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(problem);
}
```

### Response Example (RFC 7807)

```json
{
  "type": "https://api.example.com/errors/not-found",
  "title": "Resource Not Found",
  "status": 404,
  "detail": "User not found with id: 123",
  "instance": "/api/users/123"
}
```

---

## üèóÔ∏è Error Response Builder

### Fluent Builder Pattern

```java
public class ErrorResponseBuilder {
    
    private String errorCode;
    private int status;
    private String message;
    private String path;
    private LocalDateTime timestamp;
    private Map<String, Object> metadata;
    
    public static ErrorResponseBuilder builder() {
        return new ErrorResponseBuilder();
    }
    
    public ErrorResponseBuilder errorCode(String errorCode) {
        this.errorCode = errorCode;
        return this;
    }
    
    public ErrorResponseBuilder status(HttpStatus status) {
        this.status = status.value();
        return this;
    }
    
    public ErrorResponseBuilder message(String message) {
        this.message = message;
        return this;
    }
    
    public ErrorResponseBuilder path(String path) {
        this.path = path;
        return this;
    }
    
    public ErrorResponseBuilder addMetadata(String key, Object value) {
        if (this.metadata == null) {
            this.metadata = new HashMap<>();
        }
        this.metadata.put(key, value);
        return this;
    }
    
    public ErrorResponse build() {
        this.timestamp = LocalDateTime.now();
        
        return ErrorResponse.builder()
            .errorCode(errorCode)
            .status(status)
            .message(message)
            .path(path)
            .timestamp(timestamp)
            .metadata(metadata)
            .build();
    }
}
```

### Usage

```java
ErrorResponse error = ErrorResponseBuilder.builder()
    .errorCode("INSUFFICIENT_STOCK")
    .status(HttpStatus.CONFLICT)
    .message("Insufficient stock for product")
    .path(request.getRequestURI())
    .addMetadata("productId", productId)
    .addMetadata("requested", requestedQty)
    .addMetadata("available", availableQty)
    .build();
```

---

## üåç Real-World Examples

### E-commerce Error Responses

```java
// Product Not Found
{
  "errorCode": "PRODUCT_NOT_FOUND",
  "status": 404,
  "message": "Product not found with SKU: ABC123",
  "path": "/api/products/ABC123",
  "timestamp": "2024-01-15T10:30:45"
}

// Insufficient Stock
{
  "errorCode": "INSUFFICIENT_STOCK",
  "status": 409,
  "message": "Insufficient stock for product",
  "path": "/api/orders",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "productId": 123,
    "productName": "iPhone 15",
    "requestedQuantity": 5,
    "availableQuantity": 2
  }
}

// Order Validation Failed
{
  "errorCode": "VALIDATION_ERROR",
  "status": 400,
  "message": "Order validation failed",
  "errors": {
    "shippingAddress": "Shipping address is required",
    "items": "Order must contain at least one item",
    "paymentMethod": "Invalid payment method"
  },
  "path": "/api/orders",
  "timestamp": "2024-01-15T10:30:45"
}
```

### Banking Error Responses

```java
// Insufficient Balance
{
  "errorCode": "INSUFFICIENT_BALANCE",
  "status": 409,
  "message": "Insufficient balance for transaction",
  "path": "/api/transactions",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "accountNumber": "****1234",
    "currentBalance": 1000.00,
    "requestedAmount": 1500.00,
    "currency": "USD"
  }
}

// Daily Limit Exceeded
{
  "errorCode": "DAILY_LIMIT_EXCEEDED",
  "status": 409,
  "message": "Daily transaction limit exceeded",
  "path": "/api/transactions",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "dailyLimit": 5000.00,
    "usedToday": 4800.00,
    "requestedAmount": 500.00,
    "remainingLimit": 200.00
  }
}

// Account Locked
{
  "errorCode": "ACCOUNT_LOCKED",
  "status": 403,
  "message": "Account is locked due to suspicious activity",
  "path": "/api/accounts/12345/transactions",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "accountNumber": "****1234",
    "lockReason": "Multiple failed login attempts",
    "lockedSince": "2024-01-15T09:00:00",
    "contactSupport": "+1-800-123-4567"
  }
}
```

### Social Media Error Responses

```java
// Duplicate Post
{
  "errorCode": "DUPLICATE_POST",
  "status": 409,
  "message": "This post has already been published",
  "path": "/api/posts",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "existingPostId": 789,
    "publishedAt": "2024-01-15T10:00:00"
  }
}

// Content Moderation Failed
{
  "errorCode": "CONTENT_MODERATION_FAILED",
  "status": 400,
  "message": "Post contains inappropriate content",
  "path": "/api/posts",
  "timestamp": "2024-01-15T10:30:45",
  "metadata": {
    "violations": ["offensive language", "spam"],
    "suggestedActions": ["Remove offensive words", "Reduce links"]
  }
}
```

---

## üìå Best Practices

### 1. Consistent Structure

```java
// ‚úÖ Good - Same structure across all errors
@Data
@Builder
public class ErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private String path;
    private LocalDateTime timestamp;
}

// All endpoints return this format
```

### 2. Use Error Codes

```java
// ‚úÖ Good - Unique error codes
{
  "errorCode": "USER_NOT_FOUND",
  "status": 404,
  "message": "User not found with id: 123"
}

// ‚ùå Bad - No error code
{
  "status": 404,
  "message": "Not found"
}
```

### 3. Include Request Path

```java
// ‚úÖ Good - Include path for debugging
ErrorResponse.builder()
    .path(request.getRequestURI())
    .build();

// Response
{
  "path": "/api/users/123",
  "message": "User not found"
}
```

### 4. Timestamp in ISO Format

```java
// ‚úÖ Good - ISO 8601 format
@JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss.SSS")
private LocalDateTime timestamp;

// Response
{
  "timestamp": "2024-01-15T10:30:45.123"
}
```

### 5. Optional Fields with @JsonInclude

```java
// ‚úÖ Good - Hide null fields
@Data
@Builder
public class ErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private Map<String, Object> metadata;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String debugMessage;
}

// Production: debugMessage is null, not included
// Development: debugMessage included
```

### 6. Validation Errors as Map

```java
// ‚úÖ Good - Field errors as map
{
  "errorCode": "VALIDATION_ERROR",
  "errors": {
    "email": "Email must be valid",
    "age": "Must be at least 18"
  }
}

// ‚ùå Bad - Field errors as string
{
  "errorCode": "VALIDATION_ERROR",
  "message": "email: invalid, age: too young"
}
```

### 7. HTTP Status in Response Body

```java
// ‚úÖ Good - Include status in body
{
  "status": 404,
  "message": "User not found"
}

// Clients can check both HTTP status and body status
```

### 8. Environment-Specific Details

```java
@Value("${spring.profiles.active:prod}")
private String activeProfile;

private ErrorResponse createError(Exception ex) {
    ErrorResponse.ErrorResponseBuilder builder = ErrorResponse.builder()
        .status(500)
        .message("An error occurred");
    
    if ("dev".equals(activeProfile)) {
        builder.debugMessage(ex.getMessage());
        builder.stackTrace(Arrays.toString(ex.getStackTrace()));
    }
    
    return builder.build();
}
```

---

## üé§ Interview Questions

### Q1: What is an error response structure?
**Answer:** Standardized format for API error responses containing status, message, error code, path, timestamp.

### Q2: What fields should an error response include?
**Answer:** errorCode, status, message, path, timestamp (minimum). Can include metadata, details, etc.

### Q3: Why use error codes?
**Answer:** Unique identifiers for categorizing errors, easier for clients to handle specific errors programmatically.

### Q4: How to handle validation errors?
**Answer:** Return map of field names to error messages:
```json
{
  "errors": {
    "email": "Invalid email",
    "age": "Must be 18+"
  }
}
```

### Q5: Should you include stack traces in responses?
**Answer:** No in production, only in development. Log them server-side.

### Q6: What is RFC 7807?
**Answer:** Standard for problem details in HTTP APIs (type, title, status, detail, instance).

### Q7: How to include additional context?
**Answer:** Use metadata field:
```java
.metadata(Map.of("productId", 123, "available", 5))
```

### Q8: Should HTTP status be in response body?
**Answer:** Yes, for redundancy and client convenience.

### Q9: What timestamp format to use?
**Answer:** ISO 8601 (yyyy-MM-dd'T'HH:mm:ss.SSS).

### Q10: How to hide null fields?
**Answer:**
```java
@JsonInclude(JsonInclude.Include.NON_NULL)
private String debugMessage;
```

### Q11: Difference between message and detail?
**Answer:**
- message: Short summary (e.g., "User not found")
- detail: Detailed explanation (e.g., "User with id 123 does not exist")

### Q12: Should error responses be consistent?
**Answer:** Yes, use same structure across all endpoints for better client experience.

### Q13: How to create error response builder?
**Answer:** Use fluent builder pattern with method chaining.

### Q14: Should you expose internal error details?
**Answer:** No, use generic messages in production, log details server-side.

### Q15: How to include request information?
**Answer:** Add path, method, headers (non-sensitive) to error response.

### Q16: What is errorCode naming convention?
**Answer:** UPPER_SNAKE_CASE (e.g., USER_NOT_FOUND, VALIDATION_ERROR).

### Q17: Can error response include links?
**Answer:** Yes, RFC 7807 supports links for documentation or related resources.

### Q18: How to test error responses?
**Answer:** Use MockMvc to verify response structure, status, message, error code.

### Q19: Should all errors have same structure?
**Answer:** Base structure yes, but can extend (e.g., ValidationErrorResponse extends ErrorResponse).

### Q20: Best practices for error response structure?
**Answer:**
1. Consistent format
2. Include error codes
3. Add request path
4. Use ISO timestamp
5. Hide null fields
6. Validation errors as map
7. Environment-specific details
8. Don't expose sensitive info

---

## üìö Summary

### Standard Error Response

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private String path;
    
    @JsonFormat(pattern = "yyyy-MM-dd'T'HH:mm:ss.SSS")
    private LocalDateTime timestamp;
    
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private Map<String, Object> metadata;
}
```

### Validation Error Response

```java
@Data
@Builder
public class ValidationErrorResponse {
    private String errorCode;
    private int status;
    private String message;
    private Map<String, String> errors;
    private String path;
    private LocalDateTime timestamp;
}
```

### Example Response

```json
{
  "errorCode": "USER_NOT_FOUND",
  "status": 404,
  "message": "User not found with id: 123",
  "path": "/api/users/123",
  "timestamp": "2024-01-15T10:30:45.123"
}
```

### Key Points

- **Consistent Structure:** Same format across all errors
- **Error Codes:** Unique identifiers (USER_NOT_FOUND)
- **Status:** HTTP status code in body
- **Path:** Request URI for debugging
- **Timestamp:** ISO 8601 format
- **Metadata:** Additional context when needed
- **@JsonInclude:** Hide null fields

**Next:** Validation Exceptions ‚Üí

