# üë§ User Details Service - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [UserDetailsService Interface](#userdetailsservice-interface)
- [Custom Implementation](#custom-implementation)
- [UserDetails Implementation](#userdetails-implementation)
- [Loading from Database](#loading-from-database)
- [Caching User Details](#caching-user-details)
- [Custom UserDetails](#custom-userdetails)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**UserDetailsService** is the core interface for loading user-specific data during authentication.

### Purpose

```
Authentication Flow:
1. User submits username/password
2. AuthenticationManager calls UserDetailsService
3. loadUserByUsername(username) ‚Üí UserDetails
4. PasswordEncoder compares passwords
5. If match ‚Üí Authentication successful
6. SecurityContext stores Authentication
```

---

## üîç UserDetailsService Interface

### Interface Definition

```java
public interface UserDetailsService {
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}
```

### UserDetails Interface

```java
public interface UserDetails extends Serializable {
    Collection<? extends GrantedAuthority> getAuthorities();
    String getPassword();
    String getUsername();
    boolean isAccountNonExpired();
    boolean isAccountNonLocked();
    boolean isCredentialsNonExpired();
    boolean isEnabled();
}
```

### Built-in Implementation

```java
// In-memory users
@Bean
public UserDetailsService userDetailsService() {
    UserDetails user = User.builder()
        .username("user")
        .password(passwordEncoder().encode("password"))
        .roles("USER")
        .build();
    
    UserDetails admin = User.builder()
        .username("admin")
        .password(passwordEncoder().encode("admin"))
        .roles("ADMIN")
        .build();
    
    return new InMemoryUserDetailsManager(user, admin);
}
```

---

## üõ†Ô∏è Custom Implementation

### Basic Implementation

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));
        
        return org.springframework.security.core.userdetails.User.builder()
            .username(user.getUsername())
            .password(user.getPassword())
            .authorities(getAuthorities(user))
            .accountExpired(false)
            .accountLocked(!user.isActive())
            .credentialsExpired(false)
            .disabled(!user.isEnabled())
            .build();
    }
    
    private Collection<? extends GrantedAuthority> getAuthorities(User user) {
        return user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
            .collect(Collectors.toList());
    }
}
```

### With Email Login

```java
@Service
public class EmailUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        User user = userRepository.findByEmail(email)
            .orElseThrow(() -> new UsernameNotFoundException("User not found with email: " + email));
        
        return new CustomUserDetails(user);
    }
}
```

### Multiple Authentication Providers

```java
@Service
public class CompositeUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String identifier) throws UsernameNotFoundException {
        // Try username
        Optional<User> user = userRepository.findByUsername(identifier);
        
        // Try email
        if (user.isEmpty()) {
            user = userRepository.findByEmail(identifier);
        }
        
        // Try phone
        if (user.isEmpty()) {
            user = userRepository.findByPhoneNumber(identifier);
        }
        
        return user.map(CustomUserDetails::new)
            .orElseThrow(() -> new UsernameNotFoundException("User not found: " + identifier));
    }
}
```

---

## üë• UserDetails Implementation

### Custom UserDetails Class

```java
public class CustomUserDetails implements UserDetails {
    
    private final User user;
    
    public CustomUserDetails(User user) {
        this.user = user;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        Set<GrantedAuthority> authorities = new HashSet<>();
        
        // Add roles
        user.getRoles().forEach(role -> {
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getName()));
            
            // Add permissions
            role.getPermissions().forEach(permission -> 
                authorities.add(new SimpleGrantedAuthority(permission.getName()))
            );
        });
        
        return authorities;
    }
    
    @Override
    public String getPassword() {
        return user.getPassword();
    }
    
    @Override
    public String getUsername() {
        return user.getEmail(); // Using email as username
    }
    
    @Override
    public boolean isAccountNonExpired() {
        if (user.getAccountExpiryDate() == null) {
            return true;
        }
        return user.getAccountExpiryDate().isAfter(LocalDateTime.now());
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return !user.isLocked();
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        if (user.getPasswordExpiryDate() == null) {
            return true;
        }
        return user.getPasswordExpiryDate().isAfter(LocalDateTime.now());
    }
    
    @Override
    public boolean isEnabled() {
        return user.isEnabled();
    }
    
    // Additional custom methods
    public Long getId() {
        return user.getId();
    }
    
    public String getFullName() {
        return user.getFirstName() + " " + user.getLastName();
    }
    
    public User getUser() {
        return user;
    }
}
```

### Using Custom UserDetails

```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(@AuthenticationPrincipal CustomUserDetails userDetails) {
        User user = userDetails.getUser();
        return ResponseEntity.ok(new ProfileResponse(
            user.getId(),
            user.getEmail(),
            userDetails.getFullName()
        ));
    }
    
    @GetMapping("/current-user")
    public ResponseEntity<?> getCurrentUser() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        
        if (auth.getPrincipal() instanceof CustomUserDetails) {
            CustomUserDetails userDetails = (CustomUserDetails) auth.getPrincipal();
            return ResponseEntity.ok(userDetails.getUser());
        }
        
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }
}
```

---

## üíæ Loading from Database

### Entity Classes

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String username;
    
    @Column(unique = true, nullable = false)
    private String email;
    
    @Column(nullable = false)
    private String password;
    
    private String firstName;
    private String lastName;
    
    private boolean enabled = true;
    private boolean locked = false;
    
    private LocalDateTime accountExpiryDate;
    private LocalDateTime passwordExpiryDate;
    
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
    
    // Getters and setters
}

@Entity
@Table(name = "roles")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String name; // ADMIN, USER, MANAGER
    
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "role_permissions",
        joinColumns = @JoinColumn(name = "role_id"),
        inverseJoinColumns = @JoinColumn(name = "permission_id")
    )
    private Set<Permission> permissions = new HashSet<>();
    
    // Getters and setters
}

@Entity
@Table(name = "permissions")
public class Permission {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String name; // READ_USER, WRITE_USER, DELETE_USER
    
    // Getters and setters
}
```

### Repository

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
    Optional<User> findByEmail(String email);
    Optional<User> findByPhoneNumber(String phoneNumber);
    boolean existsByUsername(String username);
    boolean existsByEmail(String email);
}
```

### Service Implementation

```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private RoleRepository roleRepository;
    
    public User createUser(UserRegistrationRequest request) {
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new RuntimeException("Username already exists");
        }
        
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new RuntimeException("Email already exists");
        }
        
        User user = new User();
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setFirstName(request.getFirstName());
        user.setLastName(request.getLastName());
        user.setEnabled(true);
        
        // Assign default role
        Role userRole = roleRepository.findByName("USER")
            .orElseThrow(() -> new RuntimeException("Role not found"));
        user.getRoles().add(userRole);
        
        return userRepository.save(user);
    }
    
    public void lockUser(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new RuntimeException("User not found"));
        user.setLocked(true);
        userRepository.save(user);
    }
    
    public void unlockUser(Long userId) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new RuntimeException("User not found"));
        user.setLocked(false);
        userRepository.save(user);
    }
}
```

---

## üí® Caching User Details

### Enable Caching

```java
@Service
@CacheConfig(cacheNames = "users")
public class CachedUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    @Cacheable(key = "#username")
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));
        
        return new CustomUserDetails(user);
    }
    
    @CacheEvict(key = "#username")
    public void evictUserCache(String username) {
        // Cache will be cleared
    }
    
    @CacheEvict(allEntries = true)
    public void evictAllUsersCache() {
        // All cached users cleared
    }
}
```

### Cache Configuration

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager("users");
        return cacheManager;
    }
}
```

### With Redis Cache

```java
@Configuration
@EnableCaching
public class RedisCacheConfig {
    
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .disableCachingNullValues();
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .build();
    }
}
```

---

## üé® Custom UserDetails

### With Additional Fields

```java
public class EnhancedUserDetails extends User {
    
    private final com.example.model.User customUser;
    
    public EnhancedUserDetails(com.example.model.User user) {
        super(
            user.getUsername(),
            user.getPassword(),
            getAuthorities(user)
        );
        this.customUser = user;
    }
    
    private static Collection<? extends GrantedAuthority> getAuthorities(com.example.model.User user) {
        return user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
            .collect(Collectors.toList());
    }
    
    public Long getId() {
        return customUser.getId();
    }
    
    public String getEmail() {
        return customUser.getEmail();
    }
    
    public String getDepartment() {
        return customUser.getDepartment();
    }
    
    public com.example.model.User getCustomUser() {
        return customUser;
    }
}
```

### With OAuth2 Support

```java
public class OAuth2UserDetails implements UserDetails, OAuth2User {
    
    private final User user;
    private Map<String, Object> attributes;
    
    public OAuth2UserDetails(User user, Map<String, Object> attributes) {
        this.user = user;
        this.attributes = attributes;
    }
    
    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
            .collect(Collectors.toList());
    }
    
    @Override
    public String getName() {
        return user.getEmail();
    }
    
    @Override
    public String getUsername() {
        return user.getUsername();
    }
    
    @Override
    public String getPassword() {
        return user.getPassword();
    }
    
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return !user.isLocked();
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }
    
    @Override
    public boolean isEnabled() {
        return user.isEnabled();
    }
}
```

---

## üìå Best Practices

### 1. Use @Transactional for Database Queries

```java
// ‚úÖ Good
@Override
@Transactional(readOnly = true)
public UserDetails loadUserByUsername(String username) {
    return userRepository.findByUsername(username)
        .map(CustomUserDetails::new)
        .orElseThrow(() -> new UsernameNotFoundException("User not found"));
}
```

### 2. Throw UsernameNotFoundException

```java
// ‚úÖ Good - Proper exception
.orElseThrow(() -> new UsernameNotFoundException("User not found: " + username));

// ‚ùå Bad - Generic exception
.orElseThrow(() -> new RuntimeException("User not found"));
```

### 3. Cache User Details

```java
// ‚úÖ Good - Cached
@Cacheable(key = "#username")
public UserDetails loadUserByUsername(String username) { }

// Clear cache on user update
@CacheEvict(key = "#username")
public void updateUser(String username, User user) { }
```

### 4. Use FetchType.EAGER for Roles

```java
// ‚úÖ Good - Eager fetch roles
@ManyToMany(fetch = FetchType.EAGER)
private Set<Role> roles;
```

### 5. Separate User Entity from UserDetails

```java
// ‚úÖ Good - Wrapper class
public class CustomUserDetails implements UserDetails {
    private final User user; // Domain entity
}

// ‚ùå Bad - Entity implements UserDetails
@Entity
public class User implements UserDetails { }
```

### 6. Handle Account Status

```java
// ‚úÖ Good - Check all status flags
@Override
public boolean isAccountNonLocked() {
    return !user.isLocked() && user.getFailedLoginAttempts() < 5;
}
```

### 7. Log Authentication Attempts

```java
@Override
public UserDetails loadUserByUsername(String username) {
    log.info("Loading user: {}", username);
    try {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("User not found"));
        log.info("User found: {}", username);
        return new CustomUserDetails(user);
    } catch (UsernameNotFoundException e) {
        log.warn("User not found: {}", username);
        throw e;
    }
}
```

---

## üé§ Interview Questions

### Q1: What is UserDetailsService?
**Answer:** Core interface for loading user-specific data, returns UserDetails containing username, password, authorities.

### Q2: What does loadUserByUsername return?
**Answer:** UserDetails object containing username, password, authorities, and account status flags.

### Q3: What is UserDetails interface?
**Answer:** Represents authenticated user with username, password, authorities, and status (enabled, locked, expired).

### Q4: When is UserDetailsService called?
**Answer:** During authentication when AuthenticationManager needs to verify credentials.

### Q5: What exception to throw if user not found?
**Answer:** UsernameNotFoundException

### Q6: Can you cache UserDetails?
**Answer:** Yes, using @Cacheable annotation for performance optimization.

### Q7: Difference between User entity and UserDetails?
**Answer:** User is domain entity (database), UserDetails is security interface (authentication).

### Q8: How to load user by email instead of username?
**Answer:** loadUserByUsername receives email parameter, query by email in repository.

### Q9: What is GrantedAuthority?
**Answer:** Interface representing permission/role granted to user (e.g., ROLE_ADMIN).

### Q10: How to add custom fields to UserDetails?
**Answer:** Create custom class implementing UserDetails, add additional fields and methods.

### Q11: What is InMemoryUserDetailsManager?
**Answer:** Built-in implementation storing users in memory, useful for testing.

### Q12: How to handle roles and permissions?
**Answer:** Load from database in getAuthorities(), convert to SimpleGrantedAuthority.

### Q13: What is @AuthenticationPrincipal?
**Answer:** Annotation to inject current UserDetails into controller method.

### Q14: Should User entity implement UserDetails?
**Answer:** No, better to create wrapper class (separation of concerns).

### Q15: How to lock/unlock user account?
**Answer:** Set locked flag in User entity, check in isAccountNonLocked().

### Q16: What is FetchType.EAGER for roles?
**Answer:** Loads roles immediately with user (needed for authorities during authentication).

### Q17: How to expire user credentials?
**Answer:** Set expiry date, check in isCredentialsNonExpired().

### Q18: Can UserDetailsService access database?
**Answer:** Yes, typically injected with repository to load users.

### Q19: What is SimpleGrantedAuthority?
**Answer:** Basic implementation of GrantedAuthority, wraps string authority name.

### Q20: Best practice for UserDetailsService?
**Answer:**
1. Use @Transactional(readOnly = true)
2. Throw UsernameNotFoundException
3. Cache results
4. Eager fetch roles
5. Separate entity from UserDetails

---

## üìö Summary

### Basic Implementation

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    @Transactional(readOnly = true)
    public UserDetails loadUserByUsername(String username) {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("User not found"));
        
        return new CustomUserDetails(user);
    }
}

public class CustomUserDetails implements UserDetails {
    private final User user;
    
    public CustomUserDetails(User user) {
        this.user = user;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority("ROLE_" + role.getName()))
            .collect(Collectors.toList());
    }
    
    @Override
    public String getPassword() {
        return user.getPassword();
    }
    
    @Override
    public String getUsername() {
        return user.getUsername();
    }
    
    // ... other UserDetails methods
}
```

### Key Points

- **UserDetailsService:** Loads user from database
- **UserDetails:** Represents authenticated user
- **GrantedAuthority:** User's roles/permissions
- **UsernameNotFoundException:** Thrown when user not found
- **@Cacheable:** Cache user details for performance

**Next:** Password Encoding ‚Üí

