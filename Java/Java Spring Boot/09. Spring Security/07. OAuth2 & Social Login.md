# üîó OAuth2 & Social Login - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [OAuth2 Flow](#oauth2-flow)
- [Dependencies](#dependencies)
- [Google Login](#google-login)
- [GitHub Login](#github-login)
- [Facebook Login](#facebook-login)
- [Custom OAuth2 User Service](#custom-oauth2-user-service)
- [Multiple Providers](#multiple-providers)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**OAuth2** is an authorization framework enabling third-party applications to obtain limited access to user accounts.

### Why OAuth2?

```
Benefits:
‚úÖ No password management
‚úÖ Trusted providers (Google, GitHub)
‚úÖ Better UX (one-click login)
‚úÖ Secure (no password sharing)
‚úÖ Single Sign-On (SSO)
```

### OAuth2 vs OpenID Connect

| Feature | OAuth2 | OpenID Connect |
|---------|--------|----------------|
| Purpose | Authorization | Authentication + Authorization |
| User Info | No | Yes (ID Token) |
| Use Case | API access | User login |
| Token | Access Token | ID Token + Access Token |

---

## üîÑ OAuth2 Flow

### Authorization Code Flow

```
1. User clicks "Login with Google"
   ‚Üì
2. Redirect to Google login
   https://accounts.google.com/o/oauth2/auth?
   client_id=YOUR_CLIENT_ID&
   redirect_uri=http://localhost:8080/login/oauth2/code/google&
   response_type=code&
   scope=openid email profile
   ‚Üì
3. User authenticates with Google
   ‚Üì
4. Google redirects back with authorization code
   http://localhost:8080/login/oauth2/code/google?code=AUTH_CODE
   ‚Üì
5. Spring exchanges code for access token
   POST https://oauth2.googleapis.com/token
   ‚Üì
6. Spring fetches user info
   GET https://www.googleapis.com/oauth2/v3/userinfo
   ‚Üì
7. User logged in
```

### Simplified Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User ‚îÇ                               ‚îÇ   Google   ‚îÇ
‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ                                         ‚îÇ
   ‚îÇ 1. Login with Google                    ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 2. Login Page                           ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 3. Enter credentials                    ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 4. Authorization Code                   ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                         ‚îÇ
‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ  Spring   ‚îÇ 5. Exchange code for token     ‚îÇ
‚îÇ   Boot    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
   ‚îÇ 6. Access Token                         ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 7. Get user info                        ‚îÇ
   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                                         ‚îÇ
   ‚îÇ 8. User details                         ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
   ‚îÇ                                         ‚îÇ
```

---

## üìö Dependencies

### Maven

```xml
<dependencies>
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- OAuth2 Client -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-oauth2-client</artifactId>
    </dependency>
    
    <!-- Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- JPA (for storing users) -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
</dependencies>
```

---

## üîµ Google Login

### 1. Get Google Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create project
3. Enable Google+ API
4. Create OAuth 2.0 credentials
5. Set redirect URI: `http://localhost:8080/login/oauth2/code/google`

### 2. Configuration

```properties
# application.properties
spring.security.oauth2.client.registration.google.client-id=YOUR_CLIENT_ID
spring.security.oauth2.client.registration.google.client-secret=YOUR_CLIENT_SECRET
spring.security.oauth2.client.registration.google.scope=openid,profile,email
```

```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: YOUR_CLIENT_ID
            client-secret: YOUR_CLIENT_SECRET
            scope:
              - openid
              - profile
              - email
```

### 3. Security Configuration

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")
                .defaultSuccessUrl("/home", true)
                .failureUrl("/login?error=true")
            );
        
        return http.build();
    }
}
```

### 4. Login Page

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login</title>
</head>
<body>
    <h1>Login</h1>
    
    <a href="/oauth2/authorization/google">
        <button>Login with Google</button>
    </a>
    
    <div th:if="${param.error}">
        <p style="color: red;">Login failed!</p>
    </div>
</body>
</html>
```

### 5. Home Controller

```java
@Controller
public class HomeController {
    
    @GetMapping("/")
    public String index() {
        return "index";
    }
    
    @GetMapping("/login")
    public String login() {
        return "login";
    }
    
    @GetMapping("/home")
    public String home(Model model, @AuthenticationPrincipal OAuth2User principal) {
        if (principal != null) {
            model.addAttribute("name", principal.getAttribute("name"));
            model.addAttribute("email", principal.getAttribute("email"));
            model.addAttribute("picture", principal.getAttribute("picture"));
        }
        return "home";
    }
}
```

### 6. Extract User Info

```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/info")
    public Map<String, Object> getUserInfo(@AuthenticationPrincipal OAuth2User principal) {
        Map<String, Object> userInfo = new HashMap<>();
        userInfo.put("name", principal.getAttribute("name"));
        userInfo.put("email", principal.getAttribute("email"));
        userInfo.put("picture", principal.getAttribute("picture"));
        userInfo.put("sub", principal.getAttribute("sub")); // Google user ID
        return userInfo;
    }
}
```

---

## üü£ GitHub Login

### 1. Get GitHub Credentials

1. Go to GitHub Settings ‚Üí Developer settings ‚Üí OAuth Apps
2. Register new application
3. Set Authorization callback URL: `http://localhost:8080/login/oauth2/code/github`

### 2. Configuration

```properties
# application.properties
spring.security.oauth2.client.registration.github.client-id=YOUR_CLIENT_ID
spring.security.oauth2.client.registration.github.client-secret=YOUR_CLIENT_SECRET
spring.security.oauth2.client.registration.github.scope=read:user,user:email
```

```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: YOUR_CLIENT_ID
            client-secret: YOUR_CLIENT_SECRET
            scope:
              - read:user
              - user:email
```

### 3. Login Page

```html
<a href="/oauth2/authorization/github">
    <button>Login with GitHub</button>
</a>
```

### 4. Extract GitHub User Info

```java
@GetMapping("/github-info")
public Map<String, Object> getGitHubInfo(@AuthenticationPrincipal OAuth2User principal) {
    Map<String, Object> userInfo = new HashMap<>();
    userInfo.put("login", principal.getAttribute("login"));
    userInfo.put("name", principal.getAttribute("name"));
    userInfo.put("email", principal.getAttribute("email"));
    userInfo.put("avatar_url", principal.getAttribute("avatar_url"));
    userInfo.put("bio", principal.getAttribute("bio"));
    return userInfo;
}
```

---

## üî∑ Facebook Login

### 1. Get Facebook Credentials

1. Go to [Facebook Developers](https://developers.facebook.com/)
2. Create app
3. Add Facebook Login product
4. Set Valid OAuth Redirect URIs: `http://localhost:8080/login/oauth2/code/facebook`

### 2. Configuration

```properties
# application.properties
spring.security.oauth2.client.registration.facebook.client-id=YOUR_APP_ID
spring.security.oauth2.client.registration.facebook.client-secret=YOUR_APP_SECRET
spring.security.oauth2.client.registration.facebook.scope=public_profile,email
```

```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          facebook:
            client-id: YOUR_APP_ID
            client-secret: YOUR_APP_SECRET
            scope:
              - public_profile
              - email
```

### 3. Login Page

```html
<a href="/oauth2/authorization/facebook">
    <button>Login with Facebook</button>
</a>
```

### 4. Extract Facebook User Info

```java
@GetMapping("/facebook-info")
public Map<String, Object> getFacebookInfo(@AuthenticationPrincipal OAuth2User principal) {
    Map<String, Object> userInfo = new HashMap<>();
    userInfo.put("id", principal.getAttribute("id"));
    userInfo.put("name", principal.getAttribute("name"));
    userInfo.put("email", principal.getAttribute("email"));
    userInfo.put("picture", principal.getAttribute("picture"));
    return userInfo;
}
```

---

## üé® Custom OAuth2 User Service

### User Entity

```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String email;
    private String name;
    private String picture;
    
    @Enumerated(EnumType.STRING)
    private AuthProvider provider;
    
    private String providerId;
    
    private boolean enabled = true;
    
    @ElementCollection(fetch = FetchType.EAGER)
    @Enumerated(EnumType.STRING)
    private Set<Role> roles = new HashSet<>();
    
    // Getters and setters
}

public enum AuthProvider {
    LOCAL, GOOGLE, GITHUB, FACEBOOK
}

public enum Role {
    USER, ADMIN, MODERATOR
}
```

### Custom OAuth2UserService

```java
@Service
public class CustomOAuth2UserService extends DefaultOAuth2UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oauth2User = super.loadUser(userRequest);
        
        try {
            return processOAuth2User(userRequest, oauth2User);
        } catch (Exception ex) {
            throw new OAuth2AuthenticationException(ex.getMessage());
        }
    }
    
    private OAuth2User processOAuth2User(OAuth2UserRequest userRequest, OAuth2User oauth2User) {
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        OAuth2UserInfo oauth2UserInfo = OAuth2UserInfoFactory.getOAuth2UserInfo(registrationId, oauth2User.getAttributes());
        
        if (oauth2UserInfo.getEmail() == null || oauth2UserInfo.getEmail().isEmpty()) {
            throw new OAuth2AuthenticationException("Email not found from OAuth2 provider");
        }
        
        Optional<User> userOptional = userRepository.findByEmail(oauth2UserInfo.getEmail());
        User user;
        
        if (userOptional.isPresent()) {
            user = userOptional.get();
            
            // Update existing user
            if (!user.getProvider().equals(AuthProvider.valueOf(registrationId.toUpperCase()))) {
                throw new OAuth2AuthenticationException("Email already registered with " + user.getProvider());
            }
            
            user = updateExistingUser(user, oauth2UserInfo);
        } else {
            // Register new user
            user = registerNewUser(userRequest, oauth2UserInfo);
        }
        
        return new CustomOAuth2User(user, oauth2User.getAttributes());
    }
    
    private User registerNewUser(OAuth2UserRequest userRequest, OAuth2UserInfo oauth2UserInfo) {
        User user = new User();
        
        user.setProvider(AuthProvider.valueOf(
            userRequest.getClientRegistration().getRegistrationId().toUpperCase()
        ));
        user.setProviderId(oauth2UserInfo.getId());
        user.setName(oauth2UserInfo.getName());
        user.setEmail(oauth2UserInfo.getEmail());
        user.setPicture(oauth2UserInfo.getImageUrl());
        user.setEnabled(true);
        user.getRoles().add(Role.USER);
        
        return userRepository.save(user);
    }
    
    private User updateExistingUser(User existingUser, OAuth2UserInfo oauth2UserInfo) {
        existingUser.setName(oauth2UserInfo.getName());
        existingUser.setPicture(oauth2UserInfo.getImageUrl());
        return userRepository.save(existingUser);
    }
}
```

### OAuth2UserInfo Interface

```java
public interface OAuth2UserInfo {
    String getId();
    String getName();
    String getEmail();
    String getImageUrl();
}
```

### Google User Info

```java
public class GoogleOAuth2UserInfo implements OAuth2UserInfo {
    
    private Map<String, Object> attributes;
    
    public GoogleOAuth2UserInfo(Map<String, Object> attributes) {
        this.attributes = attributes;
    }
    
    @Override
    public String getId() {
        return (String) attributes.get("sub");
    }
    
    @Override
    public String getName() {
        return (String) attributes.get("name");
    }
    
    @Override
    public String getEmail() {
        return (String) attributes.get("email");
    }
    
    @Override
    public String getImageUrl() {
        return (String) attributes.get("picture");
    }
}
```

### GitHub User Info

```java
public class GithubOAuth2UserInfo implements OAuth2UserInfo {
    
    private Map<String, Object> attributes;
    
    public GithubOAuth2UserInfo(Map<String, Object> attributes) {
        this.attributes = attributes;
    }
    
    @Override
    public String getId() {
        return ((Integer) attributes.get("id")).toString();
    }
    
    @Override
    public String getName() {
        return (String) attributes.get("name");
    }
    
    @Override
    public String getEmail() {
        return (String) attributes.get("email");
    }
    
    @Override
    public String getImageUrl() {
        return (String) attributes.get("avatar_url");
    }
}
```

### Factory

```java
public class OAuth2UserInfoFactory {
    
    public static OAuth2UserInfo getOAuth2UserInfo(String registrationId, Map<String, Object> attributes) {
        if (registrationId.equalsIgnoreCase("google")) {
            return new GoogleOAuth2UserInfo(attributes);
        } else if (registrationId.equalsIgnoreCase("github")) {
            return new GithubOAuth2UserInfo(attributes);
        } else if (registrationId.equalsIgnoreCase("facebook")) {
            return new FacebookOAuth2UserInfo(attributes);
        } else {
            throw new OAuth2AuthenticationException("Login with " + registrationId + " is not supported");
        }
    }
}
```

### Custom OAuth2User

```java
public class CustomOAuth2User implements OAuth2User, UserDetails {
    
    private User user;
    private Map<String, Object> attributes;
    
    public CustomOAuth2User(User user, Map<String, Object> attributes) {
        this.user = user;
        this.attributes = attributes;
    }
    
    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority("ROLE_" + role.name()))
            .collect(Collectors.toList());
    }
    
    @Override
    public String getName() {
        return user.getEmail();
    }
    
    @Override
    public String getUsername() {
        return user.getEmail();
    }
    
    @Override
    public String getPassword() {
        return null; // OAuth2 users don't have password
    }
    
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return true;
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }
    
    @Override
    public boolean isEnabled() {
        return user.isEnabled();
    }
    
    public User getUser() {
        return user;
    }
}
```

---

## üîÄ Multiple Providers

### Complete Configuration

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope:
              - openid
              - profile
              - email
          
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
            scope:
              - read:user
              - user:email
          
          facebook:
            client-id: ${FACEBOOK_APP_ID}
            client-secret: ${FACEBOOK_APP_SECRET}
            scope:
              - public_profile
              - email
```

### Security Configuration

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private CustomOAuth2UserService customOAuth2UserService;
    
    @Autowired
    private OAuth2AuthenticationSuccessHandler successHandler;
    
    @Autowired
    private OAuth2AuthenticationFailureHandler failureHandler;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error", "/oauth2/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")
                .userInfoEndpoint(userInfo -> userInfo
                    .userService(customOAuth2UserService)
                )
                .successHandler(successHandler)
                .failureHandler(failureHandler)
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/")
                .permitAll()
            );
        
        return http.build();
    }
}
```

### Success Handler

```java
@Component
public class OAuth2AuthenticationSuccessHandler extends SimpleUrlAuthenticationSuccessHandler {
    
    @Override
    public void onAuthenticationSuccess(
            HttpServletRequest request,
            HttpServletResponse response,
            Authentication authentication
    ) throws IOException {
        
        if (authentication.getPrincipal() instanceof CustomOAuth2User) {
            CustomOAuth2User oauth2User = (CustomOAuth2User) authentication.getPrincipal();
            User user = oauth2User.getUser();
            
            log.info("User {} logged in via {}", user.getEmail(), user.getProvider());
        }
        
        setDefaultTargetUrl("/home");
        super.onAuthenticationSuccess(request, response, authentication);
    }
}
```

### Failure Handler

```java
@Component
public class OAuth2AuthenticationFailureHandler extends SimpleUrlAuthenticationFailureHandler {
    
    @Override
    public void onAuthenticationFailure(
            HttpServletRequest request,
            HttpServletResponse response,
            AuthenticationException exception
    ) throws IOException {
        
        log.error("OAuth2 authentication failed: {}", exception.getMessage());
        
        setDefaultFailureUrl("/login?error=true");
        super.onAuthenticationFailure(request, response, exception);
    }
}
```

### Login Page with All Providers

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login</title>
    <style>
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .social-login-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .google-btn {
            background-color: #4285F4;
            color: white;
        }
        
        .github-btn {
            background-color: #333;
            color: white;
        }
        
        .facebook-btn {
            background-color: #1877F2;
            color: white;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>Login</h2>
        
        <a href="/oauth2/authorization/google">
            <button class="social-login-btn google-btn">
                üîµ Continue with Google
            </button>
        </a>
        
        <a href="/oauth2/authorization/github">
            <button class="social-login-btn github-btn">
                ‚ö´ Continue with GitHub
            </button>
        </a>
        
        <a href="/oauth2/authorization/facebook">
            <button class="social-login-btn facebook-btn">
                üî∑ Continue with Facebook
            </button>
        </a>
        
        <div th:if="${param.error}" style="color: red; margin-top: 10px;">
            Login failed. Please try again.
        </div>
    </div>
</body>
</html>
```

---

## üìå Best Practices

### 1. Store Credentials Securely

```yaml
# ‚úÖ Good - Environment variables
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}

# ‚ùå Bad - Hardcoded
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: 123456789
            client-secret: secret123
```

### 2. Validate Email

```java
// ‚úÖ Good - Check email exists
if (oauth2UserInfo.getEmail() == null || oauth2UserInfo.getEmail().isEmpty()) {
    throw new OAuth2AuthenticationException("Email not found");
}
```

### 3. Handle Provider Conflicts

```java
// ‚úÖ Good - Check if email already registered with different provider
if (!user.getProvider().equals(currentProvider)) {
    throw new OAuth2AuthenticationException(
        "Email already registered with " + user.getProvider()
    );
}
```

### 4. Use HTTPS in Production

```properties
# ‚úÖ Good - Production redirect URI
https://yourdomain.com/login/oauth2/code/google
```

### 5. Limit Scopes

```yaml
# ‚úÖ Good - Only necessary scopes
scope:
  - openid
  - profile
  - email

# ‚ùå Bad - Too many permissions
scope:
  - openid
  - profile
  - email
  - https://www.googleapis.com/auth/drive
```

### 6. Implement Proper Error Handling

```java
// ‚úÖ Good - Custom error handling
@Component
public class OAuth2AuthenticationFailureHandler {
    // Handle errors gracefully
}
```

### 7. Log OAuth2 Events

```java
log.info("User {} logged in via {}", email, provider);
log.error("OAuth2 authentication failed: {}", exception.getMessage());
```

---

## üé§ Interview Questions

### Q1: What is OAuth2?
**Answer:** Authorization framework allowing third-party apps limited access to user accounts without sharing credentials.

### Q2: OAuth2 vs OpenID Connect?
**Answer:** OAuth2 is for authorization, OpenID Connect adds authentication layer on top.

### Q3: What is authorization code flow?
**Answer:** User logs in with provider ‚Üí gets code ‚Üí app exchanges code for token ‚Üí accesses resources.

### Q4: What is access token?
**Answer:** Token granting access to protected resources.

### Q5: What is redirect URI?
**Answer:** URL where provider redirects user after authentication.

### Q6: How to implement Google login?
**Answer:** Add oauth2-client dependency, configure client-id/secret, enable oauth2Login in SecurityConfig.

### Q7: What is OAuth2User?
**Answer:** Spring Security interface representing authenticated OAuth2 user with attributes.

### Q8: How to extract user info?
**Answer:**
```java
@AuthenticationPrincipal OAuth2User principal
String email = principal.getAttribute("email");
```

### Q9: What scopes to request?
**Answer:** openid, profile, email for basic user info.

### Q10: Can you combine OAuth2 and JWT?
**Answer:** Yes, use OAuth2 for login, generate JWT for subsequent requests.

### Q11: How to handle multiple providers?
**Answer:** Create custom OAuth2UserService, use factory pattern to handle different providers.

### Q12: What is OAuth2UserInfo?
**Answer:** Custom interface abstracting user info from different providers.

### Q13: How to store OAuth2 users?
**Answer:** Save to database with provider, providerId, email, name fields.

### Q14: What if email already exists?
**Answer:** Check provider, if different throw error, if same update user.

### Q15: Best way to store client secrets?
**Answer:** Environment variables, never hardcode or commit to git.

### Q16: What is state parameter?
**Answer:** CSRF protection token sent with OAuth2 request.

### Q17: How to customize success redirect?
**Answer:** Implement OAuth2AuthenticationSuccessHandler.

### Q18: Can users have no password?
**Answer:** Yes, OAuth2 users don't need password in database.

### Q19: How to logout OAuth2 users?
**Answer:** Clear session, optionally redirect to provider logout.

### Q20: Common OAuth2 errors?
**Answer:**
1. Invalid redirect URI
2. Client secret mismatch
3. Insufficient scopes
4. Email not provided
5. Provider configuration errors

---

## üìö Summary

### Quick Setup

```yaml
# 1. Configuration
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: YOUR_CLIENT_ID
            client-secret: YOUR_CLIENT_SECRET
            scope: openid,profile,email
```

```java
// 2. Security Config
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) {
    http.oauth2Login(Customizer.withDefaults());
    return http.build();
}
```

```html
<!-- 3. Login Button -->
<a href="/oauth2/authorization/google">Login with Google</a>
```

```java
// 4. Get User Info
@GetMapping("/user")
public String getUser(@AuthenticationPrincipal OAuth2User principal) {
    return principal.getAttribute("email");
}
```

### Key Points

- **OAuth2:** Authorization framework
- **Providers:** Google, GitHub, Facebook
- **Flow:** Redirect ‚Üí Login ‚Üí Code ‚Üí Token ‚Üí User Info
- **Custom Service:** Store users in database
- **Multiple Providers:** Use factory pattern

**Next:** Method Security ‚Üí

