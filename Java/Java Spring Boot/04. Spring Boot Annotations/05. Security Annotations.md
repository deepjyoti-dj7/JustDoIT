# ðŸ” Security Annotations - Complete Guide

## ðŸ“‹ Table of Contents
- [@EnableWebSecurity](#enablewebsecurity)
- [@Secured](#secured)
- [@PreAuthorize](#preauthorize)
- [@PostAuthorize](#postauthorize)
- [@PreFilter](#prefilter)
- [@PostFilter](#postfilter)
- [@RolesAllowed](#rolesallowed)
- [@WithMockUser](#withmockuser)
- [Method Security Configuration](#method-security-configuration)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## ðŸ›¡ï¸ @EnableWebSecurity

Enables Spring Security's web security support.

### Basic Configuration

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/")
                .permitAll()
            );
        
        return http.build();
    }
    
    @Bean
    public UserDetailsService userDetailsService() {
        UserDetails user = User.builder()
            .username("user")
            .password(passwordEncoder().encode("password"))
            .roles("USER")
            .build();
        
        UserDetails admin = User.builder()
            .username("admin")
            .password(passwordEncoder().encode("admin"))
            .roles("ADMIN", "USER")
            .build();
        
        return new InMemoryUserDetailsManager(user, admin);
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### Complete Security Configuration

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)
public class SecurityConfig {
    
    private final JwtAuthenticationFilter jwtAuthFilter;
    private final AuthenticationProvider authenticationProvider;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/user/**").hasAnyRole("USER", "ADMIN")
                .anyRequest().authenticated()
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .authenticationProvider(authenticationProvider)
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
```

---

## ðŸ”’ @Secured

Role-based method security (simple role checking).

### Basic Usage

```java
@Service
public class UserService {
    
    @Secured("ROLE_ADMIN")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    @Secured("ROLE_USER")
    public User updateProfile(UserDto dto) {
        return userRepository.save(dto.toEntity());
    }
}
```

### Multiple Roles

```java
@Service
public class ProductService {
    
    @Secured({"ROLE_ADMIN", "ROLE_MANAGER"})
    public Product createProduct(ProductDto dto) {
        return productRepository.save(dto.toEntity());
    }
    
    @Secured("ROLE_ADMIN")
    public void deleteProduct(Long id) {
        productRepository.deleteById(id);
    }
}
```

### Enable @Secured

```java
@Configuration
@EnableMethodSecurity(securedEnabled = true)
public class MethodSecurityConfig {
}
```

---

## ðŸŽ¯ @PreAuthorize

SpEL-based authorization **before** method execution.

### Basic Role Checking

```java
@Service
public class OrderService {
    
    @PreAuthorize("hasRole('ADMIN')")
    public void deleteOrder(Long id) {
        orderRepository.deleteById(id);
    }
    
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    public Order approveOrder(Long id) {
        Order order = orderRepository.findById(id).orElseThrow();
        order.setStatus(OrderStatus.APPROVED);
        return orderRepository.save(order);
    }
}
```

### Permission-Based Authorization

```java
@Service
public class DocumentService {
    
    @PreAuthorize("hasAuthority('WRITE_PRIVILEGE')")
    public Document createDocument(DocumentDto dto) {
        return documentRepository.save(dto.toEntity());
    }
    
    @PreAuthorize("hasAnyAuthority('READ_PRIVILEGE', 'ADMIN_PRIVILEGE')")
    public Document getDocument(Long id) {
        return documentRepository.findById(id).orElseThrow();
    }
}
```

### Owner-Based Authorization

```java
@Service
public class ProfileService {
    
    @PreAuthorize("#username == authentication.principal.username")
    public User updateProfile(String username, ProfileDto dto) {
        User user = userRepository.findByUsername(username).orElseThrow();
        user.setBio(dto.getBio());
        return userRepository.save(user);
    }
    
    @PreAuthorize("@securityService.isOwner(#userId)")
    public void updateUserSettings(Long userId, SettingsDto settings) {
        // Only owner can update
    }
}

@Service
public class SecurityService {
    public boolean isOwner(Long userId) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        UserDetails userDetails = (UserDetails) auth.getPrincipal();
        User user = userRepository.findByUsername(userDetails.getUsername()).orElseThrow();
        return user.getId().equals(userId);
    }
}
```

### Complex Expressions

```java
@Service
public class AccountService {
    
    @PreAuthorize("hasRole('ADMIN') or #account.owner == authentication.principal.username")
    public void closeAccount(Account account) {
        account.setStatus(AccountStatus.CLOSED);
        accountRepository.save(account);
    }
    
    @PreAuthorize("hasRole('ADMIN') and hasIpAddress('192.168.1.0/24')")
    public void adminOperation() {
        // Only admin from specific IP range
    }
    
    @PreAuthorize("@securityService.canAccess(#resourceId, authentication)")
    public Resource getResource(Long resourceId) {
        return resourceRepository.findById(resourceId).orElseThrow();
    }
}
```

---

## âœ… @PostAuthorize

Authorization **after** method execution (access to return value).

### Basic Usage

```java
@Service
public class OrderService {
    
    @PostAuthorize("returnObject.userId == authentication.principal.id")
    public Order getOrder(Long id) {
        return orderRepository.findById(id).orElseThrow();
        // Returns only if order belongs to current user
    }
    
    @PostAuthorize("hasRole('ADMIN') or returnObject.owner == authentication.principal.username")
    public Document getDocument(Long id) {
        return documentRepository.findById(id).orElseThrow();
    }
}
```

### Complex Post-Authorization

```java
@Service
public class ProjectService {
    
    @PostAuthorize("returnObject.isPublic or returnObject.members.contains(authentication.principal.username)")
    public Project getProject(Long id) {
        return projectRepository.findById(id).orElseThrow();
        // Access if public or user is member
    }
    
    @PostAuthorize("@securityService.canViewProject(returnObject, authentication)")
    public Project getProjectDetails(Long id) {
        return projectRepository.findWithDetails(id).orElseThrow();
    }
}

@Service
public class SecurityService {
    public boolean canViewProject(Project project, Authentication auth) {
        if (project.isPublic()) return true;
        
        UserDetails userDetails = (UserDetails) auth.getPrincipal();
        return project.getMembers().stream()
            .anyMatch(m -> m.getUsername().equals(userDetails.getUsername()));
    }
}
```

---

## ðŸ”½ @PreFilter

Filters collection **before** method execution.

### Basic Usage

```java
@Service
public class MessageService {
    
    @PreFilter("filterObject.sender == authentication.principal.username")
    public void deleteMessages(List<Message> messages) {
        // Only deletes messages where user is sender
        messageRepository.deleteAll(messages);
    }
    
    @PreFilter("hasRole('ADMIN') or filterObject.createdBy == authentication.principal.username")
    public void approveComments(List<Comment> comments) {
        comments.forEach(c -> c.setApproved(true));
        commentRepository.saveAll(comments);
    }
}
```

### Complex Filtering

```java
@Service
public class TaskService {
    
    @PreFilter("@securityService.canModifyTask(filterObject)")
    public void updateTasks(List<Task> tasks) {
        taskRepository.saveAll(tasks);
    }
}

@Service
public class SecurityService {
    public boolean canModifyTask(Task task) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        UserDetails userDetails = (UserDetails) auth.getPrincipal();
        
        return task.getAssignee().equals(userDetails.getUsername()) ||
               auth.getAuthorities().stream()
                   .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
    }
}
```

---

## ðŸ”¼ @PostFilter

Filters collection **after** method execution.

### Basic Usage

```java
@Service
public class DocumentService {
    
    @PostFilter("filterObject.owner == authentication.principal.username or hasRole('ADMIN')")
    public List<Document> getAllDocuments() {
        return documentRepository.findAll();
        // Returns only user's documents (unless admin)
    }
    
    @PostFilter("filterObject.isPublic or filterObject.sharedWith.contains(authentication.principal.username)")
    public List<File> getFiles() {
        return fileRepository.findAll();
        // Returns public files or files shared with user
    }
}
```

### Complex Filtering

```java
@Service
public class ProjectService {
    
    @PostFilter("@securityService.canViewProject(filterObject, authentication)")
    public List<Project> getProjects() {
        return projectRepository.findAll();
    }
}

@Service
public class SecurityService {
    public boolean canViewProject(Project project, Authentication auth) {
        if (project.isPublic()) return true;
        
        UserDetails userDetails = (UserDetails) auth.getPrincipal();
        User user = userRepository.findByUsername(userDetails.getUsername()).orElseThrow();
        
        return project.getMembers().contains(user) ||
               auth.getAuthorities().stream()
                   .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
    }
}
```

---

## ðŸŽ­ @RolesAllowed

JSR-250 annotation for role-based security.

### Basic Usage

```java
@Service
public class AdminService {
    
    @RolesAllowed("ROLE_ADMIN")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    @RolesAllowed({"ROLE_ADMIN", "ROLE_MANAGER"})
    public void approveRequest(Long requestId) {
        requestService.approve(requestId);
    }
}
```

### Enable @RolesAllowed

```java
@Configuration
@EnableMethodSecurity(jsr250Enabled = true)
public class MethodSecurityConfig {
}
```

---

## ðŸ§ª @WithMockUser

Mock user for testing.

### Basic Usage

```java
@SpringBootTest
@AutoConfigureMockMvc
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    @WithMockUser(username = "user", roles = "USER")
    void testUserAccess() throws Exception {
        mockMvc.perform(get("/api/user/profile"))
            .andExpect(status().isOk());
    }
    
    @Test
    @WithMockUser(username = "admin", roles = "ADMIN")
    void testAdminAccess() throws Exception {
        mockMvc.perform(delete("/api/users/1"))
            .andExpect(status().isNoContent());
    }
    
    @Test
    @WithMockUser(authorities = "WRITE_PRIVILEGE")
    void testWithAuthorities() throws Exception {
        mockMvc.perform(post("/api/documents"))
            .andExpect(status().isCreated());
    }
}
```

### Custom Mock User

```java
@Retention(RetentionPolicy.RUNTIME)
@WithMockUser(username = "admin", roles = {"ADMIN", "USER"})
public @interface WithMockAdmin {
}

@Retention(RetentionPolicy.RUNTIME)
@WithMockUser(username = "manager", roles = {"MANAGER", "USER"})
public @interface WithMockManager {
}

@SpringBootTest
class ServiceTest {
    
    @Test
    @WithMockAdmin
    void testAdminOperation() {
        // Test with admin user
    }
    
    @Test
    @WithMockManager
    void testManagerOperation() {
        // Test with manager user
    }
}
```

---

## âš™ï¸ Method Security Configuration

### Enable Method Security

```java
@Configuration
@EnableMethodSecurity(
    prePostEnabled = true,      // @PreAuthorize, @PostAuthorize
    securedEnabled = true,      // @Secured
    jsr250Enabled = true        // @RolesAllowed
)
public class MethodSecurityConfig {
}
```

### Custom Permission Evaluator

```java
@Configuration
@EnableMethodSecurity
public class MethodSecurityConfig {
    
    @Bean
    public DefaultMethodSecurityExpressionHandler methodSecurityExpressionHandler(
            PermissionEvaluator permissionEvaluator) {
        DefaultMethodSecurityExpressionHandler handler = new DefaultMethodSecurityExpressionHandler();
        handler.setPermissionEvaluator(permissionEvaluator);
        return handler;
    }
    
    @Bean
    public PermissionEvaluator permissionEvaluator() {
        return new CustomPermissionEvaluator();
    }
}

public class CustomPermissionEvaluator implements PermissionEvaluator {
    
    @Override
    public boolean hasPermission(Authentication auth, Object targetDomainObject, Object permission) {
        if (auth == null || targetDomainObject == null || !(permission instanceof String)) {
            return false;
        }
        
        String targetType = targetDomainObject.getClass().getSimpleName().toUpperCase();
        return hasPrivilege(auth, targetType, permission.toString());
    }
    
    @Override
    public boolean hasPermission(Authentication auth, Serializable targetId, String targetType, Object permission) {
        if (auth == null || targetType == null || !(permission instanceof String)) {
            return false;
        }
        return hasPrivilege(auth, targetType.toUpperCase(), permission.toString());
    }
    
    private boolean hasPrivilege(Authentication auth, String targetType, String permission) {
        return auth.getAuthorities().stream()
            .anyMatch(a -> a.getAuthority().equals(targetType + "_" + permission.toUpperCase()));
    }
}

// Usage
@Service
public class DocumentService {
    
    @PreAuthorize("hasPermission(#document, 'WRITE')")
    public void updateDocument(Document document) {
        documentRepository.save(document);
    }
    
    @PreAuthorize("hasPermission(#id, 'Document', 'DELETE')")
    public void deleteDocument(Long id) {
        documentRepository.deleteById(id);
    }
}
```

---

## ðŸ“Œ Best Practices

### 1. Use @PreAuthorize for Complex Logic

```java
// âœ… Flexible and powerful
@PreAuthorize("hasRole('ADMIN') or #userId == authentication.principal.id")
public void updateUser(Long userId, UserDto dto) { }

// âŒ Limited to roles only
@Secured("ROLE_ADMIN")
public void updateUser(Long userId, UserDto dto) { }
```

### 2. Externalize Security Logic

```java
// âœ… Reusable and testable
@PreAuthorize("@securityService.canAccess(#resourceId)")
public Resource getResource(Long resourceId) { }

// âŒ Complex inline logic
@PreAuthorize("hasRole('ADMIN') or (hasRole('USER') and @resourceRepository.findById(#resourceId).get().owner == authentication.principal.username)")
public Resource getResource(Long resourceId) { }
```

### 3. Use Method Security for Business Logic

```java
// âœ… Security at service layer
@Service
public class OrderService {
    @PreAuthorize("hasRole('ADMIN') or #order.userId == authentication.principal.id")
    public void cancelOrder(Order order) { }
}

// âŒ Security only at controller
@RestController
public class OrderController {
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public void cancelOrder(@PathVariable Long id) { }
}
```

### 4. Combine Annotations When Needed

```java
@Service
public class SecureService {
    
    // Role check + owner check
    @PreAuthorize("hasRole('USER')")
    @PostAuthorize("returnObject.owner == authentication.principal.username")
    public Order getOrder(Long id) {
        return orderRepository.findById(id).orElseThrow();
    }
}
```

### 5. Test Security Rules

```java
@SpringBootTest
class SecurityTest {
    
    @Test
    @WithMockUser(roles = "ADMIN")
    void adminCanDeleteUser() {
        assertDoesNotThrow(() -> userService.deleteUser(1L));
    }
    
    @Test
    @WithMockUser(roles = "USER")
    void userCannotDeleteUser() {
        assertThrows(AccessDeniedException.class, 
            () -> userService.deleteUser(1L));
    }
}
```

---

## ðŸŽ¤ Interview Questions

### Q1: Difference between @Secured and @PreAuthorize?
**Answer:**
- **@Secured**: Simple role-based, only checks roles
- **@PreAuthorize**: SpEL-based, supports complex expressions, permissions, ownership checks

### Q2: When to use @PreAuthorize vs @PostAuthorize?
**Answer:**
- **@PreAuthorize**: Check before method execution (input validation)
- **@PostAuthorize**: Check after method execution (access to return value)

### Q3: What is @PreFilter and @PostFilter?
**Answer:**
- **@PreFilter**: Filters collection parameters before method execution
- **@PostFilter**: Filters returned collection after method execution

### Q4: How to enable method security?
**Answer:**
```java
@EnableMethodSecurity(
    prePostEnabled = true,
    securedEnabled = true,
    jsr250Enabled = true
)
```

### Q5: What is @RolesAllowed?
**Answer:** JSR-250 annotation for role-based authorization. Similar to @Secured but standard Java annotation.

### Q6: How to check if user owns a resource?
**Answer:**
```java
@PreAuthorize("#userId == authentication.principal.id")
public void update(Long userId, Data data) { }
```

### Q7: What is PermissionEvaluator?
**Answer:** Custom component to evaluate permissions in @PreAuthorize using hasPermission() expression.

### Q8: How to test secured methods?
**Answer:** Use @WithMockUser annotation to mock authenticated user in tests.

### Q9: Can you combine multiple security annotations?
**Answer:** Yes, can combine @PreAuthorize, @PostAuthorize, @PreFilter, @PostFilter on same method.

### Q10: What happens when authorization fails?
**Answer:** Throws AccessDeniedException, which can be handled by @ControllerAdvice.

---

## ðŸ“š Summary

### Key Annotations
- **@EnableWebSecurity**: Enable Spring Security
- **@Secured**: Simple role-based security
- **@PreAuthorize**: Complex pre-method authorization
- **@PostAuthorize**: Post-method authorization (return value)
- **@PreFilter**: Filter input collections
- **@PostFilter**: Filter returned collections
- **@RolesAllowed**: JSR-250 role-based security
- **@WithMockUser**: Mock user for testing

### Security Comparison

| Annotation | Timing | Flexibility | Use Case |
|------------|--------|-------------|----------|
| **@Secured** | Before | Low | Simple role checks |
| **@RolesAllowed** | Before | Low | JSR-250 role checks |
| **@PreAuthorize** | Before | High | Complex authorization |
| **@PostAuthorize** | After | High | Return value checks |
| **@PreFilter** | Before | High | Filter inputs |
| **@PostFilter** | After | High | Filter outputs |

### Complete Example

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        return http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .build();
    }
}

@Service
public class OrderService {
    
    @PreAuthorize("hasRole('USER')")
    @PostAuthorize("returnObject.userId == authentication.principal.id")
    public Order getOrder(Long id) {
        return orderRepository.findById(id).orElseThrow();
    }
    
    @PreAuthorize("hasRole('ADMIN') or #order.userId == authentication.principal.id")
    public void cancelOrder(Order order) {
        orderRepository.delete(order);
    }
    
    @PostFilter("filterObject.isPublic or filterObject.userId == authentication.principal.id")
    public List<Order> getAllOrders() {
        return orderRepository.findAll();
    }
}

@SpringBootTest
class OrderServiceTest {
    @Test
    @WithMockUser(username = "user", roles = "USER")
    void userCanGetOwnOrder() {
        Order order = orderService.getOrder(1L);
        assertNotNull(order);
    }
}
```

**Next:** Transaction Annotations â†’

