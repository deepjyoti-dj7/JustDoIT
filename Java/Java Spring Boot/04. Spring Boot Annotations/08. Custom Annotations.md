# üé® Custom Annotations - Complete Guide

## üìã Table of Contents
- [Creating Custom Annotations](#creating-custom-annotations)
- [Meta-Annotations](#meta-annotations)
- [Composed Annotations](#composed-annotations)
- [Validation Annotations](#validation-annotations)
- [Security Annotations](#security-annotations)
- [AOP with Custom Annotations](#aop-with-custom-annotations)
- [Custom Conditional Annotations](#custom-conditional-annotations)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üî® Creating Custom Annotations

### Basic Custom Annotation

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LogExecutionTime {
}

// Usage
@Service
public class UserService {
    
    @LogExecutionTime
    public User createUser(UserDto dto) {
        return userRepository.save(dto.toEntity());
    }
}
```

### Annotation with Parameters

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimited {
    int limit() default 100;
    int period() default 60;  // seconds
    String key() default "";
}

// Usage
@RestController
public class ApiController {
    
    @GetMapping("/api/data")
    @RateLimited(limit = 10, period = 60)
    public Data getData() {
        return dataService.getData();
    }
}
```

### Multiple Targets

```java
@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
public @interface Audited {
    String value() default "";
    AuditLevel level() default AuditLevel.INFO;
}

enum AuditLevel {
    INFO, WARNING, ERROR
}

// Usage
@Service
@Audited(level = AuditLevel.INFO)
public class OrderService {
    
    @Audited("Order Creation")
    public Order createOrder(OrderDto dto) {
        return orderRepository.save(dto.toEntity());
    }
}
```

---

## üìå Meta-Annotations

Annotations that can be applied to other annotations.

### Common Meta-Annotations

```java
@Target(ElementType.METHOD)        // Where annotation can be used
@Retention(RetentionPolicy.RUNTIME) // Available at runtime
@Documented                         // Include in JavaDoc
@Inherited                         // Inherited by subclasses
public @interface CustomAnnotation {
}
```

### @Target Examples

```java
// Method only
@Target(ElementType.METHOD)
public @interface MethodOnly { }

// Class/Interface only
@Target(ElementType.TYPE)
public @interface TypeOnly { }

// Field only
@Target(ElementType.FIELD)
public @interface FieldOnly { }

// Parameter only
@Target(ElementType.PARAMETER)
public @interface ParamOnly { }

// Multiple targets
@Target({ElementType.METHOD, ElementType.TYPE})
public @interface MethodOrType { }
```

### @Retention Examples

```java
// Discarded during compile (default)
@Retention(RetentionPolicy.SOURCE)
public @interface SourceOnly { }

// Stored in .class but not available at runtime
@Retention(RetentionPolicy.CLASS)
public @interface ClassOnly { }

// Available at runtime via reflection
@Retention(RetentionPolicy.RUNTIME)
public @interface RuntimeAnnotation { }
```

---

## üé≠ Composed Annotations

Combine multiple annotations into one.

### REST Controller with Common Settings

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@RestController
@RequestMapping("/api")
@CrossOrigin(origins = "*")
@Validated
public @interface ApiController {
    String value() default "";
}

// Usage
@ApiController
public class UserApiController {
    // Automatically has @RestController, @RequestMapping, @CrossOrigin, @Validated
    
    @GetMapping("/users")
    public List<User> getUsers() {
        return userService.findAll();
    }
}
```

### Transactional Service

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Service
@Transactional
@Validated
public @interface TransactionalService {
    String value() default "";
}

// Usage
@TransactionalService
public class OrderService {
    // Automatically has @Service, @Transactional, @Validated
    
    public Order createOrder(OrderDto dto) {
        return orderRepository.save(dto.toEntity());
    }
}
```

### Cacheable REST Endpoint

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@GetMapping
@Cacheable
public @interface CachedGet {
    String path() default "";
    String cacheName() default "default";
}

// Usage
@RestController
public class ProductController {
    
    @CachedGet(path = "/products", cacheName = "products")
    public List<Product> getProducts() {
        return productService.findAll();
    }
}
```

---

## ‚úÖ Validation Annotations

Custom validation annotations.

### Email Validation

```java
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = EmailValidator.class)
public @interface ValidEmail {
    String message() default "Invalid email address";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

public class EmailValidator implements ConstraintValidator<ValidEmail, String> {
    
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@(.+)$");
    
    @Override
    public boolean isValid(String email, ConstraintValidatorContext context) {
        if (email == null) return true;  // Use @NotNull separately
        return EMAIL_PATTERN.matcher(email).matches();
    }
}

// Usage
public class UserDto {
    @ValidEmail
    private String email;
}
```

### Password Strength Validation

```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PasswordValidator.class)
public @interface ValidPassword {
    String message() default "Password must contain at least 8 characters, 1 uppercase, 1 lowercase, 1 digit";
    int minLength() default 8;
    boolean requireUppercase() default true;
    boolean requireLowercase() default true;
    boolean requireDigit() default true;
    boolean requireSpecial() default false;
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

public class PasswordValidator implements ConstraintValidator<ValidPassword, String> {
    
    private int minLength;
    private boolean requireUppercase;
    private boolean requireLowercase;
    private boolean requireDigit;
    private boolean requireSpecial;
    
    @Override
    public void initialize(ValidPassword annotation) {
        this.minLength = annotation.minLength();
        this.requireUppercase = annotation.requireUppercase();
        this.requireLowercase = annotation.requireLowercase();
        this.requireDigit = annotation.requireDigit();
        this.requireSpecial = annotation.requireSpecial();
    }
    
    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null) return true;
        
        if (password.length() < minLength) return false;
        if (requireUppercase && !password.matches(".*[A-Z].*")) return false;
        if (requireLowercase && !password.matches(".*[a-z].*")) return false;
        if (requireDigit && !password.matches(".*\\d.*")) return false;
        if (requireSpecial && !password.matches(".*[!@#$%^&*()].*")) return false;
        
        return true;
    }
}

// Usage
public class RegisterDto {
    @ValidPassword(minLength = 10, requireSpecial = true)
    private String password;
}
```

### Date Range Validation

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = DateRangeValidator.class)
public @interface ValidDateRange {
    String message() default "End date must be after start date";
    String start();
    String end();
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

public class DateRangeValidator implements ConstraintValidator<ValidDateRange, Object> {
    
    private String startField;
    private String endField;
    
    @Override
    public void initialize(ValidDateRange annotation) {
        this.startField = annotation.start();
        this.endField = annotation.end();
    }
    
    @Override
    public boolean isValid(Object obj, ConstraintValidatorContext context) {
        try {
            Field startDateField = obj.getClass().getDeclaredField(startField);
            Field endDateField = obj.getClass().getDeclaredField(endField);
            
            startDateField.setAccessible(true);
            endDateField.setAccessible(true);
            
            LocalDate startDate = (LocalDate) startDateField.get(obj);
            LocalDate endDate = (LocalDate) endDateField.get(obj);
            
            if (startDate == null || endDate == null) return true;
            
            return endDate.isAfter(startDate) || endDate.isEqual(startDate);
        } catch (Exception e) {
            return false;
        }
    }
}

// Usage
@ValidDateRange(start = "startDate", end = "endDate")
public class EventDto {
    private LocalDate startDate;
    private LocalDate endDate;
}
```

---

## üîê Security Annotations

Custom security annotations.

### Role-Based Access

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
public @interface AdminOrManager {
}

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@PreAuthorize("hasRole('ADMIN')")
public @interface AdminOnly {
}

// Usage
@Service
public class UserService {
    
    @AdminOnly
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    @AdminOrManager
    public void approveUser(Long id) {
        User user = userRepository.findById(id).orElseThrow();
        user.setApproved(true);
        userRepository.save(user);
    }
}
```

### IP-Based Access Control

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AllowedIPs {
    String[] value();
}

@Aspect
@Component
public class IPAccessControlAspect {
    
    @Around("@annotation(allowedIPs)")
    public Object checkIPAccess(ProceedingJoinPoint joinPoint, AllowedIPs allowedIPs) 
            throws Throwable {
        
        HttpServletRequest request = ((ServletRequestAttributes) 
            RequestContextHolder.currentRequestAttributes()).getRequest();
        
        String clientIP = request.getRemoteAddr();
        
        List<String> allowedIPList = Arrays.asList(allowedIPs.value());
        if (!allowedIPList.contains(clientIP)) {
            throw new AccessDeniedException("Access denied from IP: " + clientIP);
        }
        
        return joinPoint.proceed();
    }
}

// Usage
@RestController
public class AdminController {
    
    @GetMapping("/admin/config")
    @AllowedIPs({"192.168.1.1", "192.168.1.2"})
    public Config getConfig() {
        return configService.getConfig();
    }
}
```

---

## üéØ AOP with Custom Annotations

Use custom annotations with Aspect-Oriented Programming.

### Logging Annotation

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Loggable {
    LogLevel level() default LogLevel.INFO;
    boolean logParameters() default true;
    boolean logResult() default true;
}

enum LogLevel {
    INFO, DEBUG, WARN, ERROR
}

@Aspect
@Component
@Slf4j
public class LoggingAspect {
    
    @Around("@annotation(loggable)")
    public Object logExecutionTime(ProceedingJoinPoint joinPoint, Loggable loggable) 
            throws Throwable {
        
        String methodName = joinPoint.getSignature().getName();
        
        if (loggable.logParameters()) {
            log.info("Executing {}: {}", methodName, Arrays.toString(joinPoint.getArgs()));
        }
        
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed();
        long executionTime = System.currentTimeMillis() - start;
        
        log.info("{} executed in {} ms", methodName, executionTime);
        
        if (loggable.logResult()) {
            log.info("{} returned: {}", methodName, result);
        }
        
        return result;
    }
}

// Usage
@Service
public class OrderService {
    
    @Loggable(level = LogLevel.INFO, logParameters = true, logResult = false)
    public Order createOrder(OrderDto dto) {
        return orderRepository.save(dto.toEntity());
    }
}
```

### Performance Monitoring

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Monitor {
    String value() default "";
    long threshold() default 1000;  // milliseconds
}

@Aspect
@Component
@Slf4j
public class PerformanceMonitoringAspect {
    
    @Around("@annotation(monitor)")
    public Object monitorPerformance(ProceedingJoinPoint joinPoint, Monitor monitor) 
            throws Throwable {
        
        String operation = monitor.value().isEmpty() 
            ? joinPoint.getSignature().getName() 
            : monitor.value();
        
        long start = System.nanoTime();
        Object result = joinPoint.proceed();
        long duration = (System.nanoTime() - start) / 1_000_000;  // Convert to ms
        
        if (duration > monitor.threshold()) {
            log.warn("SLOW OPERATION: {} took {} ms (threshold: {} ms)", 
                operation, duration, monitor.threshold());
        } else {
            log.info("Operation {} completed in {} ms", operation, duration);
        }
        
        return result;
    }
}

// Usage
@Service
public class ReportService {
    
    @Monitor(value = "Generate Report", threshold = 5000)
    public Report generateReport() {
        return reportGenerator.generate();
    }
}
```

### Retry Annotation

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Retry {
    int maxAttempts() default 3;
    long delay() default 1000;  // milliseconds
    Class<? extends Exception>[] retryOn() default {Exception.class};
}

@Aspect
@Component
@Slf4j
public class RetryAspect {
    
    @Around("@annotation(retry)")
    public Object retryOperation(ProceedingJoinPoint joinPoint, Retry retry) 
            throws Throwable {
        
        int attempts = 0;
        Exception lastException = null;
        
        while (attempts < retry.maxAttempts()) {
            try {
                return joinPoint.proceed();
            } catch (Exception e) {
                lastException = e;
                attempts++;
                
                boolean shouldRetry = Arrays.stream(retry.retryOn())
                    .anyMatch(ex -> ex.isInstance(e));
                
                if (shouldRetry && attempts < retry.maxAttempts()) {
                    log.warn("Attempt {}/{} failed: {}. Retrying in {} ms...",
                        attempts, retry.maxAttempts(), e.getMessage(), retry.delay());
                    Thread.sleep(retry.delay());
                } else {
                    throw e;
                }
            }
        }
        
        throw lastException;
    }
}

// Usage
@Service
public class ExternalApiService {
    
    @Retry(maxAttempts = 3, delay = 2000, retryOn = {IOException.class, TimeoutException.class})
    public Data fetchData() throws IOException {
        return externalApi.getData();
    }
}
```

### Cache Invalidation

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface InvalidateCache {
    String[] cacheNames();
    String key() default "";
    boolean allEntries() default false;
}

@Aspect
@Component
public class CacheInvalidationAspect {
    
    @Autowired
    private CacheManager cacheManager;
    
    @AfterReturning("@annotation(invalidateCache)")
    public void invalidateCache(JoinPoint joinPoint, InvalidateCache invalidateCache) {
        
        for (String cacheName : invalidateCache.cacheNames()) {
            Cache cache = cacheManager.getCache(cacheName);
            if (cache != null) {
                if (invalidateCache.allEntries()) {
                    cache.clear();
                    log.info("Cleared entire cache: {}", cacheName);
                } else if (!invalidateCache.key().isEmpty()) {
                    cache.evict(invalidateCache.key());
                    log.info("Evicted key {} from cache: {}", invalidateCache.key(), cacheName);
                }
            }
        }
    }
}

// Usage
@Service
public class ProductService {
    
    @InvalidateCache(cacheNames = {"products", "productsList"}, allEntries = true)
    public Product updateProduct(Long id, ProductDto dto) {
        return productRepository.save(dto.toEntity());
    }
}
```

---

## üîÄ Custom Conditional Annotations

Custom annotations for conditional bean registration.

### Environment-Based Configuration

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Conditional(LocalEnvironmentCondition.class)
public @interface ConditionalOnLocal {
}

public class LocalEnvironmentCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        String profile = context.getEnvironment().getProperty("spring.profiles.active");
        return "local".equals(profile) || "dev".equals(profile);
    }
}

// Usage
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConditionalOnLocal
    public DataSource h2DataSource() {
        return new EmbeddedDatabaseBuilder().build();
    }
}
```

### Feature Toggle

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@ConditionalOnProperty(prefix = "feature", name = "name")
public @interface ConditionalOnFeature {
    String value();
}

// Usage
@Configuration
public class FeatureConfig {
    
    @Bean
    @ConditionalOnFeature("new-ui")
    public UIService newUIService() {
        return new NewUIService();
    }
}

// application.properties
// feature.new-ui.enabled=true
```

---

## üìå Best Practices

### 1. Clear Naming

```java
// ‚úÖ Clear purpose
@ValidEmail
@LogExecutionTime
@AdminOnly

// ‚ùå Unclear
@Check
@Process
@Do
```

### 2. Provide Defaults

```java
// ‚úÖ Sensible defaults
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimited {
    int limit() default 100;
    int period() default 60;
}

// ‚ùå Forces users to specify everything
public @interface RateLimited {
    int limit();
    int period();
}
```

### 3. Document Well

```java
/**
 * Marks a method for execution time logging.
 * 
 * <p>Example:
 * <pre>
 * {@code
 * @LogExecutionTime
 * public void processData() {
 *     // method body
 * }
 * }
 * </pre>
 * 
 * @see LoggingAspect
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LogExecutionTime {
}
```

### 4. Use Composition

```java
// ‚úÖ Compose existing annotations
@RestController
@RequestMapping("/api")
@Validated
public @interface ApiController {
}

// ‚ùå Reinvent the wheel
public @interface MyRestController {
    // Duplicate @RestController functionality
}
```

### 5. Proper Target and Retention

```java
// ‚úÖ Appropriate target
@Target(ElementType.METHOD)  // Only for methods
public @interface CacheResult {
}

// ‚ùå Too broad
@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})
public @interface CacheResult {
}
```

---

## üé§ Interview Questions

### Q1: How to create a custom annotation?
**Answer:** Use `@interface` keyword with meta-annotations (@Target, @Retention). Example:
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface MyAnnotation {
}
```

### Q2: What is @Target?
**Answer:** Specifies where annotation can be applied (METHOD, TYPE, FIELD, PARAMETER, CONSTRUCTOR, etc.).

### Q3: What is @Retention?
**Answer:** Specifies how long annotation is retained (SOURCE, CLASS, RUNTIME).

### Q4: Difference between SOURCE, CLASS, and RUNTIME retention?
**Answer:**
- **SOURCE**: Discarded by compiler
- **CLASS**: Stored in .class but not available at runtime
- **RUNTIME**: Available at runtime via reflection

### Q5: What are composed annotations?
**Answer:** Annotations that combine multiple annotations. Example: @RestController = @Controller + @ResponseBody.

### Q6: How to create custom validation annotation?
**Answer:** Use @Constraint annotation and implement ConstraintValidator interface.

### Q7: How to use custom annotations with AOP?
**Answer:** Create aspect with @Around/@Before/@After advice targeting @annotation(yourAnnotation).

### Q8: What is @Inherited?
**Answer:** Meta-annotation that makes annotation inheritable by subclasses.

### Q9: Can annotation have default values?
**Answer:** Yes, using `default` keyword: `String value() default "default";`

### Q10: How to access annotation values at runtime?
**Answer:** Use reflection:
```java
Method method = obj.getClass().getMethod("methodName");
MyAnnotation annotation = method.getAnnotation(MyAnnotation.class);
String value = annotation.value();
```

---

## üìö Summary

### Key Concepts
- **@interface**: Define annotation
- **@Target**: Where to apply
- **@Retention**: How long to keep
- **@Documented**: Include in JavaDoc
- **@Inherited**: Inherit by subclasses
- **Composition**: Combine annotations
- **AOP Integration**: Custom behavior

### Common Patterns

| Pattern | Use Case | Example |
|---------|----------|---------|
| **Composed** | Reduce boilerplate | @ApiController |
| **Validation** | Custom validation | @ValidEmail |
| **Security** | Access control | @AdminOnly |
| **Monitoring** | Logging, metrics | @LogExecutionTime |
| **Conditional** | Bean registration | @ConditionalOnFeature |

### Complete Example

```java
// Definition
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Audited {
    String operation();
    AuditLevel level() default AuditLevel.INFO;
}

// Aspect
@Aspect
@Component
@Slf4j
public class AuditAspect {
    
    @AfterReturning("@annotation(audited)")
    public void auditMethod(JoinPoint joinPoint, Audited audited) {
        log.info("Audit [{}]: {} by {}",
            audited.level(),
            audited.operation(),
            getCurrentUser());
    }
}

// Usage
@Service
public class OrderService {
    
    @Audited(operation = "Create Order", level = AuditLevel.INFO)
    public Order createOrder(OrderDto dto) {
        return orderRepository.save(dto.toEntity());
    }
}

// Composed annotation
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Service
@Transactional
@Validated
public @interface BusinessService {
    String value() default "";
}

// Validation annotation
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PhoneValidator.class)
public @interface ValidPhone {
    String message() default "Invalid phone number";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}
```

**Folder 04 Complete! ‚úÖ**

