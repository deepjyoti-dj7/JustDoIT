# üéØ Conditional Annotations - Complete Guide

## üìã Table of Contents
- [@Conditional](#conditional)
- [@ConditionalOnProperty](#conditionalonproperty)
- [@ConditionalOnClass](#conditionalonclass)
- [@ConditionalOnMissingClass](#conditionalonmissingclass)
- [@ConditionalOnBean](#conditionalonbean)
- [@ConditionalOnMissingBean](#conditionalonmissingbean)
- [@ConditionalOnExpression](#conditionalonexpression)
- [@ConditionalOnResource](#conditionalonresource)
- [@Profile](#profile)
- [Custom Conditions](#custom-conditions)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üé≤ @Conditional

Base annotation for conditional bean registration.

### Basic Usage

```java
@Configuration
public class AppConfig {
    
    @Bean
    @Conditional(WindowsCondition.class)
    public DataSource windowsDataSource() {
        return new WindowsDataSource();
    }
    
    @Bean
    @Conditional(LinuxCondition.class)
    public DataSource linuxDataSource() {
        return new LinuxDataSource();
    }
}

// Custom condition
public class WindowsCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return System.getProperty("os.name").toLowerCase().contains("windows");
    }
}

public class LinuxCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        return System.getProperty("os.name").toLowerCase().contains("linux");
    }
}
```

### Complex Condition

```java
public class DatabaseCondition implements Condition {
    
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        Environment env = context.getEnvironment();
        
        // Check property
        String dbType = env.getProperty("database.type");
        if (dbType == null) return false;
        
        // Check class presence
        ClassLoader classLoader = context.getClassLoader();
        try {
            if ("mysql".equals(dbType)) {
                classLoader.loadClass("com.mysql.cj.jdbc.Driver");
                return true;
            }
        } catch (ClassNotFoundException e) {
            return false;
        }
        
        return false;
    }
}

@Configuration
public class DatabaseConfig {
    
    @Bean
    @Conditional(DatabaseCondition.class)
    public DataSource dataSource() {
        return new HikariDataSource();
    }
}
```

---

## ‚öôÔ∏è @ConditionalOnProperty

Registers bean based on **property value**.

### Basic Usage

```java
@Configuration
public class CacheConfig {
    
    // Creates bean if cache.enabled=true
    @Bean
    @ConditionalOnProperty(name = "cache.enabled", havingValue = "true")
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager("users", "products");
    }
}

// application.properties
// cache.enabled=true
```

### Default Value

```java
@Configuration
public class FeatureConfig {
    
    // Creates bean if property is missing OR true
    @Bean
    @ConditionalOnProperty(
        name = "feature.new-ui.enabled",
        havingValue = "true",
        matchIfMissing = true  // Default to true
    )
    public UIService newUIService() {
        return new NewUIService();
    }
    
    // Creates bean only if explicitly set to false
    @Bean
    @ConditionalOnProperty(
        name = "feature.new-ui.enabled",
        havingValue = "false"
    )
    public UIService oldUIService() {
        return new OldUIService();
    }
}
```

### Multiple Properties

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    @ConditionalOnProperty(prefix = "security", name = {"enabled", "oauth2.enabled"})
    public SecurityFilterChain securityFilterChain() {
        // Created if both properties exist
        return new SecurityFilterChain();
    }
}

// application.yml
// security:
//   enabled: true
//   oauth2:
//     enabled: true
```

### Complex Example

```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConditionalOnProperty(
        prefix = "datasource",
        name = "type",
        havingValue = "mysql"
    )
    public DataSource mysqlDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
        return dataSource;
    }
    
    @Bean
    @ConditionalOnProperty(
        prefix = "datasource",
        name = "type",
        havingValue = "postgresql"
    )
    public DataSource postgresDataSource() {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setDriverClassName("org.postgresql.Driver");
        return dataSource;
    }
    
    @Bean
    @ConditionalOnProperty(
        prefix = "datasource",
        name = "type",
        havingValue = "h2",
        matchIfMissing = true  // Default to H2
    )
    public DataSource h2DataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
}

// application.properties
// datasource.type=mysql
```

---

## üì¶ @ConditionalOnClass

Registers bean if **class is present** on classpath.

### Basic Usage

```java
@Configuration
public class AutoConfig {
    
    // Creates bean if Jackson is on classpath
    @Bean
    @ConditionalOnClass(name = "com.fasterxml.jackson.databind.ObjectMapper")
    public ObjectMapper objectMapper() {
        return new ObjectMapper();
    }
    
    // Creates bean if Redis is on classpath
    @Bean
    @ConditionalOnClass(RedisConnectionFactory.class)
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        return template;
    }
}
```

### Multiple Classes

```java
@Configuration
public class MessagingConfig {
    
    // Creates bean if both Kafka and Jackson present
    @Bean
    @ConditionalOnClass({KafkaTemplate.class, ObjectMapper.class})
    public KafkaProducer kafkaProducer() {
        return new KafkaProducer();
    }
}
```

### Auto-Configuration Example

```java
@Configuration
@ConditionalOnClass(DataSource.class)
public class DataSourceAutoConfiguration {
    
    @Bean
    @ConditionalOnClass(HikariDataSource.class)
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource hikariDataSource() {
        return new HikariDataSource();
    }
    
    @Bean
    @ConditionalOnClass(name = "org.apache.tomcat.jdbc.pool.DataSource")
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource tomcatDataSource() {
        return new org.apache.tomcat.jdbc.pool.DataSource();
    }
}
```

---

## üö´ @ConditionalOnMissingClass

Registers bean if **class is NOT present** on classpath.

### Basic Usage

```java
@Configuration
public class FallbackConfig {
    
    // Creates bean if Jackson is NOT present
    @Bean
    @ConditionalOnMissingClass("com.fasterxml.jackson.databind.ObjectMapper")
    public JsonSerializer simpleJsonSerializer() {
        return new SimpleJsonSerializer();
    }
    
    // Creates bean if Redis is NOT present
    @Bean
    @ConditionalOnMissingClass("org.springframework.data.redis.core.RedisTemplate")
    public CacheManager inMemoryCacheManager() {
        return new ConcurrentMapCacheManager();
    }
}
```

---

## üîµ @ConditionalOnBean

Registers bean if **specified bean exists**.

### Basic Usage

```java
@Configuration
public class ServiceConfig {
    
    @Bean
    public DataSource dataSource() {
        return new HikariDataSource();
    }
    
    // Creates bean only if DataSource bean exists
    @Bean
    @ConditionalOnBean(DataSource.class)
    public JdbcTemplate jdbcTemplate(DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }
}
```

### Named Bean

```java
@Configuration
public class Config {
    
    @Bean(name = "primaryDataSource")
    public DataSource primaryDataSource() {
        return new HikariDataSource();
    }
    
    @Bean
    @ConditionalOnBean(name = "primaryDataSource")
    public TransactionManager transactionManager() {
        return new JpaTransactionManager();
    }
}
```

### Multiple Beans

```java
@Configuration
public class AdvancedConfig {
    
    // Creates bean if both DataSource and EntityManagerFactory exist
    @Bean
    @ConditionalOnBean({DataSource.class, EntityManagerFactory.class})
    public TransactionManager transactionManager() {
        return new JpaTransactionManager();
    }
}
```

---

## ‚ö™ @ConditionalOnMissingBean

Registers bean if **specified bean does NOT exist**.

### Basic Usage

```java
@Configuration
public class DefaultConfig {
    
    // Creates bean only if no DataSource bean exists
    @Bean
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource defaultDataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
}
```

### Provide Default Implementation

```java
@Configuration
public class ServiceConfig {
    
    // User can provide custom EmailService
    // If not, use default
    @Bean
    @ConditionalOnMissingBean(EmailService.class)
    public EmailService defaultEmailService() {
        return new SimpleEmailService();
    }
    
    @Bean
    @ConditionalOnMissingBean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### Auto-Configuration Pattern

```java
@Configuration
@ConditionalOnClass(ObjectMapper.class)
public class JacksonAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        mapper.registerModule(new JavaTimeModule());
        return mapper;
    }
}

// User can override by providing their own
@Configuration
public class CustomConfig {
    @Bean
    public ObjectMapper objectMapper() {
        // Custom configuration takes precedence
        return new ObjectMapper();
    }
}
```

---

## üßÆ @ConditionalOnExpression

Registers bean based on **SpEL expression**.

### Basic Usage

```java
@Configuration
public class ConditionalConfig {
    
    // Creates bean if expression evaluates to true
    @Bean
    @ConditionalOnExpression("${feature.enabled:false}")
    public FeatureService featureService() {
        return new FeatureService();
    }
}
```

### Complex Expressions

```java
@Configuration
public class AdvancedConfig {
    
    // Multiple conditions
    @Bean
    @ConditionalOnExpression("${cache.enabled:false} and ${cache.type} == 'redis'")
    public RedisCacheManager redisCacheManager() {
        return new RedisCacheManager();
    }
    
    // Numeric comparison
    @Bean
    @ConditionalOnExpression("${server.max-threads:100} > 50")
    public ThreadPoolExecutor largeThreadPool() {
        return new ThreadPoolExecutor(50, 100, 60, TimeUnit.SECONDS, 
            new LinkedBlockingQueue<>());
    }
    
    // String operations
    @Bean
    @ConditionalOnExpression("'${spring.profiles.active}'.contains('prod')")
    public ProductionConfig productionConfig() {
        return new ProductionConfig();
    }
}
```

### Environment-Based Conditions

```java
@Configuration
public class EnvironmentConfig {
    
    @Bean
    @ConditionalOnExpression("#{environment['ENV'] == 'production'}")
    public DataSource productionDataSource() {
        return new HikariDataSource();
    }
    
    @Bean
    @ConditionalOnExpression("#{systemProperties['os.name'].toLowerCase().contains('windows')}")
    public WindowsService windowsService() {
        return new WindowsService();
    }
}
```

---

## üìÅ @ConditionalOnResource

Registers bean if **resource exists**.

### Basic Usage

```java
@Configuration
public class ResourceConfig {
    
    // Creates bean if file exists
    @Bean
    @ConditionalOnResource(resources = "classpath:custom-config.properties")
    public PropertySource customProperties() {
        return new PropertySource("custom");
    }
    
    // Multiple resources
    @Bean
    @ConditionalOnResource(resources = {
        "classpath:schema.sql",
        "classpath:data.sql"
    })
    public DatabaseInitializer databaseInitializer() {
        return new DatabaseInitializer();
    }
}
```

---

## üé≠ @Profile

Activates beans based on **active profile**.

### Basic Usage

```java
@Configuration
@Profile("dev")
public class DevConfig {
    
    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
}

@Configuration
@Profile("prod")
public class ProdConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariDataSource ds = new HikariDataSource();
        ds.setJdbcUrl("jdbc:mysql://prod-server:3306/db");
        return ds;
    }
}
```

### Multiple Profiles

```java
@Configuration
@Profile({"dev", "test"})
public class NonProdConfig {
    // Active in dev OR test
}

@Configuration
@Profile("prod & cloud")
public class ProdCloudConfig {
    // Active in prod AND cloud
}

@Configuration
@Profile("!prod")
public class NotProdConfig {
    // Active when prod is NOT active
}
```

### Bean-Level Profile

```java
@Configuration
public class DatabaseConfig {
    
    @Bean
    @Profile("dev")
    public DataSource devDataSource() {
        return h2DataSource();
    }
    
    @Bean
    @Profile("prod")
    public DataSource prodDataSource() {
        return mysqlDataSource();
    }
}
```

---

## üõ†Ô∏è Custom Conditions

Create reusable custom conditions.

### Custom Condition Class

```java
public class CacheEnabledCondition implements Condition {
    
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        Environment env = context.getEnvironment();
        
        // Check property
        String cacheEnabled = env.getProperty("cache.enabled");
        if (!"true".equalsIgnoreCase(cacheEnabled)) {
            return false;
        }
        
        // Check class presence
        try {
            context.getClassLoader().loadClass("org.springframework.cache.CacheManager");
            return true;
        } catch (ClassNotFoundException e) {
            return false;
        }
    }
}

@Configuration
public class CacheConfig {
    
    @Bean
    @Conditional(CacheEnabledCondition.class)
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager();
    }
}
```

### Parameterized Custom Condition

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Conditional(OnMinimumJavaVersionCondition.class)
public @interface ConditionalOnJavaVersion {
    int value();
}

public class OnMinimumJavaVersionCondition implements Condition {
    
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        Map<String, Object> attrs = metadata.getAnnotationAttributes(
            ConditionalOnJavaVersion.class.getName()
        );
        
        int requiredVersion = (int) attrs.get("value");
        String javaVersion = System.getProperty("java.version");
        int currentVersion = Integer.parseInt(javaVersion.split("\\.")[0]);
        
        return currentVersion >= requiredVersion;
    }
}

@Configuration
public class ModernConfig {
    
    @Bean
    @ConditionalOnJavaVersion(17)
    public RecordService recordService() {
        // Only on Java 17+
        return new RecordService();
    }
}
```

### Complex Custom Condition

```java
public class DatabaseAvailableCondition implements Condition {
    
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        Environment env = context.getEnvironment();
        
        String url = env.getProperty("spring.datasource.url");
        String username = env.getProperty("spring.datasource.username");
        String password = env.getProperty("spring.datasource.password");
        
        if (url == null) return false;
        
        try (Connection conn = DriverManager.getConnection(url, username, password)) {
            return conn.isValid(5);  // 5 second timeout
        } catch (SQLException e) {
            return false;
        }
    }
}

@Configuration
public class DataConfig {
    
    @Bean
    @Conditional(DatabaseAvailableCondition.class)
    public DataSource dataSource() {
        return new HikariDataSource();
    }
    
    @Bean
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource fallbackDataSource() {
        return new EmbeddedDatabaseBuilder().build();
    }
}
```

---

## üìå Best Practices

### 1. Use Specific Annotations

```java
// ‚úÖ Clear and concise
@ConditionalOnProperty(name = "cache.enabled", havingValue = "true")

// ‚ùå Overly complex
@ConditionalOnExpression("${cache.enabled:false} == true")
```

### 2. Provide Defaults with matchIfMissing

```java
// ‚úÖ Sensible default
@ConditionalOnProperty(
    name = "feature.enabled",
    havingValue = "true",
    matchIfMissing = true  // Enabled by default
)

// ‚ùå Forces users to always set property
@ConditionalOnProperty(name = "feature.enabled", havingValue = "true")
```

### 3. Combine Conditions Logically

```java
// ‚úÖ Clear hierarchy
@Configuration
@ConditionalOnClass(RedisConnectionFactory.class)
public class RedisConfig {
    
    @Bean
    @ConditionalOnProperty(name = "cache.type", havingValue = "redis")
    @ConditionalOnMissingBean
    public RedisCacheManager cacheManager() {
        return new RedisCacheManager();
    }
}
```

### 4. Order Matters

```java
// ‚úÖ Correct order (specific to general)
@Bean
@ConditionalOnClass(HikariDataSource.class)
@ConditionalOnMissingBean(DataSource.class)
public DataSource hikariDataSource() { }

@Bean
@ConditionalOnMissingBean(DataSource.class)
public DataSource defaultDataSource() { }

// ‚ùå Wrong order (default takes precedence)
@Bean
@ConditionalOnMissingBean(DataSource.class)
public DataSource defaultDataSource() { }  // Created first!

@Bean
@ConditionalOnClass(HikariDataSource.class)
@ConditionalOnMissingBean(DataSource.class)
public DataSource hikariDataSource() { }  // Never created
```

### 5. Document Custom Conditions

```java
/**
 * Condition that matches when database is accessible.
 * Checks connection validity with 5 second timeout.
 */
public class DatabaseAvailableCondition implements Condition {
    @Override
    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
        // Implementation
    }
}
```

---

## üé§ Interview Questions

### Q1: What is @Conditional?
**Answer:** Base annotation for conditional bean registration. Bean is created only if condition is met.

### Q2: What is @ConditionalOnProperty?
**Answer:** Creates bean based on property value. Can check property existence, value, or use matchIfMissing for default.

### Q3: Difference between @ConditionalOnClass and @ConditionalOnMissingClass?
**Answer:**
- **@ConditionalOnClass**: Create bean if class exists on classpath
- **@ConditionalOnMissingClass**: Create bean if class does NOT exist

### Q4: What is @ConditionalOnMissingBean used for?
**Answer:** Provides default bean implementation. User can override by defining their own bean.

### Q5: What is @Profile?
**Answer:** Activates beans based on active profile (dev, prod, test). Can use logical operators (AND, OR, NOT).

### Q6: Difference between @Profile and @ConditionalOnProperty?
**Answer:**
- **@Profile**: Based on active profile (environment)
- **@ConditionalOnProperty**: Based on specific property value

### Q7: What is @ConditionalOnExpression?
**Answer:** Creates bean based on SpEL expression evaluation. Most flexible but also most complex.

### Q8: How to create custom condition?
**Answer:** Implement Condition interface and override matches() method. Use with @Conditional annotation.

### Q9: What is matchIfMissing in @ConditionalOnProperty?
**Answer:** Determines behavior when property is missing. If true, bean is created even if property absent.

### Q10: Order of conditional annotations?
**Answer:** More specific conditions first (class, bean), then general (property, expression). Defaults last.

---

## üìö Summary

### Key Annotations
- **@Conditional**: Base conditional registration
- **@ConditionalOnProperty**: Property-based
- **@ConditionalOnClass**: Class presence
- **@ConditionalOnMissingClass**: Class absence
- **@ConditionalOnBean**: Bean presence
- **@ConditionalOnMissingBean**: Bean absence
- **@ConditionalOnExpression**: SpEL expression
- **@ConditionalOnResource**: Resource existence
- **@Profile**: Profile-based

### When to Use

| Annotation | Use Case |
|------------|----------|
| **@ConditionalOnProperty** | Feature toggles, configuration |
| **@ConditionalOnClass** | Optional dependencies |
| **@ConditionalOnMissingBean** | Default implementations |
| **@Profile** | Environment-specific config |
| **@ConditionalOnExpression** | Complex conditions |

### Complete Example

```java
@Configuration
@ConditionalOnClass(RedisConnectionFactory.class)
@ConditionalOnProperty(name = "cache.type", havingValue = "redis")
public class RedisCacheConfig {
    
    @Bean
    @ConditionalOnMissingBean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory();
    }
    
    @Bean
    @ConditionalOnBean(RedisConnectionFactory.class)
    @ConditionalOnMissingBean(CacheManager.class)
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        return RedisCacheManager.builder(factory).build();
    }
}

@Configuration
@Profile("dev")
public class DevConfig {
    @Bean
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource h2DataSource() {
        return new EmbeddedDatabaseBuilder().build();
    }
}

@Configuration
@Profile("prod")
public class ProdConfig {
    @Bean
    @ConditionalOnProperty(name = "datasource.type", havingValue = "mysql")
    public DataSource mysqlDataSource() {
        return new HikariDataSource();
    }
}
```

**Next:** Custom Annotations ‚Üí

