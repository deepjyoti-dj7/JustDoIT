# üåç Externalized Configuration - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Configuration Sources](#configuration-sources)
- [Property Source Order](#property-source-order)
- [Configuration Files](#configuration-files)
- [External Configuration Locations](#external-configuration-locations)
- [PropertySources](#propertysources)
- [Environment Abstraction](#environment-abstraction)
- [Relaxed Binding](#relaxed-binding)
- [Type Conversion](#type-conversion)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Externalized Configuration** allows you to work with the same application code in different environments without recompilation.

### Benefits

- ‚úÖ **Environment-specific**: Different configs for dev, test, prod
- ‚úÖ **No recompilation**: Change configuration without rebuilding
- ‚úÖ **Security**: Keep secrets out of code
- ‚úÖ **Flexibility**: Override properties from multiple sources
- ‚úÖ **12-Factor App**: Follows 12-factor methodology

---

## üìÇ Configuration Sources

Spring Boot can load configuration from multiple sources:

### 1. Default Properties

```java
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(Application.class);
        
        // Set default properties
        Properties defaults = new Properties();
        defaults.setProperty("server.port", "8080");
        defaults.setProperty("app.name", "MyApp");
        app.setDefaultProperties(defaults);
        
        app.run(args);
    }
}
```

### 2. @PropertySource Annotations

```java
@Configuration
@PropertySource("classpath:custom.properties")
@PropertySource("classpath:database.properties")
public class AppConfig {
    
    @Value("${custom.property}")
    private String customProperty;
}
```

### 3. Configuration Files

```
src/main/resources/
‚îú‚îÄ‚îÄ application.properties
‚îú‚îÄ‚îÄ application.yml
‚îú‚îÄ‚îÄ application-dev.properties
‚îú‚îÄ‚îÄ application-test.properties
‚îî‚îÄ‚îÄ application-prod.properties
```

### 4. Environment Variables

```bash
# Set environment variable
export SERVER_PORT=8081
export SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/db
export APP_NAME=MyApplication

# Run application
java -jar myapp.jar
```

### 5. Command-line Arguments

```bash
java -jar myapp.jar --server.port=9090 --spring.profiles.active=prod
```

### 6. System Properties

```bash
java -Dserver.port=8082 -Dspring.profiles.active=dev -jar myapp.jar
```

### 7. Random Values

```properties
# application.properties
app.secret=${random.value}
app.number=${random.int}
app.long=${random.long}
app.uuid=${random.uuid}
app.random-range=${random.int[1,100]}
```

---

## üìä Property Source Order

Spring Boot uses a specific order (higher priority overrides lower):

### Priority Order (Highest to Lowest)

1. **Command-line arguments** (`--server.port=9090`)
2. **Java System properties** (`-Dserver.port=8080`)
3. **OS environment variables** (`SERVER_PORT=8081`)
4. **RandomValuePropertySource** (`${random.*}`)
5. **Profile-specific config outside jar** (`application-{profile}.properties`)
6. **Profile-specific config inside jar**
7. **Application config outside jar** (`application.properties`)
8. **Application config inside jar**
9. **@PropertySource annotations**
10. **Default properties** (SpringApplication.setDefaultProperties)

### Example

```properties
# application.properties (inside jar)
server.port=8080
app.name=MyApp
```

```bash
# Environment variable (higher priority)
export SERVER_PORT=8081

# Command-line argument (highest priority)
java -jar app.jar --server.port=9090

# Result: server.port = 9090 (command-line wins)
```

### Complete Example

```yaml
# application.yml (Priority 8)
server:
  port: 8080
app:
  name: DefaultApp
```

```yaml
# application-prod.yml (Priority 6)
server:
  port: 80
```

```bash
# Environment variable (Priority 3)
export APP_NAME=ProductionApp

# System property (Priority 2)
-Dserver.port=8081

# Command-line argument (Priority 1)
--server.port=9090

# Final values:
# server.port = 9090 (command-line)
# app.name = ProductionApp (environment variable)
```

---

## üìÅ Configuration Files

### Standard Locations (Searched in Order)

1. `/config` subdirectory of current directory
2. Current directory
3. `classpath:/config` package
4. `classpath:` root

```
project/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ application.properties       # Priority 1 (highest)
‚îú‚îÄ‚îÄ application.properties            # Priority 2
‚îî‚îÄ‚îÄ src/main/resources/
    ‚îú‚îÄ‚îÄ config/
    ‚îÇ   ‚îî‚îÄ‚îÄ application.properties   # Priority 3
    ‚îî‚îÄ‚îÄ application.properties        # Priority 4 (lowest)
```

### Profile-Specific Files

```
application.properties              # Base configuration
application-dev.properties          # Dev profile
application-test.properties         # Test profile
application-prod.properties         # Production profile
```

### File Naming Patterns

```
application.properties
application.yml
application-{profile}.properties
application-{profile}.yml
```

### Loading Multiple Profiles

```bash
# Activate multiple profiles
java -jar app.jar --spring.profiles.active=dev,mysql,cache

# Loads:
# application.properties
# application-dev.properties
# application-mysql.properties
# application-cache.properties
```

---

## üåê External Configuration Locations

### Custom Config Location

```bash
# Specify config location
java -jar app.jar --spring.config.location=classpath:/custom/,file:./config/

# Specify config name
java -jar app.jar --spring.config.name=myapp

# Multiple locations
java -jar app.jar --spring.config.location=file:./config/,file:/etc/myapp/
```

### Additional Locations

```bash
# Add to default locations (not replace)
java -jar app.jar --spring.config.additional-location=file:/etc/config/
```

### Import Configuration

```yaml
# application.yml
spring:
  config:
    import:
      - classpath:database.yml
      - classpath:cache.yml
      - optional:file:./dev.yml  # Optional import
```

### Directory Import

```yaml
spring:
  config:
    import:
      - optional:file:./config/[.yml]  # Import all .yml files
```

---

## üîß PropertySources

### @PropertySource

```java
@Configuration
@PropertySource("classpath:app.properties")
public class AppConfig {
    
    @Value("${app.name}")
    private String appName;
}
```

### Multiple PropertySources

```java
@Configuration
@PropertySource("classpath:app.properties")
@PropertySource("classpath:database.properties")
public class AppConfig {
}

// Or using array
@Configuration
@PropertySources({
    @PropertySource("classpath:app.properties"),
    @PropertySource("classpath:database.properties")
})
public class AppConfig {
}
```

### Factory for Custom PropertySource

```java
@Configuration
@PropertySource(
    value = "classpath:encrypted.properties",
    factory = EncryptedPropertySourceFactory.class
)
public class SecureConfig {
}

public class EncryptedPropertySourceFactory implements PropertySourceFactory {
    
    @Override
    public PropertySource<?> createPropertySource(String name, EncodedResource resource) 
            throws IOException {
        
        Properties props = new Properties();
        props.load(resource.getInputStream());
        
        // Decrypt properties
        Properties decrypted = new Properties();
        props.forEach((key, value) -> {
            decrypted.put(key, decrypt(value.toString()));
        });
        
        return new PropertiesPropertySource(
            resource.getResource().getFilename(),
            decrypted
        );
    }
    
    private String decrypt(String encrypted) {
        // Decryption logic
        return encrypted;
    }
}
```

---

## üåç Environment Abstraction

### Using Environment

```java
@Component
public class AppComponent {
    
    @Autowired
    private Environment env;
    
    public void useEnvironment() {
        // Get property
        String port = env.getProperty("server.port");
        
        // Get with default
        String name = env.getProperty("app.name", "DefaultApp");
        
        // Get required property
        String required = env.getRequiredProperty("app.required");
        
        // Get with type conversion
        Integer maxUsers = env.getProperty("app.max-users", Integer.class);
        
        // Check if property exists
        boolean hasProperty = env.containsProperty("app.feature");
        
        // Get active profiles
        String[] profiles = env.getActiveProfiles();
        
        // Check profile
        boolean isDev = env.acceptsProfiles(Profiles.of("dev"));
    }
}
```

### Placeholder Resolution

```java
@Component
public class ConfigService {
    
    @Autowired
    private Environment env;
    
    public void resolvePlaceholders() {
        // Resolve ${...} placeholders
        String resolved = env.resolvePlaceholders("App name is ${app.name}");
        
        // Resolve required placeholders
        String requiredResolved = env.resolveRequiredPlaceholders("${app.required}");
    }
}
```

---

## üîÄ Relaxed Binding

Spring Boot uses relaxed binding to match property names to bean properties.

### Property Name Formats

```yaml
# All these map to the same property
app:
  max-users: 100        # Kebab case (recommended)
  maxUsers: 100         # Camel case
  max_users: 100        # Underscore
  MAX_USERS: 100        # Upper case
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private int maxUsers;  // Matches all formats above
}
```

### Environment Variable Binding

```bash
# Environment variables (uppercase with underscores)
export APP_MAX_USERS=100
export SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/db
export SERVER_PORT=8080
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private int maxUsers;  // Binds to APP_MAX_USERS
}
```

### Supported Formats by Source

| Source | Format | Example |
|--------|--------|---------|
| **Properties files** | Kebab, camel, underscore | `max-users`, `maxUsers`, `max_users` |
| **YAML files** | Kebab, camel | `max-users`, `maxUsers` |
| **Environment variables** | Upper case with underscore | `MAX_USERS` |
| **System properties** | Kebab, camel | `max-users`, `maxUsers` |

### List Binding

```yaml
# YAML
app:
  servers:
    - server1
    - server2
```

```properties
# Properties (indexed)
app.servers[0]=server1
app.servers[1]=server2

# Properties (comma-separated)
app.servers=server1,server2
```

```bash
# Environment variable
export APP_SERVERS=server1,server2
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private List<String> servers;  // All formats work
}
```

---

## üîÑ Type Conversion

Spring Boot automatically converts property values to target types.

### Primitive Types

```yaml
app:
  max-users: 100          # int
  enabled: true           # boolean
  rate: 4.5               # double
  name: MyApp             # String
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private int maxUsers;
    private boolean enabled;
    private double rate;
    private String name;
}
```

### Duration

```yaml
app:
  session-timeout: 30s     # 30 seconds
  cache-ttl: 5m            # 5 minutes
  backup-interval: 2h      # 2 hours
  retention-period: 7d     # 7 days
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private Duration sessionTimeout;
    private Duration cacheTtl;
    private Duration backupInterval;
    private Duration retentionPeriod;
}
```

### DataSize

```yaml
app:
  max-file-size: 10MB
  buffer-size: 512KB
  cache-size: 2GB
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private DataSize maxFileSize;
    private DataSize bufferSize;
    private DataSize cacheSize;
}
```

### Collections

```yaml
app:
  servers:
    - server1
    - server2
  
  ports:
    - 8080
    - 8081
    - 8082
  
  settings:
    key1: value1
    key2: value2
```

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private List<String> servers;
    private Set<Integer> ports;
    private Map<String, String> settings;
}
```

### Custom Converters

```java
@Component
@ConfigurationPropertiesBinding
public class StringToUserConverter implements Converter<String, User> {
    
    @Override
    public User convert(String source) {
        String[] parts = source.split(":");
        User user = new User();
        user.setName(parts[0]);
        user.setEmail(parts[1]);
        return user;
    }
}

// Usage
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private User admin;  // Converts "John:john@example.com"
}
```

---

## üìå Best Practices

### 1. Use Profiles for Environments

```yaml
# application.yml
spring:
  profiles:
    active: dev

---
spring:
  config:
    activate:
      on-profile: dev
  datasource:
    url: jdbc:h2:mem:devdb

---
spring:
  config:
    activate:
      on-profile: prod
  datasource:
    url: jdbc:mysql://prod-server:3306/proddb
```

### 2. Externalize Secrets

```yaml
# ‚úÖ Use environment variables for secrets
spring:
  datasource:
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# ‚ùå Don't hardcode secrets
spring:
  datasource:
    username: admin
    password: secret123
```

### 3. Use @ConfigurationProperties for Type Safety

```java
// ‚úÖ Type-safe
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private int maxUsers;
    private Duration timeout;
}

// ‚ùå String-based
@Value("${app.max-users}")
private String maxUsers;  // Need to parse manually
```

### 4. Provide Defaults

```java
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    private int maxUsers = 100;  // Default value
    private String name = "MyApp";
}
```

### 5. Use Kebab-Case in Properties Files

```yaml
# ‚úÖ Recommended
app:
  max-users: 100
  session-timeout: 30s

# ‚ùå Less readable
app:
  maxUsers: 100
  sessionTimeout: 30s
```

### 6. Document Configuration Properties

```java
/**
 * Application configuration properties.
 */
@ConfigurationProperties(prefix = "app")
public class AppProperties {
    
    /**
     * Maximum number of concurrent users.
     * Default: 100
     */
    private int maxUsers = 100;
    
    /**
     * Session timeout duration.
     * Default: 30 minutes
     */
    private Duration sessionTimeout = Duration.ofMinutes(30);
}
```

### 7. Use Optional Imports

```yaml
# Won't fail if file doesn't exist
spring:
  config:
    import:
      - optional:file:./custom-config.yml
      - optional:classpath:optional-config.yml
```

---

## üé§ Interview Questions

### Q1: What is externalized configuration?
**Answer:** Ability to configure application from external sources (properties files, environment variables, command-line args) without changing code or recompiling.

### Q2: What are the configuration sources in Spring Boot?
**Answer:** Command-line args, system properties, environment variables, random values, profile-specific properties, application properties, @PropertySource, default properties.

### Q3: Priority order of configuration sources?
**Answer:** Command-line args (highest) ‚Üí System properties ‚Üí Environment variables ‚Üí Profile-specific config ‚Üí application.properties ‚Üí @PropertySource ‚Üí Default properties (lowest).

### Q4: What is relaxed binding?
**Answer:** Spring Boot's ability to match different property name formats (`max-users`, `maxUsers`, `MAX_USERS`) to the same bean property.

### Q5: How to specify custom configuration location?
**Answer:**
```bash
--spring.config.location=file:./config/
--spring.config.name=myapp
```

### Q6: Difference between spring.config.location and spring.config.additional-location?
**Answer:**
- **location**: Replaces default locations
- **additional-location**: Adds to default locations

### Q7: How to access configuration in code?
**Answer:**
- `@Value("${property}")` - Single property
- `@ConfigurationProperties` - Multiple properties
- `Environment.getProperty()` - Programmatic access

### Q8: What is PropertySource factory?
**Answer:** Custom implementation to load properties from non-standard sources (encrypted files, databases, remote servers).

### Q9: How to make configuration type-safe?
**Answer:** Use `@ConfigurationProperties` with strongly-typed fields instead of `@Value` with strings.

### Q10: How to handle missing required properties?
**Answer:**
```java
@NotNull
private String required;

// Or
String value = env.getRequiredProperty("app.required");
```

---

## üìö Summary

### Configuration Sources (Priority Order)

1. Command-line arguments
2. System properties
3. Environment variables
4. Random values
5. Profile-specific config (external)
6. Profile-specific config (internal)
7. Application config (external)
8. Application config (internal)
9. @PropertySource
10. Default properties

### Key Concepts

- **Externalized**: Configuration outside code
- **Multiple sources**: Properties, YAML, env vars, etc.
- **Priority order**: Higher priority overrides lower
- **Relaxed binding**: Flexible property name formats
- **Type conversion**: Automatic type conversion
- **Profiles**: Environment-specific configuration

### Best Practices

1. Use profiles for environments
2. Externalize secrets (env vars)
3. Use @ConfigurationProperties for type safety
4. Provide sensible defaults
5. Use kebab-case in properties
6. Document configuration
7. Use optional imports

### Complete Example

```yaml
# application.yml
spring:
  application:
    name: ${APP_NAME:MyApp}
  
  config:
    import:
      - optional:file:./config/custom.yml
  
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

app:
  max-users: ${APP_MAX_USERS:100}
  session-timeout: 30m
  features:
    - feature1
    - feature2
```

```java
@Configuration
@EnableConfigurationProperties(AppProperties.class)
public class AppConfig {
}

@ConfigurationProperties(prefix = "app")
@Validated
public class AppProperties {
    
    @Min(1)
    private int maxUsers = 100;
    
    @NotNull
    private Duration sessionTimeout;
    
    private List<String> features;
    
    // Getters and setters
}
```

```bash
# Run with overrides
export APP_MAX_USERS=200
java -jar app.jar --spring.profiles.active=prod --app.session-timeout=1h
```

**Next:** ConfigurationProperties ‚Üí

