# üé≠ Profile-specific Configuration - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Profile Basics](#profile-basics)
- [Profile Activation](#profile-activation)
- [Profile-specific Properties Files](#profile-specific-properties-files)
- [Multi-document YAML](#multi-document-yaml)
- [Profile-specific Beans](#profile-specific-beans)
- [Profile Groups](#profile-groups)
- [Profile Expressions](#profile-expressions)
- [Default Profile](#default-profile)
- [Testing with Profiles](#testing-with-profiles)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Profiles** provide environment-specific configuration (dev, test, prod) without changing code.

### Benefits

- ‚úÖ **Environment separation**: Different configs for different environments
- ‚úÖ **No code changes**: Switch environments via configuration
- ‚úÖ **Bean activation**: Enable/disable beans per environment
- ‚úÖ **Multiple profiles**: Activate multiple profiles simultaneously
- ‚úÖ **Testing**: Easy profile switching for tests

---

## üéØ Profile Basics

### What are Profiles?

Profiles are named logical groupings of configuration and beans.

**Common Profiles:**
- `dev` - Development
- `test` - Testing
- `staging` - Staging
- `prod` - Production

### Profile Naming Convention

```
application-{profile}.properties
application-{profile}.yml
```

**Examples:**
```
application-dev.properties
application-test.properties
application-prod.properties

application-dev.yml
application-test.yml
application-prod.yml
```

---

## ‚ö° Profile Activation

### Method 1: application.properties

```properties
# application.properties
spring.profiles.active=dev
```

```yaml
# application.yml
spring:
  profiles:
    active: dev
```

### Method 2: Command-line Arguments

```bash
java -jar app.jar --spring.profiles.active=prod
```

### Method 3: Environment Variable

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar app.jar
```

### Method 4: System Property

```bash
java -Dspring.profiles.active=prod -jar app.jar
```

### Method 5: Programmatically

```java
@SpringBootApplication
public class Application {
    
    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(Application.class);
        app.setAdditionalProfiles("dev");
        app.run(args);
    }
}
```

### Method 6: IDE Configuration

**IntelliJ IDEA:**
```
Run ‚Üí Edit Configurations ‚Üí Active profiles: dev
```

**Eclipse/STS:**
```
Run Configurations ‚Üí Arguments ‚Üí Program arguments: --spring.profiles.active=dev
```

### Multiple Profiles

```bash
# Activate multiple profiles
java -jar app.jar --spring.profiles.active=dev,mysql,cache
```

```properties
spring.profiles.active=dev,mysql,cache
```

---

## üìÅ Profile-specific Properties Files

### Base Configuration

```properties
# application.properties (base)
app.name=MyApplication
app.version=1.0.0
```

### Development Profile

```properties
# application-dev.properties
server.port=8080
spring.datasource.url=jdbc:h2:mem:devdb
spring.datasource.username=sa
spring.datasource.password=

logging.level.root=DEBUG
logging.level.com.example=TRACE

app.feature.new-ui=true
app.cache.enabled=false
```

### Test Profile

```properties
# application-test.properties
server.port=8081
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.username=sa
spring.datasource.password=

logging.level.root=INFO
logging.level.com.example=DEBUG

app.feature.new-ui=true
app.cache.enabled=true
```

### Production Profile

```properties
# application-prod.properties
server.port=80
spring.datasource.url=jdbc:mysql://prod-server:3306/proddb
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

logging.level.root=WARN
logging.level.com.example=INFO

app.feature.new-ui=false
app.cache.enabled=true

# Production-specific
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=validate
```

### Loading Order

1. `application.properties` (base)
2. `application-{profile}.properties` (profile-specific)

Profile-specific properties **override** base properties.

---

## üìÑ Multi-document YAML

YAML supports multiple documents in a single file.

### Single YAML File for All Profiles

```yaml
# application.yml

# Base configuration (always active)
spring:
  application:
    name: MyApplication
    
app:
  name: MyApp
  version: 1.0.0

---
# Development profile
spring:
  config:
    activate:
      on-profile: dev
      
server:
  port: 8080
  
spring:
  datasource:
    url: jdbc:h2:mem:devdb
    username: sa
    password: ""
    
logging:
  level:
    root: DEBUG
    com.example: TRACE

---
# Test profile
spring:
  config:
    activate:
      on-profile: test
      
server:
  port: 8081
  
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    username: sa
    password: ""
    
logging:
  level:
    root: INFO
    com.example: DEBUG

---
# Production profile
spring:
  config:
    activate:
      on-profile: prod
      
server:
  port: 80
  
spring:
  datasource:
    url: jdbc:mysql://prod-server:3306/proddb
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    
logging:
  level:
    root: WARN
    com.example: INFO
    
  jpa:
    show-sql: false
    hibernate:
      ddl-auto: validate
```

### Old Syntax (Spring Boot < 2.4)

```yaml
spring:
  profiles: dev  # Old syntax
  
# vs

spring:
  config:
    activate:
      on-profile: dev  # New syntax (2.4+)
```

---

## üèóÔ∏è Profile-specific Beans

### @Profile on Components

```java
// Development database configuration
@Configuration
@Profile("dev")
public class DevDatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
}

// Production database configuration
@Configuration
@Profile("prod")
public class ProdDatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl(env.getProperty("spring.datasource.url"));
        config.setUsername(env.getProperty("spring.datasource.username"));
        config.setPassword(env.getProperty("spring.datasource.password"));
        config.setMaximumPoolSize(20);
        return new HikariDataSource(config);
    }
}
```

### @Profile on Methods

```java
@Configuration
public class CacheConfig {
    
    @Bean
    @Profile("dev")
    public CacheManager devCacheManager() {
        // Simple in-memory cache for dev
        return new ConcurrentMapCacheManager();
    }
    
    @Bean
    @Profile("prod")
    public CacheManager prodCacheManager() {
        // Redis cache for production
        RedisCacheManager cacheManager = RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(10)))
            .build();
        return cacheManager;
    }
}
```

### @Profile on Components

```java
@Service
@Profile("dev")
public class MockEmailService implements EmailService {
    
    @Override
    public void sendEmail(String to, String subject, String body) {
        System.out.println("MOCK EMAIL:");
        System.out.println("To: " + to);
        System.out.println("Subject: " + subject);
        System.out.println("Body: " + body);
    }
}

@Service
@Profile("prod")
public class SmtpEmailService implements EmailService {
    
    @Autowired
    private JavaMailSender mailSender;
    
    @Override
    public void sendEmail(String to, String subject, String body) {
        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(to);
        message.setSubject(subject);
        message.setText(body);
        mailSender.send(message);
    }
}
```

---

## üéØ Profile Groups

Profile groups allow activating multiple profiles with a single group name.

### Defining Profile Groups

```yaml
# application.yml
spring:
  profiles:
    group:
      development:
        - dev
        - h2db
        - mock-services
      production:
        - prod
        - mysql
        - real-services
```

### Activating Profile Groups

```bash
# Activates dev, h2db, and mock-services
java -jar app.jar --spring.profiles.active=development

# Activates prod, mysql, and real-services
java -jar app.jar --spring.profiles.active=production
```

### Example with Multiple Profiles

```yaml
spring:
  profiles:
    group:
      local:
        - dev
        - h2
        - mock-external-apis
      staging:
        - test
        - mysql
        - real-external-apis
      production:
        - prod
        - mysql
        - real-external-apis
        - monitoring

---
spring:
  config:
    activate:
      on-profile: dev
server:
  port: 8080

---
spring:
  config:
    activate:
      on-profile: h2
spring:
  datasource:
    url: jdbc:h2:mem:devdb

---
spring:
  config:
    activate:
      on-profile: mysql
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/db

---
spring:
  config:
    activate:
      on-profile: mock-external-apis
external:
  payment-api:
    url: http://localhost:9000/mock
    
---
spring:
  config:
    activate:
      on-profile: real-external-apis
external:
  payment-api:
    url: https://api.payment.com
```

---

## üî£ Profile Expressions

### NOT Profile

```java
@Configuration
@Profile("!prod")  // Active when NOT production
public class NonProdConfig {
    // Development and test configuration
}
```

### Multiple Profiles (OR)

```java
@Configuration
@Profile({"dev", "test"})  // Active in dev OR test
public class DevOrTestConfig {
}
```

### Complex Expressions

```java
@Configuration
@Profile("dev & mysql")  // Active when both dev AND mysql
public class DevMySQLConfig {
}

@Configuration
@Profile("prod | staging")  // Active in prod OR staging
public class ProdOrStagingConfig {
}

@Configuration
@Profile("!prod & !staging")  // NOT prod AND NOT staging
public class LocalOnlyConfig {
}
```

### Combining Expressions

```java
@Configuration
@Profile("(dev | test) & mysql")  // (dev OR test) AND mysql
public class DevTestMySQLConfig {
}

@Configuration
@Profile("prod & !docker")  // prod AND NOT docker
public class ProdNonDockerConfig {
}
```

---

## üîß Default Profile

### Setting Default Profile

```properties
# application.properties
spring.profiles.default=dev
```

```yaml
# application.yml
spring:
  profiles:
    default: dev
```

### Default Profile Bean

```java
@Configuration
@Profile("default")  // Active when no profile is set
public class DefaultConfig {
    
    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
}
```

### Fallback Behavior

If no profile is explicitly activated:
1. Spring checks `spring.profiles.default`
2. If not set, uses profile named `default`
3. If `default` profile doesn't exist, no profile-specific config loads

---

## üß™ Testing with Profiles

### @ActiveProfiles

```java
@SpringBootTest
@ActiveProfiles("test")
class UserServiceTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    void testUserCreation() {
        // Uses test profile configuration
    }
}
```

### Multiple Profiles in Tests

```java
@SpringBootTest
@ActiveProfiles({"test", "h2db"})
class IntegrationTest {
    // Uses test and h2db profiles
}
```

### Profile-specific Test Configuration

```java
@TestConfiguration
@Profile("test")
public class TestConfig {
    
    @Bean
    @Primary
    public EmailService mockEmailService() {
        return Mockito.mock(EmailService.class);
    }
}
```

### Conditional Tests

```java
@SpringBootTest
@ActiveProfiles("integration-test")
class IntegrationTest {
    
    @Test
    @IfProfileValue(name = "test.environment", value = "integration")
    void integrationTest() {
        // Only runs in integration environment
    }
}
```

---

## üìå Best Practices

### 1. Use Meaningful Profile Names

```yaml
# ‚úÖ Clear and descriptive
spring.profiles.active=dev
spring.profiles.active=test
spring.profiles.active=staging
spring.profiles.active=prod

# ‚ùå Ambiguous
spring.profiles.active=env1
spring.profiles.active=config2
```

### 2. Keep Base Configuration in application.properties

```properties
# application.properties - base configuration
app.name=MyApplication
app.version=1.0.0

# Common settings
spring.jackson.serialization.indent-output=true
```

```properties
# application-dev.properties - only dev-specific overrides
server.port=8080
logging.level.root=DEBUG
```

### 3. Use Environment Variables for Secrets

```yaml
# application-prod.yml
spring:
  datasource:
    username: ${DB_USERNAME}  # From environment
    password: ${DB_PASSWORD}  # From environment
    
app:
  jwt-secret: ${JWT_SECRET}   # From environment
```

### 4. Use Profile Groups for Complex Setups

```yaml
spring:
  profiles:
    group:
      local:
        - dev
        - h2
        - mock-services
        - debug-logging
      
      cloud:
        - prod
        - postgres
        - real-services
        - info-logging
```

### 5. Document Profile Requirements

```java
/**
 * Production database configuration.
 * 
 * Required properties:
 * - spring.datasource.url
 * - spring.datasource.username
 * - spring.datasource.password
 * 
 * Active profiles: prod, mysql
 */
@Configuration
@Profile("prod")
public class ProdDatabaseConfig {
}
```

### 6. Use Separate Files for Large Configurations

```
application.yml              # Base
application-dev.yml          # Development
application-test.yml         # Testing
application-staging.yml      # Staging
application-prod.yml         # Production
```

### 7. Default to Safest Configuration

```properties
# application.properties - defaults to safe/dev settings
spring.jpa.show-sql=true
spring.jpa.hibernate.ddl-auto=create-drop
```

```properties
# application-prod.properties - explicit production settings
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=validate
```

---

## üé§ Interview Questions

### Q1: What are Spring Profiles?
**Answer:** Named logical groupings of configuration that allow environment-specific settings without code changes. Common profiles: dev, test, prod.

### Q2: How to activate a profile?
**Answer:**
- Command-line: `--spring.profiles.active=prod`
- Environment variable: `SPRING_PROFILES_ACTIVE=prod`
- application.properties: `spring.profiles.active=prod`
- Programmatically: `app.setAdditionalProfiles("prod")`

### Q3: Profile-specific property file naming?
**Answer:** `application-{profile}.properties` or `application-{profile}.yml`

Example: `application-dev.properties`, `application-prod.yml`

### Q4: How to activate multiple profiles?
**Answer:**
```bash
--spring.profiles.active=dev,mysql,cache
```
Comma-separated list.

### Q5: What is @Profile annotation?
**Answer:** Annotation to conditionally enable beans/configurations based on active profiles.
```java
@Configuration
@Profile("dev")
public class DevConfig { }
```

### Q6: Profile expressions?
**Answer:**
- `@Profile("!prod")` - NOT prod
- `@Profile({"dev", "test"})` - dev OR test
- `@Profile("dev & mysql")` - dev AND mysql

### Q7: What are profile groups?
**Answer:** Groups of profiles activated together:
```yaml
spring:
  profiles:
    group:
      development: [dev, h2, mock]
```

### Q8: Multi-document YAML?
**Answer:** Single YAML file with multiple profile sections separated by `---`:
```yaml
---
spring:
  config:
    activate:
      on-profile: dev
---
```

### Q9: Default profile?
**Answer:** Profile activated when none specified:
```properties
spring.profiles.default=dev
```

### Q10: How to test with specific profile?
**Answer:**
```java
@SpringBootTest
@ActiveProfiles("test")
class MyTest { }
```

---

## üìö Summary

### Profile Activation Methods

1. **Command-line**: `--spring.profiles.active=prod`
2. **Environment variable**: `SPRING_PROFILES_ACTIVE=prod`
3. **application.properties**: `spring.profiles.active=prod`
4. **System property**: `-Dspring.profiles.active=prod`
5. **Programmatically**: `app.setAdditionalProfiles("prod")`

### Configuration Files

```
application.properties              # Base
application-dev.properties          # Dev profile
application-test.properties         # Test profile
application-prod.properties         # Prod profile
```

### Profile-specific Beans

```java
@Configuration
@Profile("dev")
public class DevConfig {
    @Bean
    public DataSource dataSource() { }
}
```

### Profile Expressions

```java
@Profile("!prod")              // NOT prod
@Profile({"dev", "test"})      // dev OR test
@Profile("dev & mysql")        // dev AND mysql
@Profile("prod | staging")     // prod OR staging
@Profile("!prod & !staging")   // NOT prod AND NOT staging
```

### Complete Example

```yaml
# application.yml
spring:
  application:
    name: MyApp
  
  profiles:
    default: dev
    group:
      development: [dev, h2, mock]
      production: [prod, mysql, real]

---
spring:
  config:
    activate:
      on-profile: dev
      
server:
  port: 8080
  
spring:
  datasource:
    url: jdbc:h2:mem:devdb
    
logging:
  level:
    root: DEBUG

---
spring:
  config:
    activate:
      on-profile: prod
      
server:
  port: 80
  
spring:
  datasource:
    url: jdbc:mysql://prod:3306/db
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    
logging:
  level:
    root: WARN
```

```java
@Configuration
@Profile("dev")
public class DevConfig {
    
    @Bean
    public EmailService emailService() {
        return new MockEmailService();
    }
}

@Configuration
@Profile("prod")
public class ProdConfig {
    
    @Bean
    public EmailService emailService() {
        return new SmtpEmailService();
    }
}
```

**Next:** Environment Variables ‚Üí

