# üéØ Configuration Precedence - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Complete Precedence Order](#complete-precedence-order)
- [Property Source Priority](#property-source-priority)
- [Profile-Specific Precedence](#profile-specific-precedence)
- [Configuration File Locations](#configuration-file-locations)
- [Practical Examples](#practical-examples)
- [Testing Precedence](#testing-precedence)
- [Debugging Configuration](#debugging-configuration)
- [Common Pitfalls](#common-pitfalls)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Configuration Precedence** defines the order in which Spring Boot resolves property values when the same property is defined in multiple sources.

### Key Principle

**Higher priority sources override lower priority sources.**

---

## üìä Complete Precedence Order

### Full Order (Highest to Lowest)

1. **Devtools global settings** (`~/.spring-boot-devtools.properties`)
2. **@TestPropertySource** annotations on tests
3. **properties attribute** on tests (`@SpringBootTest(properties="...")`)
4. **Command-line arguments**
5. **SPRING_APPLICATION_JSON** properties
6. **ServletConfig init parameters**
7. **ServletContext init parameters**
8. **JNDI attributes** from `java:comp/env`
9. **Java System properties** (`System.getProperties()`)
10. **OS environment variables**
11. **RandomValuePropertySource** (`random.*`)
12. **Profile-specific application properties outside packaged jar**
    - `application-{profile}.properties`
    - `application-{profile}.yml`
13. **Profile-specific application properties inside packaged jar**
14. **Application properties outside packaged jar**
    - `application.properties`
    - `application.yml`
15. **Application properties inside packaged jar**
16. **@PropertySource** annotations on `@Configuration` classes
17. **Default properties** (`SpringApplication.setDefaultProperties()`)

---

## üéØ Property Source Priority

### Top Priority Sources

#### 1. Command-line Arguments (Highest)

```bash
java -jar app.jar --server.port=9090 --app.name="Command Line App"
```

Overrides everything else.

#### 2. Java System Properties

```bash
java -Dserver.port=8080 -Dapp.name="System Property App" -jar app.jar
```

Higher priority than environment variables and config files.

#### 3. Environment Variables

```bash
export SERVER_PORT=8081
export APP_NAME="Environment Variable App"
java -jar app.jar
```

### Mid Priority Sources

#### 4. Profile-Specific Properties (External)

```
/config/application-prod.properties      # Outside jar
```

Higher priority than internal profile-specific properties.

#### 5. Profile-Specific Properties (Internal)

```
src/main/resources/application-prod.properties   # Inside jar
```

#### 6. Application Properties (External)

```
/config/application.properties          # Outside jar
```

Higher priority than internal application properties.

#### 7. Application Properties (Internal)

```
src/main/resources/application.properties       # Inside jar
```

### Low Priority Sources

#### 8. @PropertySource

```java
@Configuration
@PropertySource("classpath:custom.properties")
public class AppConfig {
}
```

Lower priority than application.properties.

#### 9. Default Properties (Lowest)

```java
SpringApplication app = new SpringApplication(Application.class);
Properties defaults = new Properties();
defaults.setProperty("server.port", "8080");
app.setDefaultProperties(defaults);
```

Lowest priority - overridden by everything.

---

## üé≠ Profile-Specific Precedence

### Profile Properties Override Base Properties

```properties
# application.properties (base)
server.port=8080
app.name=MyApp
app.max-users=100
```

```properties
# application-prod.properties (profile)
server.port=80
app.max-users=1000
# app.name not overridden, uses base value
```

When `prod` profile is active:
- `server.port` = 80 (from profile)
- `app.name` = MyApp (from base)
- `app.max-users` = 1000 (from profile)

### External vs Internal Profile Properties

```
Priority order when prod profile is active:

1. /config/application-prod.properties           (external, profile) - HIGHEST
2. /config/application.properties                (external, base)
3. src/main/resources/application-prod.properties (internal, profile)
4. src/main/resources/application.properties      (internal, base) - LOWEST
```

---

## üìÅ Configuration File Locations

### Location Search Order (Highest to Lowest)

1. `/config` subdirectory of current directory
2. Current directory
3. `classpath:/config` package
4. `classpath:` root

```
project/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ application.properties              # Priority 1 (highest)
‚îÇ   ‚îî‚îÄ‚îÄ application-prod.properties         # Priority 1 (profile)
‚îú‚îÄ‚îÄ application.properties                  # Priority 2
‚îú‚îÄ‚îÄ application-prod.properties             # Priority 2 (profile)
‚îî‚îÄ‚îÄ src/main/resources/
    ‚îú‚îÄ‚îÄ config/
    ‚îÇ   ‚îú‚îÄ‚îÄ application.properties          # Priority 3
    ‚îÇ   ‚îî‚îÄ‚îÄ application-prod.properties     # Priority 3 (profile)
    ‚îú‚îÄ‚îÄ application.properties              # Priority 4 (lowest)
    ‚îî‚îÄ‚îÄ application-prod.properties         # Priority 4 (profile)
```

### Custom Locations

```bash
# Override default locations (replaces)
java -jar app.jar --spring.config.location=file:./custom/,classpath:/config/

# Add to default locations (appends)
java -jar app.jar --spring.config.additional-location=file:/etc/myapp/
```

Priority with custom location:
1. Custom location (highest)
2. Default locations

---

## üí° Practical Examples

### Example 1: Complete Override Chain

```properties
# src/main/resources/application.properties (Priority 15)
server.port=8080
app.name=DefaultApp
app.max-users=100
```

```bash
# Environment variable (Priority 10)
export SERVER_PORT=8081
export APP_MAX_USERS=200
```

```bash
# System property (Priority 9)
java -Dapp.name="System App" -jar app.jar
```

```bash
# Command-line argument (Priority 4 - highest)
java -jar app.jar --server.port=9090
```

**Result:**
- `server.port` = 9090 (command-line)
- `app.name` = "System App" (system property)
- `app.max-users` = 200 (environment variable)

### Example 2: Profile Configuration

```yaml
# application.yml (base)
spring:
  profiles:
    active: dev

server:
  port: 8080

app:
  name: MyApp
  max-users: 100
  cache-enabled: false
```

```yaml
# application-dev.yml (dev profile)
server:
  port: 8081

app:
  cache-enabled: true
```

```yaml
# application-prod.yml (prod profile)
server:
  port: 80

app:
  max-users: 1000
  cache-enabled: true
```

```bash
# Activate prod profile via command-line
java -jar app.jar --spring.profiles.active=prod --server.port=9090
```

**Result with prod profile:**
- `server.port` = 9090 (command-line overrides profile)
- `app.name` = MyApp (from base, not overridden)
- `app.max-users` = 1000 (from prod profile)
- `app.cache-enabled` = true (from prod profile)

### Example 3: Multiple Property Sources

```properties
# src/main/resources/application.properties
server.port=8080
app.name=DefaultApp
app.version=1.0.0
db.url=jdbc:h2:mem:devdb
```

```properties
# src/main/resources/custom.properties
app.name=CustomApp
app.feature.enabled=true
```

```java
@Configuration
@PropertySource("classpath:custom.properties")
public class AppConfig {
}
```

```bash
export SERVER_PORT=8081
java -Dapp.version=2.0.0 -jar app.jar --db.url=jdbc:mysql://localhost:3306/db
```

**Result:**
- `server.port` = 8081 (env var overrides application.properties)
- `app.name` = CustomApp (@PropertySource overrides application.properties)
- `app.version` = 2.0.0 (system property overrides application.properties)
- `db.url` = jdbc:mysql://localhost:3306/db (command-line wins)
- `app.feature.enabled` = true (from custom.properties)

### Example 4: External Configuration

```
Directory structure:
/app/
‚îú‚îÄ‚îÄ myapp.jar
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ application.properties         (external config/)
‚îÇ   ‚îî‚îÄ‚îÄ application-prod.properties    (external config/)
‚îú‚îÄ‚îÄ application.properties             (external current dir)
‚îî‚îÄ‚îÄ (jar contains internal application.properties)
```

```properties
# /app/config/application.properties (Priority 1)
server.port=9000

# /app/application.properties (Priority 2)
server.port=8500

# Inside jar: application.properties (Priority 4)
server.port=8080
```

**Result:** `server.port` = 9000 (from /app/config/)

---

## üß™ Testing Precedence

### @TestPropertySource

```java
@SpringBootTest
@TestPropertySource(properties = {
    "server.port=9999",
    "app.name=TestApp"
})
class ConfigTest {
    
    @Value("${server.port}")
    private int port;  // 9999
    
    @Value("${app.name}")
    private String name;  // "TestApp"
}
```

Overrides everything except Devtools settings.

### @SpringBootTest properties

```java
@SpringBootTest(properties = {
    "server.port=8888",
    "app.test-mode=true"
})
class AnotherTest {
    
    @Value("${server.port}")
    private int port;  // 8888
    
    @Value("${app.test-mode}")
    private boolean testMode;  // true
}
```

### Test Profile

```java
@SpringBootTest
@ActiveProfiles("test")
class ProfileTest {
    // Uses application-test.properties
}
```

```properties
# application-test.properties
server.port=8082
spring.datasource.url=jdbc:h2:mem:testdb
```

---

## üêõ Debugging Configuration

### Enable Debug Logging

```bash
# Command-line
java -jar app.jar --debug

# Or
java -jar app.jar --logging.level.org.springframework.boot.context.config=DEBUG
```

### Log Configuration on Startup

```java
@Component
public class ConfigDebugger implements ApplicationListener<ApplicationReadyEvent> {
    
    @Autowired
    private Environment env;
    
    @Override
    public void onApplicationEvent(ApplicationReadyEvent event) {
        System.out.println("=== Configuration Debug ===");
        
        // Log specific properties
        logProperty("server.port");
        logProperty("spring.profiles.active");
        logProperty("app.name");
        
        // Log active profiles
        System.out.println("Active profiles: " + Arrays.toString(env.getActiveProfiles()));
        
        // Log property sources
        MutablePropertySources propertySources = 
            ((AbstractEnvironment) env).getPropertySources();
        
        propertySources.forEach(ps -> {
            System.out.println("PropertySource: " + ps.getName());
        });
    }
    
    private void logProperty(String key) {
        String value = env.getProperty(key);
        System.out.println(key + " = " + value);
    }
}
```

### Actuator Endpoints

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

```yaml
management:
  endpoints:
    web:
      exposure:
        include: env, configprops
```

**Endpoints:**
- `GET /actuator/env` - All property sources
- `GET /actuator/env/{property}` - Specific property with source
- `GET /actuator/configprops` - @ConfigurationProperties beans

### Custom PropertySource Inspector

```java
@Component
public class PropertySourceInspector implements ApplicationListener<ApplicationReadyEvent> {
    
    @Autowired
    private ConfigurableEnvironment env;
    
    @Override
    public void onApplicationEvent(ApplicationReadyEvent event) {
        System.out.println("\n=== Property Sources (in order) ===");
        
        MutablePropertySources sources = env.getPropertySources();
        int index = 1;
        
        for (PropertySource<?> ps : sources) {
            System.out.println(index + ". " + ps.getName() + " [" + ps.getClass().getSimpleName() + "]");
            index++;
        }
        
        // Find where specific property comes from
        String propertyName = "server.port";
        PropertySource<?> source = findPropertySource(propertyName, sources);
        if (source != null) {
            System.out.println("\n" + propertyName + " comes from: " + source.getName());
        }
    }
    
    private PropertySource<?> findPropertySource(String key, MutablePropertySources sources) {
        for (PropertySource<?> ps : sources) {
            if (ps instanceof EnumerablePropertySource) {
                EnumerablePropertySource<?> eps = (EnumerablePropertySource<?>) ps;
                if (Arrays.asList(eps.getPropertyNames()).contains(key)) {
                    return ps;
                }
            }
        }
        return null;
    }
}
```

---

## ‚ö†Ô∏è Common Pitfalls

### 1. Environment Variable Format Confusion

```bash
# ‚ùå Wrong - Won't bind to server.port
export server.port=8080

# ‚úÖ Correct - Use uppercase with underscores
export SERVER_PORT=8080
```

### 2. Profile Not Activated

```properties
# application-prod.properties
server.port=80
```

```bash
# ‚ùå Profile properties won't load
java -jar app.jar

# ‚úÖ Activate profile
java -jar app.jar --spring.profiles.active=prod
```

### 3. External Config Not Found

```bash
# ‚ùå File path incorrect
java -jar app.jar --spring.config.location=/config/app.properties

# ‚úÖ Correct file path (must exist)
java -jar app.jar --spring.config.location=file:./config/application.properties
```

### 4. @PropertySource Lower Priority

```java
@Configuration
@PropertySource("classpath:custom.properties")
public class Config {
}
```

```properties
# custom.properties
server.port=9000

# application.properties (higher priority)
server.port=8080
```

Result: `server.port` = 8080 (application.properties wins)

### 5. System Property vs Environment Variable

```bash
# Environment variable
export SERVER_PORT=8080

# System property (higher priority)
java -Dserver.port=9090 -jar app.jar

# Result: server.port = 9090 (system property wins)
```

---

## üìå Best Practices

### 1. Use Appropriate Configuration Source

```
Development:
- application-dev.properties (base config)
- Override via IDE run configuration

Testing:
- application-test.properties
- @TestPropertySource for test-specific values

Production:
- Environment variables (secrets)
- External config files (non-secret config)
- Command-line arguments (deployment-specific)
```

### 2. Document Configuration Sources

```properties
# application.properties
# Base configuration - can be overridden by:
# 1. application-{profile}.properties
# 2. Environment variables (PROPERTY_NAME format)
# 3. System properties (-Dproperty.name)
# 4. Command-line arguments (--property.name)

server.port=8080
app.name=MyApp
```

### 3. Provide Sensible Defaults

```properties
# application.properties - safe defaults
server.port=8080
spring.jpa.show-sql=true
spring.jpa.hibernate.ddl-auto=create-drop
```

```properties
# application-prod.properties - production overrides
server.port=80
spring.jpa.show-sql=false
spring.jpa.hibernate.ddl-auto=validate
```

### 4. Use Environment Variables for Secrets

```yaml
# application.yml
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}    # Never hardcode

jwt:
  secret: ${JWT_SECRET}         # From environment
```

### 5. Test Configuration Precedence

```java
@SpringBootTest
class ConfigPrecedenceTest {
    
    @Value("${server.port}")
    private int port;
    
    @Test
    void testCommandLineOverride() {
        // Verify command-line args override config files
    }
    
    @Test
    void testProfilePrecedence() {
        // Verify profile-specific properties override base
    }
}
```

### 6. Use Actuator for Production Debugging

```yaml
# application-prod.yml
management:
  endpoints:
    web:
      exposure:
        include: env
  endpoint:
    env:
      show-values: when-authorized  # Hide sensitive values
```

### 7. Keep Base Config Minimal

```properties
# application.properties - only common/default values
spring.application.name=myapp
spring.profiles.default=dev

# Environment-specific in profiles
# application-dev.properties
# application-test.properties
# application-prod.properties
```

---

## üé§ Interview Questions

### Q1: What is configuration precedence in Spring Boot?
**Answer:** Order in which Spring Boot resolves property values when same property exists in multiple sources. Higher priority sources override lower ones.

### Q2: Which has highest priority: command-line args or environment variables?
**Answer:** Command-line arguments have higher priority and override environment variables.

### Q3: Complete precedence order (top 5)?
**Answer:**
1. Command-line arguments (highest)
2. Java system properties
3. OS environment variables
4. Profile-specific properties (external)
5. Profile-specific properties (internal)

### Q4: Do profile-specific properties override base properties?
**Answer:** Yes, profile-specific properties (application-{profile}.properties) override base properties (application.properties).

### Q5: External vs internal config files priority?
**Answer:** External config files (outside jar) have higher priority than internal (inside jar).

### Q6: Config file location precedence?
**Answer:**
1. `/config/` subdirectory (highest)
2. Current directory
3. `classpath:/config/`
4. `classpath:/` (lowest)

### Q7: @PropertySource priority vs application.properties?
**Answer:** application.properties has higher priority and overrides @PropertySource.

### Q8: How to debug which property source is being used?
**Answer:**
- Enable debug logging: `--debug`
- Use Actuator: `/actuator/env/{property}`
- Custom logging in ApplicationReadyEvent

### Q9: Can command-line arguments override profile properties?
**Answer:** Yes, command-line arguments have highest priority and override all property sources including profiles.

### Q10: What is the lowest priority configuration source?
**Answer:** Default properties set via `SpringApplication.setDefaultProperties()`.

---

## üìö Summary

### Priority Order (Simplified)

```
1. Command-line arguments              --server.port=9090  (HIGHEST)
2. System properties                   -Dserver.port=8080
3. Environment variables               SERVER_PORT=8081
4. Profile properties (external)       /config/application-prod.properties
5. Profile properties (internal)       classpath:application-prod.properties
6. Application properties (external)   /config/application.properties
7. Application properties (internal)   classpath:application.properties
8. @PropertySource                     @PropertySource("custom.properties")
9. Default properties                  setDefaultProperties()  (LOWEST)
```

### Configuration File Location Priority

```
1. file:./config/                      (HIGHEST)
2. file:./
3. classpath:/config/
4. classpath:/                         (LOWEST)
```

### Quick Reference

| Source | Example | Priority |
|--------|---------|----------|
| **Command-line** | `--server.port=9090` | üî¥ Highest |
| **System property** | `-Dserver.port=8080` | üî¥ Very High |
| **Environment var** | `SERVER_PORT=8081` | üü° High |
| **External profile** | `/config/application-prod.properties` | üü° Medium-High |
| **Internal profile** | `classpath:application-prod.properties` | üü¢ Medium |
| **External base** | `/config/application.properties` | üü¢ Medium-Low |
| **Internal base** | `classpath:application.properties` | üîµ Low |
| **@PropertySource** | `@PropertySource("custom.properties")` | üîµ Very Low |
| **Defaults** | `setDefaultProperties()` | ‚ö™ Lowest |

### Complete Example

```properties
# classpath:application.properties (Priority: Low)
server.port=8080
app.name=BaseApp
app.max-users=100
```

```properties
# /config/application-prod.properties (Priority: Medium-High)
server.port=80
app.max-users=1000
```

```bash
# Environment (Priority: High)
export APP_NAME=EnvApp

# System property (Priority: Very High)
-Dapp.version=2.0.0

# Command-line (Priority: Highest)
--server.port=9090
```

**Final Result:**
- `server.port` = 9090 (command-line)
- `app.name` = EnvApp (environment variable)
- `app.max-users` = 1000 (prod profile)
- `app.version` = 2.0.0 (system property)

---

**End of Configuration Topics** ‚úÖ

