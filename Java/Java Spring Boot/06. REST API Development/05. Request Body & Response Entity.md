# üì¶ Request Body & Response Entity - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [@RequestBody](#requestbody)
- [ResponseEntity](#responseentity)
- [Request Validation](#request-validation)
- [Response Headers](#response-headers)
- [Content Negotiation](#content-negotiation)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Request Body** and **Response Entity** handle request/response data in REST APIs:

- **@RequestBody**: Deserialize HTTP request body to Java object
- **ResponseEntity**: Customize HTTP response (body, headers, status)

---

## üì• @RequestBody

### Basic Usage

```java
@PostMapping("/users")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}
```

**Request:**
```http
POST /users
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com",
  "age": 30
}
```

### User Entity

```java
@Data
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private String email;
    private Integer age;
    private String city;
}
```

### Multiple Fields

```java
@PutMapping("/users/{id}")
public User updateUser(
        @PathVariable Long id,
        @RequestBody User user) {
    return userService.update(id, user);
}
```

**Request:**
```http
PUT /users/123
Content-Type: application/json

{
  "name": "John Smith",
  "email": "john.smith@example.com",
  "age": 31,
  "city": "New York"
}
```

### Partial Update with Map

```java
@PatchMapping("/users/{id}")
public User patchUser(
        @PathVariable Long id,
        @RequestBody Map<String, Object> updates) {
    return userService.patch(id, updates);
}
```

**Request:**
```http
PATCH /users/123
Content-Type: application/json

{
  "email": "newemail@example.com",
  "city": "Boston"
}
```

### DTO Pattern

```java
// Request DTO
@Data
public class CreateUserRequest {
    @NotBlank
    private String name;
    
    @Email
    @NotBlank
    private String email;
    
    @Min(18)
    @Max(150)
    private Integer age;
    
    private String city;
}

// Response DTO
@Data
public class UserResponse {
    private Long id;
    private String name;
    private String email;
    private Integer age;
    private String city;
    private LocalDateTime createdAt;
}

// Controller
@PostMapping("/users")
public UserResponse createUser(@Valid @RequestBody CreateUserRequest request) {
    User user = userService.create(request);
    return mapToResponse(user);
}
```

### Nested Objects

```java
@Data
public class CreateOrderRequest {
    private Long userId;
    private List<OrderItem> items;
    private Address shippingAddress;
    private PaymentInfo paymentInfo;
}

@Data
public class OrderItem {
    private Long productId;
    private Integer quantity;
    private BigDecimal price;
}

@Data
public class Address {
    private String street;
    private String city;
    private String state;
    private String zipCode;
}

@Data
public class PaymentInfo {
    private String cardNumber;
    private String expiryDate;
    private String cvv;
}

// Controller
@PostMapping("/orders")
public OrderResponse createOrder(@Valid @RequestBody CreateOrderRequest request) {
    return orderService.createOrder(request);
}
```

**Request:**
```http
POST /orders
Content-Type: application/json

{
  "userId": 123,
  "items": [
    {
      "productId": 456,
      "quantity": 2,
      "price": 29.99
    },
    {
      "productId": 789,
      "quantity": 1,
      "price": 49.99
    }
  ],
  "shippingAddress": {
    "street": "123 Main St",
    "city": "Boston",
    "state": "MA",
    "zipCode": "02101"
  },
  "paymentInfo": {
    "cardNumber": "4111111111111111",
    "expiryDate": "12/25",
    "cvv": "123"
  }
}
```

### Required vs Optional

```java
// Required (default)
@PostMapping("/users")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}

// Optional
@PostMapping("/users")
public User createUser(@RequestBody(required = false) User user) {
    if (user == null) {
        user = new User();
        // Set defaults
    }
    return userService.save(user);
}
```

---

## üì§ ResponseEntity

### Basic Usage

```java
@GetMapping("/users/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    
    if (user == null) {
        return ResponseEntity.notFound().build();
    }
    
    return ResponseEntity.ok(user);
}
```

### Different Status Codes

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // 200 OK
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        return userService.findById(id)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }
    
    // 201 Created
    @PostMapping
    public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
        User created = userService.save(user);
        return ResponseEntity
            .status(HttpStatus.CREATED)
            .body(created);
    }
    
    // 204 No Content
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        userService.delete(id);
        return ResponseEntity.noContent().build();
    }
    
    // 400 Bad Request
    @PostMapping("/validate")
    public ResponseEntity<String> validateUser(@RequestBody User user) {
        if (user.getAge() < 18) {
            return ResponseEntity
                .badRequest()
                .body("User must be at least 18 years old");
        }
        return ResponseEntity.ok("Valid user");
    }
}
```

### With Location Header

```java
@PostMapping
public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
    User created = userService.save(user);
    
    URI location = ServletUriComponentsBuilder
        .fromCurrentRequest()
        .path("/{id}")
        .buildAndExpand(created.getId())
        .toUri();
    
    return ResponseEntity
        .created(location)
        .body(created);
}
```

**Response:**
```http
HTTP/1.1 201 Created
Location: http://localhost:8080/api/users/123
Content-Type: application/json

{
  "id": 123,
  "name": "John Doe",
  "email": "john@example.com"
}
```

### Custom Headers

```java
@GetMapping("/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    
    return ResponseEntity.ok()
        .header("X-Custom-Header", "CustomValue")
        .header("X-Request-ID", UUID.randomUUID().toString())
        .body(user);
}
```

### Multiple Headers

```java
@GetMapping("/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    
    HttpHeaders headers = new HttpHeaders();
    headers.add("X-Custom-Header", "CustomValue");
    headers.add("X-Request-ID", UUID.randomUUID().toString());
    headers.add("Cache-Control", "max-age=3600");
    
    return ResponseEntity.ok()
        .headers(headers)
        .body(user);
}
```

### ETag Support

```java
@GetMapping("/{id}")
public ResponseEntity<User> getUser(
        @PathVariable Long id,
        @RequestHeader(value = "If-None-Match", required = false) String ifNoneMatch) {
    
    User user = userService.findById(id);
    
    if (user == null) {
        return ResponseEntity.notFound().build();
    }
    
    String etag = "\"" + user.hashCode() + "\"";
    
    if (etag.equals(ifNoneMatch)) {
        return ResponseEntity
            .status(HttpStatus.NOT_MODIFIED)
            .eTag(etag)
            .build();
    }
    
    return ResponseEntity.ok()
        .eTag(etag)
        .body(user);
}
```

### Pagination Response

```java
@Data
@AllArgsConstructor
public class PageResponse<T> {
    private List<T> content;
    private int pageNumber;
    private int pageSize;
    private long totalElements;
    private int totalPages;
    private boolean first;
    private boolean last;
}

@GetMapping
public ResponseEntity<PageResponse<User>> getUsers(
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size) {
    
    Page<User> userPage = userService.findAll(PageRequest.of(page, size));
    
    PageResponse<User> response = new PageResponse<>(
        userPage.getContent(),
        userPage.getNumber(),
        userPage.getSize(),
        userPage.getTotalElements(),
        userPage.getTotalPages(),
        userPage.isFirst(),
        userPage.isLast()
    );
    
    return ResponseEntity.ok(response);
}
```

### Error Response

```java
@Data
@AllArgsConstructor
public class ErrorResponse {
    private int status;
    private String message;
    private LocalDateTime timestamp;
    private List<String> errors;
}

@ExceptionHandler(ResourceNotFoundException.class)
public ResponseEntity<ErrorResponse> handleResourceNotFound(ResourceNotFoundException ex) {
    ErrorResponse error = new ErrorResponse(
        HttpStatus.NOT_FOUND.value(),
        ex.getMessage(),
        LocalDateTime.now(),
        Collections.emptyList()
    );
    
    return ResponseEntity
        .status(HttpStatus.NOT_FOUND)
        .body(error);
}

@ExceptionHandler(ValidationException.class)
public ResponseEntity<ErrorResponse> handleValidation(ValidationException ex) {
    ErrorResponse error = new ErrorResponse(
        HttpStatus.BAD_REQUEST.value(),
        "Validation failed",
        LocalDateTime.now(),
        ex.getErrors()
    );
    
    return ResponseEntity
        .status(HttpStatus.BAD_REQUEST)
        .body(error);
}
```

---

## ‚úÖ Request Validation

### Basic Validation

```java
@Data
public class CreateUserRequest {
    @NotBlank(message = "Name is required")
    @Size(min = 2, max = 50, message = "Name must be between 2 and 50 characters")
    private String name;
    
    @NotBlank(message = "Email is required")
    @Email(message = "Invalid email format")
    private String email;
    
    @NotNull(message = "Age is required")
    @Min(value = 18, message = "Age must be at least 18")
    @Max(value = 150, message = "Age must be less than 150")
    private Integer age;
}

@PostMapping("/users")
public ResponseEntity<User> createUser(@Valid @RequestBody CreateUserRequest request) {
    User user = userService.create(request);
    return ResponseEntity.status(HttpStatus.CREATED).body(user);
}
```

### Validation Groups

```java
public interface CreateValidation {}
public interface UpdateValidation {}

@Data
public class UserRequest {
    @Null(groups = CreateValidation.class)
    @NotNull(groups = UpdateValidation.class)
    private Long id;
    
    @NotBlank(groups = {CreateValidation.class, UpdateValidation.class})
    private String name;
    
    @NotBlank(groups = CreateValidation.class)
    @Email(groups = {CreateValidation.class, UpdateValidation.class})
    private String email;
}

@PostMapping("/users")
public ResponseEntity<User> createUser(
        @Validated(CreateValidation.class) @RequestBody UserRequest request) {
    User user = userService.create(request);
    return ResponseEntity.status(HttpStatus.CREATED).body(user);
}

@PutMapping("/users/{id}")
public ResponseEntity<User> updateUser(
        @PathVariable Long id,
        @Validated(UpdateValidation.class) @RequestBody UserRequest request) {
    User user = userService.update(id, request);
    return ResponseEntity.ok(user);
}
```

### Custom Validator

```java
// Custom annotation
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = PhoneNumberValidator.class)
public @interface ValidPhoneNumber {
    String message() default "Invalid phone number";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

// Validator implementation
public class PhoneNumberValidator implements ConstraintValidator<ValidPhoneNumber, String> {
    
    private static final Pattern PHONE_PATTERN = Pattern.compile("^\\+?[1-9]\\d{1,14}$");
    
    @Override
    public boolean isValid(String value, ConstraintValidatorContext context) {
        if (value == null) {
            return true; // Use @NotNull for null check
        }
        return PHONE_PATTERN.matcher(value).matches();
    }
}

// Usage
@Data
public class CreateUserRequest {
    @NotBlank
    private String name;
    
    @Email
    private String email;
    
    @ValidPhoneNumber
    private String phoneNumber;
}
```

### Validation Exception Handler

```java
@RestControllerAdvice
public class ValidationExceptionHandler {
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String, Object>> handleValidationException(
            MethodArgumentNotValidException ex) {
        
        Map<String, String> fieldErrors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error -> {
            fieldErrors.put(error.getField(), error.getDefaultMessage());
        });
        
        Map<String, Object> response = new HashMap<>();
        response.put("timestamp", LocalDateTime.now());
        response.put("status", HttpStatus.BAD_REQUEST.value());
        response.put("message", "Validation failed");
        response.put("errors", fieldErrors);
        
        return ResponseEntity
            .status(HttpStatus.BAD_REQUEST)
            .body(response);
    }
}
```

**Error Response:**
```json
{
  "timestamp": "2024-01-15T10:30:00",
  "status": 400,
  "message": "Validation failed",
  "errors": {
    "name": "Name is required",
    "email": "Invalid email format",
    "age": "Age must be at least 18"
  }
}
```

---

## üìã Response Headers

### Common Headers

```java
@GetMapping("/users/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    
    return ResponseEntity.ok()
        // Caching
        .cacheControl(CacheControl.maxAge(1, TimeUnit.HOURS))
        .lastModified(user.getUpdatedAt().toEpochSecond(ZoneOffset.UTC))
        
        // Content
        .contentType(MediaType.APPLICATION_JSON)
        
        // Custom
        .header("X-API-Version", "1.0")
        .header("X-Request-ID", UUID.randomUUID().toString())
        
        .body(user);
}
```

### CORS Headers

```java
@GetMapping("/users")
public ResponseEntity<List<User>> getUsers() {
    List<User> users = userService.findAll();
    
    HttpHeaders headers = new HttpHeaders();
    headers.add("Access-Control-Allow-Origin", "*");
    headers.add("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
    headers.add("Access-Control-Allow-Headers", "Content-Type, Authorization");
    
    return ResponseEntity.ok()
        .headers(headers)
        .body(users);
}
```

### Content Disposition

```java
@GetMapping("/users/{id}/export")
public ResponseEntity<byte[]> exportUser(@PathVariable Long id) {
    User user = userService.findById(id);
    byte[] data = exportService.exportToCSV(user);
    
    return ResponseEntity.ok()
        .header(HttpHeaders.CONTENT_DISPOSITION, 
                "attachment; filename=\"user-" + id + ".csv\"")
        .contentType(MediaType.parseMediaType("text/csv"))
        .body(data);
}
```

---

## üîÑ Content Negotiation

### JSON and XML

```java
@GetMapping(value = "/users/{id}", 
            produces = {MediaType.APPLICATION_JSON_VALUE, MediaType.APPLICATION_XML_VALUE})
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    return ResponseEntity.ok(user);
}
```

**Requests:**
```http
GET /users/123
Accept: application/json

GET /users/123
Accept: application/xml
```

### Custom Media Type

```java
@GetMapping(value = "/users/{id}", 
            produces = {"application/vnd.company.user.v1+json", 
                       "application/vnd.company.user.v2+json"})
public ResponseEntity<User> getUser(
        @PathVariable Long id,
        @RequestHeader("Accept") String acceptHeader) {
    
    User user = userService.findById(id);
    
    if (acceptHeader.contains("v2")) {
        return ResponseEntity.ok(userService.toV2(user));
    }
    
    return ResponseEntity.ok(user);
}
```

---

## üìå Best Practices

### 1. Use DTOs for Request/Response

```java
// ‚úÖ Good - Separate DTOs
@PostMapping("/users")
public ResponseEntity<UserResponse> createUser(
        @Valid @RequestBody CreateUserRequest request) {
    User user = userService.create(request);
    return ResponseEntity
        .status(HttpStatus.CREATED)
        .body(mapToResponse(user));
}

// ‚ùå Bad - Using entity directly
@PostMapping("/users")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}
```

### 2. Always Validate Input

```java
// ‚úÖ Good
@PostMapping("/users")
public ResponseEntity<User> createUser(@Valid @RequestBody CreateUserRequest request) {
    User user = userService.create(request);
    return ResponseEntity.status(HttpStatus.CREATED).body(user);
}

// ‚ùå Bad - No validation
@PostMapping("/users")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}
```

### 3. Use Appropriate Status Codes

```java
// ‚úÖ Good
@PostMapping("/users")
public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
    User created = userService.save(user);
    return ResponseEntity.status(HttpStatus.CREATED).body(created); // 201
}

@GetMapping("/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    return userService.findById(id)
        .map(ResponseEntity::ok)                    // 200
        .orElse(ResponseEntity.notFound().build()); // 404
}

@DeleteMapping("/{id}")
public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
    userService.delete(id);
    return ResponseEntity.noContent().build(); // 204
}
```

### 4. Include Location Header for Created Resources

```java
// ‚úÖ Good
@PostMapping("/users")
public ResponseEntity<User> createUser(@Valid @RequestBody User user) {
    User created = userService.save(user);
    
    URI location = ServletUriComponentsBuilder
        .fromCurrentRequest()
        .path("/{id}")
        .buildAndExpand(created.getId())
        .toUri();
    
    return ResponseEntity.created(location).body(created);
}
```

### 5. Handle Exceptions Properly

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidation(MethodArgumentNotValidException ex) {
        // Handle validation errors
    }
    
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFound(ResourceNotFoundException ex) {
        // Handle not found errors
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGeneral(Exception ex) {
        // Handle general errors
    }
}
```

### 6. Use Pagination for Large Collections

```java
// ‚úÖ Good
@GetMapping("/users")
public ResponseEntity<Page<User>> getUsers(Pageable pageable) {
    Page<User> users = userService.findAll(pageable);
    return ResponseEntity.ok(users);
}

// ‚ùå Bad - Returns all data
@GetMapping("/users")
public List<User> getUsers() {
    return userService.findAll(); // Could be thousands of records
}
```

### 7. Document API with Examples

```java
@PostMapping("/users")
@Operation(summary = "Create a new user")
@ApiResponses({
    @ApiResponse(responseCode = "201", description = "User created successfully"),
    @ApiResponse(responseCode = "400", description = "Invalid input"),
    @ApiResponse(responseCode = "409", description = "User already exists")
})
public ResponseEntity<UserResponse> createUser(
        @io.swagger.v3.oas.annotations.parameters.RequestBody(
            description = "User creation request",
            required = true,
            content = @Content(
                schema = @Schema(implementation = CreateUserRequest.class),
                examples = @ExampleObject(
                    value = "{\"name\":\"John Doe\",\"email\":\"john@example.com\",\"age\":30}"
                )
            )
        )
        @Valid @RequestBody CreateUserRequest request) {
    
    User user = userService.create(request);
    return ResponseEntity.status(HttpStatus.CREATED).body(mapToResponse(user));
}
```

---

## üé§ Interview Questions

### Q1: What is @RequestBody?
**Answer:** Deserializes HTTP request body to Java object using HttpMessageConverter (Jackson for JSON).

### Q2: What is ResponseEntity?
**Answer:** Wrapper for HTTP response allowing customization of body, headers, and status code.

### Q3: Difference between @RequestBody and @RequestParam?
**Answer:**
- **@RequestBody**: Request body (POST/PUT), complex objects
- **@RequestParam**: Query parameters, simple values

### Q4: How to validate @RequestBody?
**Answer:** Use @Valid with validation annotations:
```java
@PostMapping("/users")
public User createUser(@Valid @RequestBody User user) { }
```

### Q5: What is DTO and why use it?
**Answer:** Data Transfer Object - separates API contract from domain model. Prevents exposing sensitive data, allows versioning, and provides validation.

### Q6: How to return different status codes?
**Answer:** Use ResponseEntity:
```java
return ResponseEntity.status(HttpStatus.CREATED).body(user); // 201
return ResponseEntity.ok(user);                              // 200
return ResponseEntity.notFound().build();                    // 404
return ResponseEntity.noContent().build();                   // 204
```

### Q7: How to add custom headers?
**Answer:**
```java
return ResponseEntity.ok()
    .header("X-Custom-Header", "value")
    .body(data);
```

### Q8: What is Content Negotiation?
**Answer:** Selecting response format based on Accept header. Spring supports JSON, XML, etc.

### Q9: How to handle validation errors?
**Answer:** Use @RestControllerAdvice with @ExceptionHandler:
```java
@ExceptionHandler(MethodArgumentNotValidException.class)
public ResponseEntity<ErrorResponse> handleValidation(MethodArgumentNotValidException ex) {
    // Extract field errors and return
}
```

### Q10: What is the Location header?
**Answer:** Indicates URI of newly created resource. Used with 201 Created:
```java
URI location = ServletUriComponentsBuilder
    .fromCurrentRequest()
    .path("/{id}")
    .buildAndExpand(created.getId())
    .toUri();
return ResponseEntity.created(location).body(created);
```

---

## üìö Summary

### @RequestBody

```java
// Basic
@PostMapping("/users")
public User createUser(@RequestBody User user) { }

// With validation
@PostMapping("/users")
public User createUser(@Valid @RequestBody User user) { }

// With DTO
@PostMapping("/users")
public UserResponse createUser(@Valid @RequestBody CreateUserRequest request) { }
```

### ResponseEntity

```java
// Different status codes
ResponseEntity.ok(data);                      // 200
ResponseEntity.status(HttpStatus.CREATED);    // 201
ResponseEntity.noContent().build();           // 204
ResponseEntity.badRequest().build();          // 400
ResponseEntity.notFound().build();            // 404

// With headers
ResponseEntity.ok()
    .header("X-Custom", "value")
    .body(data);

// With location
URI location = ...;
ResponseEntity.created(location).body(data);
```

### Complete Example

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @PostMapping
    public ResponseEntity<UserResponse> createUser(
            @Valid @RequestBody CreateUserRequest request) {
        
        User user = userService.create(request);
        
        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(user.getId())
            .toUri();
        
        return ResponseEntity
            .created(location)
            .body(mapToResponse(user));
    }
    
    @GetMapping("/{id}")
    public ResponseEntity<UserResponse> getUser(@PathVariable Long id) {
        return userService.findById(id)
            .map(this::mapToResponse)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }
    
    @PutMapping("/{id}")
    public ResponseEntity<UserResponse> updateUser(
            @PathVariable Long id,
            @Valid @RequestBody UpdateUserRequest request) {
        
        return userService.update(id, request)
            .map(this::mapToResponse)
            .map(ResponseEntity::ok)
            .orElse(ResponseEntity.notFound().build());
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        userService.delete(id);
        return ResponseEntity.noContent().build();
    }
}
```

**Next:** HTTP Status Codes ‚Üí

