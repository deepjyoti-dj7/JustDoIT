# ðŸ”„ Content Negotiation - Complete Guide

## ðŸ“‹ Table of Contents
- [Introduction](#introduction)
- [Accept Header](#accept-header)
- [Content-Type Header](#content-type)
- [Produces and Consumes](#produces-and-consumes)
- [Message Converters](#message-converters)
- [Custom Media Types](#custom-media-types)
- [API Versioning](#api-versioning)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## ðŸŽ¯ Introduction

**Content Negotiation** allows server and client to agree on response format (JSON, XML, etc.).

### Key Concepts

- **Accept**: Client specifies desired response format
- **Content-Type**: Indicates format of request/response body
- **Produces**: Server specifies what it can produce
- **Consumes**: Server specifies what it can consume

---

## ðŸ“¨ Accept Header

### Basic Usage

```java
@GetMapping("/users/{id}")
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

**Requests:**
```http
GET /users/123
Accept: application/json
â†’ Returns JSON

GET /users/123
Accept: application/xml
â†’ Returns XML (if configured)
```

### Multiple Accept Types

```java
@GetMapping(value = "/users/{id}", 
            produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

**Requests:**
```http
GET /users/123
Accept: application/json
â†’ {"id":123,"name":"John"}

GET /users/123
Accept: application/xml
â†’ <user><id>123</id><name>John</name></user>
```

### Accept Priority

```http
Accept: application/json, application/xml;q=0.9, text/html;q=0.8

# Priority:
# 1. application/json (q=1.0, default)
# 2. application/xml (q=0.9)
# 3. text/html (q=0.8)
```

### Reading Accept Header

```java
@GetMapping("/users/{id}")
public ResponseEntity<User> getUser(
        @PathVariable Long id,
        @RequestHeader("Accept") String acceptHeader) {
    
    User user = userService.findById(id);
    
    if (acceptHeader.contains("application/json")) {
        // Return JSON
        return ResponseEntity.ok()
            .contentType(MediaType.APPLICATION_JSON)
            .body(user);
    } else if (acceptHeader.contains("application/xml")) {
        // Return XML
        return ResponseEntity.ok()
            .contentType(MediaType.APPLICATION_XML)
            .body(user);
    }
    
    return ResponseEntity.ok(user);
}
```

---

## ðŸ“¤ Content-Type Header

### Request Content-Type

```java
@PostMapping("/users")
public User createUser(@RequestBody User user) {
    return userService.save(user);
}
```

**Request:**
```http
POST /users
Content-Type: application/json

{
  "name": "John",
  "email": "john@example.com"
}
```

### Specifying Content-Type

```java
@PostMapping(value = "/users", consumes = MediaType.APPLICATION_JSON_VALUE)
public User createUserJson(@RequestBody User user) {
    return userService.save(user);
}

@PostMapping(value = "/users", consumes = MediaType.APPLICATION_XML_VALUE)
public User createUserXml(@RequestBody User user) {
    return userService.save(user);
}
```

### Response Content-Type

```java
@GetMapping("/users/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    
    return ResponseEntity.ok()
        .contentType(MediaType.APPLICATION_JSON)
        .body(user);
}
```

---

## ðŸŽ¯ Produces and Consumes

### @Produces

```java
// Single media type
@GetMapping(value = "/users/{id}", produces = MediaType.APPLICATION_JSON_VALUE)
public User getUserJson(@PathVariable Long id) {
    return userService.findById(id);
}

// Multiple media types
@GetMapping(value = "/users/{id}", 
            produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}

// Custom media type
@GetMapping(value = "/users/{id}", 
            produces = "application/vnd.company.user.v1+json")
public User getUserV1(@PathVariable Long id) {
    return userService.findById(id);
}
```

### @Consumes

```java
// Single media type
@PostMapping(value = "/users", consumes = MediaType.APPLICATION_JSON_VALUE)
public User createUserJson(@RequestBody User user) {
    return userService.save(user);
}

// Multiple media types
@PostMapping(value = "/users", 
             consumes = {MediaType.APPLICATION_JSON_VALUE, 
                        MediaType.APPLICATION_XML_VALUE})
public User createUser(@RequestBody User user) {
    return userService.save(user);
}

// Form data
@PostMapping(value = "/users/form", 
             consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE)
public User createUserFromForm(@ModelAttribute User user) {
    return userService.save(user);
}

// Multipart form data (file upload)
@PostMapping(value = "/users/upload", 
             consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public User uploadUser(
        @RequestParam("file") MultipartFile file,
        @RequestParam("name") String name) {
    return userService.createFromFile(file, name);
}
```

### Both Produces and Consumes

```java
@PostMapping(value = "/users", 
             consumes = MediaType.APPLICATION_JSON_VALUE,
             produces = MediaType.APPLICATION_JSON_VALUE)
public User createUser(@RequestBody User user) {
    return userService.save(user);
}
```

### Class-Level Configuration

```java
@RestController
@RequestMapping(value = "/api/users",
                produces = MediaType.APPLICATION_JSON_VALUE,
                consumes = MediaType.APPLICATION_JSON_VALUE)
public class UserController {
    
    // All methods inherit produces and consumes
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    // Override at method level
    @GetMapping(value = "/{id}", produces = MediaType.APPLICATION_XML_VALUE)
    public User getUserXml(@PathVariable Long id) {
        return userService.findById(id);
    }
}
```

---

## ðŸ”§ Message Converters

### Jackson (JSON)

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <!-- Jackson included by default -->
</dependency>
```

```java
// Automatic JSON conversion
@GetMapping("/users/{id}")
public User getUser(@PathVariable Long id) {
    return userService.findById(id); // Automatically converted to JSON
}
```

### JAXB (XML)

```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
</dependency>
```

```java
@Data
@XmlRootElement(name = "user")
@XmlAccessorType(XmlAccessType.FIELD)
public class User {
    @XmlElement
    private Long id;
    
    @XmlElement
    private String name;
    
    @XmlElement
    private String email;
}

@GetMapping(value = "/users/{id}", produces = MediaType.APPLICATION_XML_VALUE)
public User getUserXml(@PathVariable Long id) {
    return userService.findById(id);
}
```

**Response:**
```xml
<user>
  <id>123</id>
  <name>John Doe</name>
  <email>john@example.com</email>
</user>
```

### Custom Message Converter

```java
public class CsvHttpMessageConverter extends AbstractHttpMessageConverter<List<User>> {
    
    public CsvHttpMessageConverter() {
        super(MediaType.parseMediaType("text/csv"));
    }
    
    @Override
    protected boolean supports(Class<?> clazz) {
        return List.class.isAssignableFrom(clazz);
    }
    
    @Override
    protected List<User> readInternal(
            Class<? extends List<User>> clazz,
            HttpInputMessage inputMessage) throws IOException {
        // Parse CSV to List<User>
        return parseCsv(inputMessage.getBody());
    }
    
    @Override
    protected void writeInternal(
            List<User> users,
            HttpOutputMessage outputMessage) throws IOException {
        
        String csv = users.stream()
            .map(user -> user.getId() + "," + user.getName() + "," + user.getEmail())
            .collect(Collectors.joining("\n"));
        
        outputMessage.getBody().write(csv.getBytes());
    }
}

// Register converter
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        converters.add(new CsvHttpMessageConverter());
    }
}

// Usage
@GetMapping(value = "/users", produces = "text/csv")
public List<User> getUsersCsv() {
    return userService.findAll();
}
```

**Response:**
```
1,John Doe,john@example.com
2,Jane Smith,jane@example.com
3,Bob Johnson,bob@example.com
```

### Configure Jackson

```java
@Configuration
public class JacksonConfig {
    
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        
        // Pretty print
        mapper.enable(SerializationFeature.INDENT_OUTPUT);
        
        // Ignore null values
        mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        
        // Date format
        mapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
        
        // Handle unknown properties
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        
        return mapper;
    }
}
```

---

## ðŸŽ¨ Custom Media Types

### Vendor-Specific Media Types

```java
@GetMapping(value = "/users/{id}", 
            produces = "application/vnd.company.user.v1+json")
public UserV1 getUserV1(@PathVariable Long id) {
    return userService.findByIdV1(id);
}

@GetMapping(value = "/users/{id}", 
            produces = "application/vnd.company.user.v2+json")
public UserV2 getUserV2(@PathVariable Long id) {
    return userService.findByIdV2(id);
}
```

**Request:**
```http
GET /users/123
Accept: application/vnd.company.user.v2+json
```

### Custom Media Type Constants

```java
public class CustomMediaTypes {
    public static final String USER_V1_JSON = "application/vnd.company.user.v1+json";
    public static final String USER_V2_JSON = "application/vnd.company.user.v2+json";
    public static final MediaType USER_V1_JSON_TYPE = MediaType.parseMediaType(USER_V1_JSON);
    public static final MediaType USER_V2_JSON_TYPE = MediaType.parseMediaType(USER_V2_JSON);
}

@GetMapping(value = "/users/{id}", produces = CustomMediaTypes.USER_V1_JSON)
public UserV1 getUserV1(@PathVariable Long id) {
    return userService.findByIdV1(id);
}
```

### Content Type Based Routing

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @GetMapping(value = "/{id}", 
                produces = MediaType.APPLICATION_JSON_VALUE,
                headers = "X-API-Version=1")
    public UserV1 getUserV1(@PathVariable Long id) {
        return userService.findByIdV1(id);
    }
    
    @GetMapping(value = "/{id}", 
                produces = MediaType.APPLICATION_JSON_VALUE,
                headers = "X-API-Version=2")
    public UserV2 getUserV2(@PathVariable Long id) {
        return userService.findByIdV2(id);
    }
}
```

**Request:**
```http
GET /api/users/123
Accept: application/json
X-API-Version: 2
```

---

## ðŸ”¢ API Versioning

### URL Versioning

```java
@RestController
@RequestMapping("/api/v1/users")
public class UserControllerV1 {
    
    @GetMapping("/{id}")
    public UserV1 getUser(@PathVariable Long id) {
        return userService.findByIdV1(id);
    }
}

@RestController
@RequestMapping("/api/v2/users")
public class UserControllerV2 {
    
    @GetMapping("/{id}")
    public UserV2 getUser(@PathVariable Long id) {
        return userService.findByIdV2(id);
    }
}
```

**Requests:**
```http
GET /api/v1/users/123
GET /api/v2/users/123
```

### Header Versioning

```java
@GetMapping(value = "/users/{id}", headers = "X-API-Version=1")
public UserV1 getUserV1(@PathVariable Long id) {
    return userService.findByIdV1(id);
}

@GetMapping(value = "/users/{id}", headers = "X-API-Version=2")
public UserV2 getUserV2(@PathVariable Long id) {
    return userService.findByIdV2(id);
}
```

**Requests:**
```http
GET /users/123
X-API-Version: 1

GET /users/123
X-API-Version: 2
```

### Accept Header Versioning

```java
@GetMapping(value = "/users/{id}", 
            produces = "application/vnd.company.user.v1+json")
public UserV1 getUserV1(@PathVariable Long id) {
    return userService.findByIdV1(id);
}

@GetMapping(value = "/users/{id}", 
            produces = "application/vnd.company.user.v2+json")
public UserV2 getUserV2(@PathVariable Long id) {
    return userService.findByIdV2(id);
}
```

**Requests:**
```http
GET /users/123
Accept: application/vnd.company.user.v1+json

GET /users/123
Accept: application/vnd.company.user.v2+json
```

### Parameter Versioning

```java
@GetMapping("/users/{id}")
public ResponseEntity<?> getUser(
        @PathVariable Long id,
        @RequestParam(defaultValue = "1") int version) {
    
    if (version == 1) {
        return ResponseEntity.ok(userService.findByIdV1(id));
    } else if (version == 2) {
        return ResponseEntity.ok(userService.findByIdV2(id));
    }
    
    return ResponseEntity.badRequest().body("Unsupported version");
}
```

**Requests:**
```http
GET /users/123?version=1
GET /users/123?version=2
```

---

## ðŸ“Œ Best Practices

### 1. Support Common Formats

```java
// âœ… Good - Support JSON and XML
@GetMapping(value = "/users/{id}", 
            produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

### 2. Set Default Media Type

```java
// âœ… Good - Default to JSON
@RestController
@RequestMapping(value = "/api/users",
                produces = MediaType.APPLICATION_JSON_VALUE)
public class UserController {
    // Methods default to JSON
}
```

### 3. Use Vendor-Specific Media Types for Versioning

```java
// âœ… Good
@GetMapping(produces = "application/vnd.company.user.v1+json")
public UserV1 getUserV1() { }

@GetMapping(produces = "application/vnd.company.user.v2+json")
public UserV2 getUserV2() { }
```

### 4. Handle Unsupported Media Types

```java
@ExceptionHandler(HttpMediaTypeNotSupportedException.class)
public ResponseEntity<ErrorResponse> handleUnsupportedMediaType(
        HttpMediaTypeNotSupportedException ex) {
    
    ErrorResponse error = new ErrorResponse(
        HttpStatus.UNSUPPORTED_MEDIA_TYPE.value(),
        "Unsupported media type: " + ex.getContentType(),
        "Supported types: " + ex.getSupportedMediaTypes()
    );
    
    return ResponseEntity
        .status(HttpStatus.UNSUPPORTED_MEDIA_TYPE)
        .body(error);
}
```

### 5. Handle Unacceptable Media Types

```java
@ExceptionHandler(HttpMediaTypeNotAcceptableException.class)
public ResponseEntity<ErrorResponse> handleNotAcceptable(
        HttpMediaTypeNotAcceptableException ex) {
    
    ErrorResponse error = new ErrorResponse(
        HttpStatus.NOT_ACCEPTABLE.value(),
        "Cannot produce acceptable response format",
        "Supported types: " + ex.getSupportedMediaTypes()
    );
    
    return ResponseEntity
        .status(HttpStatus.NOT_ACCEPTABLE)
        .body(error);
}
```

### 6. Document Supported Media Types

```java
@GetMapping(value = "/users/{id}", 
            produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})
@Operation(summary = "Get user by ID")
@ApiResponses({
    @ApiResponse(responseCode = "200", description = "User found",
                 content = {
                     @Content(mediaType = "application/json", 
                             schema = @Schema(implementation = User.class)),
                     @Content(mediaType = "application/xml", 
                             schema = @Schema(implementation = User.class))
                 }),
    @ApiResponse(responseCode = "404", description = "User not found"),
    @ApiResponse(responseCode = "406", description = "Not acceptable")
})
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

### 7. Configure Content Negotiation

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void configureContentNegotiation(ContentNegotiationConfigurer configurer) {
        configurer
            // Favor Accept header
            .favorParameter(false)
            .favorPathExtension(false)
            
            // Default to JSON
            .defaultContentType(MediaType.APPLICATION_JSON)
            
            // Support these media types
            .mediaType("json", MediaType.APPLICATION_JSON)
            .mediaType("xml", MediaType.APPLICATION_XML);
    }
}
```

---

## ðŸŽ¤ Interview Questions

### Q1: What is Content Negotiation?
**Answer:** Process where server and client agree on response format (JSON, XML, etc.) based on Accept header and server capabilities.

### Q2: What is the Accept header?
**Answer:** HTTP header sent by client specifying desired response format:
```http
Accept: application/json
Accept: application/xml
Accept: application/json, application/xml;q=0.9
```

### Q3: What is Content-Type header?
**Answer:** HTTP header indicating format of request/response body:
```http
Content-Type: application/json
Content-Type: application/xml
```

### Q4: Difference between produces and consumes?
**Answer:**
- **produces**: Media types server can produce (response format)
- **consumes**: Media types server can consume (request format)

### Q5: How to support multiple formats?
**Answer:**
```java
@GetMapping(produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

### Q6: What are Message Converters?
**Answer:** Components that convert HTTP request/response bodies to/from Java objects. Examples: Jackson (JSON), JAXB (XML).

### Q7: How to create custom Message Converter?
**Answer:** Extend `AbstractHttpMessageConverter`:
```java
public class CsvConverter extends AbstractHttpMessageConverter<List<User>> {
    // Implement readInternal and writeInternal
}
```

### Q8: What is vendor-specific media type?
**Answer:** Custom media type for API versioning:
```
application/vnd.company.user.v1+json
application/vnd.company.user.v2+json
```

### Q9: API versioning strategies?
**Answer:**
- **URL**: `/api/v1/users`, `/api/v2/users`
- **Header**: `X-API-Version: 1`
- **Accept**: `application/vnd.company.v1+json`
- **Parameter**: `/users?version=1`

### Q10: What is 406 Not Acceptable?
**Answer:** HTTP status code returned when server cannot produce response in format requested by Accept header.

---

## ðŸ“š Summary

### Content Negotiation Basics

```java
// Accept header
GET /users/123
Accept: application/json â†’ Returns JSON

GET /users/123
Accept: application/xml â†’ Returns XML

// Content-Type header
POST /users
Content-Type: application/json
â†’ Request body is JSON
```

### Produces and Consumes

```java
// Produces - what server can return
@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
@GetMapping(produces = {MediaType.APPLICATION_JSON_VALUE, 
                       MediaType.APPLICATION_XML_VALUE})

// Consumes - what server can accept
@PostMapping(consumes = MediaType.APPLICATION_JSON_VALUE)
@PostMapping(consumes = {MediaType.APPLICATION_JSON_VALUE, 
                        MediaType.APPLICATION_XML_VALUE})

// Both
@PostMapping(consumes = MediaType.APPLICATION_JSON_VALUE,
             produces = MediaType.APPLICATION_JSON_VALUE)
```

### Media Types

```java
MediaType.APPLICATION_JSON_VALUE       // application/json
MediaType.APPLICATION_XML_VALUE        // application/xml
MediaType.APPLICATION_FORM_URLENCODED  // application/x-www-form-urlencoded
MediaType.MULTIPART_FORM_DATA          // multipart/form-data
MediaType.TEXT_PLAIN                   // text/plain
MediaType.TEXT_HTML                    // text/html

// Custom
"application/vnd.company.user.v1+json"
```

### Complete Example

```java
@RestController
@RequestMapping(value = "/api/users",
                produces = MediaType.APPLICATION_JSON_VALUE,
                consumes = MediaType.APPLICATION_JSON_VALUE)
public class UserController {
    
    @GetMapping(value = "/{id}", 
                produces = {MediaType.APPLICATION_JSON_VALUE, 
                           MediaType.APPLICATION_XML_VALUE})
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    @PostMapping(consumes = {MediaType.APPLICATION_JSON_VALUE, 
                            MediaType.APPLICATION_XML_VALUE})
    public ResponseEntity<User> createUser(@RequestBody User user) {
        User created = userService.save(user);
        return ResponseEntity.status(HttpStatus.CREATED).body(created);
    }
}
```

**Next:** HATEOAS â†’

