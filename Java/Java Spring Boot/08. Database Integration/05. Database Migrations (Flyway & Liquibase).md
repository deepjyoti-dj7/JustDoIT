# üîÑ Database Migrations (Flyway & Liquibase) - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [Flyway Setup](#flyway-setup)
- [Flyway Migrations](#flyway-migrations)
- [Liquibase Setup](#liquibase-setup)
- [Liquibase Changesets](#liquibase-changesets)
- [Migration Strategies](#migration-strategies)
- [Flyway vs Liquibase](#flyway-vs-liquibase)
- [Production Deployment](#production-deployment)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**Database Migrations** manage incremental, versioned database schema changes in a controlled, repeatable manner.

### Why Database Migrations?

| Without Migrations | With Migrations |
|-------------------|-----------------|
| Manual SQL scripts | Automated version control |
| Inconsistent environments | Consistent across all envs |
| No rollback strategy | Easy rollback |
| Error-prone | Repeatable, tested |
| Hard to track changes | Complete audit trail |

### Benefits

1. **Version Control**: Schema changes tracked like code
2. **Repeatable**: Same migrations across dev, test, prod
3. **Rollback**: Undo changes safely
4. **Team Collaboration**: Avoid conflicting schema changes
5. **CI/CD Integration**: Automated deployments

---

## üöÄ Flyway Setup

### Maven Dependency

```xml
<dependencies>
    <!-- Flyway Core -->
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
    </dependency>
    
    <!-- Database Driver -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

### Application Properties

```properties
# DataSource
spring.datasource.url=jdbc:mysql://localhost:3306/mydb
spring.datasource.username=root
spring.datasource.password=password

# Flyway Configuration
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.baseline-version=0
spring.flyway.validate-on-migrate=true
spring.flyway.out-of-order=false

# Disable JPA DDL auto (important!)
spring.jpa.hibernate.ddl-auto=none
```

### Folder Structure

```
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îú‚îÄ‚îÄ java/
‚îÇ   ‚îî‚îÄ‚îÄ resources/
‚îÇ       ‚îî‚îÄ‚îÄ db/
‚îÇ           ‚îî‚îÄ‚îÄ migration/
‚îÇ               ‚îú‚îÄ‚îÄ V1__Create_users_table.sql
‚îÇ               ‚îú‚îÄ‚îÄ V2__Add_email_to_users.sql
‚îÇ               ‚îî‚îÄ‚îÄ V3__Create_orders_table.sql
```

### Naming Convention

```
V{version}__{description}.sql

Examples:
V1__Initial_schema.sql
V2__Add_users_table.sql
V2.1__Add_email_column.sql
V3__Create_orders_table.sql
```

---

## üìù Flyway Migrations

### V1: Initial Schema

```sql
-- V1__Initial_schema.sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_username ON users(username);
```

### V2: Add Column

```sql
-- V2__Add_email_to_users.sql
ALTER TABLE users ADD COLUMN email VARCHAR(255) NOT NULL;
ALTER TABLE users ADD UNIQUE INDEX idx_email (email);
```

### V3: Create New Table

```sql
-- V3__Create_orders_table.sql
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    order_number VARCHAR(50) NOT NULL UNIQUE,
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_user_id ON orders(user_id);
CREATE INDEX idx_status ON orders(status);
```

### V4: Data Migration

```sql
-- V4__Migrate_user_data.sql
-- Update existing users with default email
UPDATE users 
SET email = CONCAT(username, '@example.com') 
WHERE email IS NULL;

-- Add NOT NULL constraint
ALTER TABLE users MODIFY COLUMN email VARCHAR(255) NOT NULL;
```

### V5: Complex Migration

```sql
-- V5__Refactor_user_names.sql
-- Split full_name into first_name and last_name
ALTER TABLE users ADD COLUMN first_name VARCHAR(100);
ALTER TABLE users ADD COLUMN last_name VARCHAR(100);

UPDATE users 
SET 
    first_name = SUBSTRING_INDEX(full_name, ' ', 1),
    last_name = SUBSTRING_INDEX(full_name, ' ', -1);

ALTER TABLE users DROP COLUMN full_name;
```

### Repeatable Migrations

```sql
-- R__Create_view_active_users.sql
-- Runs every time checksum changes
CREATE OR REPLACE VIEW active_users AS
SELECT id, username, email
FROM users
WHERE status = 'ACTIVE';
```

---

## üîß Liquibase Setup

### Maven Dependency

```xml
<dependencies>
    <!-- Liquibase Core -->
    <dependency>
        <groupId>org.liquibase</groupId>
        <artifactId>liquibase-core</artifactId>
    </dependency>
    
    <!-- Database Driver -->
    <dependency>
        <groupId>com.mysql</groupId>
        <artifactId>mysql-connector-j</artifactId>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

### Application Properties

```properties
# Liquibase Configuration
spring.liquibase.enabled=true
spring.liquibase.change-log=classpath:db/changelog/db.changelog-master.xml
spring.liquibase.default-schema=mydb

# Disable JPA DDL auto
spring.jpa.hibernate.ddl-auto=none
```

### Folder Structure

```
src/
‚îú‚îÄ‚îÄ main/
‚îÇ   ‚îî‚îÄ‚îÄ resources/
‚îÇ       ‚îî‚îÄ‚îÄ db/
‚îÇ           ‚îî‚îÄ‚îÄ changelog/
‚îÇ               ‚îú‚îÄ‚îÄ db.changelog-master.xml
‚îÇ               ‚îú‚îÄ‚îÄ changes/
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ 001-create-users-table.xml
‚îÇ               ‚îÇ   ‚îú‚îÄ‚îÄ 002-add-email-column.xml
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ 003-create-orders-table.xml
‚îÇ               ‚îî‚îÄ‚îÄ sql/
‚îÇ                   ‚îî‚îÄ‚îÄ sample-data.sql
```

### Master Changelog

```xml
<!-- db.changelog-master.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <include file="db/changelog/changes/001-create-users-table.xml"/>
    <include file="db/changelog/changes/002-add-email-column.xml"/>
    <include file="db/changelog/changes/003-create-orders-table.xml"/>
</databaseChangeLog>
```

---

## üìã Liquibase Changesets

### XML Format: Create Table

```xml
<!-- 001-create-users-table.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <changeSet id="1" author="john">
        <createTable tableName="users">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_date" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        
        <createIndex tableName="users" indexName="idx_username">
            <column name="username"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
```

### XML Format: Add Column

```xml
<!-- 002-add-email-column.xml -->
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <changeSet id="2" author="john">
        <addColumn tableName="users">
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <createIndex tableName="users" indexName="idx_email">
            <column name="email"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>
```

### YAML Format

```yaml
# 003-create-orders-table.yaml
databaseChangeLog:
  - changeSet:
      id: 3
      author: john
      changes:
        - createTable:
            tableName: orders
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: order_number
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: total_amount
                  type: DECIMAL(10,2)
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: PENDING
              - column:
                  name: created_date
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
        
        - addForeignKeyConstraint:
            baseTableName: orders
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_orders_user_id
```

### JSON Format

```json
{
  "databaseChangeLog": [
    {
      "changeSet": {
        "id": "4",
        "author": "john",
        "changes": [
          {
            "addColumn": {
              "tableName": "users",
              "columns": [
                {
                  "column": {
                    "name": "phone",
                    "type": "VARCHAR(20)"
                  }
                }
              ]
            }
          }
        ]
      }
    }
  ]
}
```

### SQL Format

```xml
<changeSet id="5" author="john">
    <sqlFile path="db/changelog/sql/sample-data.sql"/>
</changeSet>
```

```sql
-- sample-data.sql
INSERT INTO users (username, email, password) VALUES 
('john_doe', 'john@example.com', 'hashed_password_1'),
('jane_smith', 'jane@example.com', 'hashed_password_2');
```

### Rollback Support

```xml
<changeSet id="6" author="john">
    <addColumn tableName="users">
        <column name="age" type="INT"/>
    </addColumn>
    
    <rollback>
        <dropColumn tableName="users" columnName="age"/>
    </rollback>
</changeSet>
```

---

## üéØ Migration Strategies

### Blue-Green Deployment

```sql
-- Phase 1: Add new column (nullable)
-- V10__Add_new_email_column.sql
ALTER TABLE users ADD COLUMN new_email VARCHAR(255);

-- Phase 2: Migrate data
-- V11__Migrate_email_data.sql
UPDATE users SET new_email = email WHERE new_email IS NULL;

-- Phase 3: Make non-nullable
-- V12__Make_new_email_not_null.sql
ALTER TABLE users MODIFY COLUMN new_email VARCHAR(255) NOT NULL;

-- Phase 4: Drop old column
-- V13__Drop_old_email_column.sql
ALTER TABLE users DROP COLUMN email;
ALTER TABLE users CHANGE COLUMN new_email email VARCHAR(255) NOT NULL;
```

### Zero-Downtime Migration

```sql
-- Step 1: Add new column (deploy app version supporting both)
ALTER TABLE products ADD COLUMN price_cents BIGINT;

-- Step 2: Backfill data
UPDATE products SET price_cents = price * 100 WHERE price_cents IS NULL;

-- Step 3: Make non-nullable (deploy app version using only new column)
ALTER TABLE products MODIFY COLUMN price_cents BIGINT NOT NULL;

-- Step 4: Drop old column
ALTER TABLE products DROP COLUMN price;
```

### Conditional Migrations

```xml
<changeSet id="7" author="john">
    <preConditions onFail="MARK_RAN">
        <not>
            <columnExists tableName="users" columnName="status"/>
        </not>
    </preConditions>
    
    <addColumn tableName="users">
        <column name="status" type="VARCHAR(20)" defaultValue="ACTIVE"/>
    </addColumn>
</changeSet>
```

---

## ‚öñÔ∏è Flyway vs Liquibase

### Comparison Table

| Feature | Flyway | Liquibase |
|---------|--------|-----------|
| Learning Curve | ‚≠ê‚≠ê Easy | ‚≠ê‚≠ê‚≠ê‚≠ê Moderate |
| Format | SQL only | XML, YAML, JSON, SQL |
| Rollback | ‚ùå Pro only | ‚úÖ Free |
| Database Support | Wide | Wider |
| Community | Large | Large |
| Enterprise Features | Paid | Paid |
| Preconditions | ‚ùå Limited | ‚úÖ Extensive |
| ChangeSet Contexts | ‚ùå No | ‚úÖ Yes |
| Best For | Simple migrations | Complex migrations |

### When to Use Flyway

‚úÖ Simple SQL migrations  
‚úÖ Team familiar with SQL  
‚úÖ Straightforward schema changes  
‚úÖ No need for rollbacks  
‚úÖ Quick setup

### When to Use Liquibase

‚úÖ Complex migrations  
‚úÖ Multi-database support  
‚úÖ Need rollback capability  
‚úÖ Conditional migrations  
‚úÖ Database-agnostic changesets

### Side-by-Side Example

**Flyway:**
```sql
-- V1__Create_users.sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL
);
```

**Liquibase:**
```xml
<changeSet id="1" author="john">
    <createTable tableName="users">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="username" type="VARCHAR(100)">
            <constraints nullable="false"/>
        </column>
    </createTable>
</changeSet>
```

---

## üöÄ Production Deployment

### CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: '17'
      
      - name: Run Flyway Migrations
        run: |
          mvn flyway:info
          mvn flyway:validate
          mvn flyway:migrate
        env:
          FLYWAY_URL: ${{ secrets.DB_URL }}
          FLYWAY_USER: ${{ secrets.DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.DB_PASSWORD }}
```

### Validation Before Deployment

```bash
# Flyway commands
mvn flyway:info       # Show migration status
mvn flyway:validate   # Validate pending migrations
mvn flyway:migrate    # Apply migrations

# Liquibase commands
mvn liquibase:status
mvn liquibase:validate
mvn liquibase:update
```

### Rollback Strategy (Liquibase)

```bash
# Rollback last changeset
mvn liquibase:rollback -Dliquibase.rollbackCount=1

# Rollback to specific tag
mvn liquibase:rollback -Dliquibase.rollbackTag=v1.0

# Rollback to date
mvn liquibase:rollback -Dliquibase.rollbackDate=2024-01-01
```

### Backup Before Migration

```bash
#!/bin/bash
# backup-and-migrate.sh

# Backup database
mysqldump -u root -p mydb > backup_$(date +%Y%m%d_%H%M%S).sql

# Run migrations
mvn flyway:migrate

# If migration fails, restore
if [ $? -ne 0 ]; then
    echo "Migration failed, restoring backup"
    mysql -u root -p mydb < backup_*.sql
fi
```

---

## üìå Best Practices

### 1. Never Modify Executed Migrations

```sql
-- ‚ùå Bad - Editing V1__Create_users.sql after execution
-- Flyway will detect checksum change and fail

-- ‚úÖ Good - Create new migration
-- V2__Add_email_to_users.sql
ALTER TABLE users ADD COLUMN email VARCHAR(255);
```

### 2. Use Meaningful Names

```sql
-- ‚ùå Bad
V1__Migration.sql
V2__Update.sql

-- ‚úÖ Good
V1__Create_users_table.sql
V2__Add_email_column_to_users.sql
V3__Create_orders_table_with_foreign_key.sql
```

### 3. Test Migrations Locally First

```bash
# Always test in local/dev environment
mvn flyway:info
mvn flyway:migrate

# Verify schema changes
mysql -u root -p mydb -e "DESCRIBE users;"
```

### 4. Use Idempotent Scripts

```sql
-- ‚úÖ Good - Idempotent
CREATE TABLE IF NOT EXISTS users (
    id BIGINT PRIMARY KEY
);

ALTER TABLE users 
ADD COLUMN IF NOT EXISTS email VARCHAR(255);

-- ‚ùå Bad - Fails on re-run
CREATE TABLE users (id BIGINT PRIMARY KEY);
```

### 5. Separate DDL and DML

```sql
-- V1__Create_schema.sql (DDL)
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    username VARCHAR(100)
);

-- V2__Insert_initial_data.sql (DML)
INSERT INTO users (username) VALUES ('admin');
```

### 6. Use Transactions

```sql
-- V3__Complex_migration.sql
START TRANSACTION;

ALTER TABLE users ADD COLUMN email VARCHAR(255);
UPDATE users SET email = CONCAT(username, '@example.com');
ALTER TABLE users MODIFY COLUMN email VARCHAR(255) NOT NULL;

COMMIT;
```

### 7. Version Control Everything

```
.
‚îú‚îÄ‚îÄ src/main/resources/
‚îÇ   ‚îî‚îÄ‚îÄ db/
‚îÇ       ‚îî‚îÄ‚îÄ migration/  # ‚úÖ Committed to Git
‚îÇ           ‚îú‚îÄ‚îÄ V1__Create_users.sql
‚îÇ           ‚îú‚îÄ‚îÄ V2__Add_email.sql
‚îÇ           ‚îî‚îÄ‚îÄ V3__Create_orders.sql
```

---

## üé§ Interview Questions

### Q1: What are database migrations?
**Answer:** Versioned, incremental database schema changes tracked like code, ensuring consistency across environments.

### Q2: Why use migrations instead of manual SQL?
**Answer:** Version control, repeatability, rollback capability, team collaboration, CI/CD integration.

### Q3: What is Flyway?
**Answer:** SQL-based database migration tool with simple versioning (V1, V2, V3).

### Q4: What is Liquibase?
**Answer:** XML/YAML/JSON-based database migration tool with advanced features like rollback and preconditions.

### Q5: Flyway naming convention?
**Answer:** `V{version}__{description}.sql`, e.g., `V1__Create_users.sql`.

### Q6: Can you modify an executed Flyway migration?
**Answer:** No, Flyway uses checksums. Modifying causes validation failure. Create new migration instead.

### Q7: What is a repeatable migration?
**Answer:** Migration that runs every time checksum changes, prefixed with `R__`, used for views/procedures.

### Q8: How does Liquibase track changes?
**Answer:** Using DATABASECHANGELOG table storing id, author, filename, checksum, execution status.

### Q9: What is a changeset?
**Answer:** Liquibase's atomic unit of change, identified by id + author + file.

### Q10: Liquibase rollback support?
**Answer:** Yes, define `<rollback>` tag or use automatic rollback for supported operations.

### Q11: Flyway vs Liquibase for simple projects?
**Answer:** Flyway - easier setup, SQL-only, sufficient for simple schema changes.

### Q12: Liquibase vs Flyway for complex projects?
**Answer:** Liquibase - better for multi-database, conditional migrations, rollback needs.

### Q13: How to handle zero-downtime migrations?
**Answer:**
1. Add new column (nullable)
2. Deploy app supporting both old/new
3. Migrate data
4. Make non-nullable
5. Drop old column

### Q14: What is baseline migration?
**Answer:** Starting point for existing database, marks all prior changes as applied.

### Q15: How to validate migrations before deployment?
**Answer:**
```bash
flyway:validate  # Flyway
liquibase:validate  # Liquibase
```

### Q16: Can you use both Flyway and Liquibase?
**Answer:** Technically yes, but not recommended. Choose one to avoid conflicts.

### Q17: How to rollback Flyway migrations?
**Answer:** Flyway Community doesn't support rollback. Manual SQL or use Flyway Pro.

### Q18: What is migration checksum?
**Answer:** Hash of migration file content, used to detect modifications.

### Q19: Best practice for production migrations?
**Answer:**
1. Test in dev/staging
2. Backup database
3. Run during low traffic
4. Validate before/after
5. Have rollback plan

### Q20: How to handle migration conflicts in team?
**Answer:**
- Use sequential versioning
- Communicate schema changes
- Pull latest before creating migration
- Test locally
- Code review migrations

---

## üìö Summary

### Flyway Quick Start

```properties
# application.properties
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.jpa.hibernate.ddl-auto=none
```

```sql
-- V1__Create_users.sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL
);
```

### Liquibase Quick Start

```xml
<!-- db.changelog-master.xml -->
<databaseChangeLog ...>
    <include file="db/changelog/001-create-users.xml"/>
</databaseChangeLog>
```

```xml
<!-- 001-create-users.xml -->
<changeSet id="1" author="john">
    <createTable tableName="users">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
    </createTable>
</changeSet>
```

### Key Commands

```bash
# Flyway
mvn flyway:info
mvn flyway:migrate
mvn flyway:validate

# Liquibase
mvn liquibase:status
mvn liquibase:update
mvn liquibase:rollback -Dliquibase.rollbackCount=1
```

**Next:** Database Connection Pooling ‚Üí

