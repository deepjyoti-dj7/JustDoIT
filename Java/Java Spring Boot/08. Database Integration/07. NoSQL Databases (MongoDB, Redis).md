# üóÑÔ∏è NoSQL Databases (MongoDB, Redis) - Complete Guide

## üìã Table of Contents
- [Introduction](#introduction)
- [MongoDB with Spring Boot](#mongodb-with-spring-boot)
- [MongoDB Operations](#mongodb-operations)
- [Redis with Spring Boot](#redis-with-spring-boot)
- [Redis Caching](#redis-caching)
- [Redis Operations](#redis-operations)
- [SQL vs NoSQL](#sql-vs-nosql)
- [Use Cases](#use-cases)
- [Best Practices](#best-practices)
- [Interview Questions](#interview-questions)

---

## üéØ Introduction

**NoSQL Databases** provide flexible, schema-less data storage optimized for specific use cases.

### Types of NoSQL

| Type | Database | Use Case |
|------|----------|----------|
| **Document** | MongoDB, CouchDB | JSON-like documents, flexible schema |
| **Key-Value** | Redis, Memcached | Caching, sessions |
| **Column-Family** | Cassandra, HBase | Time-series, analytics |
| **Graph** | Neo4j, Amazon Neptune | Social networks, recommendations |

### When to Use NoSQL?

‚úÖ **Use NoSQL:**
- Flexible/evolving schema
- Horizontal scalability needed
- High read/write throughput
- Caching layer
- Real-time analytics

‚ùå **Use SQL:**
- Complex transactions (ACID)
- Strong consistency required
- Complex joins
- Established schema

---

## üçÉ MongoDB with Spring Boot

### Maven Dependencies

```xml
<dependencies>
    <!-- Spring Data MongoDB -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-mongodb</artifactId>
    </dependency>
    
    <!-- Optional: Embedded MongoDB for testing -->
    <dependency>
        <groupId>de.flapdoodle.embed</groupId>
        <artifactId>de.flapdoodle.embed.mongo</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### Configuration

```properties
# application.properties

# MongoDB Connection
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=mydb
spring.data.mongodb.username=admin
spring.data.mongodb.password=password

# Connection String (alternative)
spring.data.mongodb.uri=mongodb://admin:password@localhost:27017/mydb

# Authentication Database
spring.data.mongodb.authentication-database=admin
```

### Document Entity

```java
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;
import org.springframework.data.mongodb.core.mapping.Field;
import org.springframework.data.mongodb.core.index.Indexed;

@Document(collection = "users")
public class User {
    
    @Id
    private String id; // MongoDB uses String IDs
    
    @Indexed(unique = true)
    private String email;
    
    private String name;
    
    @Field("phone_number")
    private String phoneNumber;
    
    private Address address; // Embedded document
    
    private List<String> tags;
    
    private LocalDateTime createdDate;
    
    // Constructors, getters, setters
}

// Embedded Document
public class Address {
    private String street;
    private String city;
    private String zipCode;
    
    // Getters, setters
}
```

### Repository

```java
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.data.mongodb.repository.Query;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends MongoRepository<User, String> {
    
    // Derived queries
    List<User> findByName(String name);
    
    List<User> findByEmailContaining(String keyword);
    
    List<User> findByTagsContaining(String tag);
    
    // Custom query
    @Query("{ 'address.city': ?0 }")
    List<User> findByCity(String city);
    
    // Complex query
    @Query("{ 'createdDate': { $gte: ?0, $lte: ?1 } }")
    List<User> findByDateRange(LocalDateTime start, LocalDateTime end);
    
    // Projection
    @Query(value = "{ 'email': ?0 }", fields = "{ 'name': 1, 'email': 1 }")
    User findNameAndEmailByEmail(String email);
}
```

---

## üìù MongoDB Operations

### CRUD Operations

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    // Create
    public User create(User user) {
        user.setCreatedDate(LocalDateTime.now());
        return userRepository.save(user);
    }
    
    // Read
    public Optional<User> findById(String id) {
        return userRepository.findById(id);
    }
    
    public List<User> findAll() {
        return userRepository.findAll();
    }
    
    // Update
    public User update(String id, User updatedUser) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("User not found"));
        
        user.setName(updatedUser.getName());
        user.setEmail(updatedUser.getEmail());
        return userRepository.save(user);
    }
    
    // Partial update with MongoTemplate
    public void updateEmail(String id, String newEmail) {
        Query query = new Query(Criteria.where("id").is(id));
        Update update = new Update().set("email", newEmail);
        mongoTemplate.updateFirst(query, update, User.class);
    }
    
    // Delete
    public void delete(String id) {
        userRepository.deleteById(id);
    }
}
```

### MongoTemplate Queries

```java
@Service
public class UserQueryService {
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    // Find by criteria
    public List<User> findByName(String name) {
        Query query = new Query();
        query.addCriteria(Criteria.where("name").is(name));
        return mongoTemplate.find(query, User.class);
    }
    
    // Find with regex
    public List<User> searchByName(String keyword) {
        Query query = new Query();
        query.addCriteria(Criteria.where("name").regex(keyword, "i")); // case-insensitive
        return mongoTemplate.find(query, User.class);
    }
    
    // Find with multiple conditions
    public List<User> findByNameAndCity(String name, String city) {
        Query query = new Query();
        query.addCriteria(
            Criteria.where("name").is(name)
                .and("address.city").is(city)
        );
        return mongoTemplate.find(query, User.class);
    }
    
    // Find with OR condition
    public List<User> findByNameOrEmail(String name, String email) {
        Query query = new Query();
        query.addCriteria(
            new Criteria().orOperator(
                Criteria.where("name").is(name),
                Criteria.where("email").is(email)
            )
        );
        return mongoTemplate.find(query, User.class);
    }
    
    // Find with range
    public List<User> findByAgeRange(int minAge, int maxAge) {
        Query query = new Query();
        query.addCriteria(
            Criteria.where("age").gte(minAge).lte(maxAge)
        );
        return mongoTemplate.find(query, User.class);
    }
    
    // Pagination
    public List<User> findWithPagination(int page, int size) {
        Query query = new Query();
        query.skip(page * size).limit(size);
        return mongoTemplate.find(query, User.class);
    }
    
    // Sorting
    public List<User> findAllSorted() {
        Query query = new Query();
        query.with(Sort.by(Sort.Direction.DESC, "createdDate"));
        return mongoTemplate.find(query, User.class);
    }
    
    // Aggregation
    public long countByCity(String city) {
        Query query = new Query(Criteria.where("address.city").is(city));
        return mongoTemplate.count(query, User.class);
    }
    
    // Distinct
    public List<String> findDistinctCities() {
        return mongoTemplate.findDistinct(
            new Query(), 
            "address.city", 
            User.class, 
            String.class
        );
    }
}
```

### Aggregation Framework

```java
@Service
public class UserAggregationService {
    
    @Autowired
    private MongoTemplate mongoTemplate;
    
    // Group by city and count
    public List<CityCount> countUsersByCity() {
        Aggregation aggregation = Aggregation.newAggregation(
            Aggregation.group("address.city").count().as("count"),
            Aggregation.project("count").and("city").previousOperation(),
            Aggregation.sort(Sort.Direction.DESC, "count")
        );
        
        AggregationResults<CityCount> results = mongoTemplate.aggregate(
            aggregation, "users", CityCount.class
        );
        
        return results.getMappedResults();
    }
    
    // Average age by city
    public List<CityAverage> averageAgeByCity() {
        Aggregation aggregation = Aggregation.newAggregation(
            Aggregation.group("address.city").avg("age").as("averageAge"),
            Aggregation.project("averageAge").and("city").previousOperation()
        );
        
        AggregationResults<CityAverage> results = mongoTemplate.aggregate(
            aggregation, "users", CityAverage.class
        );
        
        return results.getMappedResults();
    }
}

// Result classes
class CityCount {
    private String city;
    private long count;
    // Getters, setters
}

class CityAverage {
    private String city;
    private double averageAge;
    // Getters, setters
}
```

---

## üî¥ Redis with Spring Boot

### Maven Dependencies

```xml
<dependencies>
    <!-- Spring Data Redis -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- Lettuce (default Redis client) -->
    <dependency>
        <groupId>io.lettuce</groupId>
        <artifactId>lettuce-core</artifactId>
    </dependency>
    
    <!-- Optional: Jedis (alternative client) -->
    <dependency>
        <groupId>redis.clients</groupId>
        <artifactId>jedis</artifactId>
    </dependency>
</dependencies>
```

### Configuration

```properties
# application.properties

# Redis Connection
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.password=
spring.data.redis.database=0

# Connection Pool (Lettuce)
spring.data.redis.lettuce.pool.max-active=8
spring.data.redis.lettuce.pool.max-idle=8
spring.data.redis.lettuce.pool.min-idle=0
spring.data.redis.lettuce.pool.max-wait=-1ms

# Timeout
spring.data.redis.timeout=60000ms
```

### Redis Configuration

```java
@Configuration
@EnableCaching
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // JSON serialization
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        objectMapper.activateDefaultTyping(
            objectMapper.getPolymorphicTypeValidator(),
            ObjectMapper.DefaultTyping.NON_FINAL
        );
        serializer.setObjectMapper(objectMapper);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        template.afterPropertiesSet();
        return template;
    }
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new Jackson2JsonRedisSerializer<>(Object.class)));
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .build();
    }
}
```

---

## üíæ Redis Caching

### Enable Caching

```java
@SpringBootApplication
@EnableCaching
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### Cache Annotations

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // Cache result
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) {
        System.out.println("Fetching from database..."); // Only prints on cache miss
        return userRepository.findById(id).orElse(null);
    }
    
    // Cache with condition
    @Cacheable(value = "users", key = "#id", condition = "#id > 0")
    public User findByIdConditional(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // Update cache
    @CachePut(value = "users", key = "#user.id")
    public User update(User user) {
        return userRepository.save(user);
    }
    
    // Remove from cache
    @CacheEvict(value = "users", key = "#id")
    public void delete(Long id) {
        userRepository.deleteById(id);
    }
    
    // Clear entire cache
    @CacheEvict(value = "users", allEntries = true)
    public void deleteAll() {
        userRepository.deleteAll();
    }
    
    // Multiple cache operations
    @Caching(
        cacheable = @Cacheable(value = "users", key = "#id"),
        evict = @CacheEvict(value = "userList", allEntries = true)
    )
    public User findByIdAndInvalidateList(Long id) {
        return userRepository.findById(id).orElse(null);
    }
}
```

### Custom Cache Key

```java
@Service
public class ProductService {
    
    // Custom key using SpEL
    @Cacheable(value = "products", key = "#category + '_' + #page + '_' + #size")
    public List<Product> findByCategory(String category, int page, int size) {
        return productRepository.findByCategory(category, 
            PageRequest.of(page, size));
    }
    
    // Using method name in key
    @Cacheable(value = "products", key = "#root.methodName + '_' + #id")
    public Product getProduct(Long id) {
        return productRepository.findById(id).orElse(null);
    }
}
```

---

## üîß Redis Operations

### String Operations

```java
@Service
public class RedisService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // Set value
    public void setValue(String key, Object value) {
        redisTemplate.opsForValue().set(key, value);
    }
    
    // Set with expiration
    public void setValueWithExpiry(String key, Object value, long timeout, TimeUnit unit) {
        redisTemplate.opsForValue().set(key, value, timeout, unit);
    }
    
    // Get value
    public Object getValue(String key) {
        return redisTemplate.opsForValue().get(key);
    }
    
    // Increment
    public Long increment(String key) {
        return redisTemplate.opsForValue().increment(key);
    }
    
    // Decrement
    public Long decrement(String key) {
        return redisTemplate.opsForValue().decrement(key);
    }
    
    // Delete key
    public Boolean delete(String key) {
        return redisTemplate.delete(key);
    }
}
```

### Hash Operations

```java
// Store hash
public void saveUser(String key, User user) {
    Map<String, Object> userMap = new HashMap<>();
    userMap.put("id", user.getId());
    userMap.put("name", user.getName());
    userMap.put("email", user.getEmail());
    
    redisTemplate.opsForHash().putAll(key, userMap);
}

// Get hash field
public Object getUserField(String key, String field) {
    return redisTemplate.opsForHash().get(key, field);
}

// Get entire hash
public Map<Object, Object> getUser(String key) {
    return redisTemplate.opsForHash().entries(key);
}

// Delete hash field
public void deleteUserField(String key, String field) {
    redisTemplate.opsForHash().delete(key, field);
}
```

### List Operations

```java
// Add to list
public void addToList(String key, Object value) {
    redisTemplate.opsForList().rightPush(key, value);
}

// Get list range
public List<Object> getListRange(String key, long start, long end) {
    return redisTemplate.opsForList().range(key, start, end);
}

// Pop from list
public Object popFromList(String key) {
    return redisTemplate.opsForList().leftPop(key);
}

// List size
public Long getListSize(String key) {
    return redisTemplate.opsForList().size(key);
}
```

### Set Operations

```java
// Add to set
public void addToSet(String key, Object... values) {
    redisTemplate.opsForSet().add(key, values);
}

// Get all set members
public Set<Object> getSetMembers(String key) {
    return redisTemplate.opsForSet().members(key);
}

// Check if member exists
public Boolean isMember(String key, Object value) {
    return redisTemplate.opsForSet().isMember(key, value);
}

// Remove from set
public void removeFromSet(String key, Object... values) {
    redisTemplate.opsForSet().remove(key, values);
}
```

### Sorted Set Operations

```java
// Add to sorted set
public void addToSortedSet(String key, Object value, double score) {
    redisTemplate.opsForZSet().add(key, value, score);
}

// Get range by score
public Set<Object> getRangeByScore(String key, double min, double max) {
    return redisTemplate.opsForZSet().rangeByScore(key, min, max);
}

// Get top N
public Set<Object> getTopN(String key, long n) {
    return redisTemplate.opsForZSet().reverseRange(key, 0, n - 1);
}

// Increment score
public void incrementScore(String key, Object value, double delta) {
    redisTemplate.opsForZSet().incrementScore(key, value, delta);
}
```

---

## ‚öñÔ∏è SQL vs NoSQL

### Comparison Table

| Feature | SQL (MySQL, PostgreSQL) | NoSQL (MongoDB, Redis) |
|---------|-------------------------|------------------------|
| Schema | Fixed, predefined | Flexible, dynamic |
| Scalability | Vertical (scale up) | Horizontal (scale out) |
| Transactions | ACID | BASE (eventual consistency) |
| Joins | Native support | Limited/no support |
| Query Language | SQL | Database-specific |
| Use Case | Transactional systems | Real-time, big data |
| Data Model | Tables, rows | Documents, key-value |
| Performance | Good for complex queries | Excellent for simple queries |

### Data Model Example

**SQL (Users & Orders):**
```sql
-- users table
id | name     | email
1  | John Doe | john@example.com

-- orders table
id | user_id | total
1  | 1       | 99.99
```

**MongoDB (Embedded):**
```json
{
  "_id": "1",
  "name": "John Doe",
  "email": "john@example.com",
  "orders": [
    {
      "id": "1",
      "total": 99.99
    }
  ]
}
```

---

## üéØ Use Cases

### MongoDB Use Cases

‚úÖ **Content Management Systems**
```java
@Document
public class Article {
    @Id private String id;
    private String title;
    private String content;
    private List<Comment> comments; // Embedded
    private List<String> tags;
}
```

‚úÖ **Product Catalogs**
```java
@Document
public class Product {
    @Id private String id;
    private String name;
    private Map<String, Object> attributes; // Flexible schema
    private List<Variant> variants;
}
```

‚úÖ **User Profiles**
```java
@Document
public class UserProfile {
    @Id private String id;
    private Map<String, Object> preferences; // Dynamic fields
    private List<Activity> activities;
}
```

### Redis Use Cases

‚úÖ **Session Storage**
```java
@Service
public class SessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void saveSession(String sessionId, UserSession session) {
        redisTemplate.opsForValue().set(
            "session:" + sessionId, 
            session, 
            30, 
            TimeUnit.MINUTES
        );
    }
}
```

‚úÖ **Leaderboards**
```java
public void updateScore(String userId, double score) {
    redisTemplate.opsForZSet().add("leaderboard", userId, score);
}

public Set<Object> getTopPlayers(int n) {
    return redisTemplate.opsForZSet().reverseRange("leaderboard", 0, n - 1);
}
```

‚úÖ **Rate Limiting**
```java
public boolean isAllowed(String userId) {
    String key = "rate:" + userId;
    Long count = redisTemplate.opsForValue().increment(key);
    
    if (count == 1) {
        redisTemplate.expire(key, 1, TimeUnit.MINUTES);
    }
    
    return count <= 100; // Max 100 requests per minute
}
```

---

## üìå Best Practices

### MongoDB Best Practices

```java
// ‚úÖ Good - Embed related data
@Document
public class Order {
    @Id private String id;
    private List<OrderItem> items; // Embedded
}

// ‚ùå Bad - Too many references
@Document
public class Order {
    @Id private String id;
    @DBRef private List<OrderItem> items; // Slow!
}
```

### Redis Best Practices

```java
// ‚úÖ Good - Set expiration
redisTemplate.opsForValue().set(key, value, 10, TimeUnit.MINUTES);

// ‚ùå Bad - No expiration (memory leak)
redisTemplate.opsForValue().set(key, value);
```

### Caching Best Practices

```java
// ‚úÖ Good - Specific cache key
@Cacheable(value = "users", key = "#id")
public User findById(Long id) { }

// ‚ùå Bad - Generic cache key
@Cacheable(value = "cache")
public User findById(Long id) { }
```

---

## üé§ Interview Questions

### Q1: What is NoSQL?
**Answer:** Non-relational databases providing flexible, schema-less data storage optimized for specific use cases like documents, key-value, graphs.

### Q2: MongoDB vs MySQL?
**Answer:** MongoDB: flexible schema, horizontal scaling, document-based. MySQL: fixed schema, ACID transactions, relational.

### Q3: What is a document in MongoDB?
**Answer:** JSON-like structure (BSON) containing fields and values, equivalent to a row in SQL.

### Q4: How to embed documents in MongoDB?
**Answer:** Define nested objects in entity:
```java
private Address address; // Embedded
```

### Q5: What is @DBRef in MongoDB?
**Answer:** Reference to document in another collection (like foreign key), but slower than embedding.

### Q6: What is Redis?
**Answer:** In-memory key-value store used for caching, sessions, real-time analytics.

### Q7: Redis vs Memcached?
**Answer:** Redis: persistent, data structures, pub/sub. Memcached: simpler, cache-only, faster for simple key-value.

### Q8: Redis data types?
**Answer:** String, Hash, List, Set, Sorted Set, Bitmap, HyperLogLog, Streams.

### Q9: How does @Cacheable work?
**Answer:** Checks cache before method execution. If found, returns cached value; otherwise executes method and caches result.

### Q10: Difference between @Cacheable and @CachePut?
**Answer:**
- **@Cacheable:** Skips method if cached
- **@CachePut:** Always executes method, updates cache

### Q11: How to invalidate cache?
**Answer:** Use @CacheEvict:
```java
@CacheEvict(value = "users", key = "#id")
```

### Q12: What is cache eviction?
**Answer:** Removing cached entries based on strategy: LRU (Least Recently Used), TTL (Time To Live).

### Q13: When to use MongoDB?
**Answer:** Flexible schema, JSON data, horizontal scaling, real-time analytics, content management.

### Q14: When to use Redis?
**Answer:** Caching, session storage, leaderboards, rate limiting, pub/sub messaging.

### Q15: Can Redis replace a database?
**Answer:** For simple key-value use cases, yes. For complex queries, transactions, use SQL/MongoDB.

### Q16: What is MongoDB aggregation?
**Answer:** Framework for data processing pipelines: group, match, project, sort operations.

### Q17: How to ensure Redis availability?
**Answer:** Use Redis Sentinel (high availability) or Redis Cluster (horizontal scaling).

### Q18: What is Redis persistence?
**Answer:** RDB (snapshots) and AOF (append-only file) to persist in-memory data to disk.

### Q19: MongoDB sharding?
**Answer:** Horizontal partitioning across multiple servers for scalability.

### Q20: Best practice: Redis cache duration?
**Answer:** Balance freshness vs performance. Typical: 5-30 minutes for frequently updated data, 1-24 hours for static data.

---

## üìö Summary

### MongoDB Quick Start

```java
@Document("users")
public class User {
    @Id private String id;
    private String name;
}

@Repository
public interface UserRepository extends MongoRepository<User, String> {
    List<User> findByName(String name);
}
```

### Redis Caching

```java
@Cacheable(value = "users", key = "#id")
public User findById(Long id) {
    return userRepository.findById(id).orElse(null);
}

@CacheEvict(value = "users", key = "#id")
public void delete(Long id) {
    userRepository.deleteById(id);
}
```

### Key Takeaways

- **MongoDB**: Flexible schema, document-based, horizontal scaling
- **Redis**: In-memory, caching, session storage, real-time data
- **Use MongoDB**: When schema changes frequently
- **Use Redis**: For temporary, fast-access data

**Next:** Database Performance Optimization ‚Üí

