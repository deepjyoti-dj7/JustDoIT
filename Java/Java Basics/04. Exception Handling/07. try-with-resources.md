# üîÑ try-with-resources

## üìñ Overview

**try-with-resources** is a Java 7 feature that automatically closes resources after use. It simplifies resource management and prevents resource leaks.

**Key Benefits:**
- Automatic resource closing
- Cleaner code
- Prevents resource leaks
- Handles suppressed exceptions

---

## üéØ Syntax

```java
// Old way (before Java 7)
BufferedReader reader = null;
try {
    reader = new BufferedReader(new FileReader("file.txt"));
    // Use reader
} finally {
    if (reader != null) {
        reader.close();
    }
}

// New way (Java 7+)
try (BufferedReader reader = new BufferedReader(new FileReader("file.txt"))) {
    // Use reader - automatically closed
}
```

---

## üíª Example 1: Basic try-with-resources

```java
import java.io.*;

public class BasicTryWithResources {
    // Old way
    static void readFileOldWay(String filename) {
        BufferedReader reader = null;
        try {
            reader = new BufferedReader(new FileReader(filename));
            String line = reader.readLine();
            System.out.println("First line: " + line);
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        } finally {
            try {
                if (reader != null) {
                    reader.close();
                    System.out.println("File closed");
                }
            } catch (IOException e) {
                System.out.println("Error closing: " + e.getMessage());
            }
        }
    }
    
    // New way
    static void readFileNewWay(String filename) {
        try (BufferedReader reader = new BufferedReader(new FileReader(filename))) {
            String line = reader.readLine();
            System.out.println("First line: " + line);
            System.out.println("File will be closed automatically");
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== Old Way ===");
        readFileOldWay("test.txt");
        
        System.out.println("\n=== New Way (try-with-resources) ===");
        readFileNewWay("test.txt");
    }
}
```

---

## üíª Example 2: Multiple Resources

```java
import java.io.*;

public class MultipleResources {
    static void copyFile(String source, String dest) {
        // Multiple resources - all closed automatically
        try (
            FileInputStream input = new FileInputStream(source);
            FileOutputStream output = new FileOutputStream(dest);
            BufferedInputStream bis = new BufferedInputStream(input);
            BufferedOutputStream bos = new BufferedOutputStream(output)
        ) {
            byte[] buffer = new byte[1024];
            int bytesRead;
            
            while ((bytesRead = bis.read(buffer)) != -1) {
                bos.write(buffer, 0, bytesRead);
            }
            
            System.out.println("File copied successfully");
            System.out.println("All resources will be closed automatically");
            
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
        // All 4 resources closed in reverse order: bos, bis, output, input
    }
    
    public static void main(String[] args) {
        System.out.println("=== Multiple Resources ===");
        copyFile("source.txt", "destination.txt");
    }
}
```

---

## üíª Example 3: AutoCloseable Interface

```java
// Custom resource implementing AutoCloseable
class MyResource implements AutoCloseable {
    private String name;
    
    public MyResource(String name) {
        this.name = name;
        System.out.println(name + " - Resource opened");
    }
    
    public void doSomething() {
        System.out.println(name + " - Doing something");
    }
    
    @Override
    public void close() {
        System.out.println(name + " - Resource closed");
    }
}

public class AutoCloseableExample {
    public static void main(String[] args) {
        System.out.println("=== Custom AutoCloseable Resource ===\n");
        
        // Single resource
        System.out.println("1. Single resource:");
        try (MyResource resource = new MyResource("Resource1")) {
            resource.doSomething();
        }
        System.out.println("After try block\n");
        
        // Multiple resources
        System.out.println("2. Multiple resources:");
        try (
            MyResource resource1 = new MyResource("Resource1");
            MyResource resource2 = new MyResource("Resource2");
            MyResource resource3 = new MyResource("Resource3")
        ) {
            resource1.doSomething();
            resource2.doSomething();
            resource3.doSomething();
        }
        System.out.println("After try block (closed in reverse order)");
    }
}
```

**Output:**
```
=== Custom AutoCloseable Resource ===

1. Single resource:
Resource1 - Resource opened
Resource1 - Doing something
Resource1 - Resource closed
After try block

2. Multiple resources:
Resource1 - Resource opened
Resource2 - Resource opened
Resource3 - Resource opened
Resource1 - Doing something
Resource2 - Doing something
Resource3 - Doing something
Resource3 - Resource closed
Resource2 - Resource closed
Resource1 - Resource closed
After try block (closed in reverse order)
```

---

## üíª Example 4: Exception in close()

```java
class ResourceWithException implements AutoCloseable {
    private String name;
    private boolean throwOnClose;
    
    public ResourceWithException(String name, boolean throwOnClose) {
        this.name = name;
        this.throwOnClose = throwOnClose;
        System.out.println(name + " - Opened");
    }
    
    public void process() throws Exception {
        System.out.println(name + " - Processing");
        throw new Exception(name + " - Processing error");
    }
    
    @Override
    public void close() throws Exception {
        System.out.println(name + " - Closing");
        if (throwOnClose) {
            throw new Exception(name + " - Close error");
        }
    }
}

public class ExceptionInClose {
    public static void main(String[] args) {
        System.out.println("=== Exception in close() ===\n");
        
        // Exception in try block and close()
        try (ResourceWithException resource = new ResourceWithException("Resource1", true)) {
            resource.process();
        } catch (Exception e) {
            System.out.println("\nCaught exception: " + e.getMessage());
            
            // Suppressed exceptions
            Throwable[] suppressed = e.getSuppressed();
            System.out.println("Suppressed exceptions: " + suppressed.length);
            for (Throwable t : suppressed) {
                System.out.println("  - " + t.getMessage());
            }
        }
    }
}
```

---

## üíª Example 5: try-with-resources with catch and finally

```java
import java.io.*;

public class TryWithResourcesFull {
    public static void main(String[] args) {
        System.out.println("=== try-with-resources + catch + finally ===\n");
        
        try (BufferedReader reader = new BufferedReader(new FileReader("test.txt"))) {
            System.out.println("1. Try block - reading file");
            String line = reader.readLine();
            System.out.println("   Line: " + line);
            
        } catch (FileNotFoundException e) {
            System.out.println("2. Catch block - File not found");
            
        } catch (IOException e) {
            System.out.println("2. Catch block - I/O error");
            
        } finally {
            System.out.println("3. Finally block - Always executes");
        }
        
        System.out.println("4. After try-catch-finally");
        System.out.println("\nExecution order:");
        System.out.println("try ‚Üí close() ‚Üí catch (if exception) ‚Üí finally");
    }
}
```

---

## üíª Example 6: Real-World Example - Database Connection

```java
import java.sql.*;

// Simulated database classes
class MockConnection implements AutoCloseable {
    private boolean connected = true;
    
    public Statement createStatement() {
        return new MockStatement();
    }
    
    @Override
    public void close() {
        System.out.println("Connection closed");
        connected = false;
    }
    
    public boolean isConnected() {
        return connected;
    }
}

class MockStatement implements AutoCloseable {
    public ResultSet executeQuery(String query) {
        System.out.println("Executing: " + query);
        return new MockResultSet();
    }
    
    @Override
    public void close() {
        System.out.println("Statement closed");
    }
}

class MockResultSet implements AutoCloseable {
    private int row = 0;
    
    public boolean next() {
        return row++ < 3;
    }
    
    public String getString(String column) {
        return "Data " + row;
    }
    
    @Override
    public void close() {
        System.out.println("ResultSet closed");
    }
}

public class DatabaseExample {
    static MockConnection getConnection() {
        System.out.println("Getting connection");
        return new MockConnection();
    }
    
    // Old way - manual cleanup
    static void queryOldWay() {
        MockConnection conn = null;
        MockStatement stmt = null;
        MockResultSet rs = null;
        
        try {
            conn = getConnection();
            stmt = conn.createStatement();
            rs = stmt.executeQuery("SELECT * FROM users");
            
            while (rs.next()) {
                System.out.println(rs.getString("name"));
            }
            
        } finally {
            try {
                if (rs != null) rs.close();
                if (stmt != null) stmt.close();
                if (conn != null) conn.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    // New way - automatic cleanup
    static void queryNewWay() {
        try (
            MockConnection conn = getConnection();
            MockStatement stmt = conn.createStatement();
            MockResultSet rs = stmt.executeQuery("SELECT * FROM users")
        ) {
            while (rs.next()) {
                System.out.println(rs.getString("name"));
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        // All resources closed automatically in reverse order
    }
    
    public static void main(String[] args) {
        System.out.println("=== Old Way ===");
        queryOldWay();
        
        System.out.println("\n=== New Way (try-with-resources) ===");
        queryNewWay();
    }
}
```

---

## üíª Example 7: Java 9+ Enhancement

```java
import java.io.*;

public class Java9Enhancement {
    public static void main(String[] args) throws IOException {
        System.out.println("=== Java 9+ Enhancement ===\n");
        
        // Before Java 9: Must declare inside try
        System.out.println("Java 7-8 style:");
        try (BufferedReader reader1 = new BufferedReader(new FileReader("file1.txt"))) {
            System.out.println(reader1.readLine());
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
        
        // Java 9+: Can use effectively final variables
        System.out.println("\nJava 9+ style:");
        BufferedReader reader2 = new BufferedReader(new FileReader("file2.txt"));
        try (reader2) {  // Variable declared outside
            System.out.println(reader2.readLine());
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
        
        // Multiple external variables
        System.out.println("\nMultiple external variables:");
        BufferedReader reader3 = new BufferedReader(new FileReader("file3.txt"));
        BufferedReader reader4 = new BufferedReader(new FileReader("file4.txt"));
        
        try (reader3; reader4) {
            System.out.println(reader3.readLine());
            System.out.println(reader4.readLine());
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
    }
}
```

---

## üíª Example 8: Custom Resource Manager

```java
class ResourceManager<T extends AutoCloseable> implements AutoCloseable {
    private T resource;
    private String name;
    
    public ResourceManager(T resource, String name) {
        this.resource = resource;
        this.name = name;
        System.out.println(name + " - Resource manager created");
    }
    
    public T getResource() {
        return resource;
    }
    
    @Override
    public void close() {
        try {
            if (resource != null) {
                resource.close();
                System.out.println(name + " - Resource manager closed resource");
            }
        } catch (Exception e) {
            System.out.println(name + " - Error closing: " + e.getMessage());
        }
    }
}

class DataSource implements AutoCloseable {
    private String name;
    
    public DataSource(String name) {
        this.name = name;
        System.out.println("DataSource " + name + " opened");
    }
    
    public void fetchData() {
        System.out.println("Fetching data from " + name);
    }
    
    @Override
    public void close() {
        System.out.println("DataSource " + name + " closed");
    }
}

public class CustomResourceManager {
    public static void main(String[] args) {
        System.out.println("=== Custom Resource Manager ===\n");
        
        try (
            ResourceManager<DataSource> manager1 = 
                new ResourceManager<>(new DataSource("DB1"), "Manager1");
            ResourceManager<DataSource> manager2 = 
                new ResourceManager<>(new DataSource("DB2"), "Manager2")
        ) {
            manager1.getResource().fetchData();
            manager2.getResource().fetchData();
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        System.out.println("\nBoth managers and data sources closed automatically");
    }
}
```

---

## üíª Example 9: File Operations

```java
import java.io.*;
import java.nio.file.*;

public class FileOperations {
    // Read file
    static void readFile(String filename) {
        System.out.println("Reading file: " + filename);
        try (BufferedReader reader = Files.newBufferedReader(Paths.get(filename))) {
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
        } catch (IOException e) {
            System.out.println("Error reading: " + e.getMessage());
        }
    }
    
    // Write file
    static void writeFile(String filename, String content) {
        System.out.println("Writing to file: " + filename);
        try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(filename))) {
            writer.write(content);
            System.out.println("Write successful");
        } catch (IOException e) {
            System.out.println("Error writing: " + e.getMessage());
        }
    }
    
    // Copy file
    static void copyFile(String source, String dest) {
        System.out.println("Copying " + source + " to " + dest);
        try (
            InputStream in = Files.newInputStream(Paths.get(source));
            OutputStream out = Files.newOutputStream(Paths.get(dest))
        ) {
            byte[] buffer = new byte[1024];
            int length;
            while ((length = in.read(buffer)) > 0) {
                out.write(buffer, 0, length);
            }
            System.out.println("Copy successful");
        } catch (IOException e) {
            System.out.println("Error copying: " + e.getMessage());
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== File Operations with try-with-resources ===\n");
        
        String filename = "test.txt";
        
        // Write
        writeFile(filename, "Hello, try-with-resources!");
        
        System.out.println();
        
        // Read
        readFile(filename);
        
        System.out.println();
        
        // Copy
        copyFile(filename, "test_copy.txt");
    }
}
```

---

## üíª Example 10: Real-World Example - Log Manager

```java
import java.io.*;
import java.time.*;
import java.time.format.DateTimeFormatter;

class LogManager implements AutoCloseable {
    private BufferedWriter writer;
    private String logFile;
    private DateTimeFormatter formatter;
    
    public LogManager(String logFile) throws IOException {
        this.logFile = logFile;
        this.writer = new BufferedWriter(new FileWriter(logFile, true));
        this.formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        log("Log session started");
    }
    
    public void log(String message) throws IOException {
        String timestamp = LocalDateTime.now().format(formatter);
        writer.write(String.format("[%s] %s%n", timestamp, message));
        writer.flush();
    }
    
    public void error(String message, Exception e) throws IOException {
        log("ERROR: " + message + " - " + e.getMessage());
    }
    
    public void info(String message) throws IOException {
        log("INFO: " + message);
    }
    
    @Override
    public void close() throws IOException {
        log("Log session ended");
        writer.close();
        System.out.println("Log file closed: " + logFile);
    }
}

public class LogManagerExample {
    static void processData(LogManager logger) throws IOException {
        logger.info("Starting data processing");
        
        try {
            logger.info("Step 1: Loading data");
            Thread.sleep(100);
            
            logger.info("Step 2: Processing data");
            Thread.sleep(100);
            
            // Simulate error
            if (Math.random() > 0.5) {
                throw new IOException("Random processing error");
            }
            
            logger.info("Step 3: Saving results");
            Thread.sleep(100);
            
            logger.info("Processing completed successfully");
            
        } catch (InterruptedException e) {
            logger.error("Thread interrupted", e);
        } catch (IOException e) {
            logger.error("Processing failed", e);
            throw e;
        }
    }
    
    public static void main(String[] args) {
        System.out.println("=== Log Manager Example ===\n");
        
        // LogManager automatically closed
        try (LogManager logger = new LogManager("application.log")) {
            logger.info("Application started");
            
            processData(logger);
            
            logger.info("Application ended");
            
        } catch (IOException e) {
            System.out.println("Error: " + e.getMessage());
        }
        
        System.out.println("\nCheck application.log for details");
    }
}
```

---

## üìä try-with-resources vs try-finally

| Feature | try-with-resources | try-finally |
|---------|-------------------|-------------|
| **Introduced** | Java 7 | Java 1 |
| **Resource closing** | Automatic | Manual |
| **Code length** | Shorter | Longer |
| **Resource leak** | Prevented | Possible |
| **Multiple resources** | Easy | Complex |
| **Suppressed exceptions** | Supported | Not supported |
| **Requirements** | AutoCloseable | Any cleanup |

---

## üí° Best Practices

1. ‚úÖ **Use for AutoCloseable resources**
   ```java
   try (FileReader fr = new FileReader("file.txt")) {
       // Use fr
   }
   ```

2. ‚úÖ **Declare resources in order of dependency**
   ```java
   try (
       FileInputStream fis = new FileInputStream("file.txt");
       BufferedInputStream bis = new BufferedInputStream(fis)
   ) { }
   ```

3. ‚úÖ **Implement AutoCloseable for custom resources**
   ```java
   class MyResource implements AutoCloseable {
       @Override
       public void close() {
           // Cleanup code
       }
   }
   ```

4. ‚úÖ **Handle exceptions appropriately**
   ```java
   try (Resource r = new Resource()) {
       // Use resource
   } catch (IOException e) {
       // Handle exception
   }
   ```

5. ‚úÖ **Check suppressed exceptions**
   ```java
   catch (Exception e) {
       for (Throwable t : e.getSuppressed()) {
           // Handle suppressed
       }
   }
   ```

---

## ‚ö†Ô∏è Common Pitfalls

```java
public class TryWithResourcesPitfalls {
    void demonstrate() throws Exception {
        // 1. Non-AutoCloseable resource
        // try (String str = "Hello") { }  // ERROR: Not AutoCloseable
        
        // 2. Null resource
        BufferedReader reader = null;
        try (reader) {  // NullPointerException
            // Use reader
        }
        
        // 3. Modifying resource variable
        // try (BufferedReader r = new BufferedReader(...)) {
        //     r = new BufferedReader(...);  // ERROR: Can't reassign
        // }
        
        // 4. Not handling close() exception
        // close() can throw exception - handle it
    }
}
```

---

## üéØ Interview Questions

1. **What is try-with-resources?**
2. **When was try-with-resources introduced?**
3. **What is AutoCloseable interface?**
4. **Difference between Closeable and AutoCloseable?**
5. **Can we use try-with-resources with any class?**
6. **What is the order of closing multiple resources?**
7. **What are suppressed exceptions?**
8. **Can we use catch and finally with try-with-resources?**
9. **What if exception occurs in close()?**
10. **Java 9 enhancement in try-with-resources?**
11. **Can we reassign resource variable?**
12. **Can resource be null?**
13. **Advantages of try-with-resources?**
14. **How to create custom AutoCloseable resource?**
15. **Best practices for try-with-resources?**

---

## üìö Related Topics

- [Exception Basics](01.%20Exception%20Basics.md)
- [try-catch-finally](02.%20try-catch-finally.md)
- [Custom Exceptions](06.%20Custom%20Exceptions.md)
- [Best Practices](08.%20Best%20Practices.md)
