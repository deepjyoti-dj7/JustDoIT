# üßµ ThreadLocal

## üìñ What is ThreadLocal?

A class that provides thread-local variables. Each thread accessing a ThreadLocal variable has its own, independently initialized copy.

**Key Features:**
- Each thread has its own copy
- No synchronization needed
- Useful for per-thread context
- Memory isolation between threads

---

## üíª Example 1: Basic ThreadLocal

```java
class BasicThreadLocalExample {
    private static ThreadLocal<Integer> threadLocal = new ThreadLocal<>();
    
    public static void main(String[] args) {
        // Thread 1
        new Thread(() -> {
            threadLocal.set(100);
            System.out.println("Thread-1 set: " + threadLocal.get());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("Thread-1 still has: " + threadLocal.get());
        }, "Thread-1").start();
        
        // Thread 2
        new Thread(() -> {
            threadLocal.set(200);
            System.out.println("Thread-2 set: " + threadLocal.get());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("Thread-2 still has: " + threadLocal.get());
        }, "Thread-2").start();
    }
}
```

**Output:**
```
Thread-1 set: 100
Thread-2 set: 200
Thread-1 still has: 100
Thread-2 still has: 200
```

---

## üíª Example 2: ThreadLocal with Initial Value

```java
class ThreadLocalWithInitialValue {
    private static ThreadLocal<Integer> threadId = ThreadLocal.withInitial(() -> {
        return (int) (Math.random() * 1000);
    });
    
    public static void main(String[] args) {
        for (int i = 1; i <= 5; i++) {
            new Thread(() -> {
                System.out.println(Thread.currentThread().getName() + 
                                 " has ID: " + threadId.get());
            }, "Thread-" + i).start();
        }
    }
}
```

---

## üíª Example 3: User Context (Session Management)

```java
class UserContext {
    private static ThreadLocal<String> userThreadLocal = new ThreadLocal<>();
    
    public static void setUser(String user) {
        userThreadLocal.set(user);
    }
    
    public static String getUser() {
        return userThreadLocal.get();
    }
    
    public static void clear() {
        userThreadLocal.remove();
    }
}

class Service {
    public void processRequest() {
        String user = UserContext.getUser();
        System.out.println(Thread.currentThread().getName() + 
                          " processing request for user: " + user);
    }
}

class ThreadLocalUserContextExample {
    public static void main(String[] args) {
        Service service = new Service();
        
        // Simulate different users in different threads
        new Thread(() -> {
            try {
                UserContext.setUser("Alice");
                service.processRequest();
                Thread.sleep(1000);
                service.processRequest();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                UserContext.clear();
            }
        }, "Request-1").start();
        
        new Thread(() -> {
            try {
                UserContext.setUser("Bob");
                service.processRequest();
                Thread.sleep(500);
                service.processRequest();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                UserContext.clear();
            }
        }, "Request-2").start();
    }
}
```

---

## üíª Example 4: Database Connection Per Thread

```java
class DatabaseConnection {
    private String connectionId;
    
    public DatabaseConnection(String id) {
        this.connectionId = id;
        System.out.println("Created connection: " + id);
    }
    
    public void executeQuery(String query) {
        System.out.println("Connection " + connectionId + 
                          " executing: " + query);
    }
    
    public void close() {
        System.out.println("Closing connection: " + connectionId);
    }
}

class ConnectionManager {
    private static ThreadLocal<DatabaseConnection> connectionThreadLocal = 
        ThreadLocal.withInitial(() -> {
            return new DatabaseConnection(Thread.currentThread().getName());
        });
    
    public static DatabaseConnection getConnection() {
        return connectionThreadLocal.get();
    }
    
    public static void closeConnection() {
        DatabaseConnection conn = connectionThreadLocal.get();
        if (conn != null) {
            conn.close();
            connectionThreadLocal.remove();
        }
    }
}

class DatabaseExample {
    public static void main(String[] args) throws InterruptedException {
        Thread[] threads = new Thread[3];
        
        for (int i = 0; i < threads.length; i++) {
            threads[i] = new Thread(() -> {
                try {
                    DatabaseConnection conn = ConnectionManager.getConnection();
                    conn.executeQuery("SELECT * FROM users");
                    Thread.sleep(1000);
                    conn.executeQuery("SELECT * FROM orders");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    ConnectionManager.closeConnection();
                }
            }, "Thread-" + (i + 1));
            threads[i].start();
        }
        
        for (Thread thread : threads) {
            thread.join();
        }
    }
}
```

---

## üíª Example 5: SimpleDateFormat Thread Safety

```java
import java.text.SimpleDateFormat;
import java.util.Date;

class DateFormatExample {
    // ThreadLocal to avoid synchronization overhead
    private static ThreadLocal<SimpleDateFormat> dateFormat = 
        ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
    
    public static String formatDate(Date date) {
        return dateFormat.get().format(date);
    }
    
    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                for (int j = 0; j < 5; j++) {
                    Date now = new Date();
                    String formatted = formatDate(now);
                    System.out.println(Thread.currentThread().getName() + 
                                     ": " + formatted);
                    try {
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }, "Thread-" + i).start();
        }
    }
}
```

---

## üíª Example 6: Transaction Context

```java
class Transaction {
    private String transactionId;
    private long startTime;
    
    public Transaction(String id) {
        this.transactionId = id;
        this.startTime = System.currentTimeMillis();
    }
    
    public String getId() {
        return transactionId;
    }
    
    public long getDuration() {
        return System.currentTimeMillis() - startTime;
    }
}

class TransactionManager {
    private static ThreadLocal<Transaction> transactionContext = new ThreadLocal<>();
    
    public static void beginTransaction() {
        String txId = Thread.currentThread().getName() + "-" + 
                     System.currentTimeMillis();
        Transaction tx = new Transaction(txId);
        transactionContext.set(tx);
        System.out.println("Started transaction: " + txId);
    }
    
    public static Transaction getCurrentTransaction() {
        return transactionContext.get();
    }
    
    public static void commit() {
        Transaction tx = transactionContext.get();
        if (tx != null) {
            System.out.println("Committed transaction: " + tx.getId() + 
                             " (duration: " + tx.getDuration() + "ms)");
            transactionContext.remove();
        }
    }
    
    public static void rollback() {
        Transaction tx = transactionContext.get();
        if (tx != null) {
            System.out.println("Rolled back transaction: " + tx.getId());
            transactionContext.remove();
        }
    }
}

class TransactionExample {
    public static void main(String[] args) {
        for (int i = 1; i <= 3; i++) {
            new Thread(() -> {
                try {
                    TransactionManager.beginTransaction();
                    
                    // Simulate work
                    Thread.sleep((long)(Math.random() * 2000));
                    
                    if (Math.random() > 0.3) {
                        TransactionManager.commit();
                    } else {
                        TransactionManager.rollback();
                    }
                } catch (InterruptedException e) {
                    TransactionManager.rollback();
                }
            }, "Worker-" + i).start();
        }
    }
}
```

---

## üíª Example 7: Request ID Tracking

```java
import java.util.UUID;

class RequestContext {
    private static ThreadLocal<String> requestId = new ThreadLocal<>();
    
    public static void setRequestId(String id) {
        requestId.set(id);
    }
    
    public static String getRequestId() {
        return requestId.get();
    }
    
    public static void clear() {
        requestId.remove();
    }
}

class Logger {
    public static void log(String message) {
        String requestId = RequestContext.getRequestId();
        System.out.println("[" + requestId + "] " + message);
    }
}

class RequestProcessor {
    public void handleRequest() {
        Logger.log("Processing started");
        doWork();
        Logger.log("Processing completed");
    }
    
    private void doWork() {
        Logger.log("Doing actual work");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}

class RequestTrackingExample {
    public static void main(String[] args) {
        RequestProcessor processor = new RequestProcessor();
        
        for (int i = 1; i <= 5; i++) {
            new Thread(() -> {
                try {
                    RequestContext.setRequestId(UUID.randomUUID().toString());
                    processor.handleRequest();
                } finally {
                    RequestContext.clear();
                }
            }, "Request-" + i).start();
        }
    }
}
```

---

## ‚ö†Ô∏è Memory Leak Warning

```java
class MemoryLeakExample {
    private static ThreadLocal<byte[]> threadLocal = new ThreadLocal<>();
    
    public static void main(String[] args) throws InterruptedException {
        // ‚ùå BAD: Can cause memory leak in thread pools
        ExecutorService executor = Executors.newFixedThreadPool(2);
        
        for (int i = 0; i < 100; i++) {
            executor.submit(() -> {
                threadLocal.set(new byte[1024 * 1024]); // 1MB
                // Forgot to call remove()!
            });
        }
        
        executor.shutdown();
        executor.awaitTermination(1, TimeUnit.MINUTES);
        
        // ‚úÖ GOOD: Always clean up
        executor = Executors.newFixedThreadPool(2);
        
        for (int i = 0; i < 100; i++) {
            executor.submit(() -> {
                try {
                    threadLocal.set(new byte[1024 * 1024]);
                    // Do work
                } finally {
                    threadLocal.remove(); // Always remove!
                }
            });
        }
        
        executor.shutdown();
    }
}
```

---

## üí° Best Practices

1. ‚úÖ Always call `remove()` in finally block
2. ‚úÖ Be careful with thread pools (threads are reused)
3. ‚úÖ Use for per-thread context (user, transaction, etc.)
4. ‚úÖ Avoid for large objects (memory overhead)
5. ‚úÖ Document ThreadLocal usage clearly

---

## üéØ Interview Questions

1. **What is ThreadLocal?**
2. **When would you use ThreadLocal?**
3. **What is the memory leak risk with ThreadLocal?**
4. **How does ThreadLocal work internally?**
5. **What is InheritableThreadLocal?**
6. **Why should you call remove()?**

---

## üìö Next Topics

- [Thread Safety](03.%20Thread%20Safety.md)
- [Memory Model](05.%20Memory%20Model.md)
