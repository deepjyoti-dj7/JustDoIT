# âš¡ Happens-Before Relationship

## ğŸ“– What is Happens-Before?

A relationship between actions in a multithreaded program that guarantees memory visibility. If action A happens-before action B, then the results of A are visible to B.

**Key Concept:**
Memory visibility guarantees in Java Memory Model

---

## ğŸ’» Example 1: Basic Happens-Before with volatile

```java
class VolatileHappensBefore {
    private volatile boolean flag = false;
    private int value = 0;
    
    // Writer thread
    public void writer() {
        value = 42;      // (1)
        flag = true;     // (2) - volatile write
    }
    
    // Reader thread
    public void reader() {
        if (flag) {      // (3) - volatile read
            System.out.println(value); // (4) - will see 42
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        VolatileHappensBefore example = new VolatileHappensBefore();
        
        Thread writer = new Thread(example::writer);
        Thread reader = new Thread(example::reader);
        
        writer.start();
        writer.join();
        
        reader.start();
        reader.join();
    }
}
```

**Happens-Before:**
- (1) happens-before (2) - program order
- (2) happens-before (3) - volatile variable rule
- (3) happens-before (4) - program order
- Therefore: (1) happens-before (4) - transitivity

---

## ğŸ’» Example 2: Happens-Before with Synchronized

```java
class SynchronizedHappensBefore {
    private int sharedVar = 0;
    private final Object lock = new Object();
    
    public void writer() {
        synchronized (lock) { // Acquire lock
            sharedVar = 100;  // Write
        }                     // Release lock
    }
    
    public void reader() {
        synchronized (lock) { // Acquire lock
            System.out.println("Value: " + sharedVar); // Read
        }                     // Release lock
    }
    
    public static void main(String[] args) throws InterruptedException {
        SynchronizedHappensBefore example = new SynchronizedHappensBefore();
        
        Thread writer = new Thread(example::writer);
        Thread reader = new Thread(example::reader);
        
        writer.start();
        writer.join();
        
        reader.start();
    }
}
```

**Happens-Before:**
- Unlock of monitor happens-before every subsequent lock of same monitor
- Actions in a thread happen-before the unlock
- Actions after lock happen-before actions in that thread

---

## ğŸ’» Example 3: Happens-Before with Thread.start()

```java
class ThreadStartHappensBefore {
    private int value = 0;
    
    public static void main(String[] args) {
        ThreadStartHappensBefore example = new ThreadStartHappensBefore();
        
        example.value = 42; // (1)
        
        Thread thread = new Thread(() -> {
            System.out.println("Value: " + example.value); // (3) - will see 42
        });
        
        thread.start(); // (2)
    }
}
```

**Happens-Before:**
- (1) happens-before (2) - program order
- (2) happens-before (3) - thread start rule
- Therefore: value write is visible in new thread

---

## ğŸ’» Example 4: Happens-Before with Thread.join()

```java
class ThreadJoinHappensBefore {
    private int result = 0;
    
    public static void main(String[] args) throws InterruptedException {
        ThreadJoinHappensBefore example = new ThreadJoinHappensBefore();
        
        Thread worker = new Thread(() -> {
            example.result = 100; // (1)
        });
        
        worker.start();
        worker.join(); // (2)
        
        System.out.println("Result: " + example.result); // (3) - will see 100
    }
}
```

**Happens-Before:**
- (1) happens-before thread termination
- Thread termination happens-before (2) returns
- (2) happens-before (3) - program order

---

## ğŸ’» Example 5: No Happens-Before (Data Race)

```java
class NoHappensBefore {
    private int value = 0;
    private boolean ready = false;
    
    // Writer - no synchronization
    public void writer() {
        value = 42;      // (1)
        ready = true;    // (2)
    }
    
    // Reader - no synchronization
    public void reader() {
        while (!ready) { // (3) - may never see true!
            // spin
        }
        System.out.println(value); // (4) - may see 0!
    }
    
    public static void main(String[] args) {
        NoHappensBefore example = new NoHappensBefore();
        
        new Thread(example::reader).start();
        new Thread(example::writer).start();
    }
}
```

**No Happens-Before:**
- No synchronization between threads
- Reader may never see updates
- This is a data race!

---

## ğŸ’» Example 6: Happens-Before with final Fields

```java
class FinalFieldsHappensBefore {
    private final int x;
    private int y;
    
    public FinalFieldsHappensBefore() {
        x = 1;  // final field
        y = 2;  // regular field
    }
    
    public static void main(String[] args) {
        // Thread 1: publishes object
        final FinalFieldsHappensBefore[] holder = new FinalFieldsHappensBefore[1];
        
        new Thread(() -> {
            holder[0] = new FinalFieldsHappensBefore();
        }).start();
        
        // Thread 2: reads object
        new Thread(() -> {
            FinalFieldsHappensBefore obj;
            while ((obj = holder[0]) == null) {
                // spin
            }
            System.out.println("x: " + obj.x); // Guaranteed to see 1
            System.out.println("y: " + obj.y); // May see 0 or 2
        }).start();
    }
}
```

---

## ğŸ’» Example 7: Happens-Before Chain

```java
import java.util.concurrent.*;

class HappensBeforeChain {
    private final BlockingQueue<Integer> queue = new LinkedBlockingQueue<>();
    
    public void producer() throws InterruptedException {
        int value = 42;
        System.out.println("Producer: putting " + value);
        queue.put(value); // (1)
    }
    
    public void consumer() throws InterruptedException {
        Integer value = queue.take(); // (2)
        System.out.println("Consumer: got " + value);
    }
    
    public static void main(String[] args) throws InterruptedException {
        HappensBeforeChain example = new HappensBeforeChain();
        
        Thread producer = new Thread(() -> {
            try {
                example.producer();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        Thread consumer = new Thread(() -> {
            try {
                example.consumer();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        producer.start();
        consumer.start();
        
        producer.join();
        consumer.join();
    }
}
```

**Happens-Before:**
- (1) happens-before (2) - blocking queue rule
- All actions before put() are visible after take()

---

## ğŸ“Š Happens-Before Rules

| Rule | Description | Example |
|------|-------------|---------|
| **Program Order** | Each action happens-before next in same thread | `x = 1; y = 2;` |
| **Monitor Lock** | Unlock happens-before subsequent lock | `synchronized` |
| **Volatile Variable** | Write happens-before subsequent read | `volatile int x` |
| **Thread Start** | `start()` happens-before actions in started thread | `thread.start()` |
| **Thread Join** | Actions in thread happen-before `join()` returns | `thread.join()` |
| **Thread Interruption** | `interrupt()` happens-before detecting interruption | `thread.interrupt()` |
| **Constructor** | End of constructor happens-before finalize | Object construction |
| **Transitivity** | If A hb B and B hb C, then A hb C | Chain of events |

---

## ğŸ’¡ Practical Implications

```java
// âŒ BAD: No happens-before guarantee
class Broken {
    private int value;
    private boolean ready;
    
    public void set() {
        value = 42;
        ready = true; // Other thread may not see this
    }
    
    public int get() {
        while (!ready);
        return value; // May return 0!
    }
}

// âœ… GOOD: With volatile
class Fixed1 {
    private int value;
    private volatile boolean ready;
    
    public void set() {
        value = 42;
        ready = true; // Happens-before guarantee
    }
    
    public int get() {
        while (!ready);
        return value; // Will return 42
    }
}

// âœ… GOOD: With synchronized
class Fixed2 {
    private int value;
    private boolean ready;
    
    public synchronized void set() {
        value = 42;
        ready = true;
    }
    
    public synchronized int get() {
        while (!ready);
        return value;
    }
}
```

---

## ğŸ’¡ Best Practices

1. âœ… Use synchronization to establish happens-before
2. âœ… Understand volatile semantics
3. âœ… Use concurrent collections (built-in happens-before)
4. âœ… Avoid data races
5. âœ… Document synchronization strategy

---

## ğŸ¯ Interview Questions

1. **What is the happens-before relationship?**
2. **What are the happens-before rules in Java?**
3. **How does volatile establish happens-before?**
4. **What is the happens-before guarantee of synchronized?**
5. **What is a data race?**
6. **How does Thread.start() establish happens-before?**

---

## ğŸ“š Next Topics

- [Memory Model](05.%20Memory%20Model.md)
- [Volatile Keyword](../../02.%20Synchronization/03.%20Volatile%20Keyword.md)
