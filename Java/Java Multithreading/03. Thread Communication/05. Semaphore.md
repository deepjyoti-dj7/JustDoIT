# ðŸš¦ Semaphore

## ðŸ“– What is Semaphore?

A counting semaphore that maintains a set of permits. Threads can acquire and release permits to control access to a shared resource.

**Use Cases:**
- Limiting concurrent access to resources
- Connection pool management
- Rate limiting
- Resource pooling

---

## ðŸ’» Example 1: Basic Semaphore

```java
import java.util.concurrent.Semaphore;

class BasicSemaphoreExample {
    public static void main(String[] args) {
        // Semaphore with 3 permits
        Semaphore semaphore = new Semaphore(3);
        
        for (int i = 1; i <= 10; i++) {
            final int id = i;
            new Thread(() -> {
                try {
                    System.out.println("Thread-" + id + " waiting for permit");
                    semaphore.acquire(); // Acquire permit
                    
                    System.out.println("Thread-" + id + " got permit, working...");
                    Thread.sleep(2000);
                    
                    System.out.println("Thread-" + id + " releasing permit");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    semaphore.release(); // Always release in finally
                }
            }).start();
        }
    }
}
```

---

## ðŸ’» Example 2: Connection Pool

```java
import java.util.concurrent.Semaphore;

class ConnectionPool {
    private Semaphore semaphore;
    private int maxConnections;
    
    public ConnectionPool(int maxConnections) {
        this.maxConnections = maxConnections;
        this.semaphore = new Semaphore(maxConnections);
    }
    
    public void useConnection(int userId) {
        try {
            System.out.println("User-" + userId + " requesting connection");
            semaphore.acquire();
            
            System.out.println("User-" + userId + " got connection (" + 
                              getAvailableConnections() + " available)");
            
            // Simulate using connection
            Thread.sleep((long)(Math.random() * 3000));
            
            System.out.println("User-" + userId + " released connection");
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            semaphore.release();
        }
    }
    
    public int getAvailableConnections() {
        return semaphore.availablePermits();
    }
    
    public static void main(String[] args) {
        ConnectionPool pool = new ConnectionPool(5);
        
        // 20 users trying to get connections
        for (int i = 1; i <= 20; i++) {
            final int userId = i;
            new Thread(() -> pool.useConnection(userId)).start();
        }
    }
}
```

---

## ðŸ’» Example 3: Parking Lot

```java
import java.util.concurrent.Semaphore;

class ParkingLot {
    private Semaphore semaphore;
    private int totalSpots;
    
    public ParkingLot(int totalSpots) {
        this.totalSpots = totalSpots;
        this.semaphore = new Semaphore(totalSpots);
    }
    
    public void parkCar(String carName) {
        try {
            System.out.println(carName + " trying to park");
            
            if (semaphore.tryAcquire()) {
                System.out.println(carName + " parked! (" + 
                                  getAvailableSpots() + " spots left)");
                Thread.sleep((long)(Math.random() * 5000));
                System.out.println(carName + " leaving");
            } else {
                System.out.println(carName + " no spots available, leaving");
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            if (semaphore.availablePermits() < totalSpots) {
                semaphore.release();
            }
        }
    }
    
    public int getAvailableSpots() {
        return semaphore.availablePermits();
    }
    
    public static void main(String[] args) {
        ParkingLot lot = new ParkingLot(3);
        
        String[] cars = {"Car-A", "Car-B", "Car-C", "Car-D", "Car-E", 
                        "Car-F", "Car-G", "Car-H"};
        
        for (String car : cars) {
            new Thread(() -> lot.parkCar(car)).start();
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

---

## ðŸ’» Example 4: Binary Semaphore (Mutex)

```java
import java.util.concurrent.Semaphore;

class BinarySemaphoreExample {
    private Semaphore mutex = new Semaphore(1); // Binary semaphore
    private int counter = 0;
    
    public void increment() {
        try {
            mutex.acquire();
            counter++;
            System.out.println(Thread.currentThread().getName() + 
                              ": " + counter);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            mutex.release();
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        BinarySemaphoreExample example = new BinarySemaphoreExample();
        
        Thread[] threads = new Thread[5];
        for (int i = 0; i < threads.length; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 3; j++) {
                    example.increment();
                }
            }, "Thread-" + (i + 1));
            threads[i].start();
        }
        
        for (Thread thread : threads) {
            thread.join();
        }
        
        System.out.println("Final count: " + example.counter);
    }
}
```

---

## ðŸ’» Example 5: Fair Semaphore

```java
import java.util.concurrent.Semaphore;

class FairSemaphoreExample {
    public static void main(String[] args) {
        // Fair semaphore - FIFO order
        Semaphore fairSemaphore = new Semaphore(2, true);
        
        for (int i = 1; i <= 6; i++) {
            final int id = i;
            new Thread(() -> {
                try {
                    System.out.println("Thread-" + id + " waiting (fair)");
                    fairSemaphore.acquire();
                    System.out.println("Thread-" + id + " got permit");
                    Thread.sleep(1000);
                    System.out.println("Thread-" + id + " releasing");
                    fairSemaphore.release();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }, "Thread-" + id).start();
        }
    }
}
```

---

## ðŸ’» Example 6: tryAcquire() with Timeout

```java
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;

class TryAcquireExample {
    public static void main(String[] args) {
        Semaphore semaphore = new Semaphore(2);
        
        for (int i = 1; i <= 5; i++) {
            final int id = i;
            new Thread(() -> {
                try {
                    System.out.println("Thread-" + id + " trying to acquire");
                    
                    if (semaphore.tryAcquire(2, TimeUnit.SECONDS)) {
                        try {
                            System.out.println("Thread-" + id + " got permit");
                            Thread.sleep(3000);
                        } finally {
                            System.out.println("Thread-" + id + " releasing");
                            semaphore.release();
                        }
                    } else {
                        System.out.println("Thread-" + id + " timeout, couldn't get permit");
                    }
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
```

---

## ðŸ’» Example 7: Rate Limiter

```java
import java.util.concurrent.Semaphore;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

class RateLimiter {
    private Semaphore semaphore;
    private int maxPermits;
    private ScheduledExecutorService scheduler;
    
    public RateLimiter(int permitsPerSecond) {
        this.maxPermits = permitsPerSecond;
        this.semaphore = new Semaphore(0);
        this.scheduler = Executors.newScheduledThreadPool(1);
        
        // Replenish permits every second
        scheduler.scheduleAtFixedRate(() -> {
            int current = semaphore.availablePermits();
            if (current < maxPermits) {
                semaphore.release(maxPermits - current);
            }
        }, 0, 1, TimeUnit.SECONDS);
    }
    
    public void makeRequest(String requestId) {
        try {
            semaphore.acquire();
            System.out.println(requestId + " processed at " + 
                              System.currentTimeMillis());
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    public void shutdown() {
        scheduler.shutdown();
    }
    
    public static void main(String[] args) throws InterruptedException {
        RateLimiter limiter = new RateLimiter(3); // 3 requests per second
        
        // Generate 15 requests
        for (int i = 1; i <= 15; i++) {
            final int id = i;
            new Thread(() -> {
                limiter.makeRequest("Request-" + id);
            }).start();
            Thread.sleep(100);
        }
        
        Thread.sleep(10000);
        limiter.shutdown();
    }
}
```

---

## ðŸ“Š Semaphore vs Mutex vs Lock

| Feature | Semaphore | Mutex (Binary Semaphore) | Lock |
|---------|-----------|-------------------------|------|
| **Permits** | Multiple | One | One |
| **Ownership** | No | No | Yes |
| **Use Case** | Resource pool | Critical section | Critical section |
| **Fairness** | Optional | Optional | Optional |

---

## ðŸ’¡ Best Practices

1. âœ… Always release in `finally` block
2. âœ… Use `tryAcquire()` to avoid indefinite blocking
3. âœ… Use fair semaphore for FIFO order
4. âœ… Monitor available permits
5. âœ… Don't release more permits than acquired

---

## ðŸŽ¯ Interview Questions

1. **What is a Semaphore?**
2. **What is the difference between Semaphore and Lock?**
3. **What is a binary semaphore?**
4. **What is a fair semaphore?**
5. **When would you use Semaphore?**
6. **Can one thread release a permit acquired by another?**

---

## ðŸ“š Next Topics

- [Exchanger](06.%20Exchanger.md)
- [Phaser](07.%20Phaser.md)
