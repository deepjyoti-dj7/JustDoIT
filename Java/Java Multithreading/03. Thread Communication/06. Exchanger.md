# ðŸ”„ Exchanger

## ðŸ“– What is Exchanger?

A synchronization point where threads can exchange objects. Two threads wait for each other and swap data.

**Use Cases:**
- Producer-Consumer pattern
- Pipeline processing
- Data exchange between threads
- Genetic algorithms

---

## ðŸ’» Example 1: Basic Exchange

```java
import java.util.concurrent.Exchanger;

class BasicExchangerExample {
    public static void main(String[] args) {
        Exchanger<String> exchanger = new Exchanger<>();
        
        // Thread 1
        new Thread(() -> {
            try {
                String data = "Data from Thread-1";
                System.out.println("Thread-1 offering: " + data);
                
                String received = exchanger.exchange(data);
                
                System.out.println("Thread-1 received: " + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        
        // Thread 2
        new Thread(() -> {
            try {
                String data = "Data from Thread-2";
                System.out.println("Thread-2 offering: " + data);
                
                String received = exchanger.exchange(data);
                
                System.out.println("Thread-2 received: " + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

**Output:**
```
Thread-1 offering: Data from Thread-1
Thread-2 offering: Data from Thread-2
Thread-1 received: Data from Thread-2
Thread-2 received: Data from Thread-1
```

---

## ðŸ’» Example 2: Producer-Consumer with Exchanger

```java
import java.util.concurrent.Exchanger;
import java.util.ArrayList;
import java.util.List;

class ProducerConsumerExchanger {
    public static void main(String[] args) {
        Exchanger<List<Integer>> exchanger = new Exchanger<>();
        
        // Producer
        new Thread(() -> {
            List<Integer> producerBuffer = new ArrayList<>();
            
            try {
                for (int cycle = 1; cycle <= 3; cycle++) {
                    // Produce items
                    for (int i = 1; i <= 5; i++) {
                        producerBuffer.add(i + (cycle - 1) * 5);
                        System.out.println("Produced: " + (i + (cycle - 1) * 5));
                    }
                    
                    System.out.println("Producer: Buffer full, exchanging...");
                    producerBuffer = exchanger.exchange(producerBuffer);
                    System.out.println("Producer: Got empty buffer back\n");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Producer").start();
        
        // Consumer
        new Thread(() -> {
            List<Integer> consumerBuffer = new ArrayList<>();
            
            try {
                for (int cycle = 1; cycle <= 3; cycle++) {
                    System.out.println("Consumer: Waiting for full buffer...");
                    consumerBuffer = exchanger.exchange(consumerBuffer);
                    
                    // Consume items
                    System.out.println("Consumer: Received items: " + consumerBuffer);
                    for (Integer item : consumerBuffer) {
                        System.out.println("Consumed: " + item);
                    }
                    consumerBuffer.clear();
                    System.out.println("Consumer: Buffer emptied\n");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Consumer").start();
    }
}
```

---

## ðŸ’» Example 3: Pipeline Processing

```java
import java.util.concurrent.Exchanger;

class PipelineProcessor {
    static class DataPacket {
        String data;
        int stage;
        
        public DataPacket(String data, int stage) {
            this.data = data;
            this.stage = stage;
        }
        
        @Override
        public String toString() {
            return "DataPacket{data='" + data + "', stage=" + stage + "}";
        }
    }
    
    public static void main(String[] args) {
        Exchanger<DataPacket> exchanger = new Exchanger<>();
        
        // Stage 1: Data loader
        new Thread(() -> {
            try {
                for (int i = 1; i <= 5; i++) {
                    DataPacket packet = new DataPacket("Data-" + i, 1);
                    System.out.println("Stage-1: Loading " + packet);
                    Thread.sleep(500);
                    
                    System.out.println("Stage-1: Sending to Stage-2");
                    packet = exchanger.exchange(packet);
                    System.out.println("Stage-1: Received back " + packet + "\n");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Stage-1").start();
        
        // Stage 2: Data processor
        new Thread(() -> {
            try {
                for (int i = 1; i <= 5; i++) {
                    DataPacket packet = exchanger.exchange(null);
                    System.out.println("Stage-2: Received " + packet);
                    
                    // Process data
                    packet.data = packet.data.toUpperCase();
                    packet.stage = 2;
                    System.out.println("Stage-2: Processed " + packet);
                    Thread.sleep(300);
                    
                    System.out.println("Stage-2: Sending back to Stage-1");
                    exchanger.exchange(packet);
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Stage-2").start();
    }
}
```

---

## ðŸ’» Example 4: Exchange with Timeout

```java
import java.util.concurrent.Exchanger;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;

class ExchangerTimeoutExample {
    public static void main(String[] args) {
        Exchanger<String> exchanger = new Exchanger<>();
        
        // Fast thread
        new Thread(() -> {
            try {
                String data = "Fast data";
                System.out.println("Fast thread offering: " + data);
                
                String received = exchanger.exchange(data, 2, TimeUnit.SECONDS);
                
                System.out.println("Fast thread received: " + received);
            } catch (TimeoutException e) {
                System.out.println("Fast thread: Timeout! No one to exchange with");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        
        // Slow thread (will cause timeout)
        new Thread(() -> {
            try {
                System.out.println("Slow thread: Sleeping for 5 seconds...");
                Thread.sleep(5000);
                
                String data = "Slow data";
                System.out.println("Slow thread offering: " + data);
                String received = exchanger.exchange(data);
                System.out.println("Slow thread received: " + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

---

## ðŸ’» Example 5: Genetic Algorithm

```java
import java.util.concurrent.Exchanger;
import java.util.Random;

class GeneticAlgorithm {
    static class Chromosome {
        int[] genes;
        double fitness;
        
        public Chromosome(int size) {
            genes = new int[size];
            Random random = new Random();
            for (int i = 0; i < size; i++) {
                genes[i] = random.nextInt(2);
            }
            calculateFitness();
        }
        
        public void calculateFitness() {
            fitness = 0;
            for (int gene : genes) {
                fitness += gene;
            }
        }
        
        @Override
        public String toString() {
            StringBuilder sb = new StringBuilder();
            for (int gene : genes) {
                sb.append(gene);
            }
            return sb.toString() + " (fitness: " + fitness + ")";
        }
    }
    
    public static void main(String[] args) {
        Exchanger<Chromosome> exchanger = new Exchanger<>();
        
        // Population 1
        new Thread(() -> {
            try {
                for (int generation = 1; generation <= 3; generation++) {
                    Chromosome chromosome = new Chromosome(8);
                    System.out.println("Pop-1 Gen-" + generation + ": " + chromosome);
                    
                    chromosome = exchanger.exchange(chromosome);
                    
                    System.out.println("Pop-1 Gen-" + generation + " received: " + chromosome + "\n");
                    Thread.sleep(1000);
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Population-1").start();
        
        // Population 2
        new Thread(() -> {
            try {
                for (int generation = 1; generation <= 3; generation++) {
                    Chromosome chromosome = new Chromosome(8);
                    System.out.println("Pop-2 Gen-" + generation + ": " + chromosome);
                    
                    chromosome = exchanger.exchange(chromosome);
                    
                    System.out.println("Pop-2 Gen-" + generation + " received: " + chromosome + "\n");
                    Thread.sleep(1000);
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Population-2").start();
    }
}
```

---

## ðŸ’» Example 6: Buffer Swapping

```java
import java.util.concurrent.Exchanger;

class BufferSwapper {
    private static final int BUFFER_SIZE = 10;
    
    static class Buffer {
        private int[] data = new int[BUFFER_SIZE];
        private int count = 0;
        
        public void add(int value) {
            if (count < BUFFER_SIZE) {
                data[count++] = value;
            }
        }
        
        public boolean isFull() {
            return count == BUFFER_SIZE;
        }
        
        public void clear() {
            count = 0;
        }
        
        public void print(String prefix) {
            System.out.print(prefix + ": [");
            for (int i = 0; i < count; i++) {
                System.out.print(data[i] + (i < count - 1 ? ", " : ""));
            }
            System.out.println("]");
        }
    }
    
    public static void main(String[] args) {
        Exchanger<Buffer> exchanger = new Exchanger<>();
        
        // Writer
        new Thread(() -> {
            Buffer buffer = new Buffer();
            try {
                for (int i = 1; i <= 30; i++) {
                    buffer.add(i);
                    
                    if (buffer.isFull()) {
                        System.out.println("Writer: Buffer full, exchanging...");
                        buffer.print("Writer sending");
                        buffer = exchanger.exchange(buffer);
                        System.out.println("Writer: Got empty buffer\n");
                    }
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Writer").start();
        
        // Reader
        new Thread(() -> {
            Buffer buffer = new Buffer();
            try {
                for (int i = 0; i < 3; i++) {
                    System.out.println("Reader: Waiting for full buffer...");
                    buffer = exchanger.exchange(buffer);
                    buffer.print("Reader received");
                    buffer.clear();
                    System.out.println("Reader: Buffer cleared\n");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Reader").start();
    }
}
```

---

## ðŸ’¡ Best Practices

1. âœ… Use for two-thread data exchange
2. âœ… Use timeout to avoid indefinite blocking
3. âœ… Clear/reset exchanged objects appropriately
4. âœ… Handle InterruptedException
5. âœ… Use for pipeline or producer-consumer patterns

---

## ðŸŽ¯ Interview Questions

1. **What is an Exchanger?**
2. **How many threads can participate in an exchange?**
3. **When would you use Exchanger?**
4. **What happens if only one thread calls exchange()?**
5. **Can you reuse an Exchanger?**

---

## ðŸ“š Next Topics

- [Phaser](07.%20Phaser.md)
- [CompletableFuture](../04.%20Executor%20Framework/03.%20CompletableFuture.md)
