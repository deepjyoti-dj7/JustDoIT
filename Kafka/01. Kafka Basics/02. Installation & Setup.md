# 02. Installation & Setup

## Prerequisites

- Java 8+ (Kafka runs on JVM)
- Minimum 4GB RAM
- Disk space for logs (depends on retention)

---

## Installation Methods

1. **Manual Installation** (Local development)
2. **Docker** (Recommended for quick setup)
3. **Cloud** (Confluent Cloud, AWS MSK, Azure Event Hubs)

---

## Method 1: Manual Installation

### Step 1: Install Java

**Check Java version:**
```bash
java -version
```

**Install Java (if not installed):**

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install openjdk-11-jdk
```

**macOS:**
```bash
brew install openjdk@11
```

**Windows:**
Download from [Oracle](https://www.oracle.com/java/technologies/downloads/) or use [OpenJDK](https://adoptium.net/)

---

### Step 2: Download Kafka

**Visit:** https://kafka.apache.org/downloads

**Download latest version:**
```bash
wget https://downloads.apache.org/kafka/3.6.0/kafka_2.13-3.6.0.tgz
```

**Extract:**
```bash
tar -xzf kafka_2.13-3.6.0.tgz
cd kafka_2.13-3.6.0
```

---

### Step 3: Start Kafka (KRaft Mode - No ZooKeeper)

Kafka 3.0+ supports KRaft (Kafka Raft) without ZooKeeper.

**Generate Cluster ID:**
```bash
KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"
```

**Format Storage:**
```bash
bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties
```

**Start Kafka Server:**
```bash
bin/kafka-server-start.sh config/kraft/server.properties
```

---

### Step 3 (Alternative): Start with ZooKeeper (Legacy)

**Start ZooKeeper:**
```bash
bin/zookeeper-server-start.sh config/zookeeper.properties
```

**Start Kafka Broker (in new terminal):**
```bash
bin/kafka-server-start.sh config/server.properties
```

---

## Method 2: Docker Installation (Recommended)

### Using Docker Compose

**docker-compose.yml:**

```yaml
version: '3'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
```

**Start Kafka:**
```bash
docker-compose up -d
```

**Check Status:**
```bash
docker-compose ps
```

**Stop Kafka:**
```bash
docker-compose down
```

---

### Using Single Docker Command

**Start ZooKeeper:**
```bash
docker run -d \
  --name zookeeper \
  -p 2181:2181 \
  -e ZOOKEEPER_CLIENT_PORT=2181 \
  confluentinc/cp-zookeeper:latest
```

**Start Kafka:**
```bash
docker run -d \
  --name kafka \
  -p 9092:9092 \
  -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
  -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
  -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
  --link zookeeper \
  confluentinc/cp-kafka:latest
```

---

## Verify Installation

### Check Kafka is Running

**List running processes:**
```bash
jps
```

You should see:
- `Kafka` or `KafkaServer`
- `QuorumControllerMain` (KRaft mode)
- `ZooKeeper` (if using ZooKeeper mode)

---

### Test with Simple Topic

**Create a test topic:**
```bash
bin/kafka-topics.sh --create \
  --topic test \
  --bootstrap-server localhost:9092 \
  --partitions 1 \
  --replication-factor 1
```

**List topics:**
```bash
bin/kafka-topics.sh --list --bootstrap-server localhost:9092
```

You should see: `test`

---

## Configuration Files

### server.properties (Important Settings)

```properties
# Broker ID (unique for each broker)
broker.id=0

# Port
listeners=PLAINTEXT://:9092

# Log directory
log.dirs=/tmp/kafka-logs

# Number of partitions per topic (default)
num.partitions=1

# Replication factor (default)
default.replication.factor=1

# Log retention (hours)
log.retention.hours=168

# ZooKeeper connection (if using ZooKeeper)
zookeeper.connect=localhost:2181
```

---

## Directory Structure

```
kafka_2.13-3.6.0/
├── bin/              # Executable scripts
│   ├── kafka-server-start.sh
│   ├── kafka-topics.sh
│   ├── kafka-console-producer.sh
│   └── kafka-console-consumer.sh
├── config/           # Configuration files
│   ├── server.properties
│   └── zookeeper.properties
├── libs/             # Kafka libraries
└── logs/             # Log files
```

---

## Common Ports

| Service | Port | Description |
|---------|------|-------------|
| Kafka Broker | 9092 | Default broker port |
| ZooKeeper | 2181 | ZooKeeper client port |
| Kafka (SSL) | 9093 | SSL encrypted port |

---

## Environment Variables

**Set KAFKA_HOME:**

**Linux/macOS:**
```bash
export KAFKA_HOME=/path/to/kafka_2.13-3.6.0
export PATH=$PATH:$KAFKA_HOME/bin
```

**Add to ~/.bashrc or ~/.zshrc:**
```bash
echo 'export KAFKA_HOME=/path/to/kafka_2.13-3.6.0' >> ~/.bashrc
echo 'export PATH=$PATH:$KAFKA_HOME/bin' >> ~/.bashrc
source ~/.bashrc
```

---

## Troubleshooting

### Issue 1: Port Already in Use

**Error:**
```
Address already in use (Bind failed)
```

**Solution:**
```bash
# Find process using port 9092
lsof -i :9092

# Kill the process
kill -9 <PID>
```

### Issue 2: ZooKeeper Connection Failed

**Check ZooKeeper is running:**
```bash
echo ruok | nc localhost 2181
# Should return: imok
```

### Issue 3: Out of Memory

**Increase heap size:**
```bash
export KAFKA_HEAP_OPTS="-Xmx1G -Xms1G"
bin/kafka-server-start.sh config/server.properties
```

---

## Production Setup Checklist

- [ ] Multiple brokers (3+ for fault tolerance)
- [ ] Replication factor ≥ 3
- [ ] Dedicated ZooKeeper cluster (3 or 5 nodes)
- [ ] Sufficient disk space for logs
- [ ] Monitoring setup (JMX, Prometheus)
- [ ] Security enabled (SSL, SASL)
- [ ] Backup and disaster recovery plan

---

## Summary

**Installation Options:**
1. Manual (Download + Extract)
2. Docker (docker-compose)
3. Cloud (Managed services)

**Two Modes:**
- KRaft (New, no ZooKeeper)
- ZooKeeper (Legacy)

**Quick Start:**
```bash
# Download & Extract
wget https://downloads.apache.org/kafka/3.6.0/kafka_2.13-3.6.0.tgz
tar -xzf kafka_2.13-3.6.0.tgz
cd kafka_2.13-3.6.0

# Start Kafka (KRaft)
KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"
bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties
bin/kafka-server-start.sh config/kraft/server.properties
```

---

## Interview Questions & Answers

### Q1: What are the prerequisites for installing Kafka?
**A:** 
- Java 8 or higher (Kafka runs on JVM)
- Minimum 4GB RAM
- Sufficient disk space for log storage
- (Optional) ZooKeeper if not using KRaft mode

### Q2: What is the difference between KRaft and ZooKeeper mode?
**A:**
- **ZooKeeper mode (Legacy)**: Uses external ZooKeeper for metadata management and coordination
- **KRaft mode (New)**: Uses Kafka's own Raft consensus protocol, eliminating ZooKeeper dependency
- KRaft is simpler to deploy and manage, available from Kafka 3.0+

### Q3: What is the default port for Kafka broker?
**A:** Port 9092 for PLAINTEXT connections. Port 9093 is commonly used for SSL/TLS encrypted connections.

### Q4: How do you verify Kafka installation?
**A:**
1. Check running processes: `jps` (should show Kafka/QuorumControllerMain)
2. Create a test topic: `kafka-topics.sh --create --topic test --bootstrap-server localhost:9092`
3. List topics: `kafka-topics.sh --list --bootstrap-server localhost:9092`
4. Produce and consume test messages

### Q5: What is the purpose of server.properties file?
**A:** server.properties contains Kafka broker configuration:
- Broker ID and listeners
- Log directories and retention policies
- Replication settings
- ZooKeeper connection (if applicable)
- Performance tuning parameters

### Q6: How do you start Kafka in KRaft mode?
**A:**
```bash
# Generate cluster ID
KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"

# Format storage
bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties

# Start Kafka
bin/kafka-server-start.sh config/kraft/server.properties
```

### Q7: What is the easiest way to run Kafka for development?
**A:** Using Docker Compose:
```yaml
services:
  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
```

### Q8: What is broker.id in Kafka configuration?
**A:** broker.id is a unique integer identifier for each Kafka broker in a cluster. It must be unique across all brokers. Example: broker.id=0, broker.id=1, etc.

### Q9: How do you troubleshoot "Address already in use" error?
**A:**
1. Find process using the port: `lsof -i :9092` or `netstat -an | grep 9092`
2. Kill the process: `kill -9 <PID>`
3. Or change the port in server.properties: `listeners=PLAINTEXT://:9093`

### Q10: What are the key directories in Kafka installation?
**A:**
- **bin/**: Executable scripts (kafka-server-start.sh, kafka-topics.sh, etc.)
- **config/**: Configuration files (server.properties, zookeeper.properties)
- **libs/**: Kafka library JAR files
- **logs/**: Kafka log files and data

### Q11: How do you increase Kafka heap memory?
**A:**
```bash
export KAFKA_HEAP_OPTS="-Xmx2G -Xms2G"
bin/kafka-server-start.sh config/server.properties
```
Or set in kafka-server-start.sh permanently.

### Q12: What is the recommended minimum number of brokers for production?
**A:** Minimum 3 brokers for:
- Fault tolerance
- Proper replication (replication factor of 3)
- High availability
- Load distribution

**Next:** Kafka CLI Commands!